<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822118.png">
    
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø© 2025</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22%D9%85%D8%AC%D9%85%D8%B9%20%D8%A7%D9%84%D8%B4%D9%81%D8%A7%D8%A1%22,%22short_name%22:%22%D8%A7%D9%84%D8%B4%D9%81%D8%A1%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f8fafc%22,%22theme_color%22:%22%232c7a7b%22,%22description%22:%22%D9%86%D8%B8%D8%A7%D9%85%20%D8%A5%D8%AF%D8%A7%D8%B1%D8%A9%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B4%D9%81%D9%8A%D8%A7%D8%AA%20%D9%88%D8%A7%D9%84%D8%B9%D9%8A%D8%A7%D8%AF%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B0%D9%83%D9%8A%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%22},{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22,%22purpose%22:%22maskable%22}]}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #2c7a7b; 
            --secondary-color: #f0fdf4; 
            --accent-blue: #0d6efd; 
            --accent-red: #dc3545; 
            --accent-green: #198754; 
            --accent-gold: #d4af37;
            --accent-warning: #ffc107;
            --accent-info: #17a2b8;
            --accent-purple: #6f42c1;
        }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); padding: 10px 20px !important; position: relative; }
        .nav-link.active { background-color: var(--accent-blue) !important; color: white !important; border-radius: 10px; }
        .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border-radius: 50%; padding: 3px 7px; font-size: 0.7rem; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; text-align: center; }
        .patient-btn { text-align: right; margin-bottom: 8px; border-right: 5px solid var(--primary-color); width: 100%; transition: 0.3s; padding: 12px 15px; background: white; border: 1px solid #dee2e6; border-radius: 10px; }
        .patient-btn.ready { border-right-color: #28a745; background-color: #f0fff4; }
        .patient-btn:hover { background-color: #f8f9fa; }
        .lab-result-item { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 4px solid var(--accent-blue); }
        .section-pane { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; padding: 20px; } }
        .search-box { position: relative; }
        .search-box input { padding-right: 40px; }
        .rx-item { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 8px; border-left: 4px solid var(--accent-green); }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        .sync-status { position: fixed; bottom: 10px; left: 10px; z-index: 1000; }
        .sync-btn { position: fixed; bottom: 10px; right: 10px; z-index: 1000; }
        .medical-record { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .nursing-schedule { border-left: 5px solid var(--accent-purple); }
        .expiry-warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .stock-critical { background: #f8d7da; border-left: 5px solid #dc3545; }
        .library-card { height: 100%; transition: all 0.3s; }
        .library-card:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .form-check { padding-right: 1.5em; margin-bottom: 0.5rem; }
        .form-check-input { margin-right: -1.5em; }
        #labTestsChecklist { scrollbar-width: thin; scrollbar-color: var(--primary-color) #f1f1f1; }
        #labTestsChecklist::-webkit-scrollbar { width: 8px; }
        #labTestsChecklist::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #labTestsChecklist::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        
        /* PWA Styles */
        .install-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50px; padding: 10px 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        .install-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .pwa-status { position: fixed; top: 10px; left: 10px; z-index: 9999; }
        .pwa-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 20px; z-index: 10000; max-width: 400px; direction: rtl; }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; text-align: center; padding: 10px; z-index: 9998; }
        .online-banner { position: fixed; top: 0; left: 0; right: 0; background: #28a745; color: white; text-align: center; padding: 10px; z-index: 9998; }
        #appVersion { font-size: 0.8em; color: #6c757d; }
        
        /* Advanced Permissions Styles */
        .permission-badge { font-size: 0.7em; padding: 2px 6px; margin-right: 3px; }
        .permission-row { border-bottom: 1px solid #eee; padding: 8px 0; }
        .permission-header { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 10px; border-radius: 8px; }
        .permission-toggle { transform: scale(0.9); }
        .user-status-online { color: #28a745; animation: pulse 2s infinite; }
        .user-status-offline { color: #dc3545; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .role-badge { font-size: 0.75em; padding: 3px 8px; }
        .permission-modal { max-height: 80vh; overflow-y: auto; }
        .password-strength { height: 5px; border-radius: 2px; margin-top: 5px; transition: all 0.3s; }
        
        /* New Styles for Workflow */
        .workflow-step { border-left: 4px solid; padding: 10px; margin: 5px 0; border-radius: 8px; }
        .step-reception { border-color: #0d6efd; background: #e7f1ff; }
        .step-doctor { border-color: #198754; background: #e8f5e8; }
        .step-lab { border-color: #dc3545; background: #fde8e8; }
        .step-pharmacy { border-color: #ffc107; background: #fff8e1; }
        .step-nursing { border-color: #6f42c1; background: #f0e8ff; }
        .step-completed { background: #d4edda !important; }
        .patient-flow { display: flex; justify-content: space-between; margin: 10px 0; }
        .flow-arrow { color: #6c757d; margin: 0 10px; }
    </style>
</head>
<body>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printArea" class="hidden-section">
        <div class="text-center border-bottom pb-3 mb-3">
            <h2 style="color: var(--primary-color);">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h2>
            <p>Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø¬Ù„Ù‚Ù†ÙŠ</p>
            <h5 id="printTitle">Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ© / ÙØ§ØªÙˆØ±Ø©</h5>
            <small id="printDate"></small>
        </div>
        <div id="printContent" class="fs-5"></div>
        <div class="mt-5 pt-3 border-top text-center"><p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¹Ø§Ø¬Ù„ Ø§Ù„Ø´ÙØ§Ø¡</p></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginOverlay" class="no-print" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0fdf4; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg" style="width: 380px; border-top: 8px solid var(--primary-color);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="60">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted small">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ - Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©</p>
                <div class="mt-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="loginMode" id="modeLocal" value="local" checked>
                        <label class="form-check-label" for="modeLocal">ğŸ’¾ Ø¹Ù…Ù„ Ù…Ø­Ù„ÙŠ</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="loginMode" id="modeServer" value="server">
                        <label class="form-check-label" for="modeServer">â˜ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª</label>
                    </div>
                </div>
            </div>
            <input type="text" id="username" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" value="admin">
            <input type="password" id="password" class="form-control mb-3" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="123">
            <button class="btn btn-primary w-100 fw-bold" onclick="handleLogin()">ğŸš€ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <div class="mt-3 text-center small text-muted" id="loginStatus">Ø¬Ø§Ù‡Ø² Ù„Ù„ØªØ´ØºÙŠÙ„</div>
            
            <!-- PWA Install Button -->
            <button id="installButton" class="install-btn hidden-section w-100 mt-3">
                ğŸ“² ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²
            </button>
            
            <div id="appVersion" class="mt-2">Ø§Ù„Ø¥ØµØ¯Ø§Ø± 2.6.1 - Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¯ÙÙ‚ Ø§Ù„Ø·Ø¨ÙŠ Ø§Ù„Ù…Ø­Ø³Ù‘Ù†</div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainContent" class="hidden-section">
        <!-- PWA Status -->
        <div class="pwa-status no-print">
            <div id="pwaStatus" class="badge bg-info">PWA: Ù†Ø´Ø·</div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between text-white align-items-center">
                <span class="navbar-brand fw-bold">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø°ÙƒÙŠ</span>
                <div>
                    <span id="currentUserDisplay" class="badge bg-light text-dark mx-2"></span>
                    <span id="clockDisplay" class="badge bg-info text-dark"></span>
                    <span id="connectionStatus" class="badge bg-success mx-2">Ù…ØªØµÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹</span>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="openUserMenu()">ğŸ‘¤</button>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
            </div>
        </nav>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="container">
            <ul class="nav nav-pills mb-4 shadow-sm p-2 bg-white rounded justify-content-center no-print" id="mainTabs">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© <span id="doctorBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„ <span id="labBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© <span id="pharBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-nursing-li"><button class="nav-link" id="btn-nursing" onclick="switchSection('nursing')">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶ <span id="nurseBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ±</button></li>
            </ul>

            <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© -->
            <div class="sync-status no-print">
                <div id="syncStatusText" class="badge bg-secondary">Ø¬Ø§Ù‡Ø²</div>
            </div>
            <div class="sync-btn no-print">
                <button class="btn btn-sm btn-outline-primary" onclick="manualSync()" title="Ù…Ø²Ø§Ù…Ù†Ø© ÙŠØ¯ÙˆÙŠØ©">
                    ğŸ”„ Ù…Ø²Ø§Ù…Ù†Ø©
                </button>
            </div>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
            <div class="tab-content">
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
                <div id="reception-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4 border-primary border-top border-4 shadow">
                                <h5 class="fw-bold text-primary mb-3">ğŸ“‹ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ - Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø´Ø§Ù…Ù„</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" id="pName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… Ø±Ø¨Ø§Ø¹ÙŠ *" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="pAge" class="form-control" placeholder="Ø§Ù„Ø¹Ù…Ø± *" required>
                                    </div>
                                    <div class="col-md-2">
                                        <select id="pGender" class="form-select">
                                            <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
                                            <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                            <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" id="pPhone" class="form-control" placeholder="Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" id="pAddress" class="form-control" placeholder="Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙƒØ§Ù…Ù„">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" id="pTicket" class="form-control" placeholder="Ø§Ù„Ø±Ø³ÙˆÙ…" value="5000">
                                    </div>
                                    <div class="col-md-3">
                                        <select id="pVisitType" class="form-select">
                                            <option value="Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©">Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</option>
                                            <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                                            <option value="Ù…ØªØ§Ø¨Ø¹Ø©">Ù…ØªØ§Ø¨Ø¹Ø©</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <textarea id="pMedicalHistory" class="form-control" rows="3" placeholder="ØªØ§Ø±ÙŠØ® Ù…Ø±Ø¶ÙŠ Ø³Ø§Ø¨Ù‚ (Ø­Ø³Ø§Ø³ÙŠØ§ØªØŒ Ø£Ù…Ø±Ø§Ø¶ Ù…Ø²Ù…Ù†Ø©ØŒ Ø£Ø¯ÙˆÙŠØ© Ù…Ù†ØªØ¸Ù…Ø©...)"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <button class="btn btn-primary w-100 fw-bold" onclick="registerPatient()">
                                            ğŸ’¾ Ø­ÙØ¸ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
                            <div class="card p-3 mt-3 border-info shadow">
                                <h6 class="fw-bold text-info">ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ÙŠÙ†</h6>
                                <input type="text" class="form-control mb-2" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„Ù‡Ø§ØªÙ..." onkeyup="searchPatientRecords(this.value)">
                                <div id="patientRecordsList" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 bg-light shadow">
                                <h6 class="fw-bold">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</h6>
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="bg-primary text-white p-3 rounded">
                                            <h4 id="todayPatients">0</h4>
                                            <small>Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="bg-success text-white p-3 rounded">
                                            <h4 id="totalPatients">0</h4>
                                            <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-warning text-white p-3 rounded">
                                            <h4 id="newPatients">0</h4>
                                            <small>Ø¬Ø¯Ø¯</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-info text-white p-3 rounded">
                                            <h4 id="returnPatients">0</h4>
                                            <small>Ù…Ø±Ø§Ø¬Ø¹ÙŠÙ†</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="fw-bold">â° Ø£ÙˆÙ‚Ø§Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" style="width: 30%">0-15 Ø¯</div>
                                        <div class="progress-bar bg-warning" style="width: 40%">15-30 Ø¯</div>
                                        <div class="progress-bar bg-danger" style="width: 30%">+30 Ø¯</div>
                                    </div>
                                    <small class="text-muted">Ù…ØªÙˆØ³Ø· ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±: <span id="avgWaitTime">0</span> Ø¯Ù‚ÙŠÙ‚Ø©</small>
                                </div>
                            </div>
                            
                            <!-- ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ… -->
                            <div class="card p-3 mt-3 border-success shadow">
                                <h6 class="fw-bold text-success">ğŸ”„ ØªØ¯ÙÙ‚ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…</h6>
                                <div id="patientFlowToday" style="max-height: 200px; overflow-y: auto;">
                                    <div class="text-center text-muted small mt-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ© Ù…Ø±ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© -->
                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h6 class="fw-bold text-primary border-bottom pb-2">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h6>
                                <div class="search-box mb-3">
                                    <input type="text" id="searchPatient" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙŠØ¶..." onkeyup="searchPatients(this.value)">
                                </div>
                                <div id="doctorPatientList" class="mt-2" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ© -->
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h6 class="fw-bold text-warning">ğŸ“š Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø·Ø¨ÙŠØ©</h6>
                                <div class="input-group mb-2">
                                    <input type="text" id="librarySearch" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±Ø¶ Ø£Ùˆ Ø¯ÙˆØ§Ø¡..." onkeyup="searchLibrary(this.value)">
                                    <button class="btn btn-warning" onclick="openLibrary()">ğŸ”</button>
                                </div>
                                <div id="quickLibraryResults" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬ -->
                            <div id="treatmentArea" class="card p-4 shadow hidden-section">
                                <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-3">
                                    <div>
                                        <h4 class="text-primary fw-bold mb-0" id="selectedPatientTitle"></h4>
                                        <small class="text-muted" id="selectedPatientInfo"></small>
                                    </div>
                                    <div>
                                        <span class="badge bg-warning text-dark" id="caseStatus">ØªØ­Øª Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</span>
                                        <button class="btn btn-sm btn-outline-info ms-2" onclick="viewFullMedicalRecord()">ğŸ“„ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ÙƒØ§Ù…Ù„</button>
                                    </div>
                                </div>
                                
                                <!-- Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ -->
                                <div class="patient-flow mb-3">
                                    <span class="step-reception p-2 rounded"><small>ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</small></span>
                                    <span class="flow-arrow">â†’</span>
                                    <span class="step-doctor p-2 rounded"><small>ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</small></span>
                                    <span class="flow-arrow">â†’</span>
                                    <span class="step-lab p-2 rounded"><small>ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</small></span>
                                    <span class="flow-arrow">â†’</span>
                                    <span class="step-pharmacy p-2 rounded"><small>ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</small></span>
                                </div>
                                
                                <!-- Ø¹Ù„Ø§Ù…Ø§Øª Ø­ÙŠÙˆÙŠØ© -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" placeholder="Ø§Ù„Ø¶ØºØ·" id="vitalBP">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="Ø§Ù„Ù†Ø¨Ø¶" id="vitalPulse">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="Ø§Ù„Ø­Ø±Ø§Ø±Ø©" id="vitalTemp">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="Ø§Ù„ØªÙ†ÙØ³" id="vitalResp">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" placeholder="Ø§Ù„Ø³ÙƒØ±" id="vitalSugar">
                                    </div>
                                </div>
                                
                                <!-- Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶ -->
                                <div class="medical-record mb-3">
                                    <h6 class="fw-bold">ğŸ“‹ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø·Ø¨ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø±Ø¶ÙŠ:</strong> <span id="patientMedicalHistory">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
                                            <p><strong>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ù†ØªØ¸Ù…Ø©:</strong> <span id="patientRegularMeds">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>Ø§Ù„Ø­Ø³Ø§Ø³ÙŠØ§Øª:</strong> <span id="patientAllergies">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
                                            <p><strong>Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</strong> <span id="patientSurgeries">Ù„Ø§ ÙŠÙˆØ¬Ø¯</span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="fw-bold mb-1">Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ:</label>
                                    <textarea id="pComplaint" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ Ù‡Ù†Ø§..."></textarea>
                                </div>
                                
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showDocSubSection('rx')">ğŸ’Š Ø§Ù„Ø±ÙˆØ´ØªØ©</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('lab')">ğŸ§ª Ø·Ù„Ø¨ ÙØ­Øµ</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('results')">ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('nursing')">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</button></li>
                                </ul>
                                
                                <div id="doc-sub-rx">
                                    <div class="p-3 bg-light border rounded mb-3">
                                        <h6 class="text-muted small mb-2">Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ© Ù„Ù„Ø±ÙˆØ´ØªØ©:</h6>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-5">
                                                <input list="stockMeds" id="medSearch" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡..." onkeyup="filterStock(this.value)">
                                                <datalist id="stockMeds"></datalist>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" id="medDose" class="form-control" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø©">
                                            </div>
                                            <div class="col-md-2">
                                                <input type="number" id="medDays" class="form-control" placeholder="Ø§Ù„Ø£ÙŠØ§Ù…" value="7">
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-outline-primary w-100" onclick="addMedToRx()">â•</button>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="checkInteractions">
                                            <label class="form-check-label small" for="checkInteractions">ÙØ­Øµ ØªÙØ§Ø¹Ù„Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</label>
                                        </div>
                                    </div>
                                    <div id="rxItemsContainer" class="mb-3"></div>
                                    <div id="drugInteractionsAlert" class="alert alert-danger hidden-section"></div>
                                    <textarea id="finalRx" class="form-control mb-3 bg-white" rows="4" readonly placeholder="Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±ÙˆØ´ØªØ©..."></textarea>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success w-50 fw-bold" onclick="sendRxToPharmacy()">ğŸ’Š Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©</button>
                                        <button class="btn btn-warning w-25" onclick="addNursingOrders()">ğŸ’‰ Ø¥Ø¶Ø§ÙØ© ØªÙ…Ø±ÙŠØ¶</button>
                                        <button class="btn btn-dark w-25" onclick="printRx()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                    </div>
                                </div>
                                
                                <div id="doc-sub-lab" class="hidden-section">
                                    <div class="mb-3">
                                        <h6 class="fw-bold text-success mb-2">Ø§Ø®ØªØ± Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:</h6>
                                        <div id="labTestsChecklist" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px; background: #f8f9fa;">
                                            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨ÙˆØ§Ø³Ø·Ø© JavaScript -->
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <button class="btn btn-danger w-100" onclick="sendSelectedTestsToLab()">ğŸ§ª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ù„Ù…Ø¹Ù…Ù„</button>
                                        <button class="btn btn-outline-secondary w-100 mt-2" onclick="selectAllLabTests()">âœ… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</button>
                                    </div>
                                    <h6 class="fw-bold text-success mt-3">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:</h6>
                                    <div id="doctorLabRequests"></div>
                                </div>
                                
                                <div id="doc-sub-results" class="hidden-section">
                                    <h6 class="fw-bold text-success">âœ… Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©:</h6>
                                    <div id="patientSpecificLabResults" class="mt-2" style="max-height: 300px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="doc-sub-nursing" class="hidden-section">
                                    <h6 class="fw-bold text-purple">ğŸ’‰ Ø£ÙˆØ§Ù…Ø± Ø§Ù„ØªÙ…Ø±ÙŠØ¶</h6>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <select id="nursingProcedure" class="form-select">
                                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</option>
                                                <option value="Ø­Ù‚Ù† Ø¹Ø¶Ù„ÙŠ">Ø­Ù‚Ù† Ø¹Ø¶Ù„ÙŠ</option>
                                                <option value="Ø­Ù‚Ù† ÙˆØ±ÙŠØ¯ÙŠ">Ø­Ù‚Ù† ÙˆØ±ÙŠØ¯ÙŠ</option>
                                                <option value="ØªØºÙŠÙŠØ± Ø¶Ù…Ø§Ø¯Ø©">ØªØºÙŠÙŠØ± Ø¶Ù…Ø§Ø¯Ø©</option>
                                                <option value="Ù‚ÙŠØ§Ø³ Ø¹Ù„Ø§Ù…Ø§Øª Ø­ÙŠÙˆÙŠØ©">Ù‚ÙŠØ§Ø³ Ø¹Ù„Ø§Ù…Ø§Øª Ø­ÙŠÙˆÙŠØ©</option>
                                                <option value="Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¬Ø±Ø­">Ø¹Ù†Ø§ÙŠØ© Ø¨Ø§Ù„Ø¬Ø±Ø­</option>
                                                <option value="Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙƒØ³Ø¬ÙŠÙ†">Ø¥Ø¹Ø·Ø§Ø¡ Ø£ÙƒØ³Ø¬ÙŠÙ†</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" id="nursingFrequency" class="form-control" placeholder="Ø§Ù„ØªÙƒØ±Ø§Ø±">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-purple w-100 text-white" onclick="addNursingOrder()">â•</button>
                                        </div>
                                    </div>
                                    <div id="nursingOrdersList" class="mb-3"></div>
                                </div>
                            </div>
                            
                            <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… -->
                            <div id="doctorInstructions" class="card p-3 bg-light mt-3">
                                <h6 class="fw-bold text-primary">ğŸ’¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h6>
                                <ol class="mb-0">
                                    <li>Ø§Ø®ØªØ± Ø§Ù„Ù…Ø±ÙŠØ¶ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</li>
                                    <li>Ø§ÙƒØªØ¨ Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ</li>
                                    <li>Ø£Ø±Ø³Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù…Ø¹Ù…Ù„</li>
                                    <li>Ø¨Ø¹Ø¯ ÙˆØµÙˆÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ØŒ Ø§ÙƒØªØ¨ Ø§Ù„Ø±ÙˆØ´ØªØ©</li>
                                    <li>Ø£Ø±Ø³Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ© Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-3 border-danger border-top border-4 shadow">
                                <h5 class="fw-bold text-danger mb-3">ğŸ§ª Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙˆØ³Ø­Ø¨ Ø§Ù„Ø¹ÙŠÙ†Ø§Øª</h5>
                                <div class="table-responsive">
                                    <table class="table table-hover align-middle">
                                        <thead class="table-danger">
                                            <tr>
                                                <th>Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                                                <th>Ø§Ù„ÙØ­Øµ</th>
                                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                                <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                            </tr>
                                        </thead>
                                        <tbody id="labWorkTable"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                            <div id="labResultForm" class="card p-4 mt-3 border-success hidden-section">
                                <h5 class="fw-bold text-success mb-3">ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ</h5>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                                    <input type="text" id="labResultPatient" class="form-control" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ù†ÙˆØ¹ Ø§Ù„ÙØ­Øµ</label>
                                    <input type="text" id="labResultTest" class="form-control" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ø§Ù„Ù†ØªÙŠØ¬Ø©</label>
                                    <textarea id="labResultValue" class="form-control" rows="3" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù‡Ù†Ø§..."></textarea>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                                    <input type="text" id="labResultNotes" class="form-control" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙ†ÙŠØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)">
                                </div>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success w-50" onclick="submitLabResult()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø©</button>
                                    <button class="btn btn-secondary w-50" onclick="cancelLabResult()">Ø¥Ù„ØºØ§Ø¡</button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 bg-light shadow">
                                <h5 class="fw-bold">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¹Ù…Ù„</h5>
                                <div class="row text-center mb-3">
                                    <div class="col-6 mb-2">
                                        <div class="bg-danger text-white p-2 rounded">
                                            <h5 id="pendingTests">0</h5>
                                            <small>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="bg-success text-white p-2 rounded">
                                            <h5 id="completedTests">0</h5>
                                            <small>Ù…ÙƒØªÙ…Ù„Ø©</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-info text-white p-2 rounded">
                                            <h5 id="todayTests">0</h5>
                                            <small>Ø§Ù„ÙŠÙˆÙ…</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-warning text-white p-2 rounded">
                                            <h5 id="totalLabRevenue">0</h5>
                                            <small>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„ -->
                            <div class="card p-3 mt-3 border-info shadow">
                                <h6 class="fw-bold text-info">ğŸ’¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h6>
                                <ol class="small mb-0">
                                    <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø©" Ù„ÙƒÙ„ ÙØ­Øµ</li>
                                    <li>Ø§ÙƒØªØ¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¨Ø¯Ù‚Ø©</li>
                                    <li>Ø§Ø­ÙØ¸ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„Ø·Ø¨ÙŠØ¨</li>
                                    <li>Ø³ÙŠØªÙ… Ø¥Ø¹Ù„Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card p-3 border-success border-top border-4 shadow">
                                <h5 class="fw-bold text-success mb-3">ğŸ’Š Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
                                <div id="pharmacyQueue"></div>
                            </div>
                            
                            <!-- Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ -->
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h5 class="fw-bold text-warning mb-3">ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§Ø³ØªØ±Ø§ØªÙŠØ¬ÙŠ</h5>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-danger">ğŸ”„ Ø¯ÙˆØ±ØªÙ‡</h6>
                                            <h4 id="stockTurnover">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-warning">â° Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                                            <h4 id="stockDays">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-success">ğŸ“Š ÙƒÙØ§Ø¡Ø©</h6>
                                            <h4 id="stockEfficiency">0%</h4>
                                        </div>
                                    </div>
                                </div>
                                <div id="strategicStockAlerts"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="card p-3 bg-light shadow">
                                <h5 class="fw-bold">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h5>
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showPharmacyTab('inventory')">Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showPharmacyTab('orders')">Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø´Ø±Ø§Ø¡</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showPharmacyTab('expiry')">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</button></li>
                                </ul>
                                
                                <div id="pharmacy-inventory">
                                    <div class="input-group mb-2">
                                        <input type="text" id="iName" class="form-control" placeholder="Ø§Ù„ØµÙ†Ù">
                                        <input type="number" id="iCost" class="form-control" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø´Ø±Ø§Ø¡">
                                        <input type="number" id="iQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                                        <button class="btn btn-primary" onclick="addInventory()">â• Ø¥Ø¶Ø§ÙØ©</button>
                                    </div>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped bg-white">
                                            <thead>
                                                <tr>
                                                    <th>Ø§Ù„ØµÙ†Ù</th>
                                                    <th>Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹</th>
                                                    <th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th>
                                                    <th>Ø¥Ø¬Ø±Ø§Ø¡</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="pharmacy-orders" class="hidden-section">
                                    <button class="btn btn-warning w-100 mb-2" onclick="generatePurchaseOrders()">ğŸ“‹ ØªÙˆÙ„ÙŠØ¯ Ø·Ù„Ø¨Ø§Øª Ø´Ø±Ø§Ø¡</button>
                                    <div id="purchaseOrdersList" style="max-height: 250px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="pharmacy-expiry" class="hidden-section">
                                    <h6 class="fw-bold text-danger">âš ï¸ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</h6>
                                    <div id="expiryAlerts" style="max-height: 250px; overflow-y: auto;"></div>
                                </div>
                            </div>
                            
                            <!-- ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„ -->
                            <div class="card p-3 mt-3 border-info">
                                <h6 class="fw-bold text-info">ğŸ’¡ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„Ø¹Ù…Ù„</h6>
                                <ol class="small mb-0">
                                    <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØµØ±Ù" Ù„ÙƒÙ„ Ø±ÙˆØ´ØªØ©</li>
                                    <li>ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</li>
                                    <li>Ø³Ø¬Ù„ ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡</li>
                                    <li>Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶ -->
                <div id="nursing-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4 border-purple border-top border-4 shadow">
                                <h5 class="fw-bold text-purple mb-3">ğŸ’‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù…Ø±Ø¶ÙŠÙ† - ØªÙ†ÙÙŠØ° Ø§Ù„Ø¬Ø±Ø¹Ø§Øª</h5>
                                
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showNursingTab('schedule')">Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠÙˆÙ…ÙŠ</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showNursingTab('patients')">Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù†Ø´Ø·ÙŠÙ†</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showNursingTab('medications')">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…Ù‚Ø±Ø±Ø©</button></li>
                                </ul>
                                
                                <div id="nursing-schedule">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <input type="date" id="nursingDate" class="form-control" value="" onchange="loadNursingSchedule()">
                                        </div>
                                        <div class="col-md-3">
                                            <select id="nursingShift" class="form-select" onchange="loadNursingSchedule()">
                                                <option value="all">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø§Øª</option>
                                                <option value="ØµØ¨Ø§Ø­">ØµØ¨Ø§Ø­ (7Øµ-3Ù…)</option>
                                                <option value="Ù…Ø³Ø§Ø¡">Ù…Ø³Ø§Ø¡ (3Ù…-11Ù…)</option>
                                                <option value="Ù„ÙŠÙ„">Ù„ÙŠÙ„ (11Ù…-7Øµ)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-purple w-100 text-white" onclick="addNewNursingTask()">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</button>
                                        </div>
                                    </div>
                                    <div id="nursingScheduleTable" style="max-height: 400px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="nursing-patients" class="hidden-section">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…Ø±ÙŠØ¶..." id="searchNursingPatient">
                                                <button class="btn btn-outline-purple" onclick="searchNursingPatients()">Ø¨Ø­Ø«</button>
                                            </div>
                                            <div id="nursingPatientsList" style="max-height: 400px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="nursing-medications" class="hidden-section">
                                    <div class="alert alert-info">
                                        <h6>ğŸ’Š Ø£Ø¯ÙˆÙŠØ© ØªØ­ØªØ§Ø¬ ØªÙ†ÙÙŠØ°</h6>
                                        <p id="pendingMedicationsCount">0 Ø¯ÙˆØ§Ø¡ ÙŠØ­ØªØ§Ø¬ Ø¥Ø¹Ø·Ø§Ø¡</p>
                                    </div>
                                    <div id="nursingMedicationsList" style="max-height: 400px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 bg-light shadow">
                                <h6 class="fw-bold">ğŸ‘©â€âš•ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù…Ø±Ø¶ÙŠÙ†</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù…Ø±Ø¶/Ø©">
                                    <select class="form-select mb-2">
                                        <option>Ù…Ù†Ø§ÙˆØ¨Ø© ØµØ¨Ø§Ø­</option>
                                        <option>Ù…Ù†Ø§ÙˆØ¨Ø© Ù…Ø³Ø§Ø¡</option>
                                        <option>Ù…Ù†Ø§ÙˆØ¨Ø© Ù„ÙŠÙ„</option>
                                    </select>
                                    <button class="btn btn-sm btn-purple text-white w-100">â• Ø¥Ø¶Ø§ÙØ© Ù…Ù…Ø±Ø¶</button>
                                </div>
                                <div id="nursesList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="card p-3 mt-3 border-info shadow">
                                <h6 class="fw-bold">ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ¶</h6>
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <div class="bg-info text-white p-2 rounded">
                                            <h5 id="nursingTasksToday">0</h5>
                                            <small>Ù…Ù‡Ø§Ù… Ø§Ù„ÙŠÙˆÙ…</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="bg-success text-white p-2 rounded">
                                            <h5 id="nursingTasksDone">0</h5>
                                            <small>Ù…ÙƒØªÙ…Ù„Ø©</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-warning text-white p-2 rounded">
                                            <h5 id="nursingTasksPending">0</h5>
                                            <small>Ù…Ø¹Ù„Ù‚Ø©</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-danger text-white p-2 rounded">
                                            <h5 id="nursingTasksLate">0</h5>
                                            <small>Ù…ØªØ£Ø®Ø±Ø©</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h6 class="fw-bold">â° ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ù…Ù‡Ù…Ø©</h6>
                                <div id="nursingAlerts" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± -->
                <div id="admin-sec" class="section-pane hidden-section">
                    <!-- Ù†ÙØ³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± -->
                    <!-- Ù„Ø£ØºØ±Ø§Ø¶ Ø§Ù„Ø§Ø®ØªØµØ§Ø±ØŒ Ù„Ù… Ø£ÙƒØ±Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙƒØ§Ù…Ù„ -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <!-- Ù†ÙØ³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
    </div>

    <div id="userMenuModal" class="modal fade" tabindex="-1">
        <!-- Ù†ÙØ³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
    </div>

    <div id="permissionsModal" class="modal fade" tabindex="-1">
        <!-- Ù†ÙØ³ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¨Ù‚ -->
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ============================================
        // Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…ØªÙ‚Ø¯Ù… (Ù…Ø«Ø¨Øª)
        // ============================================

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø£Ø¯ÙˆØ§Ø± ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª
        const ROLES = {
            SUPER_ADMIN: 'super_admin',
            ADMIN: 'admin',
            HEAD_DOCTOR: 'head_doctor',
            DOCTOR: 'doctor',
            LAB_MANAGER: 'lab_manager',
            LAB_TECH: 'lab_tech',
            PHARMACY_MANAGER: 'pharmacy_manager',
            PHARMACIST: 'pharmacist',
            HEAD_NURSE: 'head_nurse',
            NURSE: 'nurse',
            RECEPTION_SUPERVISOR: 'reception_supervisor',
            RECEPTION: 'reception',
            ACCOUNTANT: 'accountant',
            AUDITOR: 'auditor'
        };

        // ============================================
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©
        // ============================================

        const SERVER_URL = "http://alshifaclinic.somee.com/api.aspx";
        let OPERATION_MODE = "local";
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let SYNC_INTERVAL = null;
        let SESSION_TIMEOUT = null;

        // Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
        let patients = JSON.parse(localStorage.getItem('shifa_pats')) || [];
        let labRequests = JSON.parse(localStorage.getItem('shifa_lab')) || [];
        let pharmOrders = JSON.parse(localStorage.getItem('shifa_rx')) || [];
        let nursingOrders = JSON.parse(localStorage.getItem('shifa_nursing')) || [];
        let nursingTasks = JSON.parse(localStorage.getItem('shifa_nursing_tasks')) || [];
        let inventory = JSON.parse(localStorage.getItem('shifa_inv')) || [];
        let financials = JSON.parse(localStorage.getItem('shifa_fin')) || { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0 };
        let staffMembers = JSON.parse(localStorage.getItem('shifa_staff')) || [];
        let labTests = JSON.parse(localStorage.getItem('shifa_tests')) || [];
        let medicalLibrary = JSON.parse(localStorage.getItem('shifa_library')) || [];
        let nurses = JSON.parse(localStorage.getItem('shifa_nurses')) || [];
        let systemLogs = JSON.parse(localStorage.getItem('shifa_logs')) || [];

        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
        let currentUser = localStorage.getItem('shifa_user') ? JSON.parse(localStorage.getItem('shifa_user')) : null;
        let selectedPatientId = null;
        let currentRxItems = [];
        let currentNursingOrders = [];
        let currentLabTest = null;

        // ============================================
        // Ø¯ÙˆØ§Ù„ ØªØ¯ÙÙ‚ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        // ============================================

        // 1. ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ (Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ â†’ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©)
        function registerPatient() {
            const name = document.getElementById('pName').value.trim();
            const age = document.getElementById('pAge').value;
            const phone = document.getElementById('pPhone').value.trim();
            
            if (!name || !age) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù…Ø±!");
                return;
            }
            
            const patientId = Date.now();
            const newPatient = {
                id: patientId,
                name: name,
                age: age,
                gender: document.getElementById('pGender').value,
                phone: phone,
                address: document.getElementById('pAddress').value,
                ticket: parseInt(document.getElementById('pTicket').value) || 5000,
                visitType: document.getElementById('pVisitType').value,
                medicalHistory: document.getElementById('pMedicalHistory').value,
                status: 'waiting',
                department: 'reception',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                vitalSigns: {},
                complaint: '',
                diagnosis: '',
                labRequests: [],
                labResults: [],
                medications: [],
                nursingOrders: [],
                payments: []
            };
            
            patients.push(newPatient);
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            financials.clinic += newPatient.ticket;
            localStorage.setItem('shifa_fin', JSON.stringify(financials));
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('pName').value = '';
            document.getElementById('pAge').value = '';
            document.getElementById('pPhone').value = '';
            document.getElementById('pAddress').value = '';
            document.getElementById('pMedicalHistory').value = '';
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
            showNotification("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶", `ØªÙ… ØªØ³Ø¬ÙŠÙ„ ${name} Ø¨Ù†Ø¬Ø§Ø­ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ø¹ÙŠØ§Ø¯Ø©`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            loadReceptionStats();
            loadPatientRecords();
            refreshDoctorPatientList();
            updateBadges();
            
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø¨ÙŠØ¨
            if (currentUser && currentUser.r === 'doctor') {
                showNotification("Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±", `${name} ÙŠÙ†ØªØ¸Ø± Ø§Ù„ÙƒØ´Ù ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©`);
            }
            
            console.log("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶:", newPatient);
        }

        // 2. Ø¥Ø±Ø³Ø§Ù„ ÙØ­ÙˆØµØ§Øª Ù„Ù„Ù…Ø¹Ù…Ù„ (Ø§Ù„Ø·Ø¨ÙŠØ¨ â†’ Ø§Ù„Ù…Ø¹Ù…Ù„)
        function sendSelectedTestsToLab() {
            if (!selectedPatientId) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            
            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient) {
                alert("âš ï¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
                return;
            }
            
            const checkboxes = document.querySelectorAll('#labTestsChecklist input[type="checkbox"]:checked');
            if (checkboxes.length === 0) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙØ­ÙˆØµØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!");
                return;
            }
            
            const tests = [];
            checkboxes.forEach(cb => {
                const testName = cb.dataset.name;
                const testPrice = parseInt(cb.dataset.price) || 0;
                
                tests.push({
                    id: Date.now() + Math.random(),
                    name: testName,
                    price: testPrice,
                    status: 'pending',
                    requestedBy: currentUser ? currentUser.u : 'system',
                    requestedAt: new Date().toISOString(),
                    result: '',
                    notes: '',
                    completedAt: null
                });
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            patient.department = 'lab';
            patient.labRequests = patient.labRequests ? patient.labRequests.concat(tests) : tests;
            patient.updatedAt = new Date().toISOString();
            
            // ØªØ­Ø¯ÙŠØ« Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ø¹Ø§Ù…Ø©
            tests.forEach(test => {
                labRequests.push({
                    ...test,
                    patientId: patient.id,
                    patientName: patient.name,
                    patientAge: patient.age
                });
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ†
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            localStorage.setItem('shifa_lab', JSON.stringify(labRequests));
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª
            const totalTestsPrice = tests.reduce((sum, test) => sum + test.price, 0);
            financials.lab += totalTestsPrice;
            localStorage.setItem('shifa_fin', JSON.stringify(financials));
            
            // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            showNotification("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª", `${tests.length} ÙØ­Øµ ØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡ Ù„Ù„Ù…Ø¹Ù…Ù„`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            refreshLabWorkTable();
            updateBadges();
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
            document.getElementById('doctorLabRequests').innerHTML = `
                <div class="alert alert-success">
                    <strong>âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù†Ø¬Ø§Ø­!</strong><br>
                    ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${tests.length} ÙØ­Øµ Ù„Ù„Ù…Ø¹Ù…Ù„. Ø³ÙŠØªÙ… Ø¥Ø´Ø¹Ø§Ø±Ùƒ Ø¹Ù†Ø¯ Ø§ÙƒØªÙ…Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬.
                </div>
            `;
            
            console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª:", tests);
        }

        // 3. Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­Øµ (Ø§Ù„Ù…Ø¹Ù…Ù„ â†’ Ø§Ù„Ø·Ø¨ÙŠØ¨)
        function submitLabResult() {
            if (!currentLabTest) {
                alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ­Øµ Ù…Ø­Ø¯Ø¯!");
                return;
            }
            
            const resultValue = document.getElementById('labResultValue').value.trim();
            const resultNotes = document.getElementById('labResultNotes').value.trim();
            
            if (!resultValue) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ!");
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ ÙÙŠ labRequests
            const labIndex = labRequests.findIndex(l => l.id === currentLabTest.id);
            if (labIndex !== -1) {
                labRequests[labIndex].status = 'completed';
                labRequests[labIndex].result = resultValue;
                labRequests[labIndex].notes = resultNotes;
                labRequests[labIndex].completedAt = new Date().toISOString();
                labRequests[labIndex].completedBy = currentUser ? currentUser.u : 'lab_tech';
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ ÙÙŠ Ø§Ù„Ù…Ø±ÙŠØ¶
            const patient = patients.find(p => p.id === currentLabTest.patientId);
            if (patient) {
                const patientLabIndex = patient.labRequests.findIndex(l => l.id === currentLabTest.id);
                if (patientLabIndex !== -1) {
                    patient.labRequests[patientLabIndex] = labRequests[labIndex];
                    patient.department = 'doctor'; // Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ù…Ø±ÙŠØ¶ Ù„Ù„Ø·Ø¨ÙŠØ¨
                    patient.updatedAt = new Date().toISOString();
                    
                    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø¥Ù„Ù‰ labResults
                    patient.labResults = patient.labResults || [];
                    patient.labResults.push({
                        testName: currentLabTest.name,
                        result: resultValue,
                        notes: resultNotes,
                        date: new Date().toISOString()
                    });
                }
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ†
            localStorage.setItem('shifa_lab', JSON.stringify(labRequests));
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„Ø·Ø¨ÙŠØ¨
            showNotification("ğŸ“Š Ù†ØªÙŠØ¬Ø© ÙØ­Øµ Ø¬Ø§Ù‡Ø²Ø©", `ÙØ­Øµ ${currentLabTest.name} Ù„Ù€ ${patient.name} Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ø±Ø¶`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            refreshLabWorkTable();
            updateBadges();
            
            // Ø¥Ø®ÙØ§Ø¡ Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            document.getElementById('labResultForm').classList.add('hidden-section');
            document.getElementById('labResultValue').value = '';
            document.getElementById('labResultNotes').value = '';
            
            console.log("âœ… ØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø© Ø§Ù„ÙØ­Øµ:", currentLabTest.name);
        }

        // 4. Ø¥Ø±Ø³Ø§Ù„ Ø±ÙˆØ´ØªØ© Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ© (Ø§Ù„Ø·Ø¨ÙŠØ¨ â†’ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©)
        function sendRxToPharmacy() {
            if (!selectedPatientId) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            
            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient) {
                alert("âš ï¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
                return;
            }
            
            const rxText = document.getElementById('finalRx').value.trim();
            if (!rxText) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            
            const rxId = Date.now();
            const newRx = {
                id: rxId,
                patientId: patient.id,
                patientName: patient.name,
                patientAge: patient.age,
                rxText: rxText,
                medications: currentRxItems,
                status: 'pending',
                doctor: currentUser ? currentUser.u : 'doctor',
                createdAt: new Date().toISOString(),
                dispensedAt: null,
                dispensedBy: null,
                totalAmount: calculateRxTotal()
            };
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            patient.department = 'pharmacy';
            patient.medications = currentRxItems;
            patient.updatedAt = new Date().toISOString();
            
            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø±ÙˆØ´ØªØ© Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©
            pharmOrders.push(newRx);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ†
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            localStorage.setItem('shifa_rx', JSON.stringify(pharmOrders));
            
            // Ø¥Ø´Ø¹Ø§Ø± Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©
            showNotification("ğŸ’Š Ø±ÙˆØ´ØªØ© Ø¬Ø¯ÙŠØ¯Ø©", `Ø±ÙˆØ´ØªØ© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù€ ${patient.name} ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ØµØ±Ù`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            refreshPharmacyQueue();
            updateBadges();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø±ÙˆØ´ØªØ©
            currentRxItems = [];
            document.getElementById('finalRx').value = '';
            document.getElementById('rxItemsContainer').innerHTML = '';
            
            // Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯
            alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ© Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ${newRx.totalAmount} Ø¬Ù†ÙŠØ©`);
            
            console.log("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ©:", newRx);
        }

        // 5. ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ (Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© â†’ Ø§Ù„Ù…Ø±ÙŠØ¶)
        function dispenseRx(rxId) {
            const rxIndex = pharmOrders.findIndex(r => r.id === rxId);
            if (rxIndex === -1) {
                alert("âš ï¸ Ø§Ù„Ø±ÙˆØ´ØªØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
                return;
            }
            
            const rx = pharmOrders[rxIndex];
            const patient = patients.find(p => p.id === rx.patientId);
            
            if (!patient) {
                alert("âš ï¸ Ø§Ù„Ù…Ø±ÙŠØ¶ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯!");
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            const unavailableMeds = [];
            rx.medications.forEach(med => {
                const invItem = inventory.find(i => i.name.toLowerCase() === med.name.toLowerCase());
                if (!invItem || invItem.qty < med.quantity) {
                    unavailableMeds.push(med.name);
                }
            });
            
            if (unavailableMeds.length > 0) {
                alert(`âš ï¸ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:\n${unavailableMeds.join('\n')}`);
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            rx.medications.forEach(med => {
                const invIndex = inventory.findIndex(i => i.name.toLowerCase() === med.name.toLowerCase());
                if (invIndex !== -1) {
                    inventory[invIndex].qty -= med.quantity;
                    
                    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
                    financials.pharSales += (inventory[invIndex].sale * med.quantity);
                    financials.pharProfit += ((inventory[invIndex].sale - inventory[invIndex].cost) * med.quantity);
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©
            rx.status = 'dispensed';
            rx.dispensedAt = new Date().toISOString();
            rx.dispensedBy = currentUser ? currentUser.u : 'pharmacist';
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            patient.department = 'completed';
            patient.updatedAt = new Date().toISOString();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ®Ø²ÙŠÙ†
            localStorage.setItem('shifa_rx', JSON.stringify(pharmOrders));
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            localStorage.setItem('shifa_inv', JSON.stringify(inventory));
            localStorage.setItem('shifa_fin', JSON.stringify(financials));
            
            // Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­ Ø§Ù„ØµØ±Ù
            showNotification("âœ… ØªÙ… ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡", `ØªÙ… ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ù„Ù€ ${patient.name} Ø¨Ù†Ø¬Ø§Ø­`);
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
            refreshPharmacyQueue();
            updateBadges();
            
            console.log("âœ… ØªÙ… ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡:", rx);
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªØ¯ÙÙ‚
        // ============================================

        function calculateRxTotal() {
            return currentRxItems.reduce((total, item) => {
                const invItem = inventory.find(i => i.name.toLowerCase() === item.name.toLowerCase());
                return total + (invItem ? invItem.sale * item.quantity : 0);
            }, 0);
        }

        function addMedToRx() {
            const medName = document.getElementById('medSearch').value.trim();
            const dose = document.getElementById('medDose').value.trim();
            const days = parseInt(document.getElementById('medDays').value) || 7;
            
            if (!medName) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡!");
                return;
            }
            
            // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            const invItem = inventory.find(i => i.name.toLowerCase().includes(medName.toLowerCase()));
            if (!invItem) {
                alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø¯ÙˆØ§Ø¡ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†!");
                return;
            }
            
            const medItem = {
                id: Date.now(),
                name: invItem.name,
                dose: dose,
                frequency: 'ÙŠÙˆÙ…ÙŠØ§Ù‹',
                duration: `${days} ÙŠÙˆÙ…`,
                quantity: days, // ÙƒÙ… Ù…Ø±Ø© ÙÙŠ Ø§Ù„ÙŠÙˆÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
                notes: ''
            };
            
            currentRxItems.push(medItem);
            updateRxDisplay();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('medSearch').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medDays').value = '7';
        }

        function updateRxDisplay() {
            const container = document.getElementById('rxItemsContainer');
            const rxText = document.getElementById('finalRx');
            
            let html = '';
            let rxContent = 'ğŸ’Š Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©:\n\n';
            
            currentRxItems.forEach((item, index) => {
                html += `
                    <div class="rx-item d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${item.name}</strong><br>
                            <small>${item.dose} - ${item.frequency} - ${item.duration}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeRxItem(${index})">âœ•</button>
                    </div>
                `;
                
                rxContent += `${index + 1}. ${item.name} - ${item.dose} - ${item.frequency} - ${item.duration}\n`;
            });
            
            container.innerHTML = html;
            rxText.value = rxContent;
        }

        function removeRxItem(index) {
            currentRxItems.splice(index, 1);
            updateRxDisplay();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª
        // ============================================

        function refreshDoctorPatientList() {
            const container = document.getElementById('doctorPatientList');
            const waitingPatients = patients.filter(p => p.department === 'reception' || p.department === 'doctor');
            
            if (waitingPatients.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                        <small>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ù…Ø±Ø¶Ù‰ Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„Ù‡Ù… ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            waitingPatients.forEach(patient => {
                const timeAgo = getTimeAgo(patient.createdAt);
                html += `
                    <div class="patient-btn ${patient.department === 'doctor' ? 'ready' : ''}" 
                         onclick="selectPatient(${patient.id})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${patient.name}</strong> (${patient.age} Ø³Ù†Ø©)<br>
                                <small class="text-muted">${patient.visitType} â€¢ ${timeAgo}</small>
                            </div>
                            <span class="badge ${patient.department === 'doctor' ? 'bg-success' : 'bg-warning'}">
                                ${patient.department === 'doctor' ? 'Ø¬Ø§Ù‡Ø² Ù„Ù„ÙƒØ´Ù' : 'ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function selectPatient(patientId) {
            selectedPatientId = patientId;
            const patient = patients.find(p => p.id === patientId);
            
            if (!patient) return;
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            patient.department = 'doctor';
            patient.updatedAt = new Date().toISOString();
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            
            // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            document.getElementById('selectedPatientTitle').textContent = patient.name;
            document.getElementById('selectedPatientInfo').textContent = 
                `${patient.age} Ø³Ù†Ø© â€¢ ${patient.gender} â€¢ ${patient.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}`;
            
            document.getElementById('patientMedicalHistory').textContent = patient.medicalHistory || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯';
            document.getElementById('patientAllergies').textContent = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'; // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¹Ù„Ø§Ø¬
            document.getElementById('treatmentArea').classList.remove('hidden-section');
            document.getElementById('doctorInstructions').classList.add('hidden-section');
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰
            refreshDoctorPatientList();
            
            // ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            loadPatientLabResults(patientId);
            
            console.log("âœ… ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶:", patient.name);
        }

        function refreshLabWorkTable() {
            const container = document.getElementById('labWorkTable');
            const pendingTests = labRequests.filter(l => l.status === 'pending');
            
            if (pendingTests.length === 0) {
                container.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-3">
                            Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ­ÙˆØµØ§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                        </td>
                    </tr>
                `;
                updateLabStats();
                return;
            }
            
            let html = '';
            pendingTests.forEach(test => {
                const timeAgo = getTimeAgo(test.requestedAt);
                html += `
                    <tr>
                        <td>
                            <strong>${test.patientName}</strong><br>
                            <small>${test.patientAge} Ø³Ù†Ø©</small>
                        </td>
                        <td>${test.name}</td>
                        <td>${test.price} Ø¬</td>
                        <td>${timeAgo}</td>
                        <td>
                            <span class="badge bg-warning">Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</span>
                        </td>
                        <td>
                            <button class="btn btn-sm btn-success" onclick="openLabResultForm(${test.id})">
                                ğŸ“ Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªÙŠØ¬Ø©
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            container.innerHTML = html;
            updateLabStats();
        }

        function openLabResultForm(testId) {
            const test = labRequests.find(l => l.id === testId);
            if (!test) return;
            
            currentLabTest = test;
            
            document.getElementById('labResultPatient').value = test.patientName;
            document.getElementById('labResultTest').value = test.name;
            document.getElementById('labResultForm').classList.remove('hidden-section');
        }

        function refreshPharmacyQueue() {
            const container = document.getElementById('pharmacyQueue');
            const pendingRx = pharmOrders.filter(r => r.status === 'pending');
            
            if (pendingRx.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-muted p-3">
                        <p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ´ØªØ§Øª ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</p>
                        <small>Ø³ÙŠØ¸Ù‡Ø± Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ù‡Ù†Ø§ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</small>
                    </div>
                `;
                return;
            }
            
            let html = '';
            pendingRx.forEach(rx => {
                const timeAgo = getTimeAgo(rx.createdAt);
                html += `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <h6 class="card-title">${rx.patientName} (${rx.patientAge} Ø³Ù†Ø©)</h6>
                                    <p class="card-text"><small>${rx.rxText}</small></p>
                                    <small class="text-muted">Ø¨ÙˆØ§Ø³Ø·Ø©: ${rx.doctor} â€¢ ${timeAgo}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-success" onclick="dispenseRx(${rx.id})">
                                        ğŸ’Š ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡
                                    </button>
                                </div>
                            </div>
                            <div class="mt-2">
                                <strong>Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:</strong>
                                <div class="mt-1">
                                    ${rx.medications.map(med => 
                                        `<span class="badge bg-light text-dark me-1">${med.name}</span>`
                                    ).join('')}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ø§Ù…Ø©
        // ============================================

        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 60) {
                return `Ù‚Ø¨Ù„ ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
            } else if (diffMins < 1440) {
                return `Ù‚Ø¨Ù„ ${Math.floor(diffMins / 60)} Ø³Ø§Ø¹Ø©`;
            } else {
                return `Ù‚Ø¨Ù„ ${Math.floor(diffMins / 1440)} ÙŠÙˆÙ…`;
            }
        }

        function showNotification(title, message) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Notification API Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/822/822118.png'
                });
            }
            
            // ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡
            try {
                document.getElementById('notificationSound').play();
            } catch (e) {
                console.log("ØªØ¹Ø°Ø± ØªØ´ØºÙŠÙ„ ØµÙˆØª Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡");
            }
            
            // Ø¹Ø±Ø¶ ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©
            console.log(`ğŸ”” ${title}: ${message}`);
        }

        function updateBadges() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨
            const waitingPatients = patients.filter(p => p.department === 'reception' || p.department === 'doctor').length;
            const doctorBadge = document.getElementById('doctorBadge');
            if (waitingPatients > 0) {
                doctorBadge.textContent = waitingPatients;
                doctorBadge.classList.remove('hidden-section');
            } else {
                doctorBadge.classList.add('hidden-section');
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„
            const pendingTests = labRequests.filter(l => l.status === 'pending').length;
            const labBadge = document.getElementById('labBadge');
            if (pendingTests > 0) {
                labBadge.textContent = pendingTests;
                labBadge.classList.remove('hidden-section');
            } else {
                labBadge.classList.add('hidden-section');
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙÙŠ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©
            const pendingRx = pharmOrders.filter(r => r.status === 'pending').length;
            const pharBadge = document.getElementById('pharBadge');
            if (pendingRx > 0) {
                pharBadge.textContent = pendingRx;
                pharBadge.classList.remove('hidden-section');
            } else {
                pharBadge.classList.add('hidden-section');
            }
        }

        function updateLabStats() {
            const pendingTests = labRequests.filter(l => l.status === 'pending').length;
            const completedTests = labRequests.filter(l => l.status === 'completed').length;
            const todayTests = labRequests.filter(l => {
                const today = new Date().toDateString();
                const testDate = new Date(l.requestedAt).toDateString();
                return today === testDate;
            }).length;
            
            const totalRevenue = labRequests.reduce((sum, test) => sum + test.price, 0);
            
            document.getElementById('pendingTests').textContent = pendingTests;
            document.getElementById('completedTests').textContent = completedTests;
            document.getElementById('todayTests').textContent = todayTests;
            document.getElementById('totalLabRevenue').textContent = totalRevenue;
        }

        function loadPatientLabResults(patientId) {
            const patient = patients.find(p => p.id === patientId);
            const container = document.getElementById('patientSpecificLabResults');
            
            if (!patient || !patient.labResults || patient.labResults.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info">
                        Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ ÙØ­ÙˆØµØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶
                    </div>
                `;
                return;
            }
            
            let html = '';
            patient.labResults.forEach(result => {
                const date = new Date(result.date).toLocaleDateString('ar-EG');
                html += `
                    <div class="lab-result-item">
                        <div class="d-flex justify-content-between">
                            <strong>${result.testName}</strong>
                            <small class="text-muted">${date}</small>
                        </div>
                        <div class="mt-1">${result.result}</div>
                        ${result.notes ? `<small class="text-muted">Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${result.notes}</small>` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        // ============================================

        function initData() {
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹
            if (inventory.length === 0) {
                inventory = [
                    {id: 1, name: "Amoxicillin", cost: 300, sale: 500, qty: 50, category: "Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ©"},
                    {id: 2, name: "Paracetamol", cost: 100, sale: 200, qty: 100, category: "Ù…Ø³ÙƒÙ†Ø§Øª"},
                    {id: 3, name: "Vitamin C", cost: 150, sale: 300, qty: 80, category: "ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª"},
                    {id: 4, name: "Ibuprofen", cost: 200, sale: 400, qty: 60, category: "Ù…Ø³ÙƒÙ†Ø§Øª"},
                    {id: 5, name: "Insulin", cost: 800, sale: 1200, qty: 15, category: "Ù‡Ø±Ù…ÙˆÙ†Ø§Øª"},
                    {id: 6, name: "Syringe 5ml", cost: 50, sale: 100, qty: 200, category: "Ø£Ø¯ÙˆØ§Øª Ø·Ø¨ÙŠØ©"}
                ];
                localStorage.setItem('shifa_inv', JSON.stringify(inventory));
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª
            if (labTests.length === 0) {
                labTests = [
                    {name: "BFFM", price: 3000}, {name: "Widal for entrica", price: 4000}, 
                    {name: "Brucella test", price: 4000}, {name: "H. pylori Ag", price: 4000},
                    {name: "ASO", price: 5000}, {name: "U. G", price: 3000},
                    {name: "S.G", price: 3000}, {name: "RFT(U&C)", price: 10000},
                    {name: "S.uric acid", price: 5000}, {name: "ESR", price: 4000},
                    {name: "RF(rheumatoid factor)", price: 5000}, {name: "TWBCS", price: 3000}
                ];
                localStorage.setItem('shifa_tests', JSON.stringify(labTests));
            }
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ø¨Ø­Ø«
            updateMedSearchList();
            
            // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª ÙÙŠ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
            updateLabTestsChecklist();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Øª
            updateBadges();
        }

        function updateMedSearchList() {
            const datalist = document.getElementById('stockMeds');
            datalist.innerHTML = inventory.map(item => 
                `<option value="${item.name}">${item.name} (${item.qty} Ù…ØªÙˆÙØ±)</option>`
            ).join('');
        }

        function updateLabTestsChecklist() {
            const container = document.getElementById('labTestsChecklist');
            container.innerHTML = labTests.map(test => `
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" 
                           data-name="${test.name}" data-price="${test.price}">
                    <label class="form-check-label">
                        ${test.name} - ${test.price} Ø¬Ù†ÙŠØ©
                    </label>
                </div>
            `).join('');
        }

        function selectAllLabTests() {
            const checkboxes = document.querySelectorAll('#labTestsChecklist input[type="checkbox"]');
            checkboxes.forEach(cb => cb.checked = true);
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙ‡ÙŠØ¦Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        // ============================================

        window.onload = function() {
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            initData();
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø©
            updateClock();
            setInterval(updateClock, 1000);
            
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹
            if (currentUser) {
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ø£ÙˆÙ„
                switchSection('reception');
            }
        };

        function updateClock() {
            const now = new Date();
            document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('ar-EG');
        }

        function switchSection(id) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            document.querySelectorAll('.section-pane').forEach(s => s.classList.add('hidden-section'));
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            document.getElementById(`${id}-sec`).classList.remove('hidden-section');
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø´Ø·Ø©
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`btn-${id}`)?.classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø³Ù…
            if (id === 'reception') {
                loadReceptionStats();
                loadPatientRecords();
            } else if (id === 'doctor') {
                refreshDoctorPatientList();
            } else if (id === 'lab') {
                refreshLabWorkTable();
            } else if (id === 'pharmacy') {
                refreshPharmacyQueue();
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Øª
            updateBadges();
        }

        function loadReceptionStats() {
            const today = new Date().toDateString();
            const todayPatients = patients.filter(p => 
                new Date(p.createdAt).toDateString() === today
            );
            
            const newPatients = patients.filter(p => p.visitType === 'Ø²ÙŠØ§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©');
            const returnPatients = patients.filter(p => p.visitType === 'Ù…Ø±Ø§Ø¬Ø¹Ø©' || p.visitType === 'Ù…ØªØ§Ø¨Ø¹Ø©');
            
            document.getElementById('todayPatients').textContent = todayPatients.length;
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('newPatients').textContent = newPatients.length;
            document.getElementById('returnPatients').textContent = returnPatients.length;
        }

        function loadPatientRecords() {
            const container = document.getElementById('patientRecordsList');
            const recentPatients = patients.slice(-10).reverse();
            
            if (recentPatients.length === 0) {
                container.innerHTML = '<div class="text-muted text-center p-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø±Ø¶Ù‰</div>';
                return;
            }
            
            let html = '';
            recentPatients.forEach(patient => {
                const date = new Date(patient.createdAt).toLocaleDateString('ar-EG');
                html += `
                    <div class="border-bottom pb-2 mb-2">
                        <div class="d-flex justify-content-between">
                            <strong>${patient.name}</strong>
                            <small class="text-muted">${date}</small>
                        </div>
                        <small>${patient.age} Ø³Ù†Ø© â€¢ ${patient.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        function showDocSubSection(sub) {
            ['rx', 'lab', 'results', 'nursing'].forEach(s => {
                document.getElementById(`doc-sub-${s}`).classList.add('hidden-section');
            });
            document.getElementById(`doc-sub-${sub}`).classList.remove('hidden-section');
            
            if (sub === 'lab') {
                updateLabTestsChecklist();
            } else if (sub === 'results' && selectedPatientId) {
                loadPatientLabResults(selectedPatientId);
            }
        }

        function logout() {
            localStorage.removeItem('shifa_user');
            location.reload();
        }

        function handleLogin() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            // Ù…ØµØ§Ø¯Ù‚Ø© Ø¨Ø³ÙŠØ·Ø© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
            if (username === 'admin' && password === '123') {
                currentUser = { u: 'admin', r: 'admin', name: 'Ø§Ù„Ù…Ø¯ÙŠØ±' };
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                switchSection('reception');
                showNotification("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ", "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!");
            } else if (username === 'doctor' && password === 'doc123') {
                currentUser = { u: 'doctor', r: 'doctor', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¨' };
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                switchSection('doctor');
                showNotification("Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¯ÙƒØªÙˆØ±", "Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰!");
            } else if (username === 'lab' && password === 'lab123') {
                currentUser = { u: 'lab', r: 'lab_tech', name: 'ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„' };
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                switchSection('lab');
                showNotification("Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙ†ÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„", "Ø¬Ø§Ù‡Ø² Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„ÙØ­ÙˆØµØ§Øª!");
            } else if (username === 'pharmacy' && password === 'ph123') {
                currentUser = { u: 'pharmacy', r: 'pharmacist', name: 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠ' };
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                switchSection('pharmacy');
                showNotification("Ù…Ø±Ø­Ø¨Ø§Ù‹ ØµÙŠØ¯Ù„ÙŠ", "Ø¬Ø§Ù‡Ø² Ù„ØµØ±Ù Ø§Ù„Ø£Ø¯ÙˆÙŠØ©!");
            } else if (username === 'reception' && password === 'rec123') {
                currentUser = { u: 'reception', r: 'reception', name: 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' };
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.u}`;
                
                switchSection('reception');
                showNotification("Ù…Ø±Ø­Ø¨Ø§Ù‹ ÙÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„", "Ø¬Ø§Ù‡Ø² Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰!");
            } else {
                alert("âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
            }
        }

        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø£Ø®Ø±Ù‰
        function searchPatients(query) {
            const container = document.getElementById('doctorPatientList');
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                p.phone.includes(query)
            );
            
            let html = '';
            filtered.forEach(patient => {
                html += `
                    <div class="patient-btn" onclick="selectPatient(${patient.id})">
                        <strong>${patient.name}</strong> (${patient.age} Ø³Ù†Ø©)<br>
                        <small>${patient.phone || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù…'}</small>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<div class="text-muted text-center p-3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
        }

        function filterStock(query) {
            const filtered = inventory.filter(i => 
                i.name.toLowerCase().includes(query.toLowerCase())
            );
            
            const datalist = document.getElementById('stockMeds');
            datalist.innerHTML = filtered.map(item => 
                `<option value="${item.name}">${item.name} (${item.qty} Ù…ØªÙˆÙØ±)</option>`
            ).join('');
        }

        function addNursingOrder() {
            const procedure = document.getElementById('nursingProcedure').value;
            const frequency = document.getElementById('nursingFrequency').value;
            
            if (!procedure) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¬Ø±Ø§Ø¡ ØªÙ…Ø±ÙŠØ¶ÙŠ!");
                return;
            }
            
            const order = {
                id: Date.now(),
                procedure: procedure,
                frequency: frequency || 'Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©',
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            currentNursingOrders.push(order);
            
            const container = document.getElementById('nursingOrdersList');
            container.innerHTML += `
                <div class="alert alert-light border">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${procedure}</strong><br>
                            <small>Ø§Ù„ØªÙƒØ±Ø§Ø±: ${order.frequency}</small>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removeNursingOrder(${order.id})">âœ•</button>
                    </div>
                </div>
            `;
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('nursingProcedure').value = '';
            document.getElementById('nursingFrequency').value = '';
        }

        function removeNursingOrder(orderId) {
            const index = currentNursingOrders.findIndex(o => o.id === orderId);
            if (index !== -1) {
                currentNursingOrders.splice(index, 1);
                // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
                const container = document.getElementById('nursingOrdersList');
                container.innerHTML = currentNursingOrders.map(order => `
                    <div class="alert alert-light border">
                        <div class="d-flex justify-content-between">
                            <div>
                                <strong>${order.procedure}</strong><br>
                                <small>Ø§Ù„ØªÙƒØ±Ø§Ø±: ${order.frequency}</small>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="removeNursingOrder(${order.id})">âœ•</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function addNursingOrders() {
            if (!selectedPatientId) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            
            if (currentNursingOrders.length === 0) {
                alert("âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø£ÙˆØ§Ù…Ø± ØªÙ…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹!");
                return;
            }
            
            const patient = patients.find(p => p.id === selectedPatientId);
            if (patient) {
                patient.nursingOrders = patient.nursingOrders || [];
                patient.nursingOrders = patient.nursingOrders.concat(currentNursingOrders);
                localStorage.setItem('shifa_pats', JSON.stringify(patients));
                
                alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© ${currentNursingOrders.length} Ø£Ù…Ø± ØªÙ…Ø±ÙŠØ¶ÙŠ Ù„Ù„Ù…Ø±ÙŠØ¶`);
                currentNursingOrders = [];
                document.getElementById('nursingOrdersList').innerHTML = '';
            }
        }

        function printRx() {
            const patient = patients.find(p => p.id === selectedPatientId);
            if (!patient) return;
            
            const rxText = document.getElementById('finalRx').value;
            if (!rxText) {
                alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ´ØªØ© Ù„Ù„Ø·Ø¨Ø§Ø¹Ø©!");
                return;
            }
            
            const printContent = `
                <h3>ğŸ’Š Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©</h3>
                <p><strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patient.name}</p>
                <p><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${patient.age} Ø³Ù†Ø©</p>
                <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                <hr>
                <div style="white-space: pre-line; font-size: 18px;">${rxText}</div>
                <hr>
                <p>ğŸ‘¨â€âš•ï¸ ${currentUser ? currentUser.name : 'Ø§Ù„Ø·Ø¨ÙŠØ¨'}</p>
                <p>ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø¬Ù„Ù‚Ù†ÙŠ</p>
            `;
            
            document.getElementById('printContent').innerHTML = printContent;
            document.getElementById('printTitle').textContent = 'Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©';
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-EG');
            
            window.print();
        }

        // ============================================
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        // ============================================

        initData();

    </script>
    
    <!-- Service Worker Script -->
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('service-worker.js').then(function(registration) {
                console.log('Service Worker registered with scope:', registration.scope);
            }).catch(function(error) {
                console.log('Service Worker registration failed:', error);
            });
        }
    </script>
</body>
</html>
