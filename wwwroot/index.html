<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø£Ù„ØªÙŠÙ…ÙŠØª</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #f0fdf4; --danger-color: #c53030; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, sans-serif; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); border-radius: 12px !important; margin: 0 5px; padding: 10px 20px; }
        .nav-link.active { background-color: var(--primary-color) !important; color: white !important; }
        .stat-badge { font-size: 1.2rem; padding: 20px; border-radius: 15px; color: white; text-align: center; }
        .low-stock { background-color: #fff5f5 !important; color: var(--danger-color) !important; font-weight: bold; border: 1px solid var(--danger-color); animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @media print { .no-print { display: none !important; } #printArea { display: block !important; } }
        .rx-symbol { font-size: 3rem; color: var(--primary-color); font-weight: bold; }
        #rxCounter { background: var(--danger-color); color: white; border-radius: 50%; padding: 2px 8px; font-size: 0.8rem; }
    </style>
</head>
<body>

    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f0fdf4 0%, #e6fffa 100%); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg" style="width: 400px; border-top: 8px solid var(--primary-color);">
            <div class="text-center mb-4">
                <h3 class="fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted">Ø¬Ù„Ù‚Ù†ÙŠ - ÙˆÙ„Ø§ÙŠØ© Ø³Ù†Ø§Ø±</p>
            </div>
            <input type="text" id="username" class="form-control mb-3" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="password" class="form-control mb-4" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button class="btn btn-primary w-100 fw-bold py-2" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div id="mainContent" class="hidden-section">
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between">
                <span class="navbar-brand fw-bold fs-4">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</span>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
        </nav>

        <div class="container">
            <ul class="nav nav-pills mb-4 no-print shadow-sm p-2 bg-white rounded-pill justify-content-center">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">Ø§Ù„Ù…Ø¹Ù…Ù„</button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button></li>
            </ul>

            <div class="tab-content no-print">
                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4">
                                <h5 class="text-primary fw-bold mb-3">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©</h5>
                                <div class="p-3 bg-light rounded mb-3 border">
                                    <div class="row g-2">
                                        <div class="col-md-6"><input list="stockMeds" id="medSearch" class="form-control" placeholder="Ø¨Ø­Ø« Ø¯ÙˆØ§Ø¡..." onkeyup="filterMeds(this.value)"><datalist id="stockMeds"></datalist></div>
                                        <div class="col-md-3"><input type="text" id="medDose" class="form-control" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø©"></div>
                                        <div class="col-md-3"><button class="btn btn-primary w-100" onclick="addMedToRx()">â• Ø£Ø¶Ù</button></div>
                                    </div>
                                </div>
                                <textarea id="diagnosis" class="form-control mb-3" rows="6" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ Ù‡Ù†Ø§..."></textarea>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-dark w-50" onclick="printPrescription()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
                                    <button class="btn btn-success w-50" onclick="sendToPharmacy()">ğŸ’Š Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card p-3 shadow-sm border-start border-4 border-success">
                                <h5 class="text-success fw-bold">ğŸ“¥ Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
                                <div id="incomingRxList"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card p-3">
                                <h5 class="text-primary fw-bold">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h5>
                                <div class="input-group mb-2">
                                    <input type="text" id="medName" class="form-control" placeholder="Ø§Ù„Ø¯ÙˆØ§Ø¡">
                                    <input type="number" id="medCost" class="form-control" placeholder="Ø§Ù„ØªÙƒÙ„ÙØ©">
                                    <input type="number" id="medQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                                    <button class="btn btn-primary" onclick="addMed()">Ø¥Ø¶Ø§ÙØ©</button>
                                </div>
                                <table class="table table-sm mt-2">
                                    <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ø¨ÙŠØ¹</th><th>Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</th></tr></thead>
                                    <tbody id="inventoryTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="card p-3">
                        <h5 class="text-danger fw-bold">ğŸ§ª Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­Øµ Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h5>
                        <table class="table">
                            <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„ÙØ­Øµ</th><th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="labTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="admin-sec" class="section-pane hidden-section">
                    <div class="row text-center">
                        <div class="col-md-4"><div class="stat-badge bg-primary">ğŸ¦ Ø¯Ø®Ù„ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©<br><h3 id="clinicInc">0</h3></div></div>
                        <div class="col-md-4"><div class="stat-badge bg-danger">ğŸ§ª Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù…Ù„<br><h3 id="labInc">0</h3></div></div>
                        <div class="col-md-4"><div class="stat-badge bg-success">ğŸ’Š Ø¯Ø®Ù„ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©<br><h3 id="pharmacyInc">0.00</h3></div></div>
                    </div>
                    <div class="card p-3 mt-4">
                        <h6>ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø·Ø§Ù‚Ù… Ø§Ù„Ø¹Ù…Ù„</h6>
                        <table class="table">
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" style="display:none; padding: 40px; direction: rtl; border: 5px solid #2c7a7b;">
        <div style="text-align: center;">
            <h2>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø¬Ù„Ù‚Ù†ÙŠ</h2>
            <hr>
            <div class="rx-symbol">Rx</div>
            <div id="printContent" style="font-size: 1.5rem; min-height: 400px; text-align: right;"></div>
            <hr>
            <p>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¨: ....................</p>
        </div>
    </div>

    <script>
        const PROXY = "https://corsproxy.io/?";
        const API_URL = "http://alshifaclinic.somee.com/api.aspx";
        const API_BASE = PROXY + encodeURIComponent(API_URL);

        let systemUsers = JSON.parse(localStorage.getItem('shifaUsers')) || {
            "admin": { pass: "123", role: "admin" },
            "doctor": { pass: "doc123", role: "doctor" }
        };
        let inventory = JSON.parse(localStorage.getItem('shifaInv')) || [];
        let pendingRx = JSON.parse(localStorage.getItem('pendingRx')) || [];
        let financials = JSON.parse(localStorage.getItem('shifaFin')) || { clinic: 0, lab: 0, pharmacy: 0 };

        function handleLogin() {
            const u = document.getElementById('username').value.toLowerCase().trim();
            const p = document.getElementById('password').value;
            if (systemUsers[u] && systemUsers[u].pass === p) {
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                setupPermissions(systemUsers[u].role);
            } else { alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø®Ø§Ø·Ø¦Ø©!"); }
        }

        function setupPermissions(role) {
            document.querySelectorAll('.nav-item').forEach(li => li.classList.add('hidden-section'));
            if (role === 'admin') {
                document.querySelectorAll('.nav-item').forEach(li => li.classList.remove('hidden-section'));
                switchSection('admin'); 
            } else {
                document.getElementById(`tab-${role}-li`).classList.remove('hidden-section');
                switchSection(role);
            }
            refreshUI();
        }

        function switchSection(id) {
            document.querySelectorAll('.section-pane').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(`${id}-sec`).classList.remove('hidden-section');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`btn-${id}`)?.classList.add('active');
        }

        // --- Ø§Ù„Ø·Ø¨ÙŠØ¨ ---
        function filterMeds(val) {
            document.getElementById('stockMeds').innerHTML = inventory
                .filter(m => m.name.toLowerCase().includes(val.toLowerCase()))
                .map(m => `<option value="${m.name}"> Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: ${m.qty}</option>`).join('');
        }

        function addMedToRx() {
            const m = document.getElementById('medSearch').value;
            const d = document.getElementById('medDose').value;
            if(m) {
                document.getElementById('diagnosis').value += `- ${m} (${d})\n`;
                document.getElementById('medSearch').value = '';
            }
        }

        function printPrescription() {
            document.getElementById('printContent').innerText = document.getElementById('diagnosis').value;
            window.print();
        }

        async function sendToPharmacy() {
            const rx = document.getElementById('diagnosis').value;
            if(!rx) return;
            pendingRx.push({ rx, date: new Date().toLocaleTimeString() });
            localStorage.setItem('pendingRx', JSON.stringify(pendingRx));
            alert("ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ âœ…");
            document.getElementById('diagnosis').value = "";
            refreshUI();
        }

        // --- Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© ---
        function addMed() {
            const name = document.getElementById('medName').value;
            const cost = parseFloat(document.getElementById('medCost').value);
            const qty = parseInt(document.getElementById('medQty').value);
            if(name && cost) {
                inventory.push({ name, cost, sale: cost * 1.5, qty });
                localStorage.setItem('shifaInv', JSON.stringify(inventory));
                refreshUI();
            }
        }

        function dispense(idx) {
            financials.pharmacy += 1000; // Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ØµØ±Ù
            localStorage.setItem('shifaFin', JSON.stringify(financials));
            pendingRx.splice(idx, 1);
            localStorage.setItem('pendingRx', JSON.stringify(pendingRx));
            refreshUI();
        }

        function refreshUI() {
            // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†ØŒ Ø§Ù„Ø±ÙˆØ´ØªØ§ØªØŒ ÙˆØ§Ù„Ù…Ø§Ù„ÙŠØ©
            document.getElementById('inventoryTable').innerHTML = inventory.map(i => `
                <tr class="${i.qty <= 5 ? 'low-stock' : ''}"><td>${i.name}</td><td>${i.sale.toFixed(2)}</td><td>${i.qty}</td></tr>`).join('');
            
            document.getElementById('incomingRxList').innerHTML = pendingRx.map((r, idx) => `
                <div class="alert alert-info small">${r.rx}<br><button class="btn btn-sm btn-success" onclick="dispense(${idx})">ØªÙ… Ø§Ù„ØµØ±Ù</button></div>`).join('');

            document.getElementById('clinicInc').innerText = financials.clinic;
            document.getElementById('pharmacyInc').innerText = financials.pharmacy.toFixed(2);
            
            document.getElementById('usersTableBody').innerHTML = Object.keys(systemUsers).map(u => `
                <tr><td>${u}</td><td>${systemUsers[u].role}</td><td><button class="btn btn-sm text-danger" onclick="delete systemUsers['${u}']; refreshUI()">âŒ</button></td></tr>`).join('');
        }
    </script>
</body>
</html>
