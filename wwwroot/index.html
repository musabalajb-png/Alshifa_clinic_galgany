<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822118.png">
    
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22%D9%85%D8%AC%D9%85%D8%B9%20%D8%A7%D9%84%D8%B4%D9%81%D8%A7%D8%A1%22,%22short_name%22:%22%D8%A7%D9%84%D8%B4%D9%81%D8%A1%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f8fafc%22,%22theme_color%22:%22%232c7a7b%22,%22description%22:%22%D9%86%D8%B8%D8%A7%D9%85%20%D8%A5%D8%AF%D8%A7%D8%B1%D8%A9%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B4%D9%81%D9%8A%D8%A7%D8%AA%20%D9%88%D8%A7%D9%84%D8%B9%D9%8A%D8%A7%D8%AF%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B0%D9%83%D9%8A%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%22},{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22,%22purpose%22:%22maskable%22}]}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --primary-color: #2c7a7b; 
            --secondary-color: #f0fdf4; 
            --accent-blue: #0d6efd; 
            --accent-red: #dc3545; 
            --accent-green: #198754; 
            --accent-gold: #d4af37;
            --accent-warning: #ffc107;
            --accent-info: #17a2b8;
            --accent-purple: #6f42c1;
        }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .navbar { background: linear-gradient(135deg, var(--primary-color), #1f5a5a) !important; box-shadow: 0 2px 15px rgba(0,0,0,0.2); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); padding: 10px 20px !important; position: relative; }
        .nav-link.active { background-color: var(--accent-blue) !important; color: white !important; border-radius: 10px; }
        .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border-radius: 50%; padding: 3px 7px; font-size: 0.7rem; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; text-align: center; }
        .patient-btn { text-align: right; margin-bottom: 8px; border-right: 5px solid var(--primary-color); width: 100%; transition: 0.3s; padding: 12px 15px; background: white; border: 1px solid #dee2e6; border-radius: 10px; }
        .patient-btn.ready { border-right-color: #28a745; background-color: #f0fff4; }
        .patient-btn:hover { background-color: #f8f9fa; }
        .lab-result-item { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 4px solid var(--accent-blue); }
        .section-pane { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; padding: 20px; } }
        .search-box { position: relative; }
        .search-box input { padding-right: 40px; }
        .rx-item { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 8px; border-left: 4px solid var(--accent-green); }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        .sync-status { position: fixed; bottom: 10px; left: 10px; z-index: 1000; }
        .sync-btn { position: fixed; bottom: 10px; right: 10px; z-index: 1000; }
        .medical-record { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .nursing-schedule { border-left: 5px solid var(--accent-purple); }
        .expiry-warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .stock-critical { background: #f8d7da; border-left: 5px solid #dc3545; }
        .library-card { height: 100%; transition: all 0.3s; }
        .library-card:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .form-check { padding-right: 1.5em; margin-bottom: 0.5rem; }
        .form-check-input { margin-right: -1.5em; }
        #labTestsChecklist { scrollbar-width: thin; scrollbar-color: var(--primary-color) #f1f1f1; }
        #labTestsChecklist::-webkit-scrollbar { width: 8px; }
        #labTestsChecklist::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #labTestsChecklist::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        
        /* PWA Styles */
        .install-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50px; padding: 10px 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        .install-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .pwa-status { position: fixed; top: 10px; left: 10px; z-index: 9999; }
        .pwa-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 20px; z-index: 10000; max-width: 400px; direction: rtl; }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; text-align: center; padding: 10px; z-index: 9998; }
        .online-banner { position: fixed; top: 0; left: 0; right: 0; background: #28a745; color: white; text-align: center; padding: 10px; z-index: 9998; }
        #appVersion { font-size: 0.8em; color: #6c757d; }
        
        /* Advanced Permissions Styles */
        .permission-badge { font-size: 0.7em; padding: 2px 6px; margin-right: 3px; }
        .permission-row { border-bottom: 1px solid #eee; padding: 8px 0; }
        .permission-header { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 10px; border-radius: 8px; }
        .permission-toggle { transform: scale(0.9); }
        .user-status-online { color: #28a745; animation: pulse 2s infinite; }
        .user-status-offline { color: #dc3545; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .role-badge { font-size: 0.75em; padding: 3px 8px; }
        .permission-modal { max-height: 80vh; overflow-y: auto; }
        .password-strength { height: 5px; border-radius: 2px; margin-top: 5px; transition: all 0.3s; }
        
        /* New Styles for Workflow */
        .workflow-step { border-left: 4px solid; padding: 10px; margin: 5px 0; border-radius: 8px; }
        .step-reception { border-color: #0d6efd; background: #e7f1ff; }
        .step-doctor { border-color: #198754; background: #e8f5e8; }
        .step-lab { border-color: #dc3545; background: #fde8e8; }
        .step-pharmacy { border-color: #ffc107; background: #fff8e1; }
        .step-nursing { border-color: #6f42c1; background: #f0e8ff; }
        .step-completed { background: #d4edda !important; }
        .patient-flow { display: flex; justify-content: space-between; margin: 10px 0; }
        .flow-arrow { color: #6c757d; margin: 0 10px; }
        
        /* Admin Dashboard Styles */
        .admin-stat-card { border-radius: 12px; padding: 15px; color: white; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .admin-chart-container { height: 300px; position: relative; }
        .quick-action-btn { width: 100%; margin: 5px 0; }
        .system-health { font-size: 0.9em; }
        .health-good { color: #28a745; }
        .health-warning { color: #ffc107; }
        .health-critical { color: #dc3545; }
        .transaction-item { border-left: 4px solid; padding: 8px; margin: 5px 0; border-radius: 6px; }
        .transaction-income { border-color: #28a745; background: #d4edda; }
        .transaction-expense { border-color: #dc3545; background: #f8d7da; }
        .staff-avatar { width: 40px; height: 40px; border-radius: 50%; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* New Styles from Version 2 */
        .bg-medical { background: #eef2f3; border-right: 5px solid var(--primary-color); }
        .border-purple { border-color: var(--accent-purple) !important; }
        .btn-outline-purple { color: var(--accent-purple); border-color: var(--accent-purple); }
        .btn-outline-purple:hover { background-color: var(--accent-purple); color: white; }
        
        /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        .security-warning {
            border-left: 5px solid #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .access-log {
            font-size: 0.8em;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 5px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printArea" class="hidden-section">
        <div class="text-center border-bottom pb-3 mb-3">
            <h2 style="color: var(--primary-color);">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h2>
            <p>Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø¬Ù„Ù‚Ù†ÙŠ</p>
            <h5 id="printTitle">Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ© / ÙØ§ØªÙˆØ±Ø©</h5>
            <small id="printDate"></small>
        </div>
        <div id="printContent" class="fs-5"></div>
        <div class="mt-5 pt-3 border-top text-center"><p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¹Ø§Ø¬Ù„ Ø§Ù„Ø´ÙØ§Ø¡</p></div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginOverlay" class="no-print" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(44, 122, 123, 0.9), rgba(44, 122, 123, 0.8)); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg animate__animated animate__zoomIn" style="width: 420px; border-top: 8px solid var(--accent-gold);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="70">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted small">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠØ©</p>
                <div class="alert alert-info mt-2">
                    <small>ğŸ”’ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ ÙÙ‚Ø·</small>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="username" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
            </div>
            
            <div class="mb-3">
                <select id="loginDept" class="form-select" onchange="updateLoginPlaceholder()">
                    <option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                    <option value="admin">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</option>
                    <option value="reception">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                    <option value="doctor">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</option>
                    <option value="lab">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                    <option value="pharmacy">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                    <option value="nursing">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                </select>
            </div>
            
            <button class="btn btn-primary w-100 fw-bold py-2 mb-3" onclick="handleLogin()">
                ğŸš€ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
            </button>
            
            <div class="security-warning">
                <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ø§Ù†:</strong>
                <small class="d-block mt-1">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­ØµØ±ÙŠ Ù„Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³Ø©. Ø¹Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„.</small>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-secondary" onclick="showRecoveryOptions()">
                    <small>â“ Ù†Ø³ÙŠØª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ</small>
                </button>
                <button class="btn btn-sm btn-outline-info ms-2" onclick="showEmergencyAccess()" id="emergencyBtn" style="display: none;">
                    <small>ğŸš¨ ÙˆØµÙˆÙ„ Ø·Ø§Ø±Ø¦</small>
                </button>
            </div>
            
            <div class="access-log text-center mt-2">
                <small>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: <span id="lastLoginTime">--</span></small>
            </div>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦ -->
    <div id="emergencyAccessOverlay" class="admin-login-overlay">
        <div class="card p-4 shadow-lg animate__animated animate__zoomIn" style="width: 400px; border-top: 8px solid var(--accent-red);">
            <div class="text-center mb-4">
                <h4 class="fw-bold text-danger">ğŸš¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦</h4>
                <p class="text-muted small">Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø·Ø§Ø±Ø¦Ø© ÙÙ‚Ø·</p>
            </div>
            
            <div class="alert alert-warning mb-3">
                <small>âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø³Ø¬Ù„ ÙˆÙ…Ø±Ø§Ù‚Ø¨. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¶Ø±ÙˆØ±ÙŠØ© ÙÙ‚Ø·.</small>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø³Ø±ÙŠ Ø§Ù„Ø·Ø§Ø±Ø¦</label>
                <input type="password" id="emergencyCode" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ø³Ø¨Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦</label>
                <select id="emergencyReason" class="form-select">
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø³Ø¨Ø¨</option>
                    <option value="system_recovery">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø¸Ø§Ù…</option>
                    <option value="password_reset">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</option>
                    <option value="technical_support">Ø¯Ø¹Ù… ÙÙ†ÙŠ</option>
                    <option value="emergency_access">ÙˆØµÙˆÙ„ Ø·Ø§Ø±Ø¦ Ù„Ù„Ù…Ø±ÙŠØ¶</option>
                </select>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©</label>
                <textarea id="emergencyNotes" class="form-control" rows="2" placeholder="Ø§Ø°ÙƒØ± Ø³Ø¨Ø¨ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦..."></textarea>
            </div>
            
            <button class="btn btn-danger w-100 fw-bold mb-2" onclick="verifyEmergencyAccess()">
                ğŸ”“ ØªÙ†ÙÙŠØ° Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦
            </button>
            <button class="btn btn-outline-secondary w-100" onclick="hideEmergencyAccess()">
                Ø¥Ù„ØºØ§Ø¡
            </button>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
    <div id="recoveryOverlay" class="admin-login-overlay">
        <div class="card p-4 shadow-lg animate__animated animate__zoomIn" style="width: 400px; border-top: 8px solid var(--accent-info);">
            <div class="text-center mb-4">
                <h4 class="fw-bold text-info">ğŸ”§ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</h4>
                <p class="text-muted small">ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø©</p>
            </div>
            
            <div class="alert alert-info mb-3">
                <small>ğŸ“ ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù…Ø¯ÙŠØ± Ø£Ùˆ Ù‚Ø³Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„.</small>
            </div>
            
            <div class="mb-3">
                <h6>ğŸ“‹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„:</h6>
                <ul class="list-unstyled">
                    <li>ğŸ“ Ù‡Ø§ØªÙ Ø§Ù„Ø¯Ø¹Ù…: <strong>+249 123 456 789</strong></li>
                    <li>ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <strong>support@shifaclinic.sd</strong></li>
                    <li>ğŸ‘¤ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„: <strong>Ø£Ø­Ù…Ø¯ Ù…Ø­Ù…Ø¯</strong></li>
                </ul>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„Ù…ÙˆØ¸Ù</label>
                <input type="text" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡ÙˆÙŠØªÙƒ">
            </div>
            
            <div class="mb-3">
                <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø§Ù„Ù…Ø³Ø¬Ù„</label>
                <input type="tel" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ">
            </div>
            
            <button class="btn btn-info w-100 fw-bold mb-2" onclick="submitRecoveryRequest()">
                ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©
            </button>
            <button class="btn btn-outline-secondary w-100" onclick="hideRecoveryOverlay()">
                Ø±Ø¬ÙˆØ¹
            </button>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainContent" class="hidden-section">
        <!-- PWA Status -->
        <div class="pwa-status no-print">
            <div id="pwaStatus" class="badge bg-info">PWA: Ù†Ø´Ø·</div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="navbar navbar-dark mb-4 no-print py-2">
            <div class="container d-flex justify-content-between text-white align-items-center">
                <span class="navbar-brand fw-bold">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026</span>
                <div class="d-flex align-items-center">
                    <span id="currentUserDisplay" class="badge bg-white text-dark p-2 mx-2"></span>
                    <span id="clockDisplay" class="badge bg-info text-dark mx-2"></span>
                    <span id="connectionStatus" class="badge bg-success mx-2">Ù…ØªØµÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹</span>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="openUserMenu()">ğŸ‘¤</button>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </nav>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="container">
            <ul class="nav nav-pills mb-4 shadow-sm p-2 bg-white rounded-4 justify-content-center no-print" id="mainTabs">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© <span id="doctorBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„ <span id="labBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© <span id="pharBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-nursing-li"><button class="nav-link" id="btn-nursing" onclick="switchSection('nursing')">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶ <span id="nurseBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ±</button></li>
            </ul>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
            <div class="tab-content">
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
                <div id="reception-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card p-4 border-top border-primary border-4">
                                <h5 class="fw-bold mb-3">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
                                <input type="text" id="pName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                                <div class="row g-2 mb-2">
                                    <div class="col-4"><input type="number" id="pAge" class="form-control" placeholder="Ø§Ù„Ø¹Ù…Ø±"></div>
                                    <div class="col-8"><input type="text" id="pAddress" class="form-control" placeholder="Ø§Ù„Ø³ÙƒÙ† / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
                                </div>
                                <div class="bg-light p-2 rounded mb-3">
                                    <label class="small fw-bold">Ø±Ø³ÙˆÙ… ØªØ°ÙƒØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨:</label>
                                    <input type="number" id="pTicket" class="form-control" value="2000">
                                </div>
                                <button class="btn btn-primary w-100 fw-bold" onclick="registerPatient()">âœ… Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø·Ø¨ÙŠØ¨</button>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card p-4">
                                <h5 class="fw-bold mb-3">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…</h5>
                                <div id="receptionList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© -->
                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3">
                                <h6>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙƒØ´Ù</h6>
                                <div id="doctorQueue"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="doctorWorkArea" class="card p-4 hidden-section border-top border-success border-5">
                                <h4 id="currentPatientName" class="text-success fw-bold"></h4>
                                <hr>
                                <label class="fw-bold">Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
                                <textarea id="complaint" class="form-control mb-3" rows="2"></textarea>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="fw-bold small">Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª:</label>
                                        <select id="labSelect" class="form-select mb-2" multiple style="height: 100px;"></select>
                                        <button class="btn btn-sm btn-outline-danger w-100" onclick="orderLab()">ğŸ§ª Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¹Ù…Ù„</button>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="fw-bold small">ÙˆØµÙ Ø§Ù„Ø¯ÙˆØ§Ø¡:</label>
                                        <select id="medicineSelect" class="form-select mb-2" multiple style="height: 100px;"></select>
                                        <button class="btn btn-sm btn-outline-warning w-100" onclick="orderPharmacy()">ğŸ’Š Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©</button>
                                    </div>
                                </div>
                                
                                <div class="mb-3 p-2 bg-light rounded">
                                    <label class="fw-bold small">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªÙ…Ø±ÙŠØ¶ÙŠØ© (Ø­Ù‚Ù†/Ø¯Ø±ÙŠØ¨Ø§Øª):</label>
                                    <input type="text" id="nurseNotes" class="form-control mb-2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª...">
                                    <button class="btn btn-sm btn-outline-purple w-100" onclick="orderNurse()">ğŸ’‰ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ¶</button>
                                </div>
                                <button class="btn btn-success w-100 fw-bold" onclick="completeVisit()">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="card p-4 border-top border-danger border-5">
                        <h5 class="fw-bold">ğŸ§ª Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­Øµ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
                        <div id="labList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <div class="card p-4 border-top border-warning border-5">
                        <h5 class="fw-bold">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h5>
                        <div id="pharmacyList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶ -->
                <div id="nursing-sec" class="section-pane hidden-section">
                    <div class="card p-4 border-top border-purple border-5">
                        <h5 class="fw-bold">ğŸ’‰ ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ¶</h5>
                        <div id="nurseList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± -->
                <div id="admin-sec" class="section-pane hidden-section">
                    <div class="row g-3 mb-4">
                        <div class="col-md-3"><div class="stat-card bg-primary"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h6><h3 id="admIncClinic">0</h3></div></div>
                        <div class="col-md-3"><div class="stat-card bg-danger"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù…Ù„</h6><h3 id="admIncLab">0</h3></div></div>
                        <div class="col-md-3"><div class="stat-card bg-warning"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="admIncPhar">0</h3></div></div>
                        <div class="col-md-3"><div class="stat-card bg-success"><h6>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</h6><h3 id="admIncTotal">0</h3></div></div>
                    </div>

                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3">
                                <h6>â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ­Øµ</h6>
                                <input type="text" id="admLabName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ">
                                <input type="number" id="admLabPrice" class="form-control mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                                <button class="btn btn-danger btn-sm w-100" onclick="adminAddLab()">Ø­ÙØ¸ Ø§Ù„ÙØ­Øµ</button>
                            </div>
                            <div class="card p-3 mt-3">
                                <h6>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                                <input type="text" id="admMedName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
                                <input type="number" id="admMedPrice" class="form-control mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                                <input type="number" id="admMedQty" class="form-control mb-2" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                                <button class="btn btn-warning btn-sm w-100" onclick="adminAddMed()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ø¡</button>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card p-3">
                                <h6>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h6>
                                <div class="btn-group w-100 mb-3">
                                    <button class="btn btn-outline-dark btn-sm" onclick="renderReport('day')">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
                                    <button class="btn btn-outline-dark btn-sm" onclick="renderReport('week')">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                                    <button class="btn btn-outline-dark btn-sm" onclick="renderReport('month')">Ø´Ù‡Ø±ÙŠ</button>
                                </div>
                                <div id="reportArea" class="bg-light p-3 rounded">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø¹Ø±Ø¶...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="changePasswordModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</label>
                        <input type="password" id="currentPassword" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="password" id="newPassword" class="form-control" onkeyup="checkPasswordStrength()">
                        <div class="password-strength" id="passwordStrength"></div>
                        <small class="text-muted">ÙŠØ¬Ø¨ Ø£Ù† ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ØŒ Ø­Ø±ÙˆÙ ÙƒØ¨ÙŠØ±Ø© ÙˆØµØºÙŠØ±Ø©ØŒ ÙˆØ£Ø±Ù‚Ø§Ù…</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                        <input type="password" id="confirmPassword" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" onclick="confirmPasswordChange()">ØªØºÙŠÙŠØ±</button>
                </div>
            </div>
        </div>
    </div>

    <div id="userMenuModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 80px; height: 80px;">
                            <span class="fs-3">ğŸ‘¤</span>
                        </div>
                        <h5 class="mt-2" id="userNameDisplay"></h5>
                        <span class="badge bg-primary" id="userRoleDisplay"></span>
                    </div>
                    <div class="list-group">
                        <button class="list-group-item list-group-item-action" onclick="changePasswordModal()">
                            ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
                        </button>
                        <button class="list-group-item list-group-item-action" onclick="viewMyActivity()">
                            ğŸ“‹ Ø³Ø¬Ù„ Ù†Ø´Ø§Ø·ÙŠ
                        </button>
                        <button class="list-group-item list-group-item-action" onclick="toggleDarkMode()">
                            ğŸŒ™ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ
                        </button>
                        <button class="list-group-item list-group-item-action text-danger" onclick="showSecurityLog()">
                            ğŸ”’ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù†
                        </button>
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-muted" id="lastLoginDisplay"></small>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù† -->
    <div id="securityLogModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">ğŸ”’ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ø£Ù…Ø§Ù†</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="securityLogContent" style="max-height: 400px; overflow-y: auto;"></div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-outline-danger" onclick="clearSecurityLog()">ğŸ—‘ï¸ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„</button>
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============================================
        // Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
        // ============================================

        const USERS = {
            'admin': { password: '123', role: 'admin', name: 'Ø§Ù„Ù…Ø¯ÙŠØ±' },
            'doctor': { password: 'doc123', role: 'doctor', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¨' },
            'reception': { password: 'rec123', role: 'reception', name: 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' },
            'pharmacist': { password: 'ph123', role: 'pharmacy', name: 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠ' },
            'lab': { password: 'lab123', role: 'lab', name: 'Ø§Ù„Ù…Ø¹Ù…Ù„' },
            'nurse': { password: 'nur123', role: 'nursing', name: 'Ø§Ù„ØªÙ…Ø±ÙŠØ¶' }
        };

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
        const SECURITY_SETTINGS = {
            emergencyCode: 'SHIFA2026EMERG',
            maxLoginAttempts: 5,
            lockoutTime: 15, // Ø¯Ù‚Ø§Ø¦Ù‚
            sessionTimeout: 30, // Ø¯Ù‚Ø§Ø¦Ù‚
            enableAuditLog: true
        };

        let currentUser = null;
        let patients = JSON.parse(localStorage.getItem('shifa_pats')) || [];
        let labRequests = JSON.parse(localStorage.getItem('shifa_lab')) || [];
        let pharmOrders = JSON.parse(localStorage.getItem('shifa_rx')) || [];
        let nursingTasks = JSON.parse(localStorage.getItem('shifa_nursing_tasks')) || [];
        let financials = JSON.parse(localStorage.getItem('shifa_fin')) || { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0, total: 0 };
        let staffMembers = JSON.parse(localStorage.getItem('shifa_staff')) || [];
        let medicalLibrary = JSON.parse(localStorage.getItem('shifa_library')) || [];
        let backups = JSON.parse(localStorage.getItem('shifa_backups')) || [];
        let securityLog = JSON.parse(localStorage.getItem('shifa_security_log')) || [];
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©
        let labTests = JSON.parse(localStorage.getItem('shifa_labTests')) || [
            {name: 'CBC', price: 5000},
            {name: 'Malaria', price: 2000},
            {name: 'Glucose', price: 1000},
            {name: 'Cholesterol', price: 3000}
        ];
        
        let inventory = JSON.parse(localStorage.getItem('shifa_inventory')) || [
            {name: 'Panadol', price: 1000, qty: 100},
            {name: 'Antibiotic', price: 2500, qty: 50},
            {name: 'Vitamin C', price: 1500, qty: 75}
        ];

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
        let loginAttempts = JSON.parse(localStorage.getItem('shifa_login_attempts')) || {};
        let lastActivityTime = Date.now();

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„ØªØ­ÙƒÙ…
        // ============================================

        function logSecurityEvent(eventType, details) {
            if (!SECURITY_SETTINGS.enableAuditLog) return;
            
            const event = {
                timestamp: new Date().toISOString(),
                user: currentUser ? currentUser.u : 'system',
                eventType: eventType,
                details: details,
                ip: 'localhost'
            };
            
            securityLog.unshift(event);
            if (securityLog.length > 1000) securityLog = securityLog.slice(0, 1000);
            
            localStorage.setItem('shifa_security_log', JSON.stringify(securityLog));
        }

        function updateLoginPlaceholder() {
            const dept = document.getElementById('loginDept').value;
            const usernameInput = document.getElementById('username');
            
            if (dept) {
                switch(dept) {
                    case 'admin': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin'; break;
                    case 'doctor': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: doctor'; break;
                    case 'reception': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: reception'; break;
                    case 'pharmacy': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: pharmacist'; break;
                    case 'lab': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: lab'; break;
                    case 'nursing': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: nurse'; break;
                }
            } else {
                usernameInput.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            }
        }

        function showRecoveryOptions() {
            document.getElementById('recoveryOverlay').style.display = 'flex';
            logSecurityEvent('RECOVERY_ACCESS', 'Ù…Ø³ØªØ®Ø¯Ù… Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }

        function hideRecoveryOverlay() {
            document.getElementById('recoveryOverlay').style.display = 'none';
        }

        function showEmergencyAccess() {
            document.getElementById('emergencyAccessOverlay').style.display = 'flex';
            logSecurityEvent('EMERGENCY_ACCESS_ATTEMPT', 'Ø¨Ø¯Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© ÙˆØµÙˆÙ„ Ø·Ø§Ø±Ø¦');
        }

        function hideEmergencyAccess() {
            document.getElementById('emergencyAccessOverlay').style.display = 'none';
        }

        function verifyEmergencyAccess() {
            const code = document.getElementById('emergencyCode').value;
            const reason = document.getElementById('emergencyReason').value;
            const notes = document.getElementById('emergencyNotes').value;
            
            if (code === SECURITY_SETTINGS.emergencyCode && reason) {
                // Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦ Ù…Ø³Ù…ÙˆØ­
                logSecurityEvent('EMERGENCY_ACCESS_GRANTED', `Ø§Ù„Ø³Ø¨Ø¨: ${reason}, Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${notes}`);
                
                // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø´ÙƒÙ„ Ù…Ø¤Ù‚Øª
                const emergencyInfo = `
                    <div class="alert alert-success">
                        <h6>ğŸ”“ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦ Ù…ÙØ¹Ù„</h6>
                        <p><strong>Ø§Ù„Ø³Ø¨Ø¨:</strong> ${reason}</p>
                        <p><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${new Date().toLocaleString('ar-EG')}</p>
                    </div>
                    <div class="alert alert-warning">
                        <h6>ğŸ‘¥ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„:</h6>
                        <div class="row">
                            <div class="col-6">
                                <p><small>ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ±: admin</small></p>
                                <p><small>ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨: doctor</small></p>
                                <p><small>ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„: reception</small></p>
                            </div>
                            <div class="col-6">
                                <p><small>ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠ: pharmacist</small></p>
                                <p><small>ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„: lab</small></p>
                                <p><small>ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶: nurse</small></p>
                            </div>
                        </div>
                        <p class="text-danger mt-2"><small>âš ï¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø¤Ù‚ØªØ© ÙˆØ³ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø¯Ø«</small></p>
                    </div>
                `;
                
                document.getElementById('emergencyAccessOverlay').innerHTML = `
                    <div class="card p-4 shadow-lg" style="width: 500px;">
                        ${emergencyInfo}
                        <button class="btn btn-danger w-100" onclick="hideEmergencyAccess()">
                            ğŸ”’ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦
                        </button>
                    </div>
                `;
                
            } else {
                alert('âŒ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø³Ø±ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø³Ø¨Ø¨ ØºÙŠØ± Ù…Ø­Ø¯Ø¯');
                logSecurityEvent('EMERGENCY_ACCESS_DENIED', 'Ø±Ù…Ø² Ø·Ø§Ø±Ø¦ Ø®Ø§Ø·Ø¦');
            }
        }

        function submitRecoveryRequest() {
            alert('ğŸ“© ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©. Ø³ÙŠØªØµÙ„ Ø¨Ùƒ Ø§Ù„Ù…Ø¯ÙŠØ± Ø®Ù„Ø§Ù„ 24 Ø³Ø§Ø¹Ø©.');
            hideRecoveryOverlay();
            logSecurityEvent('RECOVERY_REQUEST', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„');
        }

        function checkLoginAttempts(username) {
            const now = Date.now();
            const userAttempts = loginAttempts[username] || { count: 0, lockoutUntil: 0 };
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙˆÙ„Ø§Ù‹
            if (userAttempts.lockoutUntil > now) {
                const minutesLeft = Math.ceil((userAttempts.lockoutUntil - now) / 60000);
                return { allowed: false, message: `â³ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± ${minutesLeft} Ø¯Ù‚ÙŠÙ‚Ø©` };
            }
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¥Ø°Ø§ Ù…Ø± ÙˆÙ‚Øª ÙƒØ§ÙÙŠ
            if (userAttempts.lastAttempt && (now - userAttempts.lastAttempt) > 3600000) { // Ø³Ø§Ø¹Ø©
                userAttempts.count = 0;
            }
            
            return { allowed: true, attempts: userAttempts };
        }

        function updateLoginAttempts(username, success) {
            if (!loginAttempts[username]) {
                loginAttempts[username] = { count: 0, lastAttempt: 0, lockoutUntil: 0 };
            }
            
            if (success) {
                // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø¹Ù†Ø¯ Ù†Ø¬Ø§Ø­ Ø§Ù„Ø¯Ø®ÙˆÙ„
                loginAttempts[username] = { count: 0, lastAttempt: Date.now(), lockoutUntil: 0 };
            } else {
                // Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„ÙØ§Ø´Ù„Ø©
                loginAttempts[username].count++;
                loginAttempts[username].lastAttempt = Date.now();
                
                // Ø¥Ø°Ø§ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ØŒ Ù‚ÙÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
                if (loginAttempts[username].count >= SECURITY_SETTINGS.maxLoginAttempts) {
                    loginAttempts[username].lockoutUntil = Date.now() + (SECURITY_SETTINGS.lockoutTime * 60000);
                    logSecurityEvent('ACCOUNT_LOCKOUT', `Ø­Ø³Ø§Ø¨ ${username} Ù…Ù‚ÙÙ„ Ù…Ø¤Ù‚ØªØ§Ù‹`);
                }
            }
            
            localStorage.setItem('shifa_login_attempts', JSON.stringify(loginAttempts));
        }

        // ============================================
        // Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
        // ============================================

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const department = document.getElementById('loginDept').value;
            
            if (!username || !password) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…Ø­Ø§ÙˆÙ„Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„
            const attemptCheck = checkLoginAttempts(username);
            if (!attemptCheck.allowed) {
                alert(attemptCheck.message);
                return;
            }
            
            if (USERS[username] && USERS[username].password === password) {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­
                currentUser = {
                    u: username,
                    r: USERS[username].role,
                    name: USERS[username].name,
                    loginTime: new Date().toISOString()
                };
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª
                updateLoginAttempts(username, true);
                
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                localStorage.setItem('shifa_last_login', new Date().toISOString());
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.name}`;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                const lastLogin = new Date().toLocaleString('ar-EG');
                document.getElementById('lastLoginTime').textContent = lastLogin;
                
                // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ø§Ù‹
                if (currentUser.r === 'admin') {
                    initAdminSection();
                    switchSection('admin');
                    document.getElementById('emergencyBtn').style.display = 'inline-block';
                } else {
                    switchSection(currentUser.r);
                }
                
                // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« Ø§Ù„Ø¯Ø®ÙˆÙ„
                logSecurityEvent('LOGIN_SUCCESS', `Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… ${currentUser.r}`);
                showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`, `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… ${currentUser.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                
            } else {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙØ§Ø´Ù„
                updateLoginAttempts(username, false);
                logSecurityEvent('LOGIN_FAILED', `Ù…Ø­Ø§ÙˆÙ„Ø© Ø¯Ø®ÙˆÙ„ ÙØ§Ø´Ù„Ø© Ù„Ø­Ø³Ø§Ø¨ ${username}`);
                
                alert('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ØªÙ… Ù‚ÙÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
                const attemptCheck = checkLoginAttempts(username);
                if (!attemptCheck.allowed) {
                    alert(`ğŸ”’ ${attemptCheck.message}`);
                }
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
        // ============================================

        function registerPatient() {
            const name = document.getElementById('pName').value;
            const price = parseFloat(document.getElementById('pTicket').value);
            if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨!");
            
            const p = {
                id: Date.now(),
                name,
                age: document.getElementById('pAge').value,
                address: document.getElementById('pAddress').value,
                status: 'waiting_doctor',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ar-EG'),
                ticketPrice: price,
                tests: [], meds: [], results: '', complaint: ''
            };
            patients.push(p);
            saveData();
            alert("ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø·Ø¨ÙŠØ¨");
            loadReception();
        }

        function loadReception() {
            const list = document.getElementById('receptionList');
            list.innerHTML = patients.slice().reverse().map(p => `
                <div class="card p-2 mb-2 bg-medical small">
                    <b>${p.name}</b> (${p.age}) - ${p.status} <span class="float-end text-muted">${p.time}</span>
                </div>
            `).join('');
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨
        // ============================================

        function loadDoctorLists() {
            const lSel = document.getElementById('labSelect');
            const mSel = document.getElementById('medicineSelect');
            lSel.innerHTML = labTests.map(t => `<option value="${t.name}">${t.name} (${t.price} Ø¬)</option>`).join('');
            mSel.innerHTML = inventory.map(m => `<option value="${m.name}">${m.name} (${m.price} Ø¬ - Ù…ØªÙˆÙØ±: ${m.qty})</option>`).join('');
        }

        function loadDoctor() {
            const q = document.getElementById('doctorQueue');
            const waiting = patients.filter(p => p.status === 'waiting_doctor');
            q.innerHTML = waiting.map(p => `<button class="btn btn-light w-100 mb-2 border" onclick="selectPatient(${p.id})">${p.name}</button>`).join('');
        }

        function selectPatient(id) {
            activePatient = patients.find(p => p.id === id);
            document.getElementById('doctorWorkArea').classList.remove('hidden-section');
            document.getElementById('currentPatientName').textContent = activePatient.name;
            document.getElementById('complaint').value = activePatient.complaint || '';
        }

        function orderLab() {
            const selected = Array.from(document.getElementById('labSelect').selectedOptions).map(o => o.value);
            activePatient.tests = selected.map(name => ({name, price: labTests.find(t => t.name === name).price, result: ''}));
            activePatient.status = 'waiting_lab';
            saveData(); switchSection('doctor');
        }

        function orderPharmacy() {
            const selected = Array.from(document.getElementById('medicineSelect').selectedOptions).map(o => o.value);
            activePatient.meds = selected.map(name => ({name, price: inventory.find(i => i.name === name).price}));
            activePatient.status = 'waiting_pharmacy';
            saveData(); switchSection('doctor');
        }

        function orderNurse() {
            const notes = document.getElementById('nurseNotes').value;
            activePatient.nursingInstructions = notes;
            activePatient.status = 'waiting_nurse';
            saveData(); switchSection('doctor');
        }

        function completeVisit() {
            activePatient.status = 'completed';
            saveData();
            document.getElementById('doctorWorkArea').classList.add('hidden-section');
            loadDoctor();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„
        // ============================================

        function loadLab() {
            const list = document.getElementById('labList');
            const waiting = patients.filter(p => p.status === 'waiting_lab');
            list.innerHTML = waiting.map(p => {
                const total = p.tests.reduce((s, t) => s + t.price, 0);
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-danger border-5">
                        <h6>${p.name} <span class="badge bg-dark float-end">${total} Ø¬</span></h6>
                        ${p.tests.map((t, i) => `<input type="text" class="form-control form-control-sm mb-1" placeholder="Ù†ØªÙŠØ¬Ø© ${t.name}" onchange="patients.find(x=>x.id===${p.id}).tests[${i}].result=this.value">`).join('')}
                        <button class="btn btn-danger btn-sm w-100 mt-2" onclick="finishLab(${p.id})">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ø¨ÙŠØ¨</button>
                    </div>
                </div>`;
            }).join('');
        }

        function finishLab(id) { 
            patients.find(x => x.id === id).status = 'waiting_doctor'; 
            saveData(); loadLab(); playNotify(); 
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©
        // ============================================

        function loadPharmacy() {
            const list = document.getElementById('pharmacyList');
            const waiting = patients.filter(p => p.status === 'waiting_pharmacy');
            list.innerHTML = waiting.map(p => {
                const total = p.meds.reduce((s, m) => s + m.price, 0);
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-warning border-5">
                        <h6>${p.name} <span class="badge bg-warning text-dark float-end">${total} Ø¬</span></h6>
                        <ul class="small">${p.meds.map(m => `<li>${m.name}</li>`).join('')}</ul>
                        <button class="btn btn-warning btn-sm w-100" onclick="finishPhar(${p.id})">ØµØ±Ù ÙˆØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</button>
                    </div>
                </div>`;
            }).join('');
        }

        function finishPhar(id) {
            let p = patients.find(x => x.id === id);
            p.meds.forEach(m => {
                let item = inventory.find(i => i.name === m.name);
                if(item && item.qty > 0) item.qty--;
            });
            p.status = 'completed';
            saveData(); loadPharmacy();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶
        // ============================================

        function loadNurse() {
            const list = document.getElementById('nurseList');
            const waiting = patients.filter(p => p.status === 'waiting_nurse');
            list.innerHTML = waiting.map(p => {
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-purple border-5">
                        <h6>${p.name} <span class="badge bg-purple float-end">ØªÙ…Ø±ÙŠØ¶</span></h6>
                        <div class="bg-light p-2 rounded mb-2">
                            <small><strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong> ${p.nursingInstructions || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª'}</small>
                        </div>
                        <textarea class="form-control form-control-sm mb-2" placeholder="Ø³Ø¬Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°..."></textarea>
                        <button class="btn btn-purple btn-sm w-100" onclick="finishNurse(${p.id}, this)">Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
                    </div>
                </div>`;
            }).join('');
        }

        function finishNurse(id, btn) {
            const notes = btn.previousElementSibling.value;
            patients.find(x => x.id === id).status = 'completed';
            saveData(); loadNurse();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±
        // ============================================

        function loadAdmin() {
            const clinic = patients.reduce((s, p) => s + (p.ticketPrice || 0), 0);
            const lab = patients.reduce((s, p) => s + p.tests.reduce((ss, t) => ss + t.price, 0), 0);
            const phar = patients.reduce((s, p) => s + p.meds.reduce((ss, m) => ss + m.price, 0), 0);
            
            document.getElementById('admIncClinic').textContent = clinic.toLocaleString();
            document.getElementById('admIncLab').textContent = lab.toLocaleString();
            document.getElementById('admIncPhar').textContent = phar.toLocaleString();
            document.getElementById('admIncTotal').textContent = (clinic + lab + phar).toLocaleString();
        }

        function adminAddLab() {
            const name = document.getElementById('admLabName').value;
            const price = parseFloat(document.getElementById('admLabPrice').value);
            if(name && price) {
                labTests.push({name, price});
                localStorage.setItem('shifa_tests', JSON.stringify(labTests));
                alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ­Øµ");
            }
        }

        function adminAddMed() {
            const name = document.getElementById('admMedName').value;
            const price = parseFloat(document.getElementById('admMedPrice').value);
            const qty = parseInt(document.getElementById('admMedQty').value);
            if(name && price && qty) {
                inventory.push({name, price, qty});
                localStorage.setItem('shifa_stock', JSON.stringify(inventory));
                alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†");
            }
        }

        function renderReport(type) {
            const reportArea = document.getElementById('reportArea');
            let html = '';
            
            switch(type) {
                case 'day':
                    const today = new Date().toDateString();
                    const todayPatients = patients.filter(p => new Date(p.date).toDateString() === today);
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${new Date().toLocaleDateString('ar-EG')}</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${todayPatients.length}</p>
                                <p><strong>Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${todayPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Ù…ÙƒØªÙ…Ù„:</strong> ${todayPatients.filter(p => p.status === 'completed').length}</p>
                                <p><strong>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</strong> ${todayPatients.filter(p => p.status !== 'completed').length}</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'week':
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const weekPatients = patients.filter(p => new Date(p.date) >= weekAgo);
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${weekPatients.length}</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ:</strong> ${Math.round(weekPatients.length / 7)}</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${weekPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ:</strong> ${Math.round(weekPatients.reduce((s,p) => s + (p.ticketPrice||0), 0) / 7).toLocaleString()} Ø¬</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'month':
                    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    const monthPatients = patients.filter(p => new Date(p.date) >= monthAgo);
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${monthPatients.length}</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</strong> ${Math.round(monthPatients.length / 4)}</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</strong> ${Math.round(monthPatients.reduce((s,p) => s + (p.ticketPrice||0), 0) / 4).toLocaleString()} Ø¬</p>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            reportArea.innerHTML = html;
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©
        // ============================================

        function switchSection(id) {
            if (currentUser.r === 'admin') {
                // Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            } else if (currentUser.r !== id) {
                alert(`â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‚Ø³Ù… ${id}!`);
                return;
            }
            
            document.querySelectorAll('.section-pane').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(`${id}-sec`).classList.remove('hidden-section');
            
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if(document.getElementById(`btn-${id}`)) document.getElementById(`btn-${id}`).classList.add('active');
            updateBadges();
            if(id === 'doctor') loadDoctorLists();
            if(window[`load${id.charAt(0).toUpperCase() + id.slice(1)}`]) window[`load${id.charAt(0).toUpperCase() + id.slice(1)}`]();
        }

        function saveData() {
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            updateBadges();
        }

        function updateBadges() {
            const b = {
                doctor: patients.filter(p => p.status === 'waiting_doctor').length,
                lab: patients.filter(p => p.status === 'waiting_lab').length,
                pharmacy: patients.filter(p => p.status === 'waiting_pharmacy').length,
                nurse: patients.filter(p => p.status === 'waiting_nurse').length
            };
            for(let k in b) {
                const el = document.getElementById(`${k}Badge`);
                if(el) { el.textContent = b[k]; b[k]>0 ? el.classList.remove('hidden-section') : el.classList.add('hidden-section'); }
            }
        }

        function playNotify() { 
            try { 
                document.getElementById('notificationSound').play().catch(()=>{}); 
            } catch(e) {} 
        }

        function logout() {
            if (currentUser) {
                logSecurityEvent('LOGOUT', `Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser.u}`);
            }
            localStorage.removeItem('shifa_user');
            location.reload();
        }

        function showNotification(title, message) {
            console.log(`ğŸ”” ${title}: ${message}`);
            
            try {
                document.getElementById('notificationSound').play();
            } catch (e) {}
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/822/822118.png'
                });
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        // ============================================

        function openUserMenu() {
            const modal = new bootstrap.Modal(document.getElementById('userMenuModal'));
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userRoleDisplay').textContent = currentUser.r === 'admin' ? 'Ù…Ø¯ÙŠØ±' : 
                                                                    currentUser.r === 'doctor' ? 'Ø·Ø¨ÙŠØ¨' :
                                                                    currentUser.r === 'reception' ? 'Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' :
                                                                    currentUser.r === 'pharmacy' ? 'ØµÙŠØ¯Ù„ÙŠ' :
                                                                    currentUser.r === 'lab' ? 'Ù…Ø¹Ù…Ù„' : 'ØªÙ…Ø±ÙŠØ¶';
            
            // Ø¹Ø±Ø¶ Ø¢Ø®Ø± ÙˆÙ‚Øª Ø¯Ø®ÙˆÙ„
            const lastLogin = localStorage.getItem('shifa_last_login');
            if (lastLogin) {
                document.getElementById('lastLoginDisplay').textContent = 
                    `Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: ${new Date(lastLogin).toLocaleString('ar-EG')}`;
            }
            
            modal.show();
        }

        function changePasswordModal() {
            const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
            modal.show();
        }

        function checkPasswordStrength() {
            const password = document.getElementById('newPassword').value;
            const strengthBar = document.getElementById('passwordStrength');
            
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[A-Z]/.test(password)) strength++;
            if (/[a-z]/.test(password)) strength++;
            if (/[0-9]/.test(password)) strength++;
            if (/[^A-Za-z0-9]/.test(password)) strength++;
            
            strengthBar.style.width = (strength * 20) + '%';
            
            if (strength < 2) {
                strengthBar.style.backgroundColor = '#dc3545';
            } else if (strength < 4) {
                strengthBar.style.backgroundColor = '#ffc107';
            } else {
                strengthBar.style.backgroundColor = '#28a745';
            }
        }

        function confirmPasswordChange() {
            const currentPass = document.getElementById('currentPassword').value;
            const newPass = document.getElementById('newPassword').value;
            const confirmPass = document.getElementById('confirmPassword').value;
            
            if (!currentPass || !newPass || !confirmPass) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!');
                return;
            }
            
            if (newPass !== confirmPass) {
                alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©!');
                return;
            }
            
            if (newPass.length < 8) {
                alert('âš ï¸ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† 8 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„!');
                return;
            }
            
            if (USERS[currentUser.u] && USERS[currentUser.u].password === currentPass) {
                USERS[currentUser.u].password = newPass;
                
                // ØªØ­Ø¯ÙŠØ« ÙÙŠ staffMembers
                const staff = staffMembers.find(s => s.u === currentUser.u);
                if (staff) {
                    staff.p = newPass;
                    localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
                }
                
                logSecurityEvent('PASSWORD_CHANGE', `ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ${currentUser.u}`);
                alert('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­!');
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
                modal.hide();
            } else {
                alert('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
            }
        }

        function viewMyActivity() {
            alert('ğŸ“‹ Ø³Ø¬Ù„ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ:\n\n' +
                  `ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${currentUser.name}\n` +
                  `ğŸ¥ Ø§Ù„Ù‚Ø³Ù…: ${currentUser.r}\n` +
                  `ğŸ“… ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„: ${currentUser.loginTime ? new Date(currentUser.loginTime).toLocaleString('ar-EG') : '--'}\n\n` +
                  'Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‚Ø±ÙŠØ¨Ø§Ù‹.');
        }

        function toggleDarkMode() {
            document.body.classList.toggle('bg-dark');
            document.body.classList.toggle('text-light');
            alert('ğŸŒ™ ØªÙ… ØªØºÙŠÙŠØ± ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶');
        }

        function showSecurityLog() {
            const modal = new bootstrap.Modal(document.getElementById('securityLogModal'));
            const content = document.getElementById('securityLogContent');
            
            let html = '<div class="list-group">';
            securityLog.slice(0, 50).forEach(log => {
                const time = new Date(log.timestamp).toLocaleString('ar-EG');
                html += `
                    <div class="list-group-item">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${log.eventType}</h6>
                            <small>${time}</small>
                        </div>
                        <p class="mb-1">${log.details}</p>
                        <small>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${log.user}</small>
                    </div>
                `;
            });
            html += '</div>';
            
            content.innerHTML = html;
            modal.show();
        }

        function clearSecurityLog() {
            if (confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù†ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.')) {
                securityLog = [];
                localStorage.setItem('shifa_security_log', JSON.stringify(securityLog));
                document.getElementById('securityLogContent').innerHTML = '<p class="text-center text-muted">ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù†</p>';
                logSecurityEvent('SECURITY_LOG_CLEARED', 'ØªÙ… Ù…Ø³Ø­ Ø³Ø¬Ù„ Ø§Ù„Ø£Ù…Ø§Ù† Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
            }
        }

        // ============================================
        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù†Ø¸Ø§Ù…
        // ============================================

        window.onload = function() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø©
            function updateClock() {
                const now = new Date();
                document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('ar-EG');
            }
            updateClock();
            setInterval(updateClock, 1000);
            
            // Ø·Ù„Ø¨ Ø¥Ø°Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª
            if ('Notification' in window && Notification.permission === 'default') {
                Notification.requestPermission();
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            const savedUser = localStorage.getItem('shifa_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').innerHTML = `ğŸ‘¤ <b>${currentUser.name}</b>`;
                
                // Ø¹Ø±Ø¶ Ø²Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø·Ø§Ø±Ø¦ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·
                if (currentUser.r === 'admin') {
                    document.getElementById('emergencyBtn').style.display = 'inline-block';
                }
                
                switchSection(currentUser.r === 'admin' ? 'admin' : currentUser.r);
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©
            if (staffMembers.length === 0) {
                staffMembers = Object.keys(USERS).map(username => ({
                    u: username,
                    p: USERS[username].password,
                    r: USERS[username].role,
                    name: USERS[username].name,
                    status: 'active',
                    created: new Date().toISOString()
                }));
                localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            }
            
            // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
            const lastLogin = localStorage.getItem('shifa_last_login');
            if (lastLogin) {
                document.getElementById('lastLoginTime').textContent = 
                    new Date(lastLogin).toLocaleString('ar-EG');
            }
            
            updateBadges();
            
            // ØªØ³Ø¬ÙŠÙ„ Ø­Ø¯Ø« ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…
            logSecurityEvent('SYSTEM_START', 'ØªÙ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…');
        };
    </script>
</body>
</html>
