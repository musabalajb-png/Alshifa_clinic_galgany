<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø´Ø§Ù…Ù„</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #2c7a7b;
            --secondary-color: #f0fdf4;
            --accent-green: #198754;
            --accent-red: #dc3545;
            --accent-warning: #ffc107;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒØ±ÙˆØª */
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 20px;
            transition: transform 0.2s;
        }
        
        .card:hover {
            transform: translateY(-2px);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ */
        .login-container {
            background: linear-gradient(135deg, var(--primary-color), #285e61);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        /* Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
        .nav-tabs .nav-link {
            font-weight: bold;
            color: #495057;
            border-radius: 10px 10px 0 0;
            padding: 12px 20px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª */
        .stat-card {
            background: white;
            border-right: 5px solid var(--primary-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number { font-size: 2rem; font-weight: bold; color: var(--primary-color); }
        .stat-label { color: #6c757d; font-size: 0.9rem; }

        /* Ø´Ø§Ø±Ø§Øª Ø§Ù„Ø­Ø§Ù„Ø© */
        .badge-custom { padding: 8px 12px; border-radius: 20px; font-weight: 500; }
        .status-waiting { background-color: #fff3cd; color: #856404; }
        .status-done { background-color: #d1e7dd; color: #0f5132; }

        /* Loader */
        .loader-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.8); z-index: 9999;
            display: none; justify-content: center; align-items: center;
        }
        .spinner-custom {
            width: 3rem; height: 3rem; color: var(--primary-color);
        }
    </style>
</head>
<body>

    <div id="loader" class="loader-overlay">
        <div class="spinner-border spinner-custom" role="status">
            <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
        </div>
    </div>

    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="text-center mb-4">
                <i class="fas fa-hospital-alt fa-3x mb-3" style="color: var(--primary-color);"></i>
                <h3 class="fw-bold">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted">Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            </div>
            
            <div class="alert alert-warning d-none" id="loginError"></div>

            <div class="mb-3">
                <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="loginUser" class="form-control form-control-lg" placeholder="admin">
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPass" class="form-control form-control-lg" placeholder="***">
            </div>
            
            <div class="mb-4">
                <label class="form-label fw-bold">Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© (Ø§Ù„Ù‚Ø³Ù…)</label>
                <select id="loginRole" class="form-select form-select-lg">
                    <option value="admin">ğŸ‘¨â€ğŸ’¼ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù… (Admin)</option>
                    <option value="reception">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                    <option value="nurse">ğŸ‘©â€âš•ï¸ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                    <option value="doctor">ğŸ©º Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (Ø§Ù„Ø·Ø¨ÙŠØ¨)</option>
                    <option value="lab">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                    <option value="pharmacy">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                </select>
            </div>
            
            <button onclick="performLogin()" class="btn btn-primary w-100 btn-lg fw-bold shadow">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-sign-in-alt ms-2"></i>
            </button>
            
            <div class="text-center mt-4">
                <small class="text-muted" id="serverStatus">
                    <i class="fas fa-circle-notch fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...
                </small>
            </div>
        </div>
    </div>

    <div id="mainApp" style="display: none;">
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
            <div class="container-fluid">
                <a class="navbar-brand fw-bold" href="#">
                    <i class="fas fa-heartbeat me-2"></i> Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡
                </a>
                <div class="d-flex align-items-center text-white">
                    <div class="me-3 text-end d-none d-md-block">
                        <div class="fw-bold" id="userNameDisplay">Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</div>
                        <small id="userRoleDisplay" class="badge bg-light text-primary">Ø§Ù„Ø¯ÙˆØ±</small>
                    </div>
                    <button onclick="logout()" class="btn btn-outline-light btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬
                    </button>
                </div>
            </div>
        </nav>

        <div class="container-fluid px-4">
            <ul class="nav nav-tabs mb-4" id="mainTabs">
                <li class="nav-item" data-role="all">
                    <button class="nav-link active" onclick="showTab('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                </li>
                <li class="nav-item" data-role="reception,admin">
                    <button class="nav-link" onclick="showTab('reception')">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button>
                </li>
                <li class="nav-item" data-role="nurse,admin">
                    <button class="nav-link" onclick="showTab('nursing')">ğŸ‘©â€âš•ï¸ Ø§Ù„ØªÙ…Ø±ÙŠØ¶ (Ø§Ù„ÙØ±Ø²)</button>
                </li>
                <li class="nav-item" data-role="doctor,admin">
                    <button class="nav-link" onclick="showTab('clinic')">ğŸ©º Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button>
                </li>
                <li class="nav-item" data-role="lab,admin">
                    <button class="nav-link" onclick="showTab('lab')">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</button>
                </li>
                <li class="nav-item" data-role="pharmacy,admin">
                    <button class="nav-link" onclick="showTab('pharmacy')">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</button>
                </li>
            </ul>

            <div class="tab-content">
                
                <div id="dashboardTab" class="content-pane">
                    <div class="row g-3" id="statsContainer">
                        </div>
                </div>

                <div id="receptionTab" class="content-pane" style="display:none;">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card">
                                <div class="card-header bg-white fw-bold">
                                    <i class="fas fa-user-plus text-primary"></i> ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯
                                </div>
                                <div class="card-body">
                                    <form onsubmit="event.preventDefault(); registerPatient();">
                                        <div class="mb-3">
                                            <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
                                            <input type="text" id="regName" class="form-control" required>
                                        </div>
                                        <div class="row mb-3">
                                            <div class="col">
                                                <label>Ø§Ù„Ø¹Ù…Ø±</label>
                                                <input type="number" id="regAge" class="form-control" required>
                                            </div>
                                            <div class="col">
                                                <label>Ø§Ù„Ù‡Ø§ØªÙ</label>
                                                <input type="text" id="regPhone" class="form-control">
                                            </div>
                                        </div>
                                        <div class="mb-3">
                                            <label>Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø­ÙˆÙ„Ø©</label>
                                            <select class="form-select" id="regClinic">
                                                <option value="general">Ø¹ÙŠØ§Ø¯Ø© Ø¹Ø§Ù…Ø©</option>
                                                <option value="dental">Ø£Ø³Ù†Ø§Ù†</option>
                                                <option value="im">Ø¨Ø§Ø·Ù†ÙŠØ©</option>
                                            </select>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">ØªØ³Ø¬ÙŠÙ„ ÙˆØªØ­ÙˆÙŠÙ„</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card">
                                <div class="card-header bg-white fw-bold">Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…</div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover">
                                            <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead>
                                            <tbody id="todayPatientsTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="nursingTab" class="content-pane" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-white fw-bold">
                            <i class="fas fa-notes-medical text-primary"></i> Ù‚ÙŠØ§Ø³ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©
                        </div>
                        <div class="card-body">
                            <div id="nursingList">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...</div>
                        </div>
                    </div>
                </div>

                <div id="clinicTab" class="content-pane" style="display:none;">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark fw-bold">
                                    <i class="fas fa-clock"></i> Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±
                                </div>
                                <div class="card-body p-0">
                                    <div class="list-group list-group-flush" id="doctorWaitingList">
                                        </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div class="card h-100" id="doctorActionArea" style="display:none;">
                                <div class="card-header bg-primary text-white d-flex justify-content-between">
                                    <span id="currentPatientName">Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</span>
                                    <button class="btn btn-sm btn-light" onclick="closePatientFile()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ù„Ù</button>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ (Diagnosis)</label>
                                        <textarea class="form-control" id="docDiagnosis" rows="3"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <label class="fw-bold">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© (Prescription)</label>
                                            <textarea class="form-control" id="docMeds" rows="3" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡ - Ø§Ù„Ø¬Ø±Ø¹Ø©"></textarea>
                                            <button onclick="sendToPharmacy()" class="btn btn-success w-100 mt-2">
                                                <i class="fas fa-pills"></i> Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©
                                            </button>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="fw-bold">ÙØ­ÙˆØµØ§Øª Ù…Ø¹Ù…Ù„ÙŠØ© (Lab Requests)</label>
                                            <div class="input-group">
                                                <select class="form-select" id="docLabTest">
                                                    <option value="CBC">ØµÙˆØ±Ø© Ø¯Ù… ÙƒØ§Ù…Ù„Ø© (CBC)</option>
                                                    <option value="Malaria">Ù…Ù„Ø§Ø±ÙŠØ§ (Malaria)</option>
                                                    <option value="Urine">Ø¨ÙˆÙ„ (Urine)</option>
                                                    <option value="Sugar">Ø³ÙƒØ±ÙŠ (Sugar)</option>
                                                </select>
                                                <button onclick="sendToLab()" class="btn btn-danger">Ø·Ù„Ø¨</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="text-center p-5 text-muted" id="doctorPlaceholder">
                                <i class="fas fa-user-md fa-3x mb-3"></i>
                                <h4>Ø§Ø®ØªØ± Ù…Ø±ÙŠØ¶Ø§Ù‹ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„Ø¨Ø¯Ø¡</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="labTab" class="content-pane" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-danger text-white fw-bold">
                            <i class="fas fa-flask"></i> Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªØ­Ø§Ù„ÙŠÙ„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ø·Ø¨ÙŠØ¨</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                                    <tbody id="labRequestsTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="pharmacyTab" class="content-pane" style="display:none;">
                    <div class="card">
                        <div class="card-header bg-success text-white fw-bold">
                            <i class="fas fa-prescription"></i> Ø§Ù„ÙˆØµÙØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead><tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                                    <tbody id="pharmacyOrdersTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ==========================================
        // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„ØªÙ‡ÙŠØ¦Ø© (Configuration)
        // ==========================================
        
        // ØªØ­Ø¯ÙŠØ¯ Ø±Ø§Ø¨Ø· Ø§Ù„Ù€ API ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ´ØºÙŠÙ„
        const isVercel = window.location.hostname.includes('vercel.app');
        const API_URL = isVercel 
            ? 'http://AlshifaClinic.somee.com/api.aspx' 
            : 'api.aspx';

        // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© (ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ÙÙ‚Ø· - No Local Storage)
        let currentUser = null;
        let activePatientId = null;

        // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.onload = async () => {
            checkServerStatus();
        };

        // Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯Ø© (Core API Function)
        async function callApi(action, data = {}) {
            document.getElementById('loader').style.display = 'flex';
            
            // Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ù„Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            data.action = action;
            
            // ÙÙŠ Ø­Ø§Ù„Ø© Vercel Ù†Ø±Ø³Ù„ JSONØŒ ÙÙŠ Ø­Ø§Ù„Ø© Somee Ù†Ø³ØªØ®Ø¯Ù… Form logic handled by backend
            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            };

            try {
                // Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø¨Ø±ÙˆØªÙˆÙƒÙˆÙ„ HTTP Ø§Ù„Ù…Ø®ØªÙ„Ø·
                if (isVercel && window.location.protocol === 'https:') {
                    console.warn('Mixed Content Warning: Trying to access HTTP from HTTPS');
                }

                const response = await fetch(API_URL, options);
                const result = await response.json();
                
                document.getElementById('loader').style.display = 'none';
                return result;
            } catch (error) {
                document.getElementById('loader').style.display = 'none';
                console.error("API Error:", error);
                
                if (isVercel) {
                    alert("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±. ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ³ØªØ®Ø¯Ù… http ÙˆÙ„ÙŠØ³ httpsØŒ Ø£Ùˆ Ø§Ø³Ù…Ø­ Ø¨Ø§Ù„Ù€ Mixed Content ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­.");
                }
                return { success: false, message: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: " + error.message };
            }
        }

        // ==========================================
        // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Auth & Roles)
        // ==========================================

        async function checkServerStatus() {
            const statusEl = document.getElementById('serverStatus');
            try {
                const res = await callApi('ping'); // ØªØ£ÙƒØ¯ Ø¥Ù†Ùƒ Ø¶ÙØª ping ÙÙŠ Ø§Ù„ backend
                if(res.success) {
                    statusEl.innerHTML = '<span class="text-success fw-bold">ğŸŸ¢ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²</span>';
                } else {
                    throw new Error(res.message);
                }
            } catch (e) {
                statusEl.innerHTML = '<span class="text-danger fw-bold">ğŸ”´ Ø§Ù„Ø³ÙŠØ±ÙØ± ØºÙŠØ± Ù…ØªØµÙ„ (ØªØ­Ù‚Ù‚ Ù…Ù† HTTP/HTTPS)</span>';
            }
        }

        async function performLogin() {
            const u = document.getElementById('loginUser').value;
            const p = document.getElementById('loginPass').value;
            const r = document.getElementById('loginRole').value;

            if(!u || !p) {
                showLoginError("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
                return;
            }

            // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ø³ÙŠØ±ÙØ±
            const result = await callApi('login', { u: u, p: p });

            if(result.success) {
                // Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… (Ø¨Ø¯ÙˆÙ† ØªØ®Ø²ÙŠÙ† Ù…Ø­Ù„ÙŠ)
                currentUser = { 
                    name: result.user.u, 
                    role: r, // Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø®ØªØ§Ø± Ø£Ùˆ Ø§Ù„Ø±Ø§Ø¬Ø¹ Ù…Ù† Ø§Ù„Ø¯Ø§ØªØ§ Ø¨ÙŠØ²
                    realRole: result.user.role 
                };
                
                setupUIForRole(r);
            } else {
                showLoginError(result.message || "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
            }
        }

        function showLoginError(msg) {
            const err = document.getElementById('loginError');
            err.textContent = msg;
            err.classList.remove('d-none');
        }

        function setupUIForRole(role) {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userRoleDisplay').textContent = getRoleNameAr(role);

            // Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø¯ÙˆØ±
            document.querySelectorAll('#mainTabs .nav-item').forEach(item => {
                const allowedRoles = item.getAttribute('data-role').split(',');
                if(allowedRoles.includes(role) || allowedRoles.includes('all')) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });

            // ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
            if(role === 'reception') showTab('reception');
            else if(role === 'doctor') showTab('clinic');
            else showTab('dashboard');
        }

        function logout() {
            currentUser = null;
            location.reload(); // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø©
        }

        // ==========================================
        // 3. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Tabs Logic)
        // ==========================================

        function showTab(tabId) {
            // UI Switch
            document.querySelectorAll('.content-pane').forEach(p => p.style.display = 'none');
            document.getElementById(tabId + 'Tab').style.display = 'block';
            
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            // Highlight active tab logic here if needed by ID matching

            // Load Data based on Tab
            if(tabId === 'dashboard') loadDashboardData();
            if(tabId === 'reception') loadTodayPatients();
            if(tabId === 'nursing') loadNursingList();
            if(tabId === 'clinic') loadDoctorWaitingList();
            if(tabId === 'lab') loadLabRequests();
            if(tabId === 'pharmacy') loadPharmacyOrders();
        }

        // --- Dashboard ---
        async function loadDashboardData() {
            const res = await callApi('getstatistics', {}); // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ GET ÙÙŠ Ø§Ù„backend Ø¨Ø³ Ù‡Ù†Ø§ Ø¨Ù†Ø±Ø³Ù„ POST Ù…ÙˆØ­Ø¯
            if(res.success) {
                document.getElementById('statsContainer').innerHTML = `
                    <div class="col-md-3">
                        <div class="stat-card">
                            <div class="stat-number">${res.total || 0}</div>
                            <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="stat-card border-warning">
                            <div class="stat-number text-warning">${res.waiting || 0}</div>
                            <div class="stat-label">ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</div>
                        </div>
                    </div>
                `;
            }
        }

        // --- Reception ---
        async function registerPatient() {
            const data = {
                name: document.getElementById('regName').value,
                age: document.getElementById('regAge').value,
                phone: document.getElementById('regPhone').value,
                clinic: document.getElementById('regClinic').value
            };

            const res = await callApi('addPatient', data);
            if(res.success) {
                alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­ Ø¨Ø±Ù‚Ù…: " + res.id);
                document.getElementById('regName').value = '';
                document.getElementById('regAge').value = '';
                loadTodayPatients();
            } else {
                alert("Ø®Ø·Ø£: " + res.message);
            }
        }

        async function loadTodayPatients() {
            // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„backend Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠÙ‡ Ø¯Ø§Ù„Ø© getWaitingPatientsØŒ Ø­Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹
            const res = await callApi('getwaitingpatients');
            const tbody = document.getElementById('todayPatientsTable');
            tbody.innerHTML = '';
            
            if(res.success && res.patients) {
                res.patients.forEach(p => {
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.Id}</td>
                            <td>${p.Name}</td>
                            <td>${p.Age}</td>
                            <td><span class="badge bg-info">${p.Status}</span></td>
                        </tr>
                    `;
                });
            }
        }

        // --- Nursing ---
        async function loadNursingList() {
            const res = await callApi('getwaitingpatients'); // Ù†ÙØ³ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ù„ØªÙ…Ø±ÙŠØ¶ Ù„Ù„ÙØ±Ø²
            const container = document.getElementById('nursingList');
            
            if(res.success && res.patients) {
                let html = '<ul class="list-group">';
                res.patients.forEach(p => {
                    html += `
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <h6 class="mb-0">${p.Name} (${p.Age} Ø³Ù†Ø©)</h6>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ© Ù„Ù„Ù…Ø±ÙŠØ¶ ${p.Id}')">
                                <i class="fas fa-heartbeat"></i> Ù‚ÙŠØ§Ø³
                            </button>
                        </li>
                    `;
                });
                html += '</ul>';
                container.innerHTML = html;
            } else {
                container.innerHTML = 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±';
            }
        }

        // --- Clinic (Doctor) ---
        async function loadDoctorWaitingList() {
            const res = await callApi('getwaitingpatients');
            const list = document.getElementById('doctorWaitingList');
            list.innerHTML = '';

            if(res.success && res.patients) {
                res.patients.forEach(p => {
                    list.innerHTML += `
                        <button class="list-group-item list-group-item-action" onclick="openPatientFile(${p.Id}, '${p.Name}')">
                            <div class="d-flex w-100 justify-content-between">
                                <h6 class="mb-1">${p.Name}</h6>
                                <small>${p.Age} Ø³Ù†Ø©</small>
                            </div>
                        </button>
                    `;
                });
            } else {
                list.innerHTML = '<div class="p-3 text-center">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø±Ø¶Ù‰</div>';
            }
        }

        function openPatientFile(id, name) {
            activePatientId = id;
            document.getElementById('currentPatientName').textContent = name;
            document.getElementById('doctorPlaceholder').style.display = 'none';
            document.getElementById('doctorActionArea').style.display = 'block';
        }

        function closePatientFile() {
            activePatientId = null;
            document.getElementById('doctorActionArea').style.display = 'none';
            document.getElementById('doctorPlaceholder').style.display = 'block';
            document.getElementById('docDiagnosis').value = '';
            document.getElementById('docMeds').value = '';
        }

        async function sendToPharmacy() {
            if(!activePatientId) return;
            // Ø§ÙØªØ±Ø§Ø¶ Ø¯Ø§Ù„Ø© ÙÙŠ Ø§Ù„backend (Ù„Ùˆ Ù…Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­ØªØ¶Ø±Ø¨ error Ø¨Ø³ Ø§Ù„frontend Ø¬Ø§Ù‡Ø²)
            // Ø¨Ù…Ø§ Ø§Ù† Ø§Ù„backend Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø­Ø¯ÙˆØ¯ØŒ Ø­Ù†Ø¹Ù…Ù„ Ù…Ø­Ø§ÙƒØ§Ø© Ù†Ø¬Ø§Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
            alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙˆØµÙØ© Ù„Ù„Ù…Ø±ÙŠØ¶ Ø±Ù‚Ù… ${activePatientId} Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©.`);
            closePatientFile();
            loadDoctorWaitingList();
        }
        
        async function sendToLab() {
             if(!activePatientId) return;
             alert(`ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ù„Ù„Ù…Ø±ÙŠØ¶ Ø±Ù‚Ù… ${activePatientId} Ù„Ù„Ù…Ø¹Ù…Ù„.`);
        }

        // --- Lab & Pharmacy ---
        async function loadLabRequests() {
            // Ù…Ø­Ø§ÙƒØ§Ø©: Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„API Ù„Ø³Ù‡ Ù…Ø§ ÙÙŠÙ‡Ùˆ Endpoint Ù„Ù„Ù…Ø¹Ù…Ù„ØŒ Ø­Ù†Ø¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ÙØ§Ø±ØºØ©
            // Ù„ÙƒÙ† Ø§Ù„ÙƒÙˆØ¯ Ø¬Ø§Ù‡Ø² ÙŠØ³ØªÙ‚Ø¨Ù„ data.requests Ù„Ùˆ ØªÙˆÙØ±Øª
            document.getElementById('labRequestsTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
        }

        async function loadPharmacyOrders() {
            document.getElementById('pharmacyOrdersTable').innerHTML = '<tr><td colspan="4" class="text-center text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØµÙØ§Øª Ø·Ø¨ÙŠØ© Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
        }

        // Utilities
        function getRoleNameAr(role) {
            const names = {
                'admin': 'Ø§Ù„Ù…Ø¯ÙŠØ±',
                'reception': 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„',
                'doctor': 'Ø§Ù„Ø·Ø¨ÙŠØ¨',
                'nurse': 'Ø§Ù„ØªÙ…Ø±ÙŠØ¶',
                'lab': 'Ø§Ù„Ù…Ø¹Ù…Ù„',
                'pharmacy': 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠ'
            };
            return names[role] || role;
        }

    </script>
</body>
</html>
