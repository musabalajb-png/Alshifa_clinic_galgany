<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #f0fdf4; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card { background: white; border-radius: 15px; padding: 20px; border-right: 5px solid var(--primary-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); }
        .card { border-radius: 15px; border: none; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-img { filter: brightness(0) invert(1); margin-left: 10px; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0fdf4; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .hidden-section { display: none !important; }
        @media print { .no-print { display: none !important; } #prescriptionPrintArea { display: block !important; } }
        .prescription-box { border: 2px solid #2c7a7b; padding: 30px; border-radius: 10px; min-height: 600px; background: white; }
        .lab-badge { font-size: 0.8rem; padding: 5px 10px; border-radius: 20px; }
        #labNotifyBadge { position: absolute; top: -5px; right: -5px; font-size: 0.7rem; padding: 4px 6px; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <div id="loginOverlay">
        <div class="card p-4 shadow-lg" style="width: 380px; border-top: 5px solid var(--primary-color);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="60" alt="Ù„ÙˆÙ‚Ùˆ">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted small">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="username" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
            </div>
            <div class="mb-3">
                <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="******">
            </div>
            <button class="btn btn-primary w-100 fw-bold" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p id="loginError" class="text-danger small mt-2 text-center" style="display:none;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
        </div>
    </div>

    <div id="mainContent" class="hidden-section">
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="40" class="logo-img">
                    <span class="navbar-brand mb-0 h1 fw-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </div>
                <div class="text-white">
                    <span id="userDisplay" class="me-3 small"></span>
                    <button class="btn btn-sm btn-outline-light" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="adminStats" class="row mb-4 hidden-section">
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="todaySales">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="todayProfit" class="text-success">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù…Ù„ + Ø§Ù„ØªØ°Ø§ÙƒØ±</h6><h3 id="labIncome">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…</h6><h3 id="totalIncome">0</h3></div></div>
            </div>

            <ul class="nav nav-pills mb-3 shadow-sm p-2 bg-white rounded no-print" id="pills-tab">
                <li class="nav-item tab-reception hidden-section"><button class="nav-link" id="btn-reception" data-bs-toggle="pill" data-bs-target="#reception">Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item tab-doctor hidden-section"><button class="nav-link" id="btn-doctor" data-bs-toggle="pill" data-bs-target="#doctor" onclick="loadDoctorData()">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button></li>
                <li class="nav-item tab-pharmacy hidden-section"><button class="nav-link" id="btn-pharmacy" data-bs-toggle="pill" data-bs-target="#pharmacy">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</button></li>
                <li class="nav-item tab-lab hidden-section">
                    <button class="nav-link position-relative" id="btn-lab" data-bs-toggle="pill" data-bs-target="#lab" onclick="loadLabData()">
                        Ø§Ù„Ù…Ø¹Ù…Ù„
                        <span id="labNotifyBadge" class="badge rounded-pill bg-danger" style="display: none;">0</span>
                    </button>
                </li>
                <li class="nav-item tab-users hidden-section"><button class="nav-link" id="btn-users" data-bs-toggle="pill" data-bs-target="#usersAdmin">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></li>
            </ul>

            <div class="tab-content no-print">
                <div class="tab-pane fade hidden-section" id="reception">
                    <div class="card p-4 shadow-sm">
                        <h5 class="text-primary mb-4 border-bottom pb-2">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input type="text" id="pName" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„Ø¹Ù…Ø±</label><input type="number" id="pAge" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="pGender" class="form-select"><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select></div>
                            <div class="col-md-4"><label>Ø§Ù„Ø³ÙƒÙ†</label><input type="text" id="pAddress" class="form-control"></div>
                            <div class="col-md-4"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="pPhone" class="form-control"></div>
                            <div class="col-md-4"><label class="text-danger fw-bold">ØªØ°ÙƒØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input type="number" id="pTicket" class="form-control border-danger"></div>
                            <button class="btn btn-primary w-100 btn-lg mt-4" onclick="registerPatient()">Ø­ÙØ¸ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="doctor">
                    <div class="card p-3 shadow-sm">
                        <h5>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙŠØ¶</h5>
                        <select id="visitPatientSelect" class="form-select mb-3">
                            <option>Ù…Ø±ÙŠØ¶ Ø¹Ø§Ù…</option>
                        </select>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <textarea id="doctorComplaint" class="form-control mb-2" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶..."></textarea>
                                <textarea id="diagnosis" class="form-control" rows="6" placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„ÙˆØµÙØ© Rx..."></textarea>
                            </div>
                            <div class="col-md-4">
                                <div class="p-2 border rounded bg-light">
                                    <h6>Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª Ù…Ø¹Ù…Ù„ÙŠØ©:</h6>
                                    <select id="doctorTestSelect" class="form-select mb-2">
                                        <option>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ­ÙˆØµØ§Øª...</option>
                                    </select>
                                    <button class="btn btn-outline-danger w-100 btn-sm" onclick="sendToLab()">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¹Ù…Ù„ ğŸ§ª</button>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-dark w-100" onclick="printPrescription()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©</button>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="pharmacy">
                    <div class="card p-3 mb-3 bg-light">
                        <h6>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                        <div class="row g-2">
                            <div class="col-md-4"><input type="text" id="newMedName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"></div>
                            <div class="col-md-2"><input type="number" id="newMedQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"></div>
                            <div class="col-md-2"><input type="number" id="newMedSell" class="form-control" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"></div>
                            <div class="col-md-4"><button class="btn btn-success w-100" onclick="alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©')">Ø¥Ø¶Ø§ÙØ©</button></div>
                        </div>
                    </div>
                    <div class="card p-3">
                        <table class="table table-hover">
                            <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="medTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="lab">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card p-3 border-danger">
                                <h5 class="text-danger mb-3">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­Øµ Ù…Ù† Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h5>
                                <table class="table table-bordered">
                                    <thead class="table-danger">
                                        <tr><th>Ø§Ù„Ù…Ø±ÙŠØ¶</th><th>Ø§Ù„ÙØ­Øµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr>
                                    </thead>
                                    <tbody id="pendingRequestsTable">
                                        <tr><td colspan="3" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="col-md-5">
                            <div class="card p-3 border-success">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="text-success mb-0">ğŸ’° Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ­ÙˆØµØ§Øª</h5>
                                    <button class="btn btn-sm btn-outline-success" onclick="loadLabData()">ØªØ­Ø¯ÙŠØ« ğŸ”„</button>
                                </div>
                                <table class="table table-sm">
                                    <thead><tr><th>Ø§Ù„ÙØ­Øµ</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>ØªØ¹Ø¯ÙŠÙ„</th></tr></thead>
                                    <tbody id="labSettingsTable">
                                        <tr><td colspan="3" class="text-center">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="usersAdmin">
                    <div class="card p-4 shadow-sm border-warning">
                        <h5 class="text-warning mb-4">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù…</h5>
                        <div class="row g-3">
                            <div class="col-md-3"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="newUserName" class="form-control"></div>
                            <div class="col-md-3"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="newUserPass" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                <select id="newUserRole" class="form-select">
                                    <option value="reception">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                                    <option value="doctor">Ø·Ø¨ÙŠØ¨</option>
                                    <option value="lab">Ù…Ø¹Ù…Ù„</option>
                                    <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
                                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end"><button class="btn btn-warning w-100" onclick="addNewUser()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button></div>
                        </div>
                        <hr>
                        <h6>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:</h6>
                        <ul id="usersList" class="list-group"></ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="prescriptionPrintArea" class="d-none">
        <div class="prescription-box text-end">
            <h2 class="text-center" style="color:#2c7a7b;">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h2>
            <hr>
            <div class="row">
                <div class="col-6"><strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> <span id="printPName"></span></div>
                <div class="col-6 text-start"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printDate"></span></div>
            </div>
            <div class="mt-4">
                <h5>Ø§Ù„Ø´ÙƒÙˆÙ‰:</h5><p id="printC"></p>
                <h5>Ø§Ù„ÙˆØµÙØ© Rx:</h5><p id="printDiagnosis" style="white-space: pre-wrap; font-size: 1.3rem;"></p>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Proxy Ù„ØªØ®Ø·ÙŠ Ù…Ø´Ø§ÙƒÙ„ Ø§Ù„Ø£Ù…Ø§Ù† HTTPS/HTTP
        const PROXY = "https://corsproxy.io/?";
        const API_URL = "http://alshifaclinic.somee.com/api.aspx";
        const API_BASE = PROXY + encodeURIComponent(API_URL);
        
        let lastRequestsCount = 0;

        let systemUsers = JSON.parse(localStorage.getItem('shifaUsers')) || {
            "admin": { pass: "123", role: "admin" },
            "lab": { pass: "lab123", role: "lab" },
            "doctor": { pass: "doc123", role: "doctor" }
        };

        function handleLogin() {
            const user = document.getElementById('username').value.toLowerCase().trim();
            const pass = document.getElementById('password').value;
            
            if (systemUsers[user] && systemUsers[user].pass === pass) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('userDisplay').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user}`;
                setupPermissions(systemUsers[user].role);
                setInterval(loadLabData, 30000); // ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 30 Ø«Ø§Ù†ÙŠØ©
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function setupPermissions(role) {
            document.querySelectorAll('.nav-item, .tab-pane, #adminStats').forEach(el => el.classList.add('hidden-section'));
            document.querySelectorAll('.nav-link').forEach(el => el.classList.remove('active'));

            if (role === 'admin') {
                document.querySelectorAll('.nav-item, .tab-pane, #adminStats').forEach(el => el.classList.remove('hidden-section'));
                document.getElementById('btn-reception').click();
                updateUsersTable();
                loadLabData();
            } else {
                document.querySelectorAll(`.tab-${role}`).forEach(el => el.classList.remove('hidden-section'));
                const content = document.getElementById(`${role}`);
                content.classList.remove('hidden-section');
                content.classList.add('active', 'show');
                const btn = document.getElementById(`btn-${role}`);
                if(btn) btn.classList.add('active');
                loadLabData();
            }
        }

        async function loadLabData() {
            const priceTable = document.getElementById('labSettingsTable');
            const pendingTable = document.getElementById('pendingRequestsTable');
            const docSelect = document.getElementById('doctorTestSelect');
            const notifyBadge = document.getElementById('labNotifyBadge');

            try {
                // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ø¹Ø§Ø± Ù…Ø¹ ØªØ®Ø·ÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„Ø¶Ù…Ø§Ù† Ø£Ø­Ø¯Ø« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                const priceRes = await fetch(`${API_BASE}${encodeURIComponent('?type=prices&t=' + Date.now())}`);
                const tests = await priceRes.json();
                
                if (priceTable) {
                    priceTable.innerHTML = tests.map(t => `<tr><td>${t.name}</td><td>${t.price}</td><td><button class="btn btn-sm btn-outline-primary">âœ</button></td></tr>`).join('');
                }
                
                if(docSelect) {
                    docSelect.innerHTML = tests.map(t => `<option value="${t.name}">${t.name} (${t.price} Ø¬.Ø³)</option>`).join('');
                }

                // Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ù†ØªØ¸Ø±Ø©
                const pendingRes = await fetch(`${API_BASE}${encodeURIComponent('?type=pending&t=' + Date.now())}`);
                const requests = await pendingRes.json();
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯ ÙˆØªÙ†Ø¨ÙŠÙ‡ ØµÙˆØªÙŠ Ø¥Ø°Ø§ Ø²Ø§Ø¯ Ø§Ù„Ø¹Ø¯Ø¯
                if (notifyBadge) {
                    if (requests.length > 0) {
                        notifyBadge.innerText = requests.length;
                        notifyBadge.style.display = 'inline-block';
                        if (requests.length > lastRequestsCount) {
                            document.getElementById('notificationSound').play().catch(e => console.log("Audio block"));
                        }
                    } else {
                        notifyBadge.style.display = 'none';
                    }
                    lastRequestsCount = requests.length;
                }

                if (pendingTable) {
                    if(requests.length > 0) {
                        pendingTable.innerHTML = requests.map(r => `
                            <tr>
                                <td>${r.patient}</td>
                                <td><span class="badge bg-danger">${r.test}</span></td>
                                <td><button class="btn btn-sm btn-success" onclick="completeTest('${r.patient}', '${r.test}')">Ø¥Ù†Ø¬Ø§Ø² âœ…</button></td>
                            </tr>`).join('');
                    } else {
                        pendingTable.innerHTML = '<tr><td colspan="3" class="text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ù…Ø¹Ù„Ù‚Ø©</td></tr>';
                    }
                }
            } catch(e) { 
                console.error("Connection Error:", e);
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥Ø¸Ù‡Ø§Ø± Ø±Ø³Ø§Ù„Ø© ØªÙØ§Ø¹Ù„ÙŠØ© ÙÙŠ Ø­Ø§Ù„ ÙØ´Ù„ Ø§Ù„Ø¨Ø±ÙˆÙƒØ³ÙŠ
            }
        }

        async function sendToLab() {
            const test = document.getElementById('doctorTestSelect').value;
            const patientSelect = document.getElementById('visitPatientSelect');
            const patient = patientSelect.options[patientSelect.selectedIndex]?.text || "Ù…Ø±ÙŠØ¶ Ø¹Ø§Ù…";
            
            try {
                const res = await fetch(API_BASE, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action: 'request', patient: patient, test: test })
                });
                if(res.ok) { 
                    alert("ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø¹Ù…Ù„ Ø¨Ù†Ø¬Ø§Ø­ ğŸ§ª"); 
                    loadLabData(); 
                }
            } catch(e) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±"); }
        }

        function completeTest(patient, test) {
            alert(`ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„ÙØ­Øµ: ${test} Ù„Ù„Ù…Ø±ÙŠØ¶: ${patient}`);
            loadLabData(); 
        }

        function updateUsersTable() {
            const list = document.getElementById('usersList');
            if(!list) return;
            list.innerHTML = "";
            for (let u in systemUsers) {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
                    <span><strong>${u}</strong> - ${systemUsers[u].role}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${u}')">Ø­Ø°Ù</button></li>`;
            }
        }

        function deleteUser(name) {
            if(name === 'admin') return alert("Ù…Ù…Ù†ÙˆØ¹ Ø­Ø°Ù Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ");
            delete systemUsers[name];
            localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
            updateUsersTable();
        }

        function addNewUser() {
            const name = document.getElementById('newUserName').value.toLowerCase().trim();
            const pass = document.getElementById('newUserPass').value;
            const role = document.getElementById('newUserRole').value;
            if(!name || !pass) return alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            systemUsers[name] = { pass: pass, role: role };
            localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
            updateUsersTable();
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
        }

        function printPrescription() {
            const select = document.getElementById('visitPatientSelect');
            document.getElementById('printPName').innerText = select.options[select.selectedIndex]?.text || "Ù…Ø±ÙŠØ¶ Ø¹Ø§Ù…";
            document.getElementById('printC').innerText = document.getElementById('doctorComplaint').value;
            document.getElementById('printDiagnosis').innerText = document.getElementById('diagnosis').value;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('ar-EG');
            window.print();
        }

        function registerPatient() { alert("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ ÙˆØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªØ°ÙƒØ±Ø© Ø¨Ù†Ø¬Ø§Ø­"); }
        function loadDoctorData() { loadLabData(); }
    </script>
</body>
</html>
