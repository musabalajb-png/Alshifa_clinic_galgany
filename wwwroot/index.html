<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³ÙˆØ¨Ø± 2026</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Arabic:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            font-family: 'Noto Sans Arabic', sans-serif;
        }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-50">
            <div class="w-16 h-16 border-4 border-teal-500 border-t-transparent rounded-full animate-spin mb-4"></div>
            <p class="text-lg font-semibold text-gray-700">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</p>
            <p id="loading-message" class="text-sm text-gray-500 mt-2">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
        </div>

        <!-- Login Page -->
        <div id="login-page" class="min-h-screen bg-gradient-to-br from-teal-50 via-blue-50 to-cyan-50 flex items-center justify-center p-4">
            <div class="w-full max-w-md">
                <div class="bg-white shadow-2xl rounded-2xl overflow-hidden">
                    <div class="p-8">
                        <div class="text-center mb-8">
                            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-teal-500 to-cyan-500 rounded-full mb-4">
                                <i data-lucide="heart-pulse" class="w-8 h-8 text-white"></i>
                            </div>
                            <h1 class="text-3xl font-bold text-gray-900 mb-2">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h1>
                            <p class="text-gray-600">Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ø³ÙˆØ¨Ø± 2026 - Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„</p>
                        </div>

                        <!-- Error Alert -->
                        <div id="login-error" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-start gap-3">
                            <i data-lucide="alert-circle" class="w-5 h-5 text-red-600 mt-0.5 flex-shrink-0"></i>
                            <p id="error-message" class="text-sm text-red-700"></p>
                        </div>

                        <!-- Login Form -->
                        <form id="login-form" class="space-y-6">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-3">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ± Ø§Ù„ÙˆØ¸ÙŠÙÙŠ</label>
                                <div class="grid grid-cols-2 gap-2" id="roles-container">
                                    <!-- Roles will be loaded dynamically -->
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                                <input type="password" id="password" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-teal-500 focus:border-transparent" required>
                            </div>

                            <button type="submit" class="w-full bg-gradient-to-r from-teal-500 to-cyan-500 hover:from-teal-600 hover:to-cyan-600 text-white font-semibold py-2 rounded-lg transition-all">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                        </form>

                        <div class="mt-8 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                            <p class="text-xs text-blue-700 font-semibold mb-2">ğŸ“‹ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†:</p>
                            <ul class="text-xs text-blue-600 space-y-1">
                                <li>â€¢ ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø´ÙØ±Ø© ÙˆÙ…Ø®Ø²Ù†Ø© Ø¨Ø£Ù…Ø§Ù†</li>
                                <li>â€¢ ÙŠÙ…ÙƒÙ† Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø· Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø¬Ø¯Ø¯</li>
                                <li>â€¢ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªÙØ­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹ ÙÙŠ Ø§Ù„Ù…ØªØµÙØ­</li>
                                <li>â€¢ ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø£Ù…Ø§Ù†</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <p class="text-center text-gray-600 text-sm mt-6">Ù†Ø¸Ø§Ù… Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙŠØ§Øª ÙˆØ§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©</p>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="hidden min-h-screen bg-gray-50">
            <header id="dashboard-header" class="bg-gradient-to-r from-teal-500 to-cyan-500 text-white shadow-lg sticky top-0 z-40">
                <div class="flex items-center justify-between px-4 py-4">
                    <div class="flex items-center gap-3">
                        <button id="sidebar-toggle" class="p-2 hover:bg-white/20 rounded-lg transition-colors">
                            <i data-lucide="menu" class="w-5 h-5"></i>
                        </button>
                        <div class="text-2xl">ğŸ¥</div>
                        <div>
                            <h1 class="text-xl font-bold">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h1>
                            <p id="user-role" class="text-sm opacity-90"></p>
                        </div>
                    </div>

                    <div class="flex items-center gap-4">
                        <div class="text-right">
                            <p id="user-name" class="text-sm font-semibold"></p>
                            <p id="current-date" class="text-xs opacity-75"></p>
                        </div>
                        <button id="logout-btn" class="p-2 hover:bg-white/20 rounded-lg transition-colors" title="ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>

                <div class="px-4 py-3 bg-white/10 flex gap-4 overflow-x-auto">
                    <div class="flex items-center gap-2 whitespace-nowrap">
                        <span class="text-sm">ğŸ‘¥ Ù…Ø±Ø¶Ù‰ Ø¬Ø¯Ø¯:</span>
                        <span id="stat-new-patients" class="font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-2 whitespace-nowrap">
                        <span class="text-sm">ğŸ§ª ÙØ­ÙˆØµØ§Øª:</span>
                        <span id="stat-completed-tests" class="font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-2 whitespace-nowrap">
                        <span class="text-sm">ğŸ’Š Ø±ÙˆØ´ØªØ§Øª:</span>
                        <span id="stat-dispensed-rx" class="font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-2 whitespace-nowrap">
                        <span class="text-sm">ğŸ‘¨â€âš•ï¸ Ù…ÙˆØ¸ÙÙŠÙ†:</span>
                        <span id="stat-employees" class="font-bold">0</span>
                    </div>
                    <div class="flex items-center gap-2 whitespace-nowrap">
                        <span class="text-sm">ğŸ’° Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</span>
                        <span id="stat-total-income" class="font-bold">0 Ø¬.Ø³</span>
                    </div>
                </div>
            </header>

            <div class="flex">
                <aside id="sidebar" class="w-64 bg-white shadow-lg p-4 space-y-2 max-h-[calc(100vh-120px)] overflow-y-auto transition-all duration-300">
                    <nav class="space-y-1">
                        <button data-tab="main" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors bg-teal-100 text-teal-700 font-semibold">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                        <div id="role-specific-tabs"></div>
                        <div id="admin-tabs" class="hidden">
                            <button data-tab="employees" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ‘¨â€âš•ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
                            <button data-tab="tests" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ§ª Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ­ÙˆØµØ§Øª</button>
                            <button data-tab="medicines" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ’Š Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©</button>
                            <button data-tab="overview" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø©</button>
                            <button data-tab="reports" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
                            <button data-tab="data" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">ğŸ’¾ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                            <button data-tab="settings" class="tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100">âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                        </div>
                    </nav>
                    
                    <div id="notifications-section" class="mt-6 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-yellow-800">ğŸ”” Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</h3>
                            <span id="notification-count" class="bg-red-500 text-white text-xs px-2 py-1 rounded-full">0</span>
                        </div>
                        <div id="notifications-list" class="space-y-2 max-h-40 overflow-y-auto">
                            <!-- Notifications will be added here dynamically -->
                        </div>
                    </div>
                    
                    <div class="mt-6">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">âš¡ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
                        <div class="space-y-1">
                            <button id="quick-add-employee" class="w-full text-right px-3 py-2 text-sm bg-blue-50 hover:bg-blue-100 text-blue-700 rounded transition-colors">ğŸ‘¨â€âš•ï¸ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
                            <button id="quick-add-test" class="w-full text-right px-3 py-2 text-sm bg-green-50 hover:bg-green-100 text-green-700 rounded transition-colors">ğŸ§ª Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ</button>
                            <button id="quick-add-medicine" class="w-full text-right px-3 py-2 text-sm bg-red-50 hover:bg-red-100 text-red-700 rounded transition-colors">ğŸ’Š Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡</button>
                        </div>
                    </div>
                </aside>

                <!-- Content Area -->
                <main id="content-area" class="flex-1 p-6 overflow-auto">
                    <div id="dashboard-content" class="space-y-6">
                        <div class="text-center py-12">
                            <i data-lucide="heart-pulse" class="w-16 h-16 text-teal-500 mx-auto mb-4"></i>
                            <h2 class="text-2xl font-bold text-gray-900 mb-2">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</h2>
                            <p class="text-gray-600">Ø§Ø®ØªØ± Ù‚Ø³Ù…Ù‹Ø§ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡</p>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Toast Notifications Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2 w-80"></div>

    <!-- Modal Container -->
    <div id="modal-container" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
            <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                <h3 id="modal-title" class="text-lg font-semibold"></h3>
                <button id="modal-close" class="p-1 hover:bg-gray-100 rounded">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="modal-body" class="p-4 overflow-y-auto max-h-[60vh]">
                <!-- Modal content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full mx-4">
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <i data-lucide="alert-triangle" class="w-8 h-8 text-red-500"></i>
                    <h3 class="text-lg font-semibold" id="confirm-title">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</h3>
                </div>
                <p id="confirm-message" class="text-gray-600 mb-6"></p>
                <div class="flex gap-2">
                    <button id="confirm-cancel" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">Ø¥Ù„ØºØ§Ø¡</button>
                    <button id="confirm-ok" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">ØªØ£ÙƒÙŠØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Offline Indicator -->
    <div id="offline-indicator" class="fixed bottom-4 left-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 hidden">
        <div class="flex items-center gap-2">
            <i data-lucide="wifi-off" class="w-4 h-4"></i>
            <span>Ø£Ù†Øª ØºÙŠØ± Ù…ØªØµÙ„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</span>
        </div>
    </div>

    <script>
        // ØªØ·Ø¨ÙŠÙ‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ø¹ Ø¥Ø¯Ø§Ø±Ø© Ù…ØªÙƒØ§Ù…Ù„Ø©
        
        class HospitalStateManager {
            constructor() {
                this.currentUser = null;
                this.data = {
                    employees: [],
                    patients: [],
                    appointments: [],
                    prescriptions: [],
                    labTests: [],
                    medicines: [],
                    nursingTasks: [],
                    transactions: [],
                    testTypes: [],
                    medicineCategories: []
                };
                this.notifications = [];
                this.backups = [];
                this.isOnline = navigator.onLine;
                this.init();
            }

            init() {
                this.loadFromLocalStorage();
                this.initializeDefaultData();
                this.setupAutoBackup();
                this.setupOfflineDetection();
                this.checkForUrgentTasks();
            }

            initializeDefaultData() {
                if (this.data.employees.length === 0) {
                    const defaultAdmin = {
                        id: '1',
                        username: 'admin',
                        password: this.hashPassword('Admin@2026'),
                        name: 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
                        role: 'admin',
                        email: 'admin@hospital.com',
                        phone: '0123456789',
                        department: 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©',
                        salary: 0,
                        hireDate: new Date(),
                        status: 'active',
                        permissions: ['all'],
                        color: 'from-gray-700 to-gray-800',
                        icon: 'âš™ï¸'
                    };
                    this.data.employees.push(defaultAdmin);
                    this.saveToLocalStorage();
                }

                if (this.data.testTypes.length === 0) {
                    const defaultTests = [
                        { id: '1', name: 'ØµÙˆØ±Ø© Ø¯Ù… ÙƒØ§Ù…Ù„Ø©', price: 150, category: 'Ø¯Ù…', duration: '30 Ø¯Ù‚ÙŠÙ‚Ø©' },
                        { id: '2', name: 'Ø³ÙƒØ± ØªØ±Ø§ÙƒÙ…ÙŠ', price: 120, category: 'Ø¯Ù…', duration: '1 ÙŠÙˆÙ…' },
                        { id: '3', name: 'ÙˆØ¸Ø§Ø¦Ù ÙƒØ¨Ø¯', price: 200, category: 'Ø¯Ù…', duration: '1 ÙŠÙˆÙ…' },
                        { id: '4', name: 'ØªØ­Ù„ÙŠÙ„ Ø¨ÙˆÙ„', price: 80, category: 'Ø¨ÙˆÙ„', duration: '30 Ø¯Ù‚ÙŠÙ‚Ø©' },
                        { id: '5', name: 'Ø£Ø´Ø¹Ø© Ø¹Ø§Ø¯ÙŠØ©', price: 250, category: 'Ø£Ø´Ø¹Ø©', duration: '1 Ø³Ø§Ø¹Ø©' }
                    ];
                    this.data.testTypes = defaultTests;
                }

                if (this.data.medicines.length === 0) {
                    const defaultMedicines = [
                        { id: '1', name: 'Ø¨Ø§Ù†Ø§Ø¯ÙˆÙ„', dosage: '500 Ù…Ø¬Ù…', stock: 100, price: 15, expiryDate: new Date('2026-12-31'), supplier: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©' },
                        { id: '2', name: 'Ø£Ù…ÙˆÙƒØ³ÙŠØ³ÙŠÙ„ÙŠÙ†', dosage: '500 Ù…Ø¬Ù…', stock: 50, price: 25, expiryDate: new Date('2025-06-30'), supplier: 'Ù…ØµÙ†Ø¹ Ø§Ù„Ø¯ÙˆØ§Ø¡' },
                        { id: '3', name: 'Ø£Ø¯ÙÙŠÙ„', dosage: '400 Ù…Ø¬Ù…', stock: 75, price: 20, expiryDate: new Date('2026-03-31'), supplier: 'Ø´Ø±ÙƒØ© Ø§Ù„Ø£Ø¯ÙˆÙŠØ©' }
                    ];
                    this.data.medicines = defaultMedicines;
                }

                if (this.data.medicineCategories.length === 0) {
                    this.data.medicineCategories = [
                        'Ù…Ø³ÙƒÙ†Ø§Øª', 'Ù…Ø¶Ø§Ø¯Ø§Øª Ø­ÙŠÙˆÙŠØ©', 'Ù…Ø¶Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ‡Ø§Ø¨', 'ÙÙŠØªØ§Ù…ÙŠÙ†Ø§Øª', 'Ø£Ø¯ÙˆÙŠØ© Ù…Ø²Ù…Ù†Ø©'
                    ];
                }
            }

            loadFromLocalStorage() {
                try {
                    const savedData = localStorage.getItem('hospitalData');
                    if (savedData) {
                        const parsed = JSON.parse(savedData);
                        this.data = { ...this.data, ...parsed };
                        this.restoreDates();
                    }
                    
                    const savedBackups = localStorage.getItem('hospitalBackups');
                    if (savedBackups) {
                        this.backups = JSON.parse(savedBackups);
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    this.showToast('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }

            saveToLocalStorage() {
                try {
                    localStorage.setItem('hospitalData', JSON.stringify(this.data));
                    localStorage.setItem('hospitalBackups', JSON.stringify(this.backups));
                } catch (error) {
                    console.error('Error saving data:', error);
                    this.showToast('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
                }
            }

            restoreDates() {
                const restoreDateFields = (obj, fields) => {
                    fields.forEach(field => {
                        if (obj[field] && typeof obj[field] === 'string') {
                            obj[field] = new Date(obj[field]);
                        }
                    });
                };

                this.data.employees.forEach(e => restoreDateFields(e, ['hireDate']));
                this.data.patients.forEach(p => restoreDateFields(p, ['registrationDate']));
                this.data.appointments.forEach(a => restoreDateFields(a, ['date']));
                this.data.prescriptions.forEach(p => restoreDateFields(p, ['date']));
                this.data.labTests.forEach(t => restoreDateFields(t, ['date']));
                this.data.medicines.forEach(m => restoreDateFields(m, ['expiryDate']));
                this.data.nursingTasks.forEach(t => restoreDateFields(t, ['date']));
                this.data.transactions.forEach(t => restoreDateFields(t, ['date']));
            }

            hashPassword(password) {
                return btoa(password).split('').reverse().join('');
            }

            verifyPassword(inputPassword, storedHash) {
                return this.hashPassword(inputPassword) === storedHash;
            }

            setupAutoBackup() {
                setInterval(() => {
                    this.createBackup();
                }, 3600000);
            }

            setupOfflineDetection() {
                window.addEventListener('online', () => {
                    this.isOnline = true;
                    document.getElementById('offline-indicator').classList.add('hidden');
                    this.showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'success');
                    this.syncOfflineChanges();
                });

                window.addEventListener('offline', () => {
                    this.isOnline = false;
                    document.getElementById('offline-indicator').classList.remove('hidden');
                    this.showToast('ÙÙ‚Ø¯Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
                });
            }

            syncOfflineChanges() {
                this.showToast('Ø¬Ø§Ø±ÙŠ Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...', 'info');
            }

            checkForUrgentTasks() {
                const now = new Date();
                const twoHoursFromNow = new Date(now.getTime() + 2 * 60 * 60 * 1000);

                const urgentTasks = this.data.nursingTasks.filter(task => {
                    if (task.status !== 'pending') return false;
                    const taskTime = new Date(`${task.date.toDateString()} ${task.time}`);
                    return taskTime < twoHoursFromNow && taskTime > now;
                });

                if (urgentTasks.length > 0) {
                    this.addNotification(`Ù„Ø¯ÙŠÙƒ ${urgentTasks.length} Ù…Ù‡Ø§Ù… ØªÙ…Ø±ÙŠØ¶ Ø¹Ø§Ø¬Ù„Ø©`);
                }

                const expiredMedicines = this.data.medicines.filter(med => {
                    return new Date(med.expiryDate) < new Date();
                });

                if (expiredMedicines.length > 0) {
                    this.addNotification(`Ù‡Ù†Ø§Ùƒ ${expiredMedicines.length} Ø¯ÙˆØ§Ø¡ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©`);
                }

                const lowStock = this.data.medicines.filter(med => med.stock < 10);
                if (lowStock.length > 0) {
                    this.addNotification(`Ù‡Ù†Ø§Ùƒ ${lowStock.length} Ø¯ÙˆØ§Ø¡ Ø¨Ù…Ø®Ø²ÙˆÙ† Ù…Ù†Ø®ÙØ¶`);
                }
            }

            addNotification(message, type = 'warning') {
                const notification = {
                    id: Date.now(),
                    message,
                    type,
                    timestamp: new Date(),
                    read: false
                };

                this.notifications.unshift(notification);
                this.updateNotificationsUI();
                this.showToast(message, type);
            }

            updateNotificationsUI() {
                const container = document.getElementById('notifications-list');
                const countElement = document.getElementById('notification-count');
                
                if (!container || !countElement) return;

                const unreadCount = this.notifications.filter(n => !n.read).length;
                countElement.textContent = unreadCount;

                container.innerHTML = this.notifications
                    .slice(0, 5)
                    .map(n => `
                        <div class="notification-item p-2 text-sm ${n.read ? 'text-gray-600' : 'text-gray-900 bg-yellow-100'} rounded border border-yellow-200" data-id="${n.id}">
                            <div class="flex justify-between">
                                <span>${n.message}</span>
                                <span class="text-xs text-gray-500">${this.formatTimeAgo(n.timestamp)}</span>
                            </div>
                        </div>
                    `)
                    .join('');
            }

            formatTimeAgo(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 60) return `Ù…Ù†Ø° ${diffMins} Ø¯Ù‚ÙŠÙ‚Ø©`;
                if (diffHours < 24) return `Ù…Ù†Ø° ${diffHours} Ø³Ø§Ø¹Ø©`;
                return `Ù…Ù†Ø° ${diffDays} ÙŠÙˆÙ…`;
            }

            createBackup() {
                const backup = {
                    id: Date.now(),
                    timestamp: new Date(),
                    data: JSON.parse(JSON.stringify(this.data))
                };

                this.backups.unshift(backup);
                
                if (this.backups.length > 10) {
                    this.backups.pop();
                }

                this.saveToLocalStorage();
                this.showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©', 'info');
            }

            restoreBackup(backupId) {
                const backup = this.backups.find(b => b.id === backupId);
                if (backup) {
                    this.data = JSON.parse(JSON.stringify(backup.data));
                    this.restoreDates();
                    this.saveToLocalStorage();
                    return true;
                }
                return false;
            }

            exportData(format = 'json') {
                const data = {
                    ...this.data,
                    exportDate: new Date().toISOString(),
                    version: '1.0.0'
                };

                if (format === 'json') {
                    return JSON.stringify(data, null, 2);
                } else if (format === 'csv') {
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ CSV (ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ­ÙˆÙŠÙ„ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹)
                }
            }

            importData(dataString) {
                try {
                    const importedData = JSON.parse(dataString);
                    
                    if (!this.validateImportedData(importedData)) {
                        throw new Error('Ù‡ÙŠÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ§Ù„Ø­');
                    }

                    this.data = { ...this.data, ...importedData };
                    this.restoreDates();
                    this.saveToLocalStorage();
                    return true;
                } catch (error) {
                    console.error('Import error:', error);
                    return false;
                }
            }

            validateImportedData(data) {
                const requiredFields = ['employees', 'patients', 'medicines'];
                return requiredFields.every(field => Array.isArray(data[field]));
            }

            showToast(message, type = 'info') {
                const container = document.getElementById('toast-container');
                const toastId = Date.now();
                
                const toast = document.createElement('div');
                toast.className = `toast-message p-4 rounded-lg shadow-lg fade-in ${this.getToastClass(type)}`;
                toast.innerHTML = `
                    <div class="flex items-center gap-3">
                        <i data-lucide="${this.getToastIcon(type)}" class="w-5 h-5"></i>
                        <span>${message}</span>
                    </div>
                `;

                container.appendChild(toast);
                lucide.createIcons();

                setTimeout(() => {
                    toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => toast.remove(), 300);
                }, 5000);
            }

            getToastClass(type) {
                const classes = {
                    success: 'bg-green-50 border border-green-200 text-green-800',
                    error: 'bg-red-50 border border-red-200 text-red-800',
                    warning: 'bg-yellow-50 border border-yellow-200 text-yellow-800',
                    info: 'bg-blue-50 border border-blue-200 text-blue-800'
                };
                return classes[type] || classes.info;
            }

            getToastIcon(type) {
                const icons = {
                    success: 'check-circle',
                    error: 'alert-circle',
                    warning: 'alert-triangle',
                    info: 'info'
                };
                return icons[type] || 'info';
            }

            getSystemStats() {
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const newPatients = this.data.patients.filter(p => {
                    const regDate = new Date(p.registrationDate);
                    regDate.setHours(0, 0, 0, 0);
                    return regDate.getTime() === today.getTime();
                }).length;

                const completedTests = this.data.labTests.filter(t => {
                    const testDate = new Date(t.date);
                    testDate.setHours(0, 0, 0, 0);
                    return testDate.getTime() === today.getTime() && t.status === 'completed';
                }).length;

                const dispensedRx = this.data.prescriptions.filter(p => {
                    const rxDate = new Date(p.date);
                    rxDate.setHours(0, 0, 0, 0);
                    return rxDate.getTime() === today.getTime() && p.status === 'dispensed';
                }).length;

                const totalIncome = this.data.transactions
                    .filter(t => {
                        const transDate = new Date(t.date);
                        transDate.setHours(0, 0, 0, 0);
                        return transDate.getTime() === today.getTime() && t.type === 'income';
                    })
                    .reduce((sum, t) => sum + t.amount, 0);

                return {
                    newPatients,
                    completedTests,
                    dispensedRx,
                    totalEmployees: this.data.employees.length,
                    totalTests: this.data.testTypes.length,
                    totalMedicines: this.data.medicines.length,
                    totalIncome
                };
            }

            updateStatsUI() {
                const stats = this.getSystemStats();
                
                document.getElementById('stat-new-patients').textContent = stats.newPatients;
                document.getElementById('stat-completed-tests').textContent = stats.completedTests;
                document.getElementById('stat-dispensed-rx').textContent = stats.dispensedRx;
                document.getElementById('stat-employees').textContent = stats.totalEmployees;
                document.getElementById('stat-total-income').textContent = `${stats.totalIncome.toLocaleString()} Ø¬.Ø³`;
            }

            addEmployee(employeeData) {
                const employee = {
                    id: `emp_${Date.now()}`,
                    ...employeeData,
                    password: this.hashPassword(employeeData.password),
                    hireDate: new Date(),
                    status: 'active'
                };

                this.data.employees.push(employee);
                this.saveToLocalStorage();
                this.updateStatsUI();
                this.showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù: ${employeeData.name}`, 'success');
                
                return employee;
            }

            updateEmployee(id, updates) {
                const index = this.data.employees.findIndex(e => e.id === id);
                if (index !== -1) {
                    if (updates.password) {
                        updates.password = this.hashPassword(updates.password);
                    }
                    this.data.employees[index] = {
                        ...this.data.employees[index],
                        ...updates
                    };
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                }
            }

            deleteEmployee(id) {
                const index = this.data.employees.findIndex(e => e.id === id);
                if (index !== -1) {
                    const employee = this.data.employees[index];
                    this.data.employees.splice(index, 1);
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                    this.showToast(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù: ${employee.name}`, 'success');
                    return true;
                }
                return false;
            }

            addTestType(testData) {
                const test = {
                    id: `test_${Date.now()}`,
                    ...testData
                };

                this.data.testTypes.push(test);
                this.saveToLocalStorage();
                this.updateStatsUI();
                this.showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ: ${testData.name}`, 'success');
                
                return test;
            }

            updateTestType(id, updates) {
                const index = this.data.testTypes.findIndex(t => t.id === id);
                if (index !== -1) {
                    this.data.testTypes[index] = {
                        ...this.data.testTypes[index],
                        ...updates
                    };
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                }
            }

            deleteTestType(id) {
                const index = this.data.testTypes.findIndex(t => t.id === id);
                if (index !== -1) {
                    const test = this.data.testTypes[index];
                    this.data.testTypes.splice(index, 1);
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                    this.showToast(`ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ­Øµ: ${test.name}`, 'success');
                    return true;
                }
                return false;
            }

            addMedicine(medicineData) {
                const medicine = {
                    id: `med_${Date.now()}`,
                    ...medicineData,
                    expiryDate: new Date(medicineData.expiryDate)
                };

                this.data.medicines.push(medicine);
                this.saveToLocalStorage();
                this.updateStatsUI();
                this.showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡: ${medicineData.name}`, 'success');
                
                return medicine;
            }

            updateMedicine(id, updates) {
                const index = this.data.medicines.findIndex(m => m.id === id);
                if (index !== -1) {
                    if (updates.expiryDate) {
                        updates.expiryDate = new Date(updates.expiryDate);
                    }
                    this.data.medicines[index] = {
                        ...this.data.medicines[index],
                        ...updates
                    };
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                }
            }

            deleteMedicine(id) {
                const index = this.data.medicines.findIndex(m => m.id === id);
                if (index !== -1) {
                    const medicine = this.data.medicines[index];
                    this.data.medicines.splice(index, 1);
                    this.saveToLocalStorage();
                    this.updateStatsUI();
                    this.showToast(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯ÙˆØ§Ø¡: ${medicine.name}`, 'success');
                    return true;
                }
                return false;
            }

            addMedicineCategory(category) {
                if (!this.data.medicineCategories.includes(category)) {
                    this.data.medicineCategories.push(category);
                    this.saveToLocalStorage();
                    this.showToast(`ØªÙ… Ø¥Ø¶Ø§ÙØ© ØªØµÙ†ÙŠÙ: ${category}`, 'success');
                }
            }

            checkPasswordStrength(password) {
                let strength = 0;
                if (password.length >= 8) strength++;
                if (/[A-Z]/.test(password)) strength++;
                if (/[a-z]/.test(password)) strength++;
                if (/[0-9]/.test(password)) strength++;
                if (/[^A-Za-z0-9]/.test(password)) strength++;
                
                if (strength <= 2) return 'weak';
                if (strength <= 4) return 'medium';
                return 'strong';
            }
        }

        class AuthManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
            }

            login(username, password) {
                const employee = this.stateManager.data.employees.find(
                    emp => emp.username === username && emp.status === 'active'
                );
                
                if (!employee) {
                    this.showError('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„');
                    return false;
                }

                if (!this.stateManager.verifyPassword(password, employee.password)) {
                    this.showError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                    return false;
                }

                this.stateManager.currentUser = {
                    id: employee.id,
                    username: employee.username,
                    role: employee.role,
                    name: employee.name,
                    department: employee.department,
                    status: 'online',
                    permissions: employee.permissions || []
                };

                localStorage.setItem('lastUser', JSON.stringify({
                    username: employee.username,
                    role: employee.role
                }));

                this.stateManager.addNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${employee.name}`, 'success');
                return true;
            }

            logout() {
                this.stateManager.currentUser = null;
                localStorage.removeItem('lastUser');
                this.stateManager.addNotification('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­', 'info');
            }

            showError(message) {
                const errorDiv = document.getElementById('login-error');
                const errorMessage = document.getElementById('error-message');
                
                errorDiv.classList.remove('hidden');
                errorMessage.textContent = message;
                
                setTimeout(() => {
                    errorDiv.classList.add('hidden');
                }, 5000);
            }

            hideError() {
                document.getElementById('login-error').classList.add('hidden');
            }
        }

        class DataManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
            }

            addPatient(patientData) {
                const patient = {
                    id: `patient_${Date.now()}`,
                    ...patientData,
                    registrationDate: new Date(),
                    status: 'waiting'
                };

                this.stateManager.data.patients.push(patient);
                this.stateManager.saveToLocalStorage();
                this.stateManager.updateStatsUI();
                this.stateManager.addNotification(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯: ${patientData.name}`, 'success');
                
                return patient;
            }

            updatePatient(id, updates) {
                const index = this.stateManager.data.patients.findIndex(p => p.id === id);
                if (index !== -1) {
                    this.stateManager.data.patients[index] = {
                        ...this.stateManager.data.patients[index],
                        ...updates
                    };
                    this.stateManager.saveToLocalStorage();
                    this.stateManager.updateStatsUI();
                }
            }

            addTransaction(transactionData) {
                const transaction = {
                    id: `trans_${Date.now()}`,
                    ...transactionData,
                    date: new Date()
                };

                this.stateManager.data.transactions.push(transaction);
                this.stateManager.saveToLocalStorage();
                this.stateManager.updateStatsUI();
                
                return transaction;
            }
        }

        class UIManager {
            constructor(stateManager, authManager, dataManager) {
                this.stateManager = stateManager;
                this.authManager = authManager;
                this.dataManager = dataManager;
                this.currentView = 'login';
                this.currentTab = 'main';
                this.init();
            }

            init() {
                this.initEventListeners();
                this.updateCurrentDate();
                this.loadRolesForLogin();
                setInterval(() => this.updateCurrentDate(), 60000);
            }

            initEventListeners() {
                document.getElementById('login-form').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });

                document.getElementById('sidebar-toggle').addEventListener('click', () => {
                    this.toggleSidebar();
                });

                document.getElementById('logout-btn').addEventListener('click', () => {
                    this.handleLogout();
                });

                document.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab-btn')) {
                        this.handleTabSelect(e.target.dataset.tab);
                    }
                });

                document.getElementById('quick-add-employee').addEventListener('click', () => {
                    this.showAddEmployeeForm();
                });

                document.getElementById('quick-add-test').addEventListener('click', () => {
                    this.showAddTestForm();
                });

                document.getElementById('quick-add-medicine').addEventListener('click', () => {
                    this.showAddMedicineForm();
                });

                document.getElementById('modal-close').addEventListener('click', () => {
                    this.hideModal();
                });

                document.getElementById('confirm-cancel').addEventListener('click', () => {
                    this.hideConfirmModal();
                });

                window.addEventListener('online', () => {
                    this.stateManager.isOnline = true;
                    this.showToast('ØªÙ… Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø§ØªØµØ§Ù„', 'success');
                });

                window.addEventListener('offline', () => {
                    this.stateManager.isOnline = false;
                    this.showToast('ÙÙ‚Ø¯Øª Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª', 'warning');
                });
            }

            loadRolesForLogin() {
                const rolesContainer = document.getElementById('roles-container');
                const activeEmployees = this.stateManager.data.employees.filter(emp => emp.status === 'active');
                
                rolesContainer.innerHTML = activeEmployees.map(emp => `
                    <button type="button" data-username="${emp.username}" class="role-btn p-3 rounded-lg text-sm font-medium transition-all bg-gray-100 text-gray-700 hover:bg-gray-200">${this.getRoleName(emp.role)} - ${emp.name}</button>
                `).join('');
                
                this.updateRoleNames();
            }

            getRoleName(role) {
                const roleNames = {
                    'admin': 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…',
                    'doctor': 'Ø§Ù„Ø·Ø¨ÙŠØ¨',
                    'reception': 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„',
                    'pharmacist': 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠ',
                    'lab': 'Ø§Ù„Ù…Ø¹Ù…Ù„',
                    'nurse': 'Ø§Ù„ØªÙ…Ø±ÙŠØ¶'
                };
                return roleNames[role] || role;
            }

            updateRoleNames() {
                document.querySelectorAll('.role-btn').forEach(btn => {
                    const role = btn.dataset.username;
                    const emp = this.stateManager.data.employees.find(e => e.username === role);
                    if (emp) {
                        btn.textContent = `${this.getRoleName(emp.role)} - ${emp.name}`;
                    }
                });
            }

            handleLogin() {
                const username = document.querySelector('.role-btn.bg-teal-500')?.dataset.username;
                const password = document.getElementById('password').value;

                if (!username) {
                    this.authManager.showError('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¯ÙˆØ± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…');
                    return;
                }

                this.authManager.hideError();

                if (this.authManager.login(username, password)) {
                    this.showDashboard();
                }
            }

            handleLogout() {
                if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                    this.authManager.logout();
                    this.showLogin();
                }
            }

            handleTabSelect(tab) {
                this.currentTab = tab;
                
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.classList.remove('bg-teal-100', 'text-teal-700', 'font-semibold');
                    btn.classList.add('text-gray-700', 'hover:bg-gray-100');
                });

                const activeBtn = document.querySelector(`[data-tab="${tab}"]`);
                activeBtn.classList.remove('text-gray-700', 'hover:bg-gray-100');
                activeBtn.classList.add('bg-teal-100', 'text-teal-700', 'font-semibold');

                this.loadTabContent(tab);
            }

            toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                const icon = document.querySelector('#sidebar-toggle i');
                
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    sidebar.classList.add('block');
                    icon.setAttribute('data-lucide', 'x');
                } else {
                    sidebar.classList.add('hidden');
                    icon.setAttribute('data-lucide', 'menu');
                }
            }

            updateCurrentDate() {
                const now = new Date();
                const options = { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric',
                    calendar: 'islamic-umalqura'
                };
                document.getElementById('current-date').textContent = now.toLocaleDateString('ar-SA', options);
            }

            showDashboard() {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                const user = this.stateManager.currentUser;
                document.getElementById('user-name').textContent = user.name;
                document.getElementById('user-role').textContent = this.getRoleName(user.role);
                
                const header = document.getElementById('dashboard-header');
                const emp = this.stateManager.data.employees.find(e => e.id === user.id);
                if (emp && emp.color) {
                    header.className = `bg-gradient-to-r ${emp.color} text-white shadow-lg sticky top-0 z-40`;
                }
                
                this.updateRoleTabs(user.role);
                this.stateManager.updateStatsUI();
                this.stateManager.updateNotificationsUI();
                this.loadTabContent('main');
                this.stateManager.showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ${user.name}`, 'success');
                
                document.getElementById('loading-screen').classList.add('hidden');
            }

            showLogin() {
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('password').value = '';
                this.authManager.hideError();
                this.loadRolesForLogin();
            }

            updateRoleTabs(role) {
                const tabsContainer = document.getElementById('role-specific-tabs');
                tabsContainer.innerHTML = '';

                if (role === 'admin') {
                    document.getElementById('admin-tabs').classList.remove('hidden');
                } else {
                    document.getElementById('admin-tabs').classList.add('hidden');
                    const roleTabs = {
                        reception: [
                            { id: 'patients', label: 'ğŸ‘¥ Ø§Ù„Ù…Ø±Ø¶Ù‰', icon: 'users' },
                            { id: 'appointments', label: 'ğŸ“… Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯', icon: 'calendar' }
                        ],
                        doctor: [
                            { id: 'consultation', label: 'ğŸ©º Ø§Ù„ÙƒØ´Ù', icon: 'stethoscope' },
                            { id: 'prescriptions', label: 'ğŸ’Š Ø§Ù„Ø±ÙˆØ´ØªØ§Øª', icon: 'pill' }
                        ],
                        pharmacist: [
                            { id: 'inventory', label: 'ğŸ“¦ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†', icon: 'package' },
                            { id: 'dispense', label: 'ğŸ’Š Ø§Ù„ØµØ±Ù', icon: 'syringe' }
                        ],
                        lab: [
                            { id: 'tests', label: 'ğŸ§ª Ø§Ù„ÙØ­ÙˆØµØ§Øª', icon: 'flask-conical' },
                            { id: 'results', label: 'ğŸ“Š Ø§Ù„Ù†ØªØ§Ø¦Ø¬', icon: 'clipboard-check' }
                        ],
                        nurse: [
                            { id: 'tasks', label: 'ğŸ“‹ Ø§Ù„Ù…Ù‡Ø§Ù…', icon: 'clipboard-list' },
                            { id: 'vitals', label: 'â¤ï¸ Ø§Ù„Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„Ø­ÙŠÙˆÙŠØ©', icon: 'activity' }
                        ]
                    };

                    const tabs = roleTabs[role] || [];
                    tabs.forEach(tab => {
                        const button = document.createElement('button');
                        button.className = 'tab-btn w-full text-right px-4 py-2 rounded-lg transition-colors text-gray-700 hover:bg-gray-100';
                        button.dataset.tab = tab.id;
                        button.innerHTML = tab.label;
                        tabsContainer.appendChild(button);
                    });
                }
            }

            loadTabContent(tab) {
                const contentArea = document.getElementById('dashboard-content');
                
                switch(tab) {
                    case 'main':
                        this.loadMainDashboard();
                        break;
                    case 'employees':
                        this.loadEmployeesManagement();
                        break;
                    case 'tests':
                        this.loadTestsManagement();
                        break;
                    case 'medicines':
                        this.loadMedicinesManagement();
                        break;
                    case 'overview':
                        this.loadAdminOverview();
                        break;
                    case 'reports':
                        this.loadAdminReports();
                        break;
                    case 'data':
                        this.loadAdminData();
                        break;
                    case 'settings':
                        this.loadAdminSettings();
                        break;
                    default:
                        this.loadMainDashboard();
                }
            }

            loadMainDashboard() {
                const role = this.stateManager.currentUser?.role;
                let content = '';

                if (role === 'admin') {
                    content = this.getAdminDashboardContent();
                } else {
                    content = this.getRoleDashboardContent(role);
                }

                document.getElementById('dashboard-content').innerHTML = content;
                this.initDashboardComponents();
                lucide.createIcons();
            }

            getAdminDashboardContent() {
                const stats = this.stateManager.getSystemStats();
                const totalPatients = this.stateManager.data.patients.length;
                const totalIncome = this.stateManager.data.transactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                const totalExpense = this.stateManager.data.transactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                return `
                    <div class="space-y-6">
                        <div>
                            <h2 class="text-3xl font-bold text-gray-900">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±</h2>
                            <p class="text-gray-600 mt-1">Ø¥Ø¯Ø§Ø±Ø© Ø´Ø§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰</p>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                            <div class="p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl">
                                <div class="text-3xl font-bold">${totalPatients}</div>
                                <p class="text-blue-100 mt-1">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</p>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl">
                                <div class="text-3xl font-bold">${stats.totalEmployees}</div>
                                <p class="text-green-100 mt-1">Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</p>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-red-500 to-red-600 text-white rounded-xl">
                                <div class="text-3xl font-bold">${stats.totalTests}</div>
                                <p class="text-red-100 mt-1">Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„ÙØ­ÙˆØµØ§Øª</p>
                            </div>
                            <div class="p-6 bg-gradient-to-br from-yellow-500 to-yellow-600 text-white rounded-xl">
                                <div class="text-3xl font-bold">${stats.totalMedicines}</div>
                                <p class="text-yellow-100 mt-1">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</p>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-xl shadow">
                                <h3 class="text-xl font-bold text-gray-900 mb-4">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</h3>
                                <div class="space-y-3">
                                    <div class="flex justify-between items-center p-3 bg-blue-50 rounded-lg">
                                        <span>Ù…Ø±Ø¶Ù‰ Ø¬Ø¯Ø¯</span>
                                        <span class="font-bold">${stats.newPatients}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                                        <span>ÙØ­ÙˆØµØ§Øª Ù…ÙƒØªÙ…Ù„Ø©</span>
                                        <span class="font-bold">${stats.completedTests}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                                        <span>Ø±ÙˆØ´ØªØ§Øª Ù…ØµØ±ÙØ©</span>
                                        <span class="font-bold">${stats.dispensedRx}</span>
                                    </div>
                                    <div class="flex justify-between items-center p-3 bg-purple-50 rounded-lg">
                                        <span>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…</span>
                                        <span class="font-bold">${stats.totalIncome.toLocaleString()} Ø¬.Ø³</span>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-xl shadow">
                                <h3 class="text-xl font-bold text-gray-900 mb-4">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ</h3>
                                <div class="space-y-4">
                                    <div class="p-4 bg-green-50 rounded-lg border-l-4 border-l-green-500">
                                        <p class="text-sm text-gray-600">Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</p>
                                        <p class="text-2xl font-bold text-green-600">${totalIncome.toLocaleString()} Ø¬.Ø³</p>
                                    </div>
                                    <div class="p-4 bg-red-50 rounded-lg border-l-4 border-l-red-500">
                                        <p class="text-sm text-gray-600">Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ©</p>
                                        <p class="text-2xl font-bold text-red-600">${totalExpense.toLocaleString()} Ø¬.Ø³</p>
                                    </div>
                                    <div class="p-4 bg-blue-50 rounded-lg border-l-4 border-l-blue-500">
                                        <p class="text-sm text-gray-600">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­</p>
                                        <p class="text-2xl font-bold text-blue-600">${(totalIncome - totalExpense).toLocaleString()} Ø¬.Ø³</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø³Ø±ÙŠØ¹Ø©</h3>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <button onclick="uiManager.showAddEmployeeForm()" class="p-4 bg-blue-50 hover:bg-blue-100 rounded-lg transition-colors flex items-center gap-3">
                                    <i data-lucide="user-plus" class="w-6 h-6 text-blue-600"></i>
                                    <div class="text-right">
                                        <p class="font-semibold text-gray-900">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</p>
                                        <p class="text-sm text-gray-600">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù…</p>
                                    </div>
                                </button>
                                <button onclick="uiManager.showAddTestForm()" class="p-4 bg-red-50 hover:bg-red-100 rounded-lg transition-colors flex items-center gap-3">
                                    <i data-lucide="flask-conical" class="w-6 h-6 text-red-600"></i>
                                    <div class="text-right">
                                        <p class="font-semibold text-gray-900">Ø¥Ø¶Ø§ÙØ© ÙØ­Øµ</p>
                                        <p class="text-sm text-gray-600">Ø¥Ø¶Ø§ÙØ© Ù†ÙˆØ¹ ÙØ­Øµ Ø¬Ø¯ÙŠØ¯</p>
                                    </div>
                                </button>
                                <button onclick="uiManager.showAddMedicineForm()" class="p-4 bg-green-50 hover:bg-green-100 rounded-lg transition-colors flex items-center gap-3">
                                    <i data-lucide="pill" class="w-6 h-6 text-green-600"></i>
                                    <div class="text-right">
                                        <p class="font-semibold text-gray-900">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡</p>
                                        <p class="text-sm text-gray-600">Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</p>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            getRoleDashboardContent(role) {
                const roleNames = {
                    'doctor': 'Ø§Ù„Ø£Ø·Ø¨Ø§Ø¡',
                    'reception': 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„',
                    'pharmacist': 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©',
                    'lab': 'Ø§Ù„Ù…Ø¹Ù…Ù„',
                    'nurse': 'Ø§Ù„ØªÙ…Ø±ÙŠØ¶'
                };

                return `
                    <div class="text-center py-12">
                        <i data-lucide="${this.getRoleIcon(role)}" class="w-16 h-16 ${this.getRoleColor(role)} mx-auto mb-4"></i>
                        <h2 class="text-2xl font-bold text-gray-900 mb-2">Ù‚Ø³Ù… ${roleNames[role] || role}</h2>
                        <p class="text-gray-600">Ø¥Ø¯Ø§Ø±Ø© Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù‚Ø³Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</p>
                    </div>
                `;
            }

            getRoleIcon(role) {
                const icons = {
                    'doctor': 'stethoscope',
                    'reception': 'users',
                    'pharmacist': 'pill',
                    'lab': 'flask-conical',
                    'nurse': 'heart'
                };
                return icons[role] || 'activity';
            }

            getRoleColor(role) {
                const colors = {
                    'doctor': 'text-green-500',
                    'reception': 'text-blue-500',
                    'pharmacist': 'text-yellow-500',
                    'lab': 'text-red-500',
                    'nurse': 'text-purple-500'
                };
                return colors[role] || 'text-gray-500';
            }

            initDashboardComponents() {
                // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
            }
        }

        // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        const stateManager = new HospitalStateManager();
        const authManager = new AuthManager(stateManager);
        const dataManager = new DataManager(stateManager);
        const uiManager = new UIManager(stateManager, authManager, dataManager);

        window.stateManager = stateManager;
        window.authManager = authManager;
        window.dataManager = dataManager;
        window.uiManager = uiManager;

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('hidden');
                lucide.createIcons();
            }, 1000);
        });
    </script>
</body>
</html>
