<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822118.png">
    
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026</title>
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22%D9%85%D8%AC%D9%85%D8%B9%20%D8%A7%D9%84%D8%B4%D9%81%D8%A7%D8%A1%22,%22short_name%22:%22%D8%A7%D9%84%D8%B4%D9%81%D8%A1%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f8fafc%22,%22theme_color%22:%22%232c7a7b%22,%22description%22:%22%D9%86%D8%B8%D8%A7%D9%85%20%D8%A5%D8%AF%D8%A7%D8%B1%D8%A9%20%D8%A7%D9%84%D9%85%D8%B3%D8%AA%D8%B4%D9%81%D9%8A%D8%A7%D8%AA%20%D9%88%D8%A7%D9%84%D8%B9%D9%8A%D8%A7%D8%AF%D8%A7%D8%AA%20%D8%A7%D9%84%D8%B0%D9%83%D9%8A%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22,%22purpose%22:%22any%22},{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22192x192%22,%22type%22:%22image/png%22,%22purpose%22:%22maskable%22}]}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
    <style>
        :root { 
            --primary-color: #2c7a7b; 
            --secondary-color: #f0fdf4; 
            --accent-blue: #0d6efd; 
            --accent-red: #dc3545; 
            --accent-green: #198754; 
            --accent-gold: #d4af37;
            --accent-warning: #ffc107;
            --accent-info: #17a2b8;
            --accent-purple: #6f42c1;
        }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .navbar { background: linear-gradient(135deg, var(--primary-color), #1f5a5a) !important; box-shadow: 0 2px 15px rgba(0,0,0,0.2); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); padding: 10px 20px !important; position: relative; }
        .nav-link.active { background-color: var(--accent-blue) !important; color: white !important; border-radius: 10px; }
        .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border-radius: 50%; padding: 3px 7px; font-size: 0.7rem; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; text-align: center; }
        .patient-btn { text-align: right; margin-bottom: 8px; border-right: 5px solid var(--primary-color); width: 100%; transition: 0.3s; padding: 12px 15px; background: white; border: 1px solid #dee2e6; border-radius: 10px; }
        .patient-btn.ready { border-right-color: #28a745; background-color: #f0fff4; }
        .patient-btn:hover { background-color: #f8f9fa; }
        .lab-result-item { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 4px solid var(--accent-blue); }
        .section-pane { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; padding: 20px; } }
        .search-box { position: relative; }
        .search-box input { padding-right: 40px; }
        .rx-item { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 8px; border-left: 4px solid var(--accent-green); }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        .sync-status { position: fixed; bottom: 10px; left: 10px; z-index: 1000; }
        .sync-btn { position: fixed; bottom: 10px; right: 10px; z-index: 1000; }
        .medical-record { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .nursing-schedule { border-left: 5px solid var(--accent-purple); }
        .expiry-warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .stock-critical { background: #f8d7da; border-left: 5px solid #dc3545; }
        .library-card { height: 100%; transition: all 0.3s; }
        .library-card:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .form-check { padding-right: 1.5em; margin-bottom: 0.5rem; }
        .form-check-input { margin-right: -1.5em; }
        #labTestsChecklist { scrollbar-width: thin; scrollbar-color: var(--primary-color) #f1f1f1; }
        #labTestsChecklist::-webkit-scrollbar { width: 8px; }
        #labTestsChecklist::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        #labTestsChecklist::-webkit-scrollbar-thumb { background: var(--primary-color); border-radius: 4px; }
        
        /* PWA Styles */
        .install-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50px; padding: 10px 20px; font-weight: bold; box-shadow: 0 4px 15px rgba(0,0,0,0.2); transition: all 0.3s; }
        .install-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.3); }
        .pwa-status { position: fixed; top: 10px; left: 10px; z-index: 9999; }
        .pwa-notification { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 20px; z-index: 10000; max-width: 400px; direction: rtl; }
        .offline-banner { position: fixed; top: 0; left: 0; right: 0; background: #dc3545; color: white; text-align: center; padding: 10px; z-index: 9998; }
        .online-banner { position: fixed; top: 0; left: 0; right: 0; background: #28a745; color: white; text-align: center; padding: 10px; z-index: 9998; }
        #appVersion { font-size: 0.8em; color: #6c757d; }
        
        /* Advanced Permissions Styles */
        .permission-badge { font-size: 0.7em; padding: 2px 6px; margin-right: 3px; }
        .permission-row { border-bottom: 1px solid #eee; padding: 8px 0; }
        .permission-header { background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%); color: white; padding: 10px; border-radius: 8px; }
        .permission-toggle { transform: scale(0.9); }
        .user-status-online { color: #28a745; animation: pulse 2s infinite; }
        .user-status-offline { color: #dc3545; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .role-badge { font-size: 0.75em; padding: 3px 8px; }
        .permission-modal { max-height: 80vh; overflow-y: auto; }
        .password-strength { height: 5px; border-radius: 2px; margin-top: 5px; transition: all 0.3s; }
        
        /* New Styles for Workflow */
        .workflow-step { border-left: 4px solid; padding: 10px; margin: 5px 0; border-radius: 8px; }
        .step-reception { border-color: #0d6efd; background: #e7f1ff; }
        .step-doctor { border-color: #198754; background: #e8f5e8; }
        .step-lab { border-color: #dc3545; background: #fde8e8; }
        .step-pharmacy { border-color: #ffc107; background: #fff8e1; }
        .step-nursing { border-color: #6f42c1; background: #f0e8ff; }
        .step-completed { background: #d4edda !important; }
        .patient-flow { display: flex; justify-content: space-between; margin: 10px 0; }
        .flow-arrow { color: #6c757d; margin: 0 10px; }
        
        /* Admin Dashboard Styles */
        .admin-stat-card { border-radius: 12px; padding: 15px; color: white; text-align: center; min-height: 100px; display: flex; flex-direction: column; justify-content: center; }
        .admin-chart-container { height: 300px; position: relative; }
        .quick-action-btn { width: 100%; margin: 5px 0; }
        .system-health { font-size: 0.9em; }
        .health-good { color: #28a745; }
        .health-warning { color: #ffc107; }
        .health-critical { color: #dc3545; }
        .transaction-item { border-left: 4px solid; padding: 8px; margin: 5px 0; border-radius: 6px; }
        .transaction-income { border-color: #28a745; background: #d4edda; }
        .transaction-expense { border-color: #dc3545; background: #f8d7da; }
        .staff-avatar { width: 40px; height: 40px; border-radius: 50%; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        
        /* New Styles from Version 2 */
        .bg-medical { background: #eef2f3; border-right: 5px solid var(--primary-color); }
        .border-purple { border-color: var(--accent-purple) !important; }
        .btn-outline-purple { color: var(--accent-purple); border-color: var(--accent-purple); }
        .btn-outline-purple:hover { background-color: var(--accent-purple); color: white; }
        
        /* Ø¥Ø¶Ø§ÙØ© Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª */
        .admin-login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            display: none;
        }
        
        .security-warning {
            border-left: 5px solid #dc3545;
            background: #f8d7da;
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .access-log {
            font-size: 0.8em;
            color: #6c757d;
            border-top: 1px solid #dee2e6;
            padding-top: 5px;
            margin-top: 10px;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ© */
        .prescription-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
        }
        
        .medicine-entry {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid var(--accent-green);
        }
        
        .add-medicine-btn {
            border: 2px dashed #0d6efd;
            color: #0d6efd;
            background: transparent;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }
        
        .add-medicine-btn:hover {
            background: #e7f1ff;
            border-color: #0a58ca;
        }
        
        .pharmacy-daily-stats {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .prescription-list-item {
            border-left: 4px solid #ffc107;
            background: #fff8e1;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .lab-results-panel {
            background: #e8f4fd;
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border-left: 5px solid #0d6efd;
        }
        
        .lab-result-badge {
            background: #0d6efd;
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8em;
        }
        
        /* Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† */
        .admin-tabs {
            background: white;
            border-radius: 10px;
            padding: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .admin-tab-btn {
            margin: 0 5px;
            padding: 8px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .admin-tab-btn.active {
            background: var(--primary-color);
            color: white;
        }
        
        .admin-tab-btn:hover {
            background: #e7f1ff;
        }
        
        .staff-card {
            border-left: 5px solid var(--accent-blue);
            margin-bottom: 10px;
            transition: all 0.3s;
        }
        
        .staff-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .staff-role-badge {
            font-size: 0.7em;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .staff-admin { background: #dc3545; color: white; }
        .staff-doctor { background: #198754; color: white; }
        .staff-reception { background: #0d6efd; color: white; }
        .staff-pharmacy { background: #ffc107; color: #000; }
        .staff-lab { background: #6f42c1; color: white; }
        .staff-nursing { background: #17a2b8; color: white; }
        
        .reset-system-card {
            border: 2px dashed var(--accent-red);
            background: #fff5f5;
            text-align: center;
            padding: 30px;
            border-radius: 15px;
        }
        
        .reset-system-card h5 {
            color: var(--accent-red);
        }
        
        .system-backup {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printArea" class="hidden-section">
        <div class="text-center border-bottom pb-3 mb-3">
            <h2 style="color: var(--primary-color);">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h2>
            <p>Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø¬Ù„Ù‚Ù†ÙŠ</p>
            <h5 id="printTitle">Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©</h5>
            <small id="printDate"></small>
        </div>
        <div id="printContent" class="fs-5"></div>
        <div class="mt-5 pt-3 border-top text-center">
            <p>Ø§Ø³Ù… ÙˆØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¨: <strong id="printDoctorName"></strong></p>
            <p>Ù†ØªÙ…Ù†Ù‰ Ù„ÙƒÙ… Ø¹Ø§Ø¬Ù„ Ø§Ù„Ø´ÙØ§Ø¡</p>
        </div>
    </div>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginOverlay" class="no-print" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(rgba(44, 122, 123, 0.9), rgba(44, 122, 123, 0.8)); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg animate__animated animate__zoomIn" style="width: 420px; border-top: 8px solid var(--accent-gold);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="70">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted small">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø·Ø¨ÙŠØ©</p>
                <div class="alert alert-info mt-2">
                    <small>ğŸ”’ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ùƒ ÙÙ‚Ø·</small>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="username" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" autocomplete="username">
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ğŸ” ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" autocomplete="current-password">
            </div>
            
            <div class="mb-3">
                <select id="loginDept" class="form-select" onchange="updateLoginPlaceholder()">
                    <option value="">Ø§Ø®ØªØ± Ù‚Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„</option>
                    <option value="admin">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</option>
                    <option value="reception">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                    <option value="doctor">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</option>
                    <option value="lab">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                    <option value="pharmacy">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                    <option value="nursing">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                </select>
            </div>
            
            <button class="btn btn-primary w-100 fw-bold py-2 mb-3" onclick="handleLogin()">
                ğŸš€ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
            </button>
            
            <div class="security-warning">
                <strong>âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ø§Ù†:</strong>
                <small class="d-block mt-1">Ù‡Ø°Ø§ Ø§Ù„Ù†Ø¸Ø§Ù… Ø­ØµØ±ÙŠ Ù„Ù„Ø¹Ø§Ù…Ù„ÙŠÙ† Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³Ø©. Ø¹Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„.</small>
            </div>
            
            <div class="text-center mt-3">
                <button class="btn btn-sm btn-outline-secondary" onclick="showRecoveryOptions()">
                    <small>â“ Ù†Ø³ÙŠØª Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ØŸ</small>
                </button>
                <button class="btn btn-sm btn-outline-info ms-2" onclick="showEmergencyAccess()" id="emergencyBtn" style="display: none;">
                    <small>ğŸš¨ ÙˆØµÙˆÙ„ Ø·Ø§Ø±Ø¦</small>
                </button>
            </div>
            
            <div class="access-log text-center mt-2">
                <small>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: <span id="lastLoginTime">--</span></small>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div id="mainContent" class="hidden-section">
        <!-- PWA Status -->
        <div class="pwa-status no-print">
            <div id="pwaStatus" class="badge bg-info">PWA: Ù†Ø´Ø·</div>
        </div>
        
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="navbar navbar-dark mb-4 no-print py-2">
            <div class="container d-flex justify-content-between text-white align-items-center">
                <span class="navbar-brand fw-bold">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ 2026</span>
                <div class="d-flex align-items-center">
                    <span id="currentUserDisplay" class="badge bg-white text-dark p-2 mx-2"></span>
                    <span id="clockDisplay" class="badge bg-info text-dark mx-2"></span>
                    <span id="connectionStatus" class="badge bg-success mx-2">Ù…ØªØµÙ„ Ù…Ø­Ù„ÙŠØ§Ù‹</span>
                    <button class="btn btn-sm btn-outline-light ms-2" onclick="openUserMenu()">ğŸ‘¤</button>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </nav>

        <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <div class="container">
            <ul class="nav nav-pills mb-4 shadow-sm p-2 bg-white rounded-4 justify-content-center no-print" id="mainTabs">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© <span id="doctorBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„ <span id="labBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© <span id="pharBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-nursing-li"><button class="nav-link" id="btn-nursing" onclick="switchSection('nursing')">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶ <span id="nurseBadge" class="badge bg-danger ms-1 hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ±</button></li>
            </ul>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… -->
            <div class="tab-content">
                <!-- Ù‚Ø³Ù… Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
                <div id="reception-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card p-4 border-top border-primary border-4">
                                <h5 class="fw-bold mb-3">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
                                <input type="text" id="pName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ">
                                <div class="row g-2 mb-2">
                                    <div class="col-4"><input type="number" id="pAge" class="form-control" placeholder="Ø§Ù„Ø¹Ù…Ø±"></div>
                                    <div class="col-8"><input type="text" id="pAddress" class="form-control" placeholder="Ø§Ù„Ø³ÙƒÙ† / Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"></div>
                                </div>
                                <div class="bg-light p-2 rounded mb-3">
                                    <label class="small fw-bold">Ø±Ø³ÙˆÙ… ØªØ°ÙƒØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨:</label>
                                    <input type="number" id="pTicket" class="form-control" value="2000">
                                </div>
                                <button class="btn btn-primary w-100 fw-bold" onclick="registerPatient()">âœ… Ø­ÙØ¸ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø·Ø¨ÙŠØ¨</button>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card p-4">
                                <h5 class="fw-bold mb-3">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…</h5>
                                <div id="receptionList"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© -->
                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3">
                                <h6>Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„ÙƒØ´Ù</h6>
                                <div id="doctorQueue"></div>
                            </div>
                        </div>
                        <div class="col-md-8">
                            <div id="doctorWorkArea" class="card p-4 hidden-section border-top border-success border-5">
                                <h4 id="currentPatientName" class="text-success fw-bold"></h4>
                                <hr>
                                
                                <!-- Ù‚Ø³Ù… Ø§Ù„Ø´ÙƒÙˆÙ‰ ÙˆØ§Ù„ØªØ´Ø®ÙŠØµ -->
                                <label class="fw-bold">Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶:</label>
                                <textarea id="complaint" class="form-control mb-3" rows="2"></textarea>
                                
                                <label class="fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ:</label>
                                <textarea id="diagnosis" class="form-control mb-3" rows="2" placeholder="ØªØ´Ø®ÙŠØµ Ø§Ù„Ø­Ø§Ù„Ø©..."></textarea>
                                
                                <!-- Ù‚Ø³Ù… Ø·Ù„Ø¨ Ø§Ù„ÙØ­ÙˆØµØ§Øª -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label class="fw-bold small">Ø·Ù„Ø¨ ÙØ­ÙˆØµØ§Øª:</label>
                                        <select id="labSelect" class="form-select mb-2" multiple style="height: 100px;"></select>
                                        <button class="btn btn-sm btn-outline-danger w-100" onclick="orderLab()">ğŸ§ª Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø¹Ù…Ù„</button>
                                    </div>
                                    
                                    <!-- Ù‚Ø³Ù… ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ© -->
                                    <div class="col-md-6">
                                        <label class="fw-bold small">Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©:</label>
                                        <button class="btn btn-sm btn-primary w-100 mb-2" onclick="addMedicineItem()">â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡</button>
                                        <div id="prescriptionItems" class="mb-2">
                                            <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
                                        </div>
                                        <button class="btn btn-sm btn-success w-100 mb-2" onclick="generatePrescription()">ğŸ“ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø±ÙˆØ´ØªØ©</button>
                                        <button class="btn btn-sm btn-warning w-100" onclick="orderPharmacy()">ğŸ’Š Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©</button>
                                    </div>
                                </div>
                                
                                <!-- Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© -->
                                <div id="labResultsPanel" class="lab-results-panel hidden-section">
                                    <h6>ğŸ“‹ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª:</h6>
                                    <div id="labResultsDisplay"></div>
                                </div>
                                
                                <div class="mb-3 p-2 bg-light rounded">
                                    <label class="fw-bold small">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª ØªÙ…Ø±ÙŠØ¶ÙŠØ© (Ø­Ù‚Ù†/Ø¯Ø±ÙŠØ¨Ø§Øª):</label>
                                    <input type="text" id="nurseNotes" class="form-control mb-2" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª...">
                                    <button class="btn btn-sm btn-outline-purple w-100" onclick="orderNurse()">ğŸ’‰ Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªÙ…Ø±ÙŠØ¶</button>
                                </div>
                                <button class="btn btn-success w-100 fw-bold" onclick="completeVisit()">ğŸ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø²ÙŠØ§Ø±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="card p-4 border-top border-danger border-5">
                        <h5 class="fw-bold">ğŸ§ª Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­Øµ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
                        <div id="labList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
                    <div class="pharmacy-daily-stats">
                        <div class="row">
                            <div class="col-md-8">
                                <h5>ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø±ÙƒØ²ÙŠØ©</h5>
                                <h3>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…: <span id="dailySalesTotal">0</span> Ø¬.Ø³</h3>
                            </div>
                            <div class="col-md-4 text-end">
                                <button class="btn btn-light mt-2" onclick="resetDailySales()">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯ Ø§Ù„ÙŠÙˆÙ…ÙŠ</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
                    <div class="card p-3 mb-3">
                        <h6>ğŸ“‹ Ø±ÙˆØ´ØªØ§Øª Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©</h6>
                        <div id="dailyPrescriptionsList"></div>
                    </div>
                    
                    <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                    <div class="card p-4 border-top border-warning border-5">
                        <h5 class="fw-bold">ğŸ“‹ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h5>
                        <div id="pharmacyList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶ -->
                <div id="nursing-sec" class="section-pane hidden-section">
                    <div class="card p-4 border-top border-purple border-5">
                        <h5 class="fw-bold">ğŸ’‰ ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ¶</h5>
                        <div id="nurseList" class="row g-3"></div>
                    </div>
                </div>

                <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± -->
                <div id="admin-sec" class="section-pane hidden-section">
                    <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± -->
                    <div class="admin-tabs mb-4">
                        <button class="admin-tab-btn active" onclick="switchAdminTab('dashboard')">ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
                        <button class="admin-tab-btn" onclick="switchAdminTab('staff')">ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
                        <button class="admin-tab-btn" onclick="switchAdminTab('reset')">ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…</button>
                    </div>
                    
                    <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
                    <div id="admin-dashboard" class="admin-tab-content">
                        <div class="row g-3 mb-4">
                            <div class="col-md-3"><div class="stat-card bg-primary"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</h6><h3 id="admIncClinic">0</h3></div></div>
                            <div class="col-md-3"><div class="stat-card bg-danger"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„Ù…Ø¹Ù…Ù„</h6><h3 id="admIncLab">0</h3></div></div>
                            <div class="col-md-3"><div class="stat-card bg-warning"><h6>Ø¥ÙŠØ±Ø§Ø¯ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="admIncPhar">0</h3></div></div>
                            <div class="col-md-3"><div class="stat-card bg-success"><h6>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ„ÙŠ</h6><h3 id="admIncTotal">0</h3></div></div>
                        </div>

                        <div class="row">
                            <div class="col-md-4">
                                <div class="card p-3">
                                    <h6>â• Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ ÙØ­Øµ</h6>
                                    <input type="text" id="admLabName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ">
                                    <input type="number" id="admLabPrice" class="form-control mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                                    <button class="btn btn-danger btn-sm w-100" onclick="adminAddLab()">Ø­ÙØ¸ Ø§Ù„ÙØ­Øµ</button>
                                </div>
                                <div class="card p-3 mt-3">
                                    <h6>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                                    <input type="text" id="admMedName" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
                                    <input type="number" id="admMedPrice" class="form-control mb-2" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                                    <input type="number" id="admMedQty" class="form-control mb-2" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©">
                                    <button class="btn btn-warning btn-sm w-100" onclick="adminAddMed()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙˆØ§Ø¡</button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card p-3">
                                    <h6>ğŸ“Š ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡</h6>
                                    <div class="btn-group w-100 mb-3">
                                        <button class="btn btn-outline-dark btn-sm" onclick="renderReport('day')">ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ</button>
                                        <button class="btn btn-outline-dark btn-sm" onclick="renderReport('week')">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                                        <button class="btn btn-outline-dark btn-sm" onclick="renderReport('month')">Ø´Ù‡Ø±ÙŠ</button>
                                    </div>
                                    <div id="reportArea" class="bg-light p-3 rounded">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ù„Ù„Ø¹Ø±Ø¶...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
                    <div id="admin-staff" class="admin-tab-content hidden-section">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="card p-4">
                                    <h5 class="fw-bold mb-3">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h5>
                                    <input type="text" id="newStaffUsername" class="form-control mb-2" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                                    <input type="password" id="newStaffPassword" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                                    <input type="text" id="newStaffName" class="form-control mb-2" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                                    <select id="newStaffRole" class="form-select mb-3">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
                                        <option value="admin">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</option>
                                        <option value="reception">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                                        <option value="doctor">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</option>
                                        <option value="lab">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                                        <option value="pharmacy">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                                        <option value="nursing">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                                    </select>
                                    <button class="btn btn-primary w-100" onclick="addNewStaff()">â• Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
                                </div>
                            </div>
                            <div class="col-md-8">
                                <div class="card p-4">
                                    <h5 class="fw-bold mb-3">ğŸ‘¥ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</h5>
                                    <div id="staffList" class="row g-3">
                                        <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù‡Ù†Ø§ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… -->
                    <div id="admin-reset" class="admin-tab-content hidden-section">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="reset-system-card">
                                    <h5>ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ</h5>
                                    <p class="text-muted">Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø³ÙŠØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ø§Ù‹ Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯.</p>
                                    <p><strong>âš ï¸ ØªØ­Ø°ÙŠØ±:</strong> Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© ØºÙŠØ± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©.</p>
                                    
                                    <div class="mt-4">
                                        <button class="btn btn-danger btn-lg w-100 mb-3" onclick="resetDailySystem()">
                                            ğŸ”„ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ
                                        </button>
                                        <small class="text-muted">Ø¢Ø®Ø± ØªØµÙÙŠØ±: <span id="lastResetTime">Ù„Ù… ÙŠØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø¹Ø¯</span></small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="system-backup">
                                    <h5>ğŸ’¾ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</h5>
                                    <p>Ø§Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù‚Ø¨Ù„ Ø§Ù„ØªØµÙÙŠØ±</p>
                                    <button class="btn btn-light mt-2" onclick="createSystemBackup()">ğŸ’¾ Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©</button>
                                </div>
                                
                                <div class="card p-3 mt-3">
                                    <h6>ğŸ“‹ Ù…Ø§ Ø³ÙŠØªÙ… ØªØµÙÙŠØªÙ‡:</h6>
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item">âœ… Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</li>
                                        <li class="list-group-item">âœ… Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</li>
                                        <li class="list-group-item">âœ… Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</li>
                                        <li class="list-group-item">âœ… Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©</li>
                                        <li class="list-group-item">âœ… Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</li>
                                        <li class="list-group-item">âœ… Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ© -->
    <div id="prescriptionModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">ğŸ“ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="prescriptionContent">
                        <!-- Ø³ÙŠØªÙ… ØªØ¹Ø¨Ø¦Ø© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±ÙˆØ´ØªØ© Ù‡Ù†Ø§ -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥ØºÙ„Ø§Ù‚</button>
                    <button type="button" class="btn btn-primary" onclick="printPrescription()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="editStaffModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning text-white">
                    <h5 class="modal-title">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editStaffId">
                    <div class="mb-3">
                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                        <input type="text" id="editStaffUsername" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
                        <input type="text" id="editStaffName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ø§Ù„Ø¯ÙˆØ±</label>
                        <select id="editStaffRole" class="form-select">
                            <option value="admin">ğŸ‘‘ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…</option>
                            <option value="reception">ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                            <option value="doctor">ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø·Ø¨ÙŠØ¨</option>
                            <option value="lab">ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                            <option value="pharmacy">ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                            <option value="nursing">ğŸ’‰ Ø§Ù„ØªÙ…Ø±ÙŠØ¶</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ© Ø¥Ø°Ø§ Ù„Ù… ØªØ±Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±)</label>
                        <input type="password" id="editStaffPassword" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-warning" onclick="saveStaffChanges()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù -->
    <div id="confirmDeleteModal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">âš ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ÙˆØ¸ÙØŸ</p>
                    <p><strong>âš ï¸ ØªØ­Ø°ÙŠØ±:</strong> Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!</p>
                    <input type="hidden" id="deleteStaffId">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-danger" onclick="deleteStaffConfirmed()">ğŸ—‘ï¸ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ============================================
        // Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
        // ============================================

        const USERS = {
            'admin': { password: '123', role: 'admin', name: 'Ø§Ù„Ù…Ø¯ÙŠØ±' },
            'doctor': { password: 'doc123', role: 'doctor', name: 'Ø§Ù„Ø·Ø¨ÙŠØ¨' },
            'reception': { password: 'rec123', role: 'reception', name: 'Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„' },
            'pharmacist': { password: 'ph123', role: 'pharmacy', name: 'Ø§Ù„ØµÙŠØ¯Ù„ÙŠ' },
            'lab': { password: 'lab123', role: 'lab', name: 'Ø§Ù„Ù…Ø¹Ù…Ù„' },
            'nurse': { password: 'nur123', role: 'nursing', name: 'Ø§Ù„ØªÙ…Ø±ÙŠØ¶' }
        };

        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø£Ù…Ø§Ù† Ø§Ù„Ù†Ø¸Ø§Ù…
        const SECURITY_SETTINGS = {
            emergencyCode: 'SHIFA2026EMERG',
            maxLoginAttempts: 5,
            lockoutTime: 15, // Ø¯Ù‚Ø§Ø¦Ù‚
            sessionTimeout: 30, // Ø¯Ù‚Ø§Ø¦Ù‚
            enableAuditLog: true
        };

        let currentUser = null;
        let patients = JSON.parse(localStorage.getItem('shifa_pats')) || [];
        let labRequests = JSON.parse(localStorage.getItem('shifa_lab')) || [];
        let pharmOrders = JSON.parse(localStorage.getItem('shifa_rx')) || [];
        let nursingTasks = JSON.parse(localStorage.getItem('shifa_nursing_tasks')) || [];
        let financials = JSON.parse(localStorage.getItem('shifa_fin')) || { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0, total: 0 };
        let staffMembers = JSON.parse(localStorage.getItem('shifa_staff')) || [];
        let medicalLibrary = JSON.parse(localStorage.getItem('shifa_library')) || [];
        let backups = JSON.parse(localStorage.getItem('shifa_backups')) || [];
        let securityLog = JSON.parse(localStorage.getItem('shifa_security_log')) || [];
        
        // Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        let labTests = JSON.parse(localStorage.getItem('shifa_labTests')) || [
            {name: 'CBC', price: 5000},
            {name: 'Malaria', price: 2000},
            {name: 'Glucose', price: 1000},
            {name: 'Cholesterol', price: 3000}
        ];
        
        let inventory = JSON.parse(localStorage.getItem('shifa_inventory')) || [
            {name: 'Panadol', price: 1000, qty: 100},
            {name: 'Antibiotic', price: 2500, qty: 50},
            {name: 'Vitamin C', price: 1500, qty: 75}
        ];
        
        // Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        let dailySales = JSON.parse(localStorage.getItem('shifa_daily_sales')) || {
            total: 0,
            prescriptions: []
        };

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
        let loginAttempts = JSON.parse(localStorage.getItem('shifa_login_attempts')) || {};
        let lastActivityTime = Date.now();
        let activePatient = null;
        let prescriptionItems = [];
        
        // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
        let systemSettings = JSON.parse(localStorage.getItem('shifa_settings')) || {
            lastReset: null,
            dailyResetAuto: false,
            backupCount: 0
        };

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
        // ============================================

        function initStaffMembers() {
            // Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ Ù‚Ù… Ø¨ØªÙ‡ÙŠØ¦ØªÙ‡Ø§ Ù…Ù† USERS
            if (staffMembers.length === 0) {
                staffMembers = Object.keys(USERS).map(username => ({
                    id: Date.now() + Math.random(),
                    username: username,
                    password: USERS[username].password,
                    name: USERS[username].name,
                    role: USERS[username].role,
                    status: 'active',
                    created: new Date().toISOString(),
                    lastLogin: null
                }));
                localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            }
        }

        function loadStaffList() {
            const container = document.getElementById('staffList');
            if (!container) return;
            
            container.innerHTML = staffMembers.map(staff => `
                <div class="col-md-6">
                    <div class="card p-3 staff-card">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${staff.name}</h6>
                                <small class="text-muted">@${staff.username}</small>
                                <div class="mt-2">
                                    <span class="staff-role-badge staff-${staff.role}">
                                        ${getRoleName(staff.role)}
                                    </span>
                                    <span class="badge ${staff.status === 'active' ? 'bg-success' : 'bg-secondary'}">
                                        ${staff.status === 'active' ? 'Ù†Ø´Ø·' : 'ØºÙŠØ± Ù†Ø´Ø·'}
                                    </span>
                                </div>
                            </div>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-warning" onclick="editStaff('${staff.id}')">âœï¸</button>
                                <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteStaff('${staff.id}')">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="mt-2 small text-muted">
                            <div>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${new Date(staff.created).toLocaleDateString('ar-EG')}</div>
                            ${staff.lastLogin ? `<div>Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„: ${new Date(staff.lastLogin).toLocaleDateString('ar-EG')}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getRoleName(role) {
            const roles = {
                'admin': 'ğŸ‘‘ Ù…Ø¯ÙŠØ±',
                'doctor': 'ğŸ‘¨â€âš•ï¸ Ø·Ø¨ÙŠØ¨',
                'reception': 'ğŸ“‹ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„',
                'pharmacy': 'ğŸ’Š ØµÙŠØ¯Ù„ÙŠ',
                'lab': 'ğŸ§ª Ù…Ø¹Ù…Ù„',
                'nursing': 'ğŸ’‰ ØªÙ…Ø±ÙŠØ¶'
            };
            return roles[role] || role;
        }

        function addNewStaff() {
            const username = document.getElementById('newStaffUsername').value.trim();
            const password = document.getElementById('newStaffPassword').value;
            const name = document.getElementById('newStaffName').value.trim();
            const role = document.getElementById('newStaffRole').value;
            
            if (!username || !password || !name || !role) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„!');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
            if (staffMembers.some(staff => staff.username === username)) {
                alert('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }
            
            const newStaff = {
                id: Date.now() + Math.random(),
                username: username,
                password: password,
                name: name,
                role: role,
                status: 'active',
                created: new Date().toISOString(),
                lastLogin: null
            };
            
            staffMembers.push(newStaff);
            localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            
            // ØªØ­Ø¯ÙŠØ« USERS Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„ÙÙˆØ±ÙŠ
            USERS[username] = {
                password: password,
                role: role,
                name: name
            };
            
            // Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„
            document.getElementById('newStaffUsername').value = '';
            document.getElementById('newStaffPassword').value = '';
            document.getElementById('newStaffName').value = '';
            document.getElementById('newStaffRole').value = '';
            
            loadStaffList();
            alert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function editStaff(staffId) {
            const staff = staffMembers.find(s => s.id === staffId);
            if (!staff) return;
            
            document.getElementById('editStaffId').value = staffId;
            document.getElementById('editStaffUsername').value = staff.username;
            document.getElementById('editStaffName').value = staff.name;
            document.getElementById('editStaffRole').value = staff.role;
            document.getElementById('editStaffPassword').value = '';
            
            const modal = new bootstrap.Modal(document.getElementById('editStaffModal'));
            modal.show();
        }

        function saveStaffChanges() {
            const staffId = document.getElementById('editStaffId').value;
            const staffIndex = staffMembers.findIndex(s => s.id === staffId);
            
            if (staffIndex === -1) return;
            
            const username = document.getElementById('editStaffUsername').value.trim();
            const name = document.getElementById('editStaffName').value.trim();
            const role = document.getElementById('editStaffRole').value;
            const password = document.getElementById('editStaffPassword').value;
            
            if (!username || !name || !role) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!');
                return;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ØªÙƒØ±Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø¨Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ)
            const duplicate = staffMembers.find((s, index) => 
                s.username === username && index !== staffIndex
            );
            if (duplicate) {
                alert('âš ï¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„!');
                return;
            }
            
            // Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª
            staffMembers[staffIndex].username = username;
            staffMembers[staffIndex].name = name;
            staffMembers[staffIndex].role = role;
            
            if (password) {
                staffMembers[staffIndex].password = password;
            }
            
            localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            
            // ØªØ­Ø¯ÙŠØ« USERS
            USERS[username] = {
                password: password || staffMembers[staffIndex].password,
                role: role,
                name: name
            };
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editStaffModal'));
            modal.hide();
            
            loadStaffList();
            alert('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!');
        }

        function confirmDeleteStaff(staffId) {
            const staff = staffMembers.find(s => s.id === staffId);
            if (!staff) return;
            
            // Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
            if (staff.username === 'admin') {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ!');
                return;
            }
            
            // Ù…Ù†Ø¹ Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
            if (currentUser && staff.username === currentUser.u) {
                alert('âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø­Ø°Ù Ø­Ø³Ø§Ø¨Ùƒ Ø£Ø«Ù†Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„!');
                return;
            }
            
            document.getElementById('deleteStaffId').value = staffId;
            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        }

        function deleteStaffConfirmed() {
            const staffId = document.getElementById('deleteStaffId').value;
            const staffIndex = staffMembers.findIndex(s => s.id === staffId);
            
            if (staffIndex === -1) return;
            
            const username = staffMembers[staffIndex].username;
            
            // Ø­Ø°Ù Ù…Ù† staffMembers
            staffMembers.splice(staffIndex, 1);
            localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            
            // Ø­Ø°Ù Ù…Ù† USERS
            delete USERS[username];
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            modal.hide();
            
            loadStaffList();
            alert('âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙˆØ¸Ù Ø¨Ù†Ø¬Ø§Ø­!');
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù…
        // ============================================

        function resetDailySystem() {
            if (!confirm('âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠØŸ\n\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø§Ù„ØªØ§Ù„ÙŠØ©:\nâ€¢ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\nâ€¢ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\nâ€¢ Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\nâ€¢ Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø¹Ù„Ù‚Ø©\nâ€¢ Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\n\nÙ‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù†Ù‡!')) {
                return;
            }
            
            // Ø­ÙØ¸ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© ØªÙ„Ù‚Ø§Ø¦ÙŠØ©
            createAutoBackup();
            
            // 1. ØªØµÙÙŠØ± Ø§Ù„Ù…Ø±Ø¶Ù‰ - Ø¥Ø¨Ù‚Ø§Ø¡ ÙÙ‚Ø· Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ÙƒØªÙ…Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠ
            const completedPatients = patients.filter(p => p.status === 'completed');
            const today = new Date().toISOString().split('T')[0];
            
            // Ù†Ø¨Ø¯Ø£ ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ Ø¨Ù…Ø±Ø¶Ù‰ Ø¬Ø¯Ø¯ ÙÙ‚Ø·
            patients = completedPatients; // Ù†Ø­ØªÙØ¸ Ø¨Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ÙƒØªÙ…Ù„ÙŠÙ† ÙƒØ³Ø¬Ù„ ØªØ§Ø±ÙŠØ®ÙŠ
            
            // 2. ØªØµÙÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù…Ù„
            labRequests = [];
            localStorage.setItem('shifa_lab', JSON.stringify(labRequests));
            
            // 3. ØªØµÙÙŠØ± Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©
            pharmOrders = [];
            localStorage.setItem('shifa_rx', JSON.stringify(pharmOrders));
            
            // 4. ØªØµÙÙŠØ± Ù…Ù‡Ø§Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶
            nursingTasks = [];
            localStorage.setItem('shifa_nursing_tasks', JSON.stringify(nursingTasks));
            
            // 5. ØªØµÙÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            dailySales = {
                total: 0,
                prescriptions: []
            };
            localStorage.setItem('shifa_daily_sales', JSON.stringify(dailySales));
            
            // 6. ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø¶Ù‰
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            
            // 7. ØªØ­Ø¯ÙŠØ« Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            systemSettings.lastReset = new Date().toISOString();
            localStorage.setItem('shifa_settings', JSON.stringify(systemSettings));
            
            // 8. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
            updateBadges();
            
            // 9. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            if (currentUser) {
                switchSection(currentUser.r);
            }
            
            // 10. ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± ØªØµÙÙŠØ±
            document.getElementById('lastResetTime').textContent = new Date().toLocaleString('ar-EG');
            
            alert('âœ… ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ Ø¨Ù†Ø¬Ø§Ø­!\nØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…ÙƒØªÙ…Ù„ÙŠÙ†.');
        }

        function createSystemBackup() {
            const backupData = {
                timestamp: new Date().toISOString(),
                patients: patients,
                labRequests: labRequests,
                pharmOrders: pharmOrders,
                nursingTasks: nursingTasks,
                dailySales: dailySales,
                staffMembers: staffMembers,
                labTests: labTests,
                inventory: inventory
            };
            
            backups.unshift(backupData);
            if (backups.length > 10) backups = backups.slice(0, 10); // Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù€ 10 Ù†Ø³Ø® ÙÙ‚Ø·
            
            localStorage.setItem('shifa_backups', JSON.stringify(backups));
            systemSettings.backupCount = backups.length;
            localStorage.setItem('shifa_settings', JSON.stringify(systemSettings));
            
            alert(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­!\nØ±Ù‚Ù… Ø§Ù„Ù†Ø³Ø®Ø©: ${backups.length}\nØ§Ù„ÙˆÙ‚Øª: ${new Date().toLocaleString('ar-EG')}`);
        }

        function createAutoBackup() {
            const backupData = {
                timestamp: new Date().toISOString(),
                patients: patients,
                labRequests: labRequests,
                pharmOrders: pharmOrders,
                nursingTasks: nursingTasks,
                dailySales: dailySales,
                type: 'auto_reset_backup'
            };
            
            backups.unshift(backupData);
            if (backups.length > 10) backups = backups.slice(0, 10);
            
            localStorage.setItem('shifa_backups', JSON.stringify(backups));
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø¯ÙŠØ±
        // ============================================

        function switchAdminTab(tabName) {
            // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
            document.querySelectorAll('.admin-tab-content').forEach(el => {
                el.classList.add('hidden-section');
            });
            
            // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù†Ø´Ø· Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('.admin-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            document.getElementById(`admin-${tabName}`).classList.remove('hidden-section');
            
            // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
            event.target.classList.add('active');
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†ØŒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            if (tabName === 'staff') {
                loadStaffList();
            }
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØµÙÙŠØ±ØŒ ØªØ­Ù…ÙŠÙ„ Ø¢Ø®Ø± ÙˆÙ‚Øª ØªØµÙÙŠØ±
            if (tabName === 'reset') {
                if (systemSettings.lastReset) {
                    document.getElementById('lastResetTime').textContent = 
                        new Date(systemSettings.lastReset).toLocaleString('ar-EG');
                }
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©
        // ============================================

        function addMedicineItem() {
            const container = document.getElementById('prescriptionItems');
            const itemId = Date.now();
            
            const itemHTML = `
                <div class="medicine-entry" id="medItem-${itemId}">
                    <div class="row g-2 mb-2">
                        <div class="col-md-5">
                            <select class="form-select medicine-select" onchange="updateMedicineDetails(${itemId})">
                                <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡</option>
                                ${inventory.map(med => `<option value="${med.name}" data-price="${med.price}">${med.name} - ${med.price} Ø¬.Ø³</option>`).join('')}
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="number" class="form-control qty-input" value="1" min="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" onchange="updateMedicineDetails(${itemId})">
                        </div>
                        <div class="col-md-3">
                            <input type="text" class="form-control dosage-input" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø© (Ù…Ø«Ø§Ù„: 3 Ù…Ø±Ø§Øª ÙŠÙˆÙ…ÙŠØ§Ù‹)">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-danger btn-sm w-100" onclick="removeMedicineItem(${itemId})">âœ•</button>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-8">
                            <input type="text" class="form-control notes-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©">
                        </div>
                        <div class="col-md-4">
                            <span class="badge bg-info price-display" id="price-${itemId}">0 Ø¬.Ø³</span>
                        </div>
                    </div>
                </div>
            `;
            
            container.insertAdjacentHTML('beforeend', itemHTML);
            prescriptionItems.push({
                id: itemId,
                name: '',
                price: 0,
                qty: 1,
                dosage: '',
                notes: '',
                total: 0
            });
        }

        function removeMedicineItem(itemId) {
            const element = document.getElementById(`medItem-${itemId}`);
            if (element) {
                element.remove();
                prescriptionItems = prescriptionItems.filter(item => item.id !== itemId);
            }
        }

        function updateMedicineDetails(itemId) {
            const element = document.getElementById(`medItem-${itemId}`);
            if (!element) return;
            
            const select = element.querySelector('.medicine-select');
            const qtyInput = element.querySelector('.qty-input');
            const dosageInput = element.querySelector('.dosage-input');
            const notesInput = element.querySelector('.notes-input');
            const priceDisplay = element.querySelector('.price-display');
            
            const selectedMedicine = inventory.find(med => med.name === select.value);
            const qty = parseInt(qtyInput.value) || 1;
            
            const itemIndex = prescriptionItems.findIndex(item => item.id === itemId);
            if (itemIndex !== -1 && selectedMedicine) {
                prescriptionItems[itemIndex] = {
                    id: itemId,
                    name: selectedMedicine.name,
                    price: selectedMedicine.price,
                    qty: qty,
                    dosage: dosageInput.value,
                    notes: notesInput.value,
                    total: selectedMedicine.price * qty
                };
                
                priceDisplay.textContent = `${prescriptionItems[itemIndex].total.toLocaleString()} Ø¬.Ø³`;
            }
        }

        function generatePrescription() {
            if (!activePatient) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            if (prescriptionItems.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ© Ù„Ù„Ø±ÙˆØ´ØªØ©');
                return;
            }
            
            const totalAmount = prescriptionItems.reduce((sum, item) => sum + item.total, 0);
            
            const prescriptionHTML = `
                <div class="prescription-header text-center mb-4">
                    <h4>ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h4>
                    <p>Ø§Ù„Ø³ÙˆØ¯Ø§Ù† - Ø¬Ù„Ù‚Ù†ÙŠ</p>
                </div>
                
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h5>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶</h5>
                        <p><strong>Ø§Ù„Ø§Ø³Ù…:</strong> ${activePatient.name}</p>
                        <p><strong>Ø§Ù„Ø¹Ù…Ø±:</strong> ${activePatient.age || '--'}</p>
                        <p><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> ${new Date().toLocaleDateString('ar-EG')}</p>
                    </div>
                    <div class="col-md-6">
                        <h5>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¨</h5>
                        <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> Ø¯. ${currentUser?.name || 'Ø·Ø¨ÙŠØ¨'}</p>
                        <p><strong>Ø§Ù„ØªÙˆÙ‚ÙŠØ¹:</strong> ________________</p>
                    </div>
                </div>
                
                <div class="mb-4">
                    <h5>Ø§Ù„ØªØ´Ø®ÙŠØµ:</h5>
                    <p class="p-3 bg-light rounded">${document.getElementById('diagnosis').value || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ´Ø®ÙŠØµ Ù…Ø­Ø¯Ø¯'}</p>
                </div>
                
                <div class="mb-4">
                    <h5>Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØµÙˆÙØ©:</h5>
                    <table class="table table-bordered">
                        <thead class="table-primary">
                            <tr>
                                <th>#</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                                <th>Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${prescriptionItems.map((item, index) => `
                                <tr>
                                    <td>${index + 1}</td>
                                    <td>${item.name}</td>
                                    <td>${item.qty}</td>
                                    <td>${item.dosage || '--'}</td>
                                    <td>${item.notes || '--'}</td>
                                    <td>${item.total.toLocaleString()} Ø¬.Ø³</td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot class="table-success">
                            <tr>
                                <td colspan="5" class="text-end"><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong></td>
                                <td><strong>${totalAmount.toLocaleString()} Ø¬.Ø³</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="alert alert-info">
                    <h6>ğŸ“‹ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø¹Ø§Ù…Ø©:</h6>
                    <ul>
                        <li>ÙŠØ¬Ø¨ ØªÙ†Ø§ÙˆÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª</li>
                        <li>Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙÙŠ Ø­Ø§Ù„Ø© Ø¸Ù‡ÙˆØ± Ø£ÙŠ Ø£Ø¹Ø±Ø§Ø¶ Ø¬Ø§Ù†Ø¨ÙŠØ©</li>
                        <li>Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø¬Ø±Ø¹Ø§Øª Ø¨Ø¯Ù‚Ø©</li>
                    </ul>
                </div>
                
                <div class="text-center mt-4">
                    <p>_________________________________</p>
                    <p><strong>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¨</strong></p>
                    <p>Ø¯. ${currentUser?.name || 'Ø·Ø¨ÙŠØ¨'}</p>
                </div>
            `;
            
            document.getElementById('prescriptionContent').innerHTML = prescriptionHTML;
            
            // Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ´ØªØ© ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶
            activePatient.prescription = {
                date: new Date().toISOString(),
                doctor: currentUser?.name || 'Ø·Ø¨ÙŠØ¨',
                diagnosis: document.getElementById('diagnosis').value,
                medicines: prescriptionItems,
                totalAmount: totalAmount
            };
            
            saveData();
            
            const modal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
            modal.show();
        }

        function printPrescription() {
            const printContent = document.getElementById('prescriptionContent').innerHTML;
            
            document.getElementById('printTitle').textContent = 'Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©';
            document.getElementById('printDate').textContent = new Date().toLocaleDateString('ar-EG');
            document.getElementById('printDoctorName').textContent = currentUser?.name || 'Ø·Ø¨ÙŠØ¨';
            document.getElementById('printContent').innerHTML = printContent;
            
            // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© - Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
        // ============================================

        function loadDailySales() {
            document.getElementById('dailySalesTotal').textContent = dailySales.total.toLocaleString();
            
            const container = document.getElementById('dailyPrescriptionsList');
            container.innerHTML = dailySales.prescriptions.map((pres, index) => `
                <div class="prescription-list-item">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${index + 1}. ${pres.patientName}</strong>
                            <small class="d-block">${pres.date}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-success">${pres.totalAmount.toLocaleString()} Ø¬.Ø³</span>
                        </div>
                    </div>
                    <div class="mt-2">
                        <small><strong>Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:</strong> ${pres.medicines.map(m => `${m.name} (${m.qty})`).join('ØŒ ')}</small>
                    </div>
                </div>
            `).join('');
        }

        function resetDailySales() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©ØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø±ÙˆØ´ØªØ§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø© Ø§Ù„ÙŠÙˆÙ….')) {
                dailySales = {
                    total: 0,
                    prescriptions: []
                };
                localStorage.setItem('shifa_daily_sales', JSON.stringify(dailySales));
                loadDailySales();
                alert('âœ… ØªÙ… ØªØµÙÙŠØ± Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©');
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù…Ù„ - Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª
        // ============================================

        function loadLab() {
            const list = document.getElementById('labList');
            const waiting = patients.filter(p => p.status === 'waiting_lab');
            
            list.innerHTML = waiting.map(p => {
                const total = p.tests?.reduce((s, t) => s + t.price, 0) || 0;
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-danger border-5">
                        <h6>${p.name} <span class="badge bg-dark float-end">${total} Ø¬.Ø³</span></h6>
                        ${(p.tests || []).map((t, i) => `
                            <div class="mb-2">
                                <label>${t.name}:</label>
                                <div class="input-group">
                                    <input type="text" class="form-control form-control-sm" 
                                           id="labResult-${p.id}-${i}"
                                           placeholder="Ø£Ø¯Ø®Ù„ Ù†ØªÙŠØ¬Ø© ${t.name}"
                                           value="${t.result || ''}"
                                           onchange="updateLabResult(${p.id}, ${i}, this.value)">
                                    <span class="input-group-text">${t.price} Ø¬.Ø³</span>
                                </div>
                            </div>
                        `).join('')}
                        <button class="btn btn-danger btn-sm w-100 mt-2" onclick="finishLab(${p.id})">âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø·Ø¨ÙŠØ¨</button>
                    </div>
                </div>`;
            }).join('');
        }

        function updateLabResult(patientId, testIndex, result) {
            const patient = patients.find(p => p.id === patientId);
            if (patient && patient.tests && patient.tests[testIndex]) {
                patient.tests[testIndex].result = result;
                saveData();
            }
        }

        function finishLab(id) { 
            const patient = patients.find(x => x.id === id);
            if (patient) {
                patient.status = 'waiting_doctor';
                
                // Ø¥Ø¶Ø§ÙØ© Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø¥Ù„Ù‰ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±ÙŠØ¶
                if (!patient.labResults) patient.labResults = [];
                patient.labResults.push({
                    date: new Date().toISOString(),
                    tests: patient.tests || [],
                    technician: currentUser?.name || 'ÙÙ†ÙŠ Ù…Ø¹Ù…Ù„'
                });
                
                saveData(); 
                loadLab(); 
                playNotify();
                alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ù„Ù„Ø·Ø¨ÙŠØ¨');
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© - Ø¹Ø±Ø¶ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª
        // ============================================

        function displayLabResults() {
            if (!activePatient || !activePatient.labResults || activePatient.labResults.length === 0) {
                document.getElementById('labResultsPanel').classList.add('hidden-section');
                return;
            }
            
            const latestResults = activePatient.labResults[activePatient.labResults.length - 1];
            const display = document.getElementById('labResultsDisplay');
            
            let resultsHTML = `
                <div class="mb-2">
                    <strong>ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ­Øµ:</strong> ${new Date(latestResults.date).toLocaleDateString('ar-EG')}
                    <span class="lab-result-badge ms-2">${latestResults.technician}</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                        <thead class="table-info">
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„ÙØ­Øµ</th>
                                <th>Ø§Ù„Ù†ØªÙŠØ¬Ø©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${(latestResults.tests || []).map(test => `
                                <tr>
                                    <td>${test.name}</td>
                                    <td><strong>${test.result || 'Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªÙŠØ¬Ø©'}</strong></td>
                                    <td>${test.price} Ø¬.Ø³</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            display.innerHTML = resultsHTML;
            document.getElementById('labResultsPanel').classList.remove('hidden-section');
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© - Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª
        // ============================================

        function loadPharmacy() {
            const list = document.getElementById('pharmacyList');
            const waiting = patients.filter(p => p.status === 'waiting_pharmacy');
            
            list.innerHTML = waiting.map(p => {
                const total = p.prescription?.totalAmount || 
                              (p.meds || []).reduce((s, m) => s + (m.price * (m.qty || 1)), 0);
                
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-warning border-5">
                        <div class="d-flex justify-content-between mb-2">
                            <h6>${p.name}</h6>
                            <span class="badge bg-warning text-dark">${total.toLocaleString()} Ø¬.Ø³</span>
                        </div>
                        
                        ${(p.prescription?.medicines || p.meds || []).map((m, index) => `
                            <div class="alert alert-sm alert-light mb-1">
                                <div class="d-flex justify-content-between">
                                    <span>${m.name}</span>
                                    <span>${m.qty || 1} Ã— ${m.price} Ø¬.Ø³</span>
                                </div>
                                ${m.dosage ? `<small class="text-muted">Ø§Ù„Ø¬Ø±Ø¹Ø©: ${m.dosage}</small><br>` : ''}
                                <small class="text-muted">Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­: ${getMedicineStock(m.name)}</small>
                            </div>
                        `).join('')}
                        
                        <div class="mt-3">
                            <button class="btn btn-warning btn-sm w-100" onclick="dispenseMedicine(${p.id})">
                                ğŸ’Š ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ ÙˆØ®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
                            </button>
                            <button class="btn btn-outline-info btn-sm w-100 mt-1" onclick="viewPrescriptionDetails(${p.id})">
                                ğŸ“‹ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±ÙˆØ´ØªØ©
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
            
            loadDailySales();
        }

        function getMedicineStock(medicineName) {
            const medicine = inventory.find(m => m.name === medicineName);
            return medicine ? medicine.qty : 0;
        }

        function dispenseMedicine(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient) return;
            
            const medicines = patient.prescription?.medicines || patient.meds || [];
            let canDispense = true;
            let insufficientMedicines = [];
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙˆÙØ± Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            medicines.forEach(m => {
                const medicine = inventory.find(med => med.name === m.name);
                if (!medicine || medicine.qty < (m.qty || 1)) {
                    canDispense = false;
                    insufficientMedicines.push(m.name);
                }
            });
            
            if (!canDispense) {
                alert(`âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© ÙƒØ§ÙÙŠØ© Ù…Ù†: ${insufficientMedicines.join(', ')}`);
                return;
            }
            
            // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
            let totalAmount = 0;
            medicines.forEach(m => {
                const medicine = inventory.find(med => med.name === m.name);
                if (medicine) {
                    const quantity = m.qty || 1;
                    medicine.qty -= quantity;
                    totalAmount += medicine.price * quantity;
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            dailySales.total += totalAmount;
            dailySales.prescriptions.push({
                patientName: patient.name,
                medicines: medicines,
                totalAmount: totalAmount,
                date: new Date().toLocaleString('ar-EG')
            });
            
            localStorage.setItem('shifa_daily_sales', JSON.stringify(dailySales));
            
            // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø±ÙŠØ¶
            patient.status = 'completed';
            patient.pharmacyDispensed = {
                date: new Date().toISOString(),
                pharmacist: currentUser?.name || 'ØµÙŠØ¯Ù„ÙŠ',
                amount: totalAmount
            };
            
            saveData();
            loadPharmacy();
            alert(`âœ… ØªÙ… ØµØ±Ù Ø§Ù„Ø¯ÙˆØ§Ø¡ Ø¨Ù†Ø¬Ø§Ø­\nØ§Ù„Ù…Ø¨Ù„Øº: ${totalAmount.toLocaleString()} Ø¬.Ø³`);
        }

        function viewPrescriptionDetails(patientId) {
            const patient = patients.find(p => p.id === patientId);
            if (!patient || !patient.prescription) {
                alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±ÙŠØ¶');
                return;
            }
            
            const prescription = patient.prescription;
            const modalContent = `
                <div class="prescription-header text-center mb-4">
                    <h4>ğŸ¥ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©</h4>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-6">
                        <p><strong>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> ${patient.name}</p>
                        <p><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø±ÙˆØ´ØªØ©:</strong> ${new Date(prescription.date).toLocaleDateString('ar-EG')}</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>Ø§Ù„Ø·Ø¨ÙŠØ¨:</strong> Ø¯. ${prescription.doctor}</p>
                        <p><strong>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</strong> ${prescription.totalAmount.toLocaleString()} Ø¬.Ø³</p>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6>Ø§Ù„ØªØ´Ø®ÙŠØµ:</h6>
                    <p class="p-2 bg-light rounded">${prescription.diagnosis || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</p>
                </div>
                
                <div class="mb-3">
                    <h6>Ø§Ù„Ø£Ø¯ÙˆÙŠØ©:</h6>
                    <table class="table table-sm table-bordered">
                        <thead>
                            <tr>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</th>
                                <th>Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                                <th>Ø§Ù„Ø¬Ø±Ø¹Ø©</th>
                                <th>Ø§Ù„Ø³Ø¹Ø±</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${prescription.medicines.map((med, idx) => `
                                <tr>
                                    <td>${med.name}</td>
                                    <td>${med.qty}</td>
                                    <td>${med.dosage || '--'}</td>
                                    <td>${med.total.toLocaleString()} Ø¬.Ø³</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('prescriptionContent').innerHTML = modalContent;
            const modal = new bootstrap.Modal(document.getElementById('prescriptionModal'));
            modal.show();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
        // ============================================

        function registerPatient() {
            const name = document.getElementById('pName').value;
            const price = parseFloat(document.getElementById('pTicket').value);
            if(!name) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨!");
            
            const p = {
                id: Date.now(),
                name,
                age: document.getElementById('pAge').value,
                address: document.getElementById('pAddress').value,
                status: 'waiting_doctor',
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('ar-EG'),
                ticketPrice: price,
                tests: [], 
                meds: [], 
                complaint: '',
                diagnosis: '',
                labResults: [],
                prescription: null,
                pharmacyDispensed: null
            };
            patients.push(p);
            saveData();
            alert("âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ø·Ø¨ÙŠØ¨");
            loadReception();
        }

        function loadReception() {
            const list = document.getElementById('receptionList');
            list.innerHTML = patients.slice().reverse().map(p => `
                <div class="card p-2 mb-2 bg-medical small">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <b>${p.name}</b> (${p.age || '--'}) 
                            <br><small>${p.status === 'completed' ? 'âœ… Ù…ÙƒØªÙ…Ù„' : 
                                       p.status === 'waiting_doctor' ? 'ğŸŸ¡ Ø¹Ù†Ø¯ Ø§Ù„Ø·Ø¨ÙŠØ¨' :
                                       p.status === 'waiting_lab' ? 'ğŸ”µ ÙÙŠ Ø§Ù„Ù…Ø¹Ù…Ù„' :
                                       p.status === 'waiting_pharmacy' ? 'ğŸŸ  ÙÙŠ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©' : 'ğŸŸ£ ÙÙŠ Ø§Ù„ØªÙ…Ø±ÙŠØ¶'}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${p.time}</small><br>
                            <small>${p.ticketPrice || 0} Ø¬.Ø³</small>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ø·Ø¨ÙŠØ¨
        // ============================================

        function loadDoctorLists() {
            const lSel = document.getElementById('labSelect');
            lSel.innerHTML = labTests.map(t => `<option value="${t.name}">${t.name} (${t.price} Ø¬.Ø³)</option>`).join('');
            
            // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©
            prescriptionItems = [];
            document.getElementById('prescriptionItems').innerHTML = '';
            addMedicineItem(); // Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ± Ø¯ÙˆØ§Ø¡ Ø§ÙØªØ±Ø§Ø¶ÙŠ
        }

        function loadDoctor() {
            const q = document.getElementById('doctorQueue');
            const waiting = patients.filter(p => p.status === 'waiting_doctor');
            q.innerHTML = waiting.map(p => `
                <button class="btn btn-light w-100 mb-2 border" onclick="selectPatient(${p.id})">
                    ${p.name}
                    ${p.labResults && p.labResults.length > 0 ? '<span class="badge bg-info ms-1">Ù†ØªØ§Ø¦Ø¬</span>' : ''}
                </button>
            `).join('');
        }

        function selectPatient(id) {
            activePatient = patients.find(p => p.id === id);
            document.getElementById('doctorWorkArea').classList.remove('hidden-section');
            document.getElementById('currentPatientName').textContent = activePatient.name;
            document.getElementById('complaint').value = activePatient.complaint || '';
            document.getElementById('diagnosis').value = activePatient.diagnosis || '';
            
            // ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª Ø¥Ù† ÙˆØ¬Ø¯Øª
            displayLabResults();
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
            if (activePatient.prescription?.medicines) {
                prescriptionItems = [...activePatient.prescription.medicines];
                document.getElementById('prescriptionItems').innerHTML = '';
                prescriptionItems.forEach((item, index) => {
                    const itemHTML = `
                        <div class="medicine-entry" id="medItem-${item.id || Date.now() + index}">
                            <div class="row g-2 mb-2">
                                <div class="col-md-5">
                                    <select class="form-select medicine-select" onchange="updateMedicineDetails(${item.id || Date.now() + index})">
                                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ§Ø¡</option>
                                        ${inventory.map(med => `
                                            <option value="${med.name}" data-price="${med.price}" ${med.name === item.name ? 'selected' : ''}>
                                                ${med.name} - ${med.price} Ø¬.Ø³
                                            </option>
                                        `).join('')}
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <input type="number" class="form-control qty-input" value="${item.qty}" min="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" onchange="updateMedicineDetails(${item.id || Date.now() + index})">
                                </div>
                                <div class="col-md-3">
                                    <input type="text" class="form-control dosage-input" placeholder="Ø§Ù„Ø¬Ø±Ø¹Ø©" value="${item.dosage || ''}">
                                </div>
                                <div class="col-md-2">
                                    <button class="btn btn-danger btn-sm w-100" onclick="removeMedicineItem(${item.id || Date.now() + index})">âœ•</button>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-8">
                                    <input type="text" class="form-control notes-input" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©" value="${item.notes || ''}">
                                </div>
                                <div class="col-md-4">
                                    <span class="badge bg-info price-display" id="price-${item.id || Date.now() + index}">${item.total.toLocaleString()} Ø¬.Ø³</span>
                                </div>
                            </div>
                        </div>
                    `;
                    document.getElementById('prescriptionItems').insertAdjacentHTML('beforeend', itemHTML);
                });
            } else {
                prescriptionItems = [];
                document.getElementById('prescriptionItems').innerHTML = '';
                addMedicineItem();
            }
        }

        function orderLab() {
            if (!activePatient) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const selected = Array.from(document.getElementById('labSelect').selectedOptions).map(o => o.value);
            if (selected.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙØ­ÙˆØµØ§Øª');
                return;
            }
            
            activePatient.tests = selected.map(name => ({
                name, 
                price: labTests.find(t => t.name === name).price, 
                result: ''
            }));
            activePatient.status = 'waiting_lab';
            activePatient.complaint = document.getElementById('complaint').value;
            activePatient.diagnosis = document.getElementById('diagnosis').value;
            saveData(); 
            
            alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${selected.length} ÙØ­Øµ Ù„Ù„Ù…Ø¹Ù…Ù„`);
            switchSection('doctor');
        }

        function orderPharmacy() {
            if (!activePatient) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„
            prescriptionItems.forEach(item => {
                updateMedicineDetails(item.id);
            });
            
            if (prescriptionItems.length === 0) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø¥Ø¶Ø§ÙØ© Ø£Ø¯ÙˆÙŠØ© Ù„Ù„Ø±ÙˆØ´ØªØ©');
                return;
            }
            
            activePatient.meds = prescriptionItems;
            activePatient.status = 'waiting_pharmacy';
            activePatient.complaint = document.getElementById('complaint').value;
            activePatient.diagnosis = document.getElementById('diagnosis').value;
            saveData(); 
            
            alert(`âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ ${prescriptionItems.length} Ø¯ÙˆØ§Ø¡ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©`);
            switchSection('doctor');
        }

        function orderNurse() {
            if (!activePatient) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            const notes = document.getElementById('nurseNotes').value;
            if (!notes.trim()) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ…Ø§Øª Ø§Ù„ØªÙ…Ø±ÙŠØ¶');
                return;
            }
            
            activePatient.nursingInstructions = notes;
            activePatient.status = 'waiting_nurse';
            activePatient.complaint = document.getElementById('complaint').value;
            activePatient.diagnosis = document.getElementById('diagnosis').value;
            saveData();
            
            alert('âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„ØªÙ…Ø±ÙŠØ¶');
            switchSection('doctor');
        }

        function completeVisit() {
            if (!activePatient) {
                alert('âš ï¸ ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ø£ÙˆÙ„Ø§Ù‹');
                return;
            }
            
            activePatient.status = 'completed';
            activePatient.complaint = document.getElementById('complaint').value;
            activePatient.diagnosis = document.getElementById('diagnosis').value;
            activePatient.completedDate = new Date().toISOString();
            saveData();
            
            document.getElementById('doctorWorkArea').classList.add('hidden-section');
            prescriptionItems = [];
            document.getElementById('prescriptionItems').innerHTML = '';
            addMedicineItem();
            
            alert('âœ… ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø²ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
            loadDoctor();
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„ØªÙ…Ø±ÙŠØ¶
        // ============================================

        function loadNurse() {
            const list = document.getElementById('nurseList');
            const waiting = patients.filter(p => p.status === 'waiting_nurse');
            list.innerHTML = waiting.map(p => {
                return `
                <div class="col-md-6">
                    <div class="card p-3 border-start border-purple border-5">
                        <h6>${p.name} <span class="badge bg-purple float-end">ØªÙ…Ø±ÙŠØ¶</span></h6>
                        <div class="bg-light p-2 rounded mb-2">
                            <small><strong>Ø§Ù„ØªØ¹Ù„ÙŠÙ…Ø§Øª:</strong> ${p.nursingInstructions || 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ…Ø§Øª'}</small>
                        </div>
                        <textarea class="form-control form-control-sm mb-2" placeholder="Ø³Ø¬Ù„ Ø§Ù„ØªÙ†ÙÙŠØ°..." id="nurseReport-${p.id}"></textarea>
                        <button class="btn btn-purple btn-sm w-100" onclick="finishNurse(${p.id})">âœ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©</button>
                    </div>
                </div>`;
            }).join('');
        }

        function finishNurse(id) {
            const notes = document.getElementById(`nurseReport-${id}`)?.value || '';
            const patient = patients.find(x => x.id === id);
            if (patient) {
                patient.status = 'completed';
                patient.nursingReport = {
                    date: new Date().toISOString(),
                    nurse: currentUser?.name || 'Ù…Ù…Ø±Ø¶',
                    notes: notes
                };
                saveData(); 
                loadNurse();
                alert('âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ù…Ù‡Ù…Ø© Ø§Ù„ØªÙ…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­');
            }
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±
        // ============================================

        function loadAdmin() {
            const clinic = patients.reduce((s, p) => s + (p.ticketPrice || 0), 0);
            const lab = patients.reduce((s, p) => s + (p.tests || []).reduce((ss, t) => ss + t.price, 0), 0);
            const phar = patients.reduce((s, p) => s + (p.pharmacyDispensed?.amount || 0), 0);
            
            document.getElementById('admIncClinic').textContent = clinic.toLocaleString();
            document.getElementById('admIncLab').textContent = lab.toLocaleString();
            document.getElementById('admIncPhar').textContent = phar.toLocaleString();
            document.getElementById('admIncTotal').textContent = (clinic + lab + phar).toLocaleString();
        }

        function adminAddLab() {
            const name = document.getElementById('admLabName').value;
            const price = parseFloat(document.getElementById('admLabPrice').value);
            if(name && price) {
                labTests.push({name, price});
                localStorage.setItem('shifa_tests', JSON.stringify(labTests));
                document.getElementById('admLabName').value = '';
                document.getElementById('admLabPrice').value = '';
                alert("âœ… ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ­Øµ Ø¨Ù†Ø¬Ø§Ø­");
                loadDoctorLists();
            } else {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            }
        }

        function adminAddMed() {
            const name = document.getElementById('admMedName').value;
            const price = parseFloat(document.getElementById('admMedPrice').value);
            const qty = parseInt(document.getElementById('admMedQty').value);
            if(name && price && qty) {
                inventory.push({name, price, qty});
                localStorage.setItem('shifa_stock', JSON.stringify(inventory));
                document.getElementById('admMedName').value = '';
                document.getElementById('admMedPrice').value = '';
                document.getElementById('admMedQty').value = '';
                alert("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­");
                loadDoctorLists();
            } else {
                alert("âš ï¸ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„");
            }
        }

        function renderReport(type) {
            const reportArea = document.getElementById('reportArea');
            let html = '';
            
            switch(type) {
                case 'day':
                    const today = new Date().toDateString();
                    const todayPatients = patients.filter(p => new Date(p.date).toDateString() === today);
                    const todaySales = dailySales.prescriptions.filter(p => {
                        const date = new Date(p.date.split('ØŒ')[0]);
                        return date.toDateString() === today;
                    });
                    
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ - ${new Date().toLocaleDateString('ar-EG')}</h6>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <div class="card p-3 mb-2">
                                    <h6>Ø§Ù„Ù…Ø±Ø¶Ù‰</h6>
                                    <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${todayPatients.length}</p>
                                    <p><strong>Ù…ÙƒØªÙ…Ù„:</strong> ${todayPatients.filter(p => p.status === 'completed').length}</p>
                                    <p><strong>ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±:</strong> ${todayPatients.filter(p => p.status !== 'completed').length}</p>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card p-3 mb-2">
                                    <h6>Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</h6>
                                    <p><strong>Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©:</strong> ${todayPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬.Ø³</p>
                                    <p><strong>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©:</strong> ${todaySales.reduce((s,p) => s + p.totalAmount, 0).toLocaleString()} Ø¬.Ø³</p>
                                    <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ø±ÙˆØ´ØªØ§Øª:</strong> ${todaySales.length}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'week':
                    const weekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
                    const weekPatients = patients.filter(p => new Date(p.date) >= weekAgo);
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${weekPatients.length}</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ:</strong> ${Math.round(weekPatients.length / 7)}</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${weekPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬.Ø³</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· ÙŠÙˆÙ…ÙŠ:</strong> ${Math.round(weekPatients.reduce((s,p) => s + (p.ticketPrice||0), 0) / 7).toLocaleString()} Ø¬.Ø³</p>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'month':
                    const monthAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000);
                    const monthPatients = patients.filter(p => new Date(p.date) >= monthAgo);
                    html = `
                        <h6>ğŸ“Š ØªÙ‚Ø±ÙŠØ± Ø´Ù‡Ø±ÙŠ</h6>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø¶Ù‰:</strong> ${monthPatients.length}</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</strong> ${Math.round(monthPatients.length / 4)}</p>
                            </div>
                            <div class="col-6">
                                <p><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª:</strong> ${monthPatients.reduce((s,p) => s + (p.ticketPrice||0), 0).toLocaleString()} Ø¬.Ø³</p>
                                <p><strong>Ù…ØªÙˆØ³Ø· Ø£Ø³Ø¨ÙˆØ¹ÙŠ:</strong> ${Math.round(monthPatients.reduce((s,p) => s + (p.ticketPrice||0), 0) / 4).toLocaleString()} Ø¬.Ø³</p>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            reportArea.innerHTML = html;
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ù…Ø©
        // ============================================

        function switchSection(id) {
            if (currentUser.r === 'admin') {
                // Ø§Ù„Ù…Ø¯ÙŠØ± ÙŠÙ…ÙƒÙ†Ù‡ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
            } else if (currentUser.r !== id) {
                alert(`â›” Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù‚Ø³Ù… ${id}!`);
                return;
            }
            
            document.querySelectorAll('.section-pane').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(`${id}-sec`).classList.remove('hidden-section');
            
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            if(document.getElementById(`btn-${id}`)) document.getElementById(`btn-${id}`).classList.add('active');
            
            updateBadges();
            
            if(id === 'doctor') {
                loadDoctorLists();
                loadDoctor();
            }
            if(id === 'pharmacy') loadPharmacy();
            if(id === 'lab') loadLab();
            if(id === 'nursing') loadNurse();
            if(id === 'reception') loadReception();
            if(id === 'admin') loadAdmin();
        }

        function saveData() {
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            localStorage.setItem('shifa_inventory', JSON.stringify(inventory));
            localStorage.setItem('shifa_labTests', JSON.stringify(labTests));
            updateBadges();
        }

        function updateBadges() {
            const b = {
                doctor: patients.filter(p => p.status === 'waiting_doctor').length,
                lab: patients.filter(p => p.status === 'waiting_lab').length,
                pharmacy: patients.filter(p => p.status === 'waiting_pharmacy').length,
                nurse: patients.filter(p => p.status === 'waiting_nurse').length
            };
            for(let k in b) {
                const el = document.getElementById(`${k}Badge`);
                if(el) { 
                    el.textContent = b[k]; 
                    b[k]>0 ? el.classList.remove('hidden-section') : el.classList.add('hidden-section'); 
                }
            }
        }

        function playNotify() { 
            try { 
                document.getElementById('notificationSound').play().catch(()=>{}); 
            } catch(e) {} 
        }

        // ============================================
        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
        // ============================================

        window.onload = function() {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø§Ø¹Ø©
            function updateClock() {
                const now = new Date();
                document.getElementById('clockDisplay').textContent = now.toLocaleTimeString('ar-EG');
            }
            updateClock();
            setInterval(updateClock, 1000);
            
            // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
            const savedUser = localStorage.getItem('shifa_user');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    document.getElementById('loginOverlay').classList.add('hidden-section');
                    document.getElementById('mainContent').classList.remove('hidden-section');
                    document.getElementById('currentUserDisplay').innerHTML = `ğŸ‘¤ <b>${currentUser.name}</b>`;
                    
                    switchSection(currentUser.r === 'admin' ? 'admin' : currentUser.r);
                } catch (e) {
                    console.error('Error loading user data:', e);
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
            const savedSales = localStorage.getItem('shifa_daily_sales');
            if (savedSales) {
                try {
                    dailySales = JSON.parse(savedSales);
                } catch (e) {
                    dailySales = { total: 0, prescriptions: [] };
                }
            }
            
            // ØªØ­Ù…ÙŠÙ„ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…
            const savedSettings = localStorage.getItem('shifa_settings');
            if (savedSettings) {
                try {
                    systemSettings = JSON.parse(savedSettings);
                } catch (e) {
                    systemSettings = { lastReset: null, dailyResetAuto: false, backupCount: 0 };
                }
            }
            
            // ØªÙ‡ÙŠØ¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†
            initStaffMembers();
            
            updateBadges();
        };

        // ============================================
        // Ø¯ÙˆØ§Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹)
        // ============================================

        function logSecurityEvent(eventType, details) {
            // ØªÙ†ÙÙŠØ° Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø«
            console.log(`ğŸ”’ ${eventType}: ${details}`);
        }

        function updateLoginPlaceholder() {
            const dept = document.getElementById('loginDept').value;
            const usernameInput = document.getElementById('username');
            
            if (dept) {
                switch(dept) {
                    case 'admin': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: admin'; break;
                    case 'doctor': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: doctor'; break;
                    case 'reception': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: reception'; break;
                    case 'pharmacy': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: pharmacist'; break;
                    case 'lab': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: lab'; break;
                    case 'nursing': usernameInput.placeholder = 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: nurse'; break;
                }
            } else {
                usernameInput.placeholder = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…';
            }
        }

        function handleLogin() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const department = document.getElementById('loginDept').value;
            
            if (!username || !password) {
                alert('âš ï¸ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±!');
                return;
            }
            
            if (USERS[username] && USERS[username].password === password) {
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø§Ø¬Ø­
                currentUser = {
                    u: username,
                    r: USERS[username].role,
                    name: USERS[username].name,
                    loginTime: new Date().toISOString()
                };
                
                localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                localStorage.setItem('shifa_last_login', new Date().toISOString());
                
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').textContent = `ğŸ‘¤ ${currentUser.name}`;
                
                // ØªØ­Ø¯ÙŠØ« ÙˆÙ‚Øª Ø¢Ø®Ø± Ø¯Ø®ÙˆÙ„
                const lastLogin = new Date().toLocaleString('ar-EG');
                document.getElementById('lastLoginTime').textContent = lastLogin;
                
                // ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø¯ÙŠØ±Ø§Ù‹
                if (currentUser.r === 'admin') {
                    initAdminSection();
                    switchSection('admin');
                    document.getElementById('emergencyBtn').style.display = 'inline-block';
                } else {
                    switchSection(currentUser.r);
                }
                
                showNotification(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name}`, `ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ù‚Ø³Ù… ${currentUser.name} Ø¨Ù†Ø¬Ø§Ø­!`);
                
            } else {
                alert('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!');
            }
        }

        function logout() {
            if (confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')) {
                localStorage.removeItem('shifa_user');
                location.reload();
            }
        }

        function showNotification(title, message) {
            console.log(`ğŸ”” ${title}: ${message}`);
            
            try {
                document.getElementById('notificationSound').play();
            } catch (e) {}
            
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification(title, {
                    body: message,
                    icon: 'https://cdn-icons-png.flaticon.com/512/822/822118.png'
                });
            }
        }

        function openUserMenu() {
            alert('Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚ÙŠØ¯ Ø§Ù„ØªØ·ÙˆÙŠØ±');
        }

        // Ø¯Ø§Ù„Ø© ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± (Ø¥Ù† ÙˆØ¬Ø¯Øª)
        function initAdminSection() {
            // ØªÙ‡ÙŠØ¦Ø© Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±
            console.log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ±');
        }
    </script>
</body>
</html>
