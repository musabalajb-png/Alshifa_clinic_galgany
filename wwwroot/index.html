<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #f0fdf4; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-card { background: white; border-radius: 15px; padding: 20px; border-right: 5px solid var(--primary-color); box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .nav-pills .nav-link.active { background-color: var(--primary-color); }
        .card { border-radius: 15px; border: none; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo-img { filter: brightness(0) invert(1); margin-left: 10px; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0fdf4; z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .hidden-section { display: none !important; }
        @media print { .no-print { display: none !important; } #prescriptionPrintArea { display: block !important; } }
        .prescription-box { border: 2px solid #2c7a7b; padding: 30px; border-radius: 10px; min-height: 600px; background: white; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card p-4 shadow-lg" style="width: 380px; border-top: 5px solid var(--primary-color);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="60" alt="Ù„ÙˆÙ‚Ùˆ">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted small">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</p>
            </div>
            <div class="mb-3">
                <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="username" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…">
            </div>
            <div class="mb-3">
                <label class="form-label">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="password" class="form-control" placeholder="******">
            </div>
            <button class="btn btn-primary w-100 fw-bold" onclick="handleLogin()">Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…</button>
            <p id="loginError" class="text-danger small mt-2 text-center" style="display:none;">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
        </div>
    </div>

    <div id="mainContent" class="hidden-section">
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between">
                <div class="d-flex align-items-center">
                    <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="40" class="logo-img">
                    <span class="navbar-brand mb-0 h1 fw-bold">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
                </div>
                <div class="text-white">
                    <span id="userDisplay" class="me-3 small"></span>
                    <button class="btn btn-sm btn-outline-light" onclick="location.reload()">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <div id="adminStats" class="row mb-4 hidden-section">
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="todaySales">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h6><h3 id="todayProfit" class="text-success">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¹Ù…Ù„ + Ø§Ù„ØªØ°Ø§ÙƒØ±</h6><h3 id="labIncome">0</h3></div></div>
                <div class="col-md-3 mb-3"><div class="stat-card"><h6>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…</h6><h3 id="totalIncome">0</h3></div></div>
            </div>

            <ul class="nav nav-pills mb-3 shadow-sm p-2 bg-white rounded no-print" id="pills-tab">
                <li class="nav-item tab-reception hidden-section"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#reception">Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</button></li>
                <li class="nav-item tab-doctor hidden-section"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#doctor" onclick="loadDoctorData()">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</button></li>
                <li class="nav-item tab-pharmacy hidden-section"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#pharmacy">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</button></li>
                <li class="nav-item tab-lab hidden-section"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#lab" onclick="loadLabSettings()">Ø§Ù„Ù…Ø¹Ù…Ù„</button></li>
                <li class="nav-item tab-users hidden-section"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#usersAdmin">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</button></li>
            </ul>

            <div class="tab-content no-print">
                
                <div class="tab-pane fade hidden-section" id="reception">
                    <div class="card p-4 shadow-sm">
                        <h5 class="text-primary mb-4 border-bottom pb-2">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ</label><input type="text" id="pName" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„Ø¹Ù…Ø±</label><input type="number" id="pAge" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="pGender" class="form-select"><option>Ø°ÙƒØ±</option><option>Ø£Ù†Ø«Ù‰</option></select></div>
                            <div class="col-md-4"><label>Ø§Ù„Ø³ÙƒÙ†</label><input type="text" id="pAddress" class="form-control"></div>
                            <div class="col-md-4"><label>Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="pPhone" class="form-control"></div>
                            <div class="col-md-4"><label class="text-danger fw-bold">ØªØ°ÙƒØ±Ø© Ø§Ù„Ø·Ø¨ÙŠØ¨</label><input type="number" id="pTicket" class="form-control border-danger"></div>
                            <button class="btn btn-primary w-100 btn-lg mt-4" onclick="registerPatient()">Ø­ÙØ¸ ÙˆØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØ°ÙƒØ±Ø©</button>
                        </div>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="doctor">
                    <div class="card p-3 shadow-sm">
                        <h5>Ù…Ø¹Ø§ÙŠÙ†Ø© Ø§Ù„Ù…Ø±ÙŠØ¶</h5>
                        <select id="visitPatientSelect" class="form-select mb-3"></select>
                        <textarea id="doctorComplaint" class="form-control mb-3" rows="2" placeholder="Ø§ÙƒØªØ¨ Ø´ÙƒÙˆÙ‰ Ø§Ù„Ù…Ø±ÙŠØ¶..."></textarea>
                        <textarea id="diagnosis" class="form-control mb-3" rows="6" placeholder="Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„ÙˆØµÙØ© Rx..."></textarea>
                        <button class="btn btn-dark w-100" onclick="printPrescription()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©</button>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="pharmacy">
                    <div class="card p-3 mb-3 bg-light">
                        <h6>â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ù„Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                        <div class="row g-2">
                            <div class="col-md-4"><input type="text" id="newMedName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù"></div>
                            <div class="col-md-2"><input type="number" id="newMedQty" class="form-control" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©"></div>
                            <div class="col-md-2"><input type="number" id="newMedSell" class="form-control" placeholder="Ø³Ø¹Ø± Ø§Ù„Ø¨ÙŠØ¹"></div>
                            <div class="col-md-4"><button class="btn btn-success w-100" onclick="alert('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©')">Ø¥Ø¶Ø§ÙØ©</button></div>
                        </div>
                    </div>
                    <div class="card p-3">
                        <table class="table table-hover">
                            <thead><tr><th>Ø§Ù„ØµÙ†Ù</th><th>Ø§Ù„Ù…ØªÙˆÙØ±</th><th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                            <tbody id="medTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="lab">
                    <div class="card p-3">
                        <h5 class="text-success">Ø£Ø³Ø¹Ø§Ø± Ø§Ù„ÙØ­ÙˆØµØ§Øª</h5>
                        <table class="table table-bordered">
                            <tbody id="labSettingsTable"></tbody>
                        </table>
                    </div>
                </div>

                <div class="tab-pane fade hidden-section" id="usersAdmin">
                    <div class="card p-4 shadow-sm border-warning">
                        <h5 class="text-warning mb-4">ğŸ‘¥ Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù†Ø¸Ø§Ù…</h5>
                        <div class="row g-3">
                            <div class="col-md-3"><label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label><input type="text" id="newUserName" class="form-control"></div>
                            <div class="col-md-3"><label>ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label><input type="password" id="newUserPass" class="form-control"></div>
                            <div class="col-md-3"><label>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                                <select id="newUserRole" class="form-select">
                                    <option value="reception">Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                                    <option value="doctor">Ø·Ø¨ÙŠØ¨</option>
                                    <option value="lab">Ù…Ø¹Ù…Ù„</option>
                                    <option value="pharmacy">ØµÙŠØ¯Ù„ÙŠØ©</option>
                                    <option value="admin">Ù…Ø¯ÙŠØ± Ù†Ø¸Ø§Ù…</option>
                                </select>
                            </div>
                            <div class="col-md-3 d-flex align-items-end"><button class="btn btn-warning w-100" onclick="addNewUser()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button></div>
                        </div>
                        <hr>
                        <h6>Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠÙŠÙ†:</h6>
                        <ul id="usersList" class="list-group"></ul>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div id="prescriptionPrintArea" class="d-none">
        <div class="prescription-box">
            <h2 class="text-center" style="color:#2c7a7b;">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h2>
            <p class="text-center">Ø±ÙˆØ´ØªØ© Ø·Ø¨ÙŠØ©</p>
            <hr>
            <div class="row mb-4">
                <div class="col-6"><strong>Ø§Ù„Ù…Ø±ÙŠØ¶:</strong> <span id="printPName"></span></div>
                <div class="col-6 text-end"><strong>Ø§Ù„ØªØ§Ø±ÙŠØ®:</strong> <span id="printDate"></span></div>
            </div>
            <div class="mb-4">
                <h5 class="text-primary text-decoration-underline">Ø§Ù„Ø´ÙƒÙˆÙ‰:</h5>
                <p id="printC" style="padding-right: 20px;"></p>
            </div>
            <div class="mb-4">
                <h5 class="text-primary text-decoration-underline">Ø§Ù„ÙˆØµÙØ© Rx:</h5>
                <p id="printDiagnosis" style="white-space: pre-wrap; font-size: 1.3rem; min-height: 300px; padding-right: 20px;"></p>
            </div>
            <div class="mt-5 text-start"><p>___________________<br>ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¨</p></div>
        </div>
    </div>

    <script>
        const API_BASE = "https://alshifa-clinic-galgany.onrender.com/api";
        
        // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† Ù…Ù† Ø§Ù„Ù€ LocalStorage Ø¹Ø´Ø§Ù† ÙŠÙØ¶Ù„ÙˆØ§ Ù…Ø­ÙÙˆØ¸ÙŠÙ†
        let systemUsers = JSON.parse(localStorage.getItem('shifaUsers')) || {
            "admin": { pass: "123", role: "admin" }
        };

        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            
            if (systemUsers[user] && systemUsers[user].pass === pass) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('userDisplay').innerText = `Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: ${user}`;
                setupPermissions(systemUsers[user].role);
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function setupPermissions(role) {
            document.querySelectorAll('.nav-item, .tab-pane, #adminStats').forEach(el => el.classList.add('hidden-section'));
            
            if (role === 'admin') {
                document.querySelectorAll('.nav-item, .tab-pane, #adminStats').forEach(el => el.classList.remove('hidden-section'));
                document.querySelector('.tab-reception .nav-link').click();
                updateUsersTable();
                loadReports();
            } else {
                document.querySelectorAll(`.tab-${role}, #${role}`).forEach(el => el.classList.remove('hidden-section'));
                document.querySelector(`.tab-${role} .nav-link`).click();
            }
            loadInventory();
        }

        function addNewUser() {
            const name = document.getElementById('newUserName').value;
            const pass = document.getElementById('newUserPass').value;
            const role = document.getElementById('newUserRole').value;
            
            if(!name || !pass) return alert("Ø§Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¯ÙŠ Ø£ÙˆÙ„Ø§Ù‹");
            
            systemUsers[name] = { pass: pass, role: role };
            localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
            alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­");
            updateUsersTable();
        }

        function updateUsersTable() {
            const list = document.getElementById('usersList');
            list.innerHTML = "";
            for (let u in systemUsers) {
                list.innerHTML += `<li class="list-group-item d-flex justify-content-between">
                    <span><strong>${u}</strong> - ØµÙ„Ø§Ø­ÙŠØ©: ${systemUsers[u].role}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteUser('${u}')">Ø­Ø°Ù</button>
                </li>`;
            }
        }

        function deleteUser(name) {
            if(name === 'admin') return alert("Ù…Ø§ ÙŠÙ†ÙØ¹ ØªØ­Ø°Ù Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ!");
            delete systemUsers[name];
            localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
            updateUsersTable();
        }

        // Ø¯ÙˆØ§Ù„ Ø§Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±
        async function loadInventory() {
            const res = await fetch(`${API_BASE}/Pharmacy/inventory`);
            const data = await res.json();
            document.getElementById('medTableBody').innerHTML = data.map(med => `
                <tr><td>${med.name}</td><td>${med.stockQuantity}</td><td>${med.sellingPrice} SDG</td>
                <td><button class="btn btn-sm btn-success" onclick="sellMed(${med.id}, 1)">ØµØ±Ù</button></td></tr>`).join('');
        }

        async function registerPatient() {
            const p = { 
                name: document.getElementById('pName').value, 
                age: document.getElementById('pAge').value, 
                ticketPrice: document.getElementById('pTicket').value 
            };
            await fetch(`${API_BASE}/Clinic/patients`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p) });
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­");
        }

        async function loadDoctorData() {
            const pRes = await fetch(`${API_BASE}/Clinic/patients`);
            const patients = await pRes.json();
            document.getElementById('visitPatientSelect').innerHTML = `<option>-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± --</option>` + 
                patients.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }

        function printPrescription() {
            const select = document.getElementById('visitPatientSelect');
            document.getElementById('printPName').innerText = select.options[select.selectedIndex].text;
            document.getElementById('printC').innerText = document.getElementById('doctorComplaint').value;
            document.getElementById('printDiagnosis').innerText = document.getElementById('diagnosis').value;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString('ar-EG');
            window.print();
        }

        async function loadLabSettings() {
            const res = await fetch(`${API_BASE}/Clinic/lab/pending`);
            const tests = await res.json();
            document.getElementById('labSettingsTable').innerHTML = tests.map(t => `
                <tr><td>${t.name}</td><td>${t.price} SDG</td></tr>`).join('');
        }

        async function loadReports() {
            const res = await fetch(`${API_BASE}/Pharmacy/reports`);
            const data = await res.json();
            document.getElementById('todaySales').innerText = data.todaySales.toLocaleString();
            document.getElementById('todayProfit').innerText = data.todayProfit.toLocaleString();
        }

    </script>
</body>
</html>
