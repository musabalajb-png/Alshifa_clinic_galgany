<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ูุธุงู ูุฌูุน ุงูุดูุงุก ุงูุทุจู - ุงููุณุฎุฉ ุงูุฐูุจูุฉ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { --primary-color: #2c7a7b; --secondary-color: #f0fdf4; --accent-red: #c53030; }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, sans-serif; overflow-x: hidden; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; transition: 0.3s; }
        .card:hover { transform: translateY(-5px); }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); border-radius: 12px !important; margin: 0 5px; padding: 10px 20px; }
        .nav-link.active { background-color: var(--primary-color) !important; color: white !important; }
        .stat-badge { font-size: 1.2rem; padding: 20px; border-radius: 15px; color: white; text-align: center; }
        .low-stock { background-color: #fff5f5 !important; color: var(--accent-red) !important; font-weight: bold; border: 1px solid var(--accent-red); animation: blink 2s infinite; }
        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
        @media print { .no-print { display: none !important; } #printArea { display: block !important; } }
        .rx-symbol { font-size: 3rem; color: var(--primary-color); font-weight: bold; margin-bottom: 10px; }
        .btn-action { border-radius: 10px; font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <div id="loginOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #f0fdf4 0%, #e6fffa 100%); z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg" style="width: 400px; border-top: 8px solid var(--primary-color);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="80">
                <h3 class="fw-bold mt-3" style="color: var(--primary-color);">ูุฌูุน ุงูุดูุงุก ุงูุทุจู</h3>
                <p class="text-muted">ูุธุงู ุงูุฅุฏุงุฑุฉ ุงููุชูุงูู - ุฌูููู</p>
            </div>
            <div class="mb-3">
                <label class="form-label small fw-bold">ุงุณู ุงููุณุชุฎุฏู</label>
                <input type="text" id="username" class="form-control form-control-lg" placeholder="ูุซูุงู: admin">
            </div>
            <div class="mb-4">
                <label class="form-label small fw-bold">ูููุฉ ุงููุฑูุฑ</label>
                <input type="password" id="password" class="form-control form-control-lg" placeholder="โขโขโขโขโขโขโขโข">
            </div>
            <button class="btn btn-primary btn-lg w-100 fw-bold" onclick="handleLogin()">ุชุณุฌูู ุงูุฏุฎูู</button>
        </div>
    </div>

    <div id="mainContent" class="hidden-section">
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between">
                <span class="navbar-brand fw-bold fs-4">๐ฅ ูุฌูุน ุงูุดูุงุก ุงูุทุจู - ุฌูููู</span>
                <div class="text-white">
                    <span id="userDisplay" class="me-3 badge bg-light text-dark"></span>
                    <button class="btn btn-sm btn-danger fw-bold" onclick="location.reload()">ุชุณุฌูู ุฎุฑูุฌ</button>
                </div>
            </div>
        </nav>

        <div class="container">
            <ul class="nav nav-pills mb-4 no-print shadow-sm p-2 bg-white rounded-pill justify-content-center" id="mainNavTabs">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">๐ ุงูุงุณุชูุจุงู</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">๐จโโ๏ธ ุงูุนูุงุฏุฉ</button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">๐งช ุงููุนูู</button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">๐ ุงูุตูุฏููุฉ</button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">๐ ุงููุฏูุฑ</button></li>
            </ul>

            <div class="tab-content no-print">
                
                <div id="reception-sec" class="section-pane hidden-section">
                    <div class="card p-4">
                        <h5 class="text-primary fw-bold mb-3">๐ ุชุณุฌูู ูุฑูุถ ุฌุฏูุฏ</h5>
                        <div class="row g-3">
                            <div class="col-md-6"><input type="text" id="pName" class="form-control" placeholder="ุงุณู ุงููุฑูุถ ุงูุฑุจุงุนู"></div>
                            <div class="col-md-3"><input type="number" id="pAge" class="form-control" placeholder="ุงูุนูุฑ"></div>
                            <div class="col-md-3"><button class="btn btn-primary w-100" onclick="registerPatient()">ุฅุถุงูุฉ ููุงุฆูุฉ ุงูุงูุชุธุงุฑ</button></div>
                        </div>
                        <hr>
                        <h6>ูุงุฆูุฉ ุงูุงูุชุธุงุฑ ุงูุญุงููุฉ:</h6>
                        <ul id="waitingList" class="list-group"></ul>
                    </div>
                </div>

                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4">
                                <h5 class="text-primary mb-3">๐จโโ๏ธ ูุญุต ุงููุฑูุถ ูุงูุฑูุดุชุฉ</h5>
                                <select id="patientSelect" class="form-select mb-3 form-select-lg border-primary"></select>
                                
                                <div class="p-3 bg-light rounded-3 mb-3 border">
                                    <div class="row g-2">
                                        <div class="col-md-6">
                                            <input list="stockMeds" id="medSearch" class="form-control" placeholder="ุงุจุญุซ ุนู ุฏูุงุก..." onkeyup="filterMeds(this.value)">
                                            <datalist id="stockMeds"></datalist>
                                        </div>
                                        <div class="col-md-3"><input type="text" id="medDose" class="form-control" placeholder="ุงูุฌุฑุนุฉ"></div>
                                        <div class="col-md-3"><button class="btn btn-primary w-100" onclick="addMedToRx()">โ ุฃุถู</button></div>
                                    </div>
                                </div>

                                <textarea id="diagnosis" class="form-control mb-3" rows="6" placeholder="ุงูุชุจ ุงูุชุดุฎูุต ุฃู ุงูุฃุฏููุฉ ููุง..."></textarea>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-outline-dark w-50 fw-bold" onclick="printPrescription()">๐จ๏ธ ุทุจุงุนุฉ ุงูุฑูุดุชุฉ</button>
                                    <button class="btn btn-success w-50 fw-bold" onclick="sendToPharmacy()">๐ ุฅุฑุณุงู ููุตูุฏููุฉ</button>
                                </div>
                                <button class="btn btn-danger w-100 mt-2 fw-bold" onclick="sendToLab()">๐งช ุทูุจ ูุญุต ูุนููู</button>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card p-3 bg-primary text-white">
                                <h6>๐ ููุงุญุธุงุช ุงูุทุจูุจ</h6>
                                <small>ุชุฃูุฏ ูู ูุฑุงุฌุนุฉ ุงูุญุณุงุณูุฉ ูุจู ุฅุถุงูุฉ ุงูุฏูุงุก.</small>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="card p-3">
                        <h5 class="text-danger fw-bold">๐งช ุทูุจุงุช ุงููุญุต ุงููุงุฑุฏุฉ</h5>
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-dark"><tr><th>ุงููุฑูุถ</th><th>ุงููุญุต</th><th>ุงููุชูุฌุฉ</th><th>ุฅุฌุฑุงุก</th></tr></thead>
                                <tbody id="labRequestsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-5">
                            <div class="card p-3 shadow border-start border-success border-5">
                                <h5 class="text-success fw-bold">๐ฅ ุฑูุดุชุงุช ูู ุงูุงูุชุธุงุฑ</h5>
                                <div id="incomingRxList" style="max-height: 500px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        <div class="col-md-7">
                            <div class="card p-3">
                                <h5 class="text-primary fw-bold">๐ฆ ุฅุฏุงุฑุฉ ุงููุฎุฒูู (ุตูุฏููุฉ ุฌูููู)</h5>
                                <div class="input-group mb-3 shadow-sm">
                                    <input type="text" id="medName" class="form-control" placeholder="ุงุณู ุงูุฏูุงุก">
                                    <input type="number" id="medCost" class="form-control" placeholder="ุงูุชูููุฉ">
                                    <input type="number" id="medQty" class="form-control" placeholder="ุงููููุฉ">
                                    <button class="btn btn-primary fw-bold" onclick="addMed()">ุฅุถุงูุฉ ุฏูุงุก</button>
                                </div>
                                <div class="table-responsive" style="max-height: 400px;">
                                    <table class="table table-striped align-middle">
                                        <thead class="table-primary"><tr><th>ุงูุตูู</th><th>ุณุนุฑ ุงูุจูุน</th><th>ุงููุฎุฒูู</th><th>ุฅุฌุฑุงุก</th></tr></thead>
                                        <tbody id="inventoryTable"></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-sec" class="section-pane hidden-section">
                    <div class="row g-3 mb-4">
                        <div class="col-md-4"><div class="stat-badge bg-primary shadow">๐ฆ ุฏุฎู ุงูุนูุงุฏุฉ<br><h3 id="clinicIncome">0</h3></div></div>
                        <div class="col-md-4"><div class="stat-badge bg-danger shadow">๐งช ุฏุฎู ุงููุนูู<br><h3 id="labIncome">0</h3></div></div>
                        <div class="col-md-4"><div class="stat-badge bg-success shadow">๐ ุฏุฎู ุงูุตูุฏููุฉ<br><h3 id="pharmacyIncome">0.00</h3></div></div>
                    </div>
                    
                    <div class="card p-4">
                        <h5 class="fw-bold"><img src="https://cdn-icons-png.flaticon.com/512/681/681494.png" width="30"> ุฅุฏุงุฑุฉ ุทุงูู ุงูุนูู</h5>
                        <div class="row g-2 mb-3 bg-light p-3 rounded shadow-sm">
                            <div class="col-md-4"><input type="text" id="newU" class="form-control" placeholder="ุงุณู ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ"></div>
                            <div class="col-md-3"><input type="password" id="newP" class="form-control" placeholder="ูููุฉ ุงููุฑูุฑ"></div>
                            <div class="col-md-3">
                                <select id="newR" class="form-select">
                                    <option value="doctor">ุทุจูุจ (Doctor)</option>
                                    <option value="pharmacy">ุตูุฏูู (Pharmacy)</option>
                                    <option value="lab">ูุฎุจุฑู (Lab)</option>
                                    <option value="reception">ููุธู ุงุณุชูุจุงู (Reception)</option>
                                </select>
                            </div>
                            <div class="col-md-2"><button class="btn btn-primary w-100 fw-bold" onclick="addNewUser()">ุฅุถุงูุฉ</button></div>
                        </div>
                        <table class="table table-hover align-middle">
                            <thead class="table-light"><tr><th>ุงููุณุชุฎุฏู</th><th>ุงูุตูุงุญูุฉ</th><th>ุชุนุฏูู</th><th>ุญุฐู</th></tr></thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="printArea" style="display:none; padding: 50px; direction: rtl; border: 10px double #2c7a7b;">
        <div style="text-align: center;">
            <h1>ูุฌูุน ุงูุดูุงุก ุงูุทุจู - ุฌูููู</h1>
            <p>ููุงูุฉ ุณูุงุฑ - ูุญุฏุฉ ุฌูููู ุงูุฅุฏุงุฑูุฉ</p>
            <hr>
            <div class="rx-symbol">Rx</div>
            <div id="printContent" style="font-size: 1.6rem; min-height: 500px; text-align: right; padding: 20px;"></div>
            <hr>
            <p style="font-size: 0.9rem;">ุชูููุน ุงูุทุจูุจ: ................................ | ุงูุชุงุฑูุฎ: <span id="printDate"></span></p>
        </div>
    </div>

    <script>
        // --- ุงูุฅุนุฏุงุฏุงุช ุงูุฃูููุฉ ูุงูุจูุงูุงุช ---
        let systemUsers = JSON.parse(localStorage.getItem('shifaUsers')) || {
            "admin": { pass: "123", role: "admin" },
            "doctor": { pass: "doc123", role: "doctor" },
            "pharmacy": { pass: "ph123", role: "pharmacy" }
        };

        let inventory = JSON.parse(localStorage.getItem('shifaInventory')) || [];
        let pendingRx = JSON.parse(localStorage.getItem('pendingRx')) || [];
        let waitingPatients = JSON.parse(localStorage.getItem('waitingPatients')) || [];
        let labRequests = JSON.parse(localStorage.getItem('labRequests')) || [];
        let financials = JSON.parse(localStorage.getItem('shifaFinancials')) || { clinic: 0, lab: 0, pharmacy: 0 };

        // --- ูุธุงู ุชุณุฌูู ุงูุฏุฎูู ---
        function handleLogin() {
            const u = document.getElementById('username').value.toLowerCase().trim();
            const p = document.getElementById('password').value;
            if (systemUsers[u] && systemUsers[u].pass === p) {
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('userDisplay').innerText = `ุงููุณุชุฎุฏู: ${u}`;
                setupPermissions(systemUsers[u].role);
            } else { alert("ุนููุงู! ุงุณู ุงููุณุชุฎุฏู ุฃู ูููุฉ ุงููุฑูุฑ ุบูุฑ ุตุญูุญุฉ."); }
        }

        function setupPermissions(role) {
            document.querySelectorAll('.nav-item').forEach(li => li.classList.add('hidden-section'));
            if (role === 'admin') {
                document.querySelectorAll('.nav-item').forEach(li => li.classList.remove('hidden-section'));
                switchSection('admin'); 
            } else {
                document.getElementById(`tab-${role}-li`).classList.remove('hidden-section');
                switchSection(role);
            }
            refreshAllData();
        }

        function switchSection(secId) {
            document.querySelectorAll('.section-pane').forEach(sec => sec.classList.add('hidden-section'));
            document.getElementById(`${secId}-sec`).classList.remove('hidden-section');
            document.querySelectorAll('.nav-link').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${secId}`)?.classList.add('active');
        }

        // --- ูุธุงุฆู ุงูุงุณุชูุจุงู ---
        function registerPatient() {
            const name = document.getElementById('pName').value;
            const age = document.getElementById('pAge').value;
            if(!name) return;
            waitingPatients.push({ name, age, id: Date.now() });
            localStorage.setItem('waitingPatients', JSON.stringify(waitingPatients));
            document.getElementById('pName').value = '';
            refreshAllData();
        }

        // --- ูุธุงุฆู ุงูุทุจูุจ (ุงูุฑูุดุชุฉ ูุงููุนูู) ---
        function filterMeds(val) {
            document.getElementById('stockMeds').innerHTML = inventory
                .filter(m => m.name.toLowerCase().includes(val.toLowerCase()))
                .map(m => `<option value="${m.name}"> ุงููุฎุฒูู: ${m.qty}</option>`).join('');
        }

        function addMedToRx() {
            const name = document.getElementById('medSearch').value;
            const dose = document.getElementById('medDose').value;
            if(name) {
                document.getElementById('diagnosis').value += `- ${name} | ุงูุฌุฑุนุฉ: ${dose}\n`;
                document.getElementById('medSearch').value = '';
                document.getElementById('medDose').value = '';
            }
        }

        function sendToLab() {
            const patient = document.getElementById('patientSelect').value;
            const test = prompt("ุงูุชุจ ุงุณู ุงููุญุต ุงููุทููุจ:");
            if(test) {
                labRequests.push({ patient, test, result: 'ูู ุงูุงูุชุธุงุฑ...', status: 'pending' });
                localStorage.setItem('labRequests', JSON.stringify(labRequests));
                alert("ุชู ุฅุฑุณุงู ุงูุทูุจ ูููุนูู ๐งช");
                refreshAllData();
            }
        }

        function sendToPharmacy() {
            const rx = document.getElementById('diagnosis').value;
            const patient = document.getElementById('patientSelect').value;
            if(!rx) return alert("ุงูุฑูุดุชุฉ ูุงุฑุบุฉ!");
            pendingRx.push({ patient, rx, date: new Date().toLocaleString() });
            localStorage.setItem('pendingRx', JSON.stringify(pendingRx));
            alert("ุชู ุฅุฑุณุงู ุงูุฑูุดุชุฉ ููุตูุฏููุฉ โ");
            document.getElementById('diagnosis').value = "";
            refreshAllData();
        }

        function printPrescription() {
            document.getElementById('printContent').innerText = document.getElementById('diagnosis').value;
            document.getElementById('printDate').innerText = new Date().toLocaleDateString();
            window.print();
        }

        // --- ูุธุงุฆู ุงูุตูุฏููุฉ ูุงููุงููุฉ ---
        function addMed() {
            const name = document.getElementById('medName').value;
            const cost = parseFloat(document.getElementById('medCost').value);
            const qty = parseInt(document.getElementById('medQty').value);
            if(name && cost) {
                inventory.push({ name, cost, sale: cost * 1.5, qty });
                localStorage.setItem('shifaInventory', JSON.stringify(inventory));
                refreshAllData();
            }
        }

        function dispenseRx(idx) {
            const rxObj = pendingRx[idx];
            // ูุญุงูุงุฉ ุญุณุงุจ ุงูุณุนุฑ (ุงูุชุฑุงุถู 500 ุฌููู ููู ุฑูุดุชุฉ ูุชุจุณูุท ุงูุญุณุงุจ ููุง)
            financials.pharmacy += 500; 
            localStorage.setItem('shifaFinancials', JSON.stringify(financials));
            pendingRx.splice(idx, 1);
            localStorage.setItem('pendingRx', JSON.stringify(pendingRx));
            alert("ุชู ุตุฑู ุงูุฑูุดุชุฉ ูุชุญุฏูุซ ุงูุฎุฒููุฉ ๐ฐ");
            refreshAllData();
        }

        // --- ูุธุงุฆู ุงููุนูู ---
        function recordLabResult(idx) {
            const res = prompt("ุงูุชุจ ูุชูุฌุฉ ุงููุญุต:");
            if(res) {
                labRequests[idx].result = res;
                labRequests[idx].status = 'done';
                financials.lab += 1000; // ุณุนุฑ ุงููุญุต
                localStorage.setItem('labRequests', JSON.stringify(labRequests));
                localStorage.setItem('shifaFinancials', JSON.stringify(financials));
                refreshAllData();
            }
        }

        // --- ูุธุงุฆู ุงููุฏูุฑ ---
        function addNewUser() {
            const u = document.getElementById('newU').value.toLowerCase().trim();
            const p = document.getElementById('newP').value;
            const r = document.getElementById('newR').value;
            if(u && p) {
                systemUsers[u] = { pass: p, role: r };
                localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
                alert("ุชู ุฅุถุงูุฉ ุงูููุธู ุงูุฌุฏูุฏ ุจูุฌุงุญ.");
                refreshAllData();
            }
        }

        function deleteUser(u) {
            if(u === 'admin') return alert("ูุง ูููู ุญุฐู ุงููุฏูุฑ ุงูุฑุฆูุณู!");
            delete systemUsers[u];
            localStorage.setItem('shifaUsers', JSON.stringify(systemUsers));
            refreshAllData();
        }

        // --- ุชุญุฏูุซ ุงููุงุฌูุฉ (The Engine) ---
        function refreshAllData() {
            // ุงูุงุณุชูุจุงู
            document.getElementById('waitingList').innerHTML = waitingPatients.map(p => 
                `<li class="list-group-item d-flex justify-content-between align-items-center">${p.name} (ุนูุฑู: ${p.age}) <span class="badge bg-primary rounded-pill">ููุชุธุฑ</span></li>`).join('');
            
            // ุงูุทุจูุจ
            document.getElementById('patientSelect').innerHTML = waitingPatients.map(p => `<option value="${p.name}">${p.name}</option>`).join('');
            
            // ุงูุตูุฏููุฉ
            document.getElementById('inventoryTable').innerHTML = inventory.map(i => `
                <tr class="${i.qty <= 5 ? 'low-stock' : ''}">
                    <td>${i.name}</td><td>${i.sale.toFixed(2)}</td><td>${i.qty}</td>
                    <td><button class="btn btn-sm btn-danger" onclick="inventory.splice(inventory.indexOf('${i.name}'),1); refreshAllData()">ุญุฐู</button></td>
                </tr>`).join('');
            
            document.getElementById('incomingRxList').innerHTML = pendingRx.map((r, idx) => `
                <div class="card p-3 mb-2 border-start border-4 border-success shadow-sm">
                    <strong>๐ค ุงููุฑูุถ: ${r.patient}</strong> <small class="text-muted">${r.date}</small>
                    <pre class="mt-2 p-2 bg-light rounded">${r.rx}</pre>
                    <button class="btn btn-sm btn-success fw-bold" onclick="dispenseRx(${idx})">โ ุชู ุงูุตุฑู ูุงูุฏูุน</button>
                </div>`).join('');

            // ุงููุนูู
            document.getElementById('labRequestsTable').innerHTML = labRequests.map((l, idx) => `
                <tr><td>${l.patient}</td><td>${l.test}</td><td>${l.result}</td>
                <td><button class="btn btn-sm btn-warning" onclick="recordLabResult(${idx})">ุชุณุฌูู ูุชูุฌุฉ</button></td></tr>`).join('');

            // ุงููุฏูุฑ
            document.getElementById('clinicIncome').innerText = financials.clinic + " ุฌ.ุณ";
            document.getElementById('labIncome').innerText = financials.lab + " ุฌ.ุณ";
            document.getElementById('pharmacyIncome').innerText = financials.pharmacy.toFixed(2) + " ุฌ.ุณ";
            
            document.getElementById('usersTableBody').innerHTML = Object.keys(systemUsers).map(u => `
                <tr><td>${u}</td><td><span class="badge bg-info">${systemUsers[u].role}</span></td>
                <td><button class="btn btn-sm btn-outline-secondary" onclick="const np=prompt('ูููุฉ ุณุฑ ุฌุฏูุฏุฉ:'); if(np) systemUsers['${u}'].pass=np; refreshAllData()">ุชุบููุฑ ุงูุณุฑ</button></td>
                <td><button onclick="deleteUser('${u}')" class="btn btn-sm text-danger">๐๏ธ</button></td></tr>
            `).join('');
        }
    </script>
</body>
</html>
