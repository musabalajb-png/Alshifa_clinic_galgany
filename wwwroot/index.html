<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <title>Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„</title>
    
    <!-- Bootstrap RTL -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #2c7a7b;
            --secondary-color: #f0fdf4;
            --accent-green: #198754;
            --accent-red: #dc3545;
            --accent-warning: #ffc107;
            --accent-blue: #0d6efd;
            --accent-purple: #6f42c1;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
        }
        
        .card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            border: none;
            padding: 10px 25px;
            font-weight: bold;
        }
        
        .btn-primary:hover {
            background-color: #246b6c;
            transform: translateY(-2px);
        }
        
        .nav-tabs .nav-link {
            border-radius: 10px 10px 0 0;
            font-weight: bold;
            color: #6c757d;
            padding: 10px 20px;
        }
        
        .nav-tabs .nav-link.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .stat-card {
            background: linear-gradient(135deg, var(--primary-color), #38b2ac);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .login-container {
            background: linear-gradient(135deg, var(--primary-color), #38b2ac);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .login-box {
            background: white;
            border-radius: 20px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media print {
            .no-print {
                display: none !important;
            }
            
            .print-only {
                display: block !important;
            }
        }
        
        .connection-info {
            background: linear-gradient(135deg, var(--primary-color), #38b2ac);
            color: white;
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.85rem;
            display: inline-block;
        }
        
        .db-status {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .db-online { background-color: #28a745; }
        .db-offline { background-color: #dc3545; }
        
        .medicine-item {
            border-left: 4px solid var(--accent-green);
            background: #f8f9fa;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
        }
        
        .patient-card {
            border-left: 5px solid var(--primary-color);
            transition: all 0.3s ease;
        }
        
        .patient-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: bold;
        }
        
        .bg-waiting { background-color: #fff3cd; color: #856404; }
        .bg-inprogress { background-color: #cce5ff; color: #004085; }
        .bg-completed { background-color: #d4edda; color: #155724; }
        
        .search-box {
            position: relative;
        }
        
        .search-box input {
            padding-right: 40px;
        }
        
        .search-box .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }
        
        .modal-backdrop {
            z-index: 1040 !important;
        }
        
        .modal {
            z-index: 1050 !important;
        }
        
        .toast-container {
            z-index: 1060 !important;
        }
        
        .table-hover tbody tr:hover {
            background-color: rgba(44, 122, 123, 0.1);
        }
        
        .alert-dismissible .btn-close {
            padding: 1rem;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(44, 122, 123, 0.25);
        }
        
        .badge {
            font-weight: 500;
        }
        
        .prescription-box {
            border: 2px dashed var(--primary-color);
            background-color: #f8fafc;
            min-height: 200px;
            padding: 20px;
            border-radius: 10px;
        }
        
        .medicine-entry {
            background: #e8f5e9;
            border-left: 4px solid var(--accent-green);
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
        }
    </style>
</head>
<body>

    <!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginScreen" class="login-container">
        <div class="login-box">
            <div class="text-center mb-4">
                <h3 style="color: var(--primary-color); font-weight: bold;">ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ</h3>
                <p class="text-muted">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„ Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©</p>
            </div>
          <div class="mb-3">
                <label class="form-label fw-bold">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="loginUsername" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…" value="admin">
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="loginPassword" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" value="123">
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Ø§Ù„Ø¯ÙˆØ±</label>
                <select id="loginRole" class="form-select">
                    <option value="admin">Ø§Ù„Ù…Ø¯ÙŠØ±</option>
                    <option value="doctor">Ø§Ù„Ø·Ø¨ÙŠØ¨</option>
                    <option value="reception">Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„</option>
                    <option value="pharmacy">Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</option>
                    <option value="lab">Ø§Ù„Ù…Ø¹Ù…Ù„</option>
                </select>
            </div>
            
            <button class="btn btn-primary w-100 fw-bold py-2" onclick="login()" id="loginBtn">
                Ø¯Ø®ÙˆÙ„ Ù„Ù„Ù†Ø¸Ø§Ù…
            </button>
            
            <div class="text-center mt-4">
                <small class="text-muted">Ø§Ù„Ù†Ø³Ø®Ø© 3.0 | Ù†Ø¸Ø§Ù… Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…ØªÙƒØ§Ù…Ù„</small>
                <br>
                <small class="text-muted" id="serverConnectionStatus">ğŸ”´ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±...</small>
            </div>
        </div>
    </div>

    <!-- Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
    <div id="mainApp" style="display: none;">
        <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ†Ù‚Ù„ -->
        <nav class="navbar navbar-dark bg-primary py-3 shadow">
            <div class="container-fluid">
                <span class="navbar-brand fw-bold">
                    ğŸ¥ Ù…Ø¬Ù…Ø¹ Ø§Ù„Ø´ÙØ§Ø¡ Ø§Ù„Ø·Ø¨ÙŠ - Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„
                    <small class="d-block" style="font-size: 0.8rem; opacity: 0.9;">
                        Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª SQL Server | Ø³ÙŠØ±ÙØ± Somee.com
                    </small>
                </span>
                
                <div class="d-flex align-items-center">
                    <div class="connection-info me-3">
                        <span id="dbStatusIndicator" class="db-status db-online"></span>
                        <span id="connectionStatusText">ğŸŸ¢ Ù…ØªØµÙ„</span>
                    </div>
                    <div class="me-3">
                        <span id="currentUserRole" class="badge bg-light text-dark fs-6"></span>
                    </div>
                    <button class="btn btn-sm btn-outline-light" onclick="logout()">
                        <small>ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</small>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„ -->
        <div class="container-fluid mt-3">
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <span>ğŸ“¡ Ø§Ù„Ø³ÙŠØ±ÙØ±: <strong>AlshifaClinic.somee.com</strong></span>
                                <span class="mx-3">|</span>
                                <span>ğŸ—„ï¸ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: <strong>AlshifaDb.mssql.somee.com</strong></span>
                                <span class="mx-3">|</span>
                                <span>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <strong id="dbUserInfo">Musab_SQLLogin_1</strong></span>
                            </div>
                            <button class="btn btn-sm btn-outline-info" onclick="testConnection()">
                                ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
        <div class="container-fluid mt-4">
            <!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª -->
            <div class="row mb-4" id="statsRow">
                <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
            </div>

            <!-- ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
            <ul class="nav nav-tabs mb-4" id="mainTabs">
                <li class="nav-item">
                    <button class="nav-link active" onclick="switchTab('dashboard')" id="tab-dashboard">
                        ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('reception')" id="tab-reception">
                        ğŸ“‹ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('clinic')" id="tab-clinic">
                        ğŸ‘¨â€âš•ï¸ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
                        <span id="clinicBadge" class="badge bg-danger ms-1" style="display: none;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('pharmacy')" id="tab-pharmacy">
                        ğŸ’Š Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©
                        <span id="pharmacyBadge" class="badge bg-danger ms-1" style="display: none;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('lab')" id="tab-lab">
                        ğŸ§ª Ø§Ù„Ù…Ø¹Ù…Ù„
                        <span id="labBadge" class="badge bg-danger ms-1" style="display: none;">0</span>
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('patients')" id="tab-patients">
                        ğŸ“ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('reports')" id="tab-reports">
                        ğŸ“ˆ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" onclick="switchTab('settings')" id="tab-settings">
                        âš™ï¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
                    </button>
                </li>
            </ul>

            <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
            <div id="tabContent">
                <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… -->
                <div id="dashboardTab" class="tab-pane">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">ğŸ“Š Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                                    <button class="btn btn-sm btn-light" onclick="loadStatistics()">
                                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div class="row" id="dashboardStats">
                                        <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù‡Ù†Ø§ -->
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6>ğŸ“‹ Ø¢Ø®Ø± Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†</h6>
                                        <div id="recentPatients" class="mt-3">
                                            <!-- Ø³ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¬Ø¯Ø¯ Ù‡Ù†Ø§ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">ğŸš€ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="switchTab('reception')">
                                            â• ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯
                                        </button>
                                        <button class="btn btn-warning" onclick="switchTab('clinic')">
                                            ğŸ‘¨â€âš•ï¸ Ø¨Ø¯Ø¡ ÙƒØ´Ù Ø·Ø¨ÙŠ
                                        </button>
                                        <button class="btn btn-info" onclick="switchTab('pharmacy')">
                                            ğŸ’Š ØµØ±Ù Ø£Ø¯ÙˆÙŠØ©
                                        </button>
                                        <button class="btn btn-danger" onclick="switchTab('lab')">
                                            ğŸ§ª Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ ÙØ­ÙˆØµØ§Øª
                                        </button>
                                        <button class="btn btn-secondary" onclick="generateDailyReport()">
                                            ğŸ“„ ØªÙ‚Ø±ÙŠØ± ÙŠÙˆÙ…ÙŠ
                                        </button>
                                    </div>
                                    
                                    <hr>
                                    
                                    <div class="mt-3">
                                        <h6>ğŸ“… Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h6>
                                        <div id="systemInfo">
                                            <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ -->
                <div id="receptionTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø±Ø¨Ø§Ø¹ÙŠ</label>
                                            <input type="text" id="patientName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„Ø¹Ù…Ø±</label>
                                            <input type="number" id="patientAge" class="form-control" placeholder="Ø§Ù„Ø¹Ù…Ø±">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„Ø¬Ù†Ø³</label>
                                            <select id="patientGender" class="form-select">
                                                <option value="">Ø§Ø®ØªØ±</option>
                                                <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
                                                <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                                            <input type="tel" id="patientPhone" class="form-control" placeholder="09XXXXXXXX">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label>
                                            <input type="text" id="patientAddress" class="form-control" placeholder="Ø§Ù„Ø³ÙƒÙ†">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ù„Ø³Ø¨Ø¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</label>
                                            <input type="text" id="patientReason" class="form-control" placeholder="Ø§Ù„Ù…Ø±Ø¶/Ø§Ù„Ø´ÙƒÙˆÙ‰">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø±Ø³ÙˆÙ… Ø§Ù„ÙƒØ´Ù (Ø¬.Ø³)</label>
                                            <input type="number" id="patientFee" class="form-control" value="2000">
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="registerPatient()">
                                            âœ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶
                                        </button>
                                        <button class="btn btn-success flex-fill" onclick="registerAndPrint()">
                                            ğŸ–¨ï¸ ØªØ³Ø¬ÙŠÙ„ ÙˆØ·Ø¨Ø§Ø¹Ø©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0">Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ø¬Ø¯Ø¯ Ø§Ù„ÙŠÙˆÙ…</h5>
                                    <button class="btn btn-sm btn-light" onclick="loadTodayPatients()">
                                        ğŸ”„ ØªØ­Ø¯ÙŠØ«
                                    </button>
                                </div>
                                <div class="card-body">
                                    <div id="todayPatientsList" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„ÙŠÙˆÙ…ÙŠØ© -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© -->
                <div id="clinicTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</h5>
                                </div>
                                <div class="card-body">
                                    <div id="waitingPatients" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰ Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="input-group mb-3">
                                        <input type="text" id="medSearchInput" class="form-control" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ø¯ÙˆØ§Ø¡...">
                                        <button class="btn btn-outline-primary" onclick="searchMedicines()">
                                            Ø¨Ø­Ø«
                                        </button>
                                    </div>
                                    <div id="medicinesList" style="max-height: 300px; overflow-y: auto;">
                                        <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Ø§Ù„Ø±ÙˆØ´ØªØ© Ø§Ù„Ø·Ø¨ÙŠØ©</h5>
                                </div>
                                <div class="card-body">
                                    <div id="selectedPatientInfo" class="alert alert-info" style="display: none;">
                                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø±ÙŠØ¶ Ø§Ù„Ù…Ø®ØªØ§Ø± -->
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Ø§Ù„ØªØ´Ø®ÙŠØµ</label>
                                        <textarea id="diagnosisText" class="form-control" rows="4" 
                                                  placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªØ´Ø®ÙŠØµ ÙˆØ§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ©..."></textarea>
                                    </div>
                                    
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØµÙˆÙØ©</label>
                                        <div id="prescribedMeds" class="prescription-box">
                                            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© Ø§Ù„Ù…ÙˆØµÙˆÙØ© -->
                                        </div>
                                    </div>
                                    
                                    <div class="row g-3">
                                        <div class="col-md-4">
                                            <label class="form-label">Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
                                            <input type="text" id="medName" class="form-control" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„Ø¬Ø±Ø¹Ø©</label>
                                            <input type="text" id="medDose" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 2Ã—1">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„Ù…Ø¯Ø©</label>
                                            <input type="text" id="medDuration" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 5 Ø£ÙŠØ§Ù…">
                                        </div>
                                        <div class="col-md-2 d-flex align-items-end">
                                            <button class="btn btn-primary w-100" onclick="addMedicineToPrescription()">
                                                â• Ø¥Ø¶Ø§ÙØ©
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4 d-flex gap-2">
                                        <button class="btn btn-primary flex-fill" onclick="savePrescription()">
                                            ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø±ÙˆØ´ØªØ©
                                        </button>
                                        <button class="btn btn-success flex-fill" onclick="printPrescription()">
                                            ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø±ÙˆØ´ØªØ©
                                        </button>
                                        <button class="btn btn-warning flex-fill" onclick="sendToPharmacy()">
                                            ğŸ’Š Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                <div id="pharmacyTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¡</label>
                                            <input type="text" id="newMedName" class="form-control" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„Ø³Ø¹Ø± (Ø¬.Ø³)</label>
                                            <input type="number" id="newMedPrice" class="form-control" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Ø§Ù„ÙƒÙ…ÙŠØ©</label>
                                            <input type="number" id="newMedQty" class="form-control" placeholder="Ø§Ù„Ø¹Ø¯Ø¯">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ù„Ù†ÙˆØ¹</label>
                                            <select id="newMedType" class="form-select">
                                                <option value="Ø­Ø¨ÙˆØ¨">Ø­Ø¨ÙˆØ¨</option>
                                                <option value="Ø´Ø±Ø§Ø¨">Ø´Ø±Ø§Ø¨</option>
                                                <option value="Ø­Ù‚Ù†">Ø­Ù‚Ù†</option>
                                                <option value="Ù…Ø±Ù‡Ù…">Ù…Ø±Ù‡Ù…</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø§Ù„Ø´Ø±ÙƒØ©</label>
                                            <input type="text" id="newMedCompany" class="form-control" placeholder="Ø§Ù„Ø´Ø±ÙƒØ© Ø§Ù„Ù…ØµÙ†Ø¹Ø©">
                                        </div>
                                        <div class="col-md-12">
                                            <button class="btn btn-success w-100" onclick="addMedicineToInventory()">
                                                â• Ø¥Ø¶Ø§ÙØ© Ø¯ÙˆØ§Ø¡ Ø¬Ø¯ÙŠØ¯
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h6>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</h6>
                                        <div id="inventoryList" style="max-height: 300px; overflow-y: auto;">
                                            <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ† -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©</h5>
                                </div>
                                <div class="card-body">
                                    <div id="pharmacyOrdersList" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù…Ù„ -->
                <div id="labTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­ÙˆØµØ§Øª</h5>
                                </div>
                                <div class="card-body">
                                    <div id="labRequestsList" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙØ­ÙˆØµØ§Øª -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">Ø¥Ø¯Ø®Ø§Ù„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ­ÙˆØµØ§Øª</h5>
                                </div>
                                <div class="card-body">
                                    <div id="labResultsForm">
                                        <!-- Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
                <div id="patientsTab" class="tab-pane" style="display: none;">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <div class="row align-items-center">
                                <div class="col-md-6">
                                    <h5 class="mb-0">Ø³Ø¬Ù„ Ø§Ù„Ù…Ø±Ø¶Ù‰</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <input type="date" id="filterDate" class="form-control" onchange="filterPatientsByDate()">
                                        <input type="text" id="searchPatient" class="form-control" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø£Ùˆ Ù‡Ø§ØªÙ..." 
                                               onkeyup="searchAllPatients(this.value)">
                                        <button class="btn btn-light" onclick="loadAllPatients()">
                                            ğŸ”„ ØªØ­Ø¯ÙŠØ«
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</th>
                                            <th>Ø§Ù„Ø¹Ù…Ø±</th>
                                            <th>Ø§Ù„Ø¬Ù†Ø³</th>
                                            <th>Ø§Ù„Ù‡Ø§ØªÙ</th>
                                            <th>ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                                            <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                            <th>Ø§Ù„Ø±Ø³ÙˆÙ…</th>
                                            <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                                        </tr>
                                    </thead>
                                    <tbody id="allPatientsTable">
                                        <!-- Ø¬Ø¯ÙˆÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± -->
                <div id="reportsTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">Ù…Ù† ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" id="reportFrom" class="form-control">
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®</label>
                                            <input type="date" id="reportTo" class="form-control">
                                        </div>
                                        <div class="col-md-12">
                                            <button class="btn btn-primary w-100" onclick="generateFinancialReport()">
                                                ğŸ“Š ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <div id="financialReport">
                                            <!-- Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                                </div>
                                <div class="card-body">
                                    <div id="systemStats">
                                        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª -->
                <div id="settingsTab" class="tab-pane" style="display: none;">
                    <div class="row">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h5 class="mb-0">Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„</h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</label>
                                        <input type="text" id="serverUrl" class="form-control" value="AlshifaClinic.somee.com" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</label>
                                        <input type="text" id="dbName" class="form-control" value="AlshifaDb.mssql.somee.com" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                                        <input type="text" id="dbUsername" class="form-control" value="Musab_SQLLogin_1" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Ø­Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„</label>
                                        <div id="connectionTestResult" class="alert alert-info">
                                            Ø¬Ø§Ø±ÙŠ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„...
                                        </div>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="testConnection()">
                                        ğŸ”„ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h5>
                                </div>
                                <div class="card-body">
                                    <div id="systemInformation">
                                        <!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ù„ØªØ­Ù…ÙŠÙ„ -->
    <div class="modal fade" id="loadingModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-body text-center py-4">
                    <div class="loader mx-auto mb-3"></div>
                    <h5 id="loadingMessage">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</h5>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ù„Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª -->
    <div class="modal fade" id="alertModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="alertModalTitle">ØªÙ†Ø¨ÙŠÙ‡</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="alertModalBody">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Ù…ÙˆØ§ÙÙ‚</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal ØªØ£ÙƒÙŠØ¯ -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="confirmModalTitle">ØªØ£ÙƒÙŠØ¯</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="confirmModalBody">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¥Ù„ØºØ§Ø¡</button>
                    <button type="button" class="btn btn-primary" id="confirmModalBtn" onclick="confirmAction()">ØªØ£ÙƒÙŠØ¯</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© -->
    <div id="printArea" style="display: none; padding: 30px; direction: rtl;">
        <div id="printContent"></div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
    // ============================================
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ø¯Ø«Ø© Ù„Ù„Ø±Ø¨Ø· Ù…Ø¹ Ø§Ù„Ø³ÙŠØ±ÙØ±
    // ============================================
    
    // Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ Ù…Ø³Ø§Ø± Ù†Ø³Ø¨ÙŠ Ø¹Ø´Ø§Ù† ÙŠØ´ØªØºÙ„ ÙÙŠ Ù†ÙØ³ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const API_URL = 'api.aspx'; 
    
    let currentUser = null;
    let selectedMedicines = [];

    // --- Ø¯Ø§Ù„Ø© Ø§Ù„Ø§ØªØµØ§Ù„ Ø§Ù„Ø¹Ø§Ù…Ø© (Ø§Ù„Ù…Ø­Ø¯Ø«Ø©) ---
    async function callApi(action, method = 'GET', data = null) {
        try {
            let url = `${API_URL}?action=${action}`;
            let options = { method: method };

            if (method === 'POST' && data) {
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù€ Form Data Ø¹Ø´Ø§Ù† Ø§Ù„Ù€ API ÙŠØ³ØªÙ„Ù…Ù‡Ø§ ØµØ­
                const formData = new URLSearchParams();
                for (const key in data) formData.append(key, data[key]);
                options.body = formData;
                options.headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
            }

            const response = await fetch(url, options);
            const result = await response.json();
            return result;
        } catch (error) {
            console.error('API Error:', error);
            return { success: false, error: "ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±" };
        }
    }

    // --- 1. Ø¹Ù…Ù„ÙŠØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ---
    async function login() {
        const u = document.getElementById('loginUsername').value;
        const p = document.getElementById('loginPassword').value;
        const r = document.getElementById('loginRole').value;

        const result = await callApi('login', 'POST', { username: u, password: p, role: r });

        if (result.success) {
            currentUser = { name: result.user.name, role: r };
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainApp').style.display = 'block';
            document.getElementById('currentUserRole').textContent = currentUser.name + " (" + r + ")";
            loadInitialData();
        } else {
            alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: " + result.error);
        }
    }

    // --- 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ÙÙˆÙ‚) ---
    async function loadStatistics() {
        const result = await callApi('getstatistics');
        if (result.success) {
            const statsRow = document.getElementById('statsRow');
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            statsRow.innerHTML = `
                <div class="col-md-3">
                    <div class="stat-card">
                        <div class="stat-number">${result.total}</div>
                        <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø¶Ù‰</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #ed8936, #dd6b20);">
                        <div class="stat-number">${result.waiting}</div>
                        <div class="stat-label">ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø·Ø¨ÙŠØ¨</div>
                    </div>
                </div>
            `;
        }
    }

    // --- 3. ØªØ³Ø¬ÙŠÙ„ Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯ ---
    async function registerPatient() {
        const name = document.getElementById('patientName').value;
        const age = document.getElementById('patientAge').value;
        
        if(!name || !age) { alert("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¹Ù…Ø±"); return; }

        const result = await callApi('addpatient', 'POST', { name: name, age: age });
        if (result.success) {
            alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø±ÙŠØ¶ Ø¨Ù†Ø¬Ø§Ø­");
            switchTab('dashboard');
            loadInitialData();
        }
    }

    // --- 4. Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© ---
    async function loadWaitingPatients() {
        const result = await callApi('getwaitingpatients');
        const container = document.getElementById('waitingPatients');
        
        if (result.success && result.patients) {
            container.innerHTML = result.patients.map(p => `
                <div class="card patient-card mb-2">
                    <div class="card-body p-3">
                        <h6>${p.Name}</h6>
                        <small>${p.Age} Ø³Ù†Ø© - Ø§Ù„Ø­Ø§Ù„Ø©: ${p.Status}</small>
                        <button class="btn btn-sm btn-primary d-block mt-2" onclick="selectPatientForExamination(${p.Id}, '${p.Name}')">Ø¨Ø¯Ø¡ Ø§Ù„ÙƒØ´Ù</button>
                    </div>
                </div>
            `).join('');
            document.getElementById('clinicBadge').innerText = result.patients.length;
            document.getElementById('clinicBadge').style.display = 'inline';
        }
    }

    // --- Ø¯Ø§Ù„Ø© Ø§Ø®ØªÙŠØ§Ø± Ù…Ø±ÙŠØ¶ Ù„Ù„ÙƒØ´Ù ---
    function selectPatientForExamination(id, name) {
        document.getElementById('selectedPatientInfo').style.display = 'block';
        document.getElementById('selectedPatientInfo').innerHTML = `<h6>Ø§Ù„Ø·Ø¨ÙŠØ¨ ÙŠÙƒØ´Ù Ø§Ù„Ø¢Ù† Ø¹Ù„Ù‰: ${name}</h6>`;
        // Ù‡Ù†Ø§ Ù…Ù…ÙƒÙ† ØªØ¶ÙŠÙ ÙƒÙˆØ¯ Ù„ÙØªØ­ Ø§Ù„Ø±ÙˆØ´ØªØ©
    }

    // --- ÙˆØ¸Ø§Ø¦Ù Ø¹Ø§Ù…Ø© ---
    function loadInitialData() {
        loadStatistics();
        loadWaitingPatients();
    }

    function switchTab(tabName) {
        document.querySelectorAll('.tab-pane').forEach(t => t.style.display = 'none');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        document.getElementById(tabName + 'Tab').style.display = 'block';
        document.getElementById('tab-' + tabName).classList.add('active');
        if(tabName === 'clinic') loadWaitingPatients();
        if(tabName === 'dashboard') loadStatistics();
    }

    function logout() { location.reload(); }

    // Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
    window.onload = async () => {
        const res = await callApi('ping');
        const statusText = document.getElementById('serverConnectionStatus');
        if(res.success) {
            statusText.innerHTML = "ğŸŸ¢ Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…ØªØµÙ„ ÙˆØ¬Ø§Ù‡Ø²";
            statusText.className = "text-success";
        } else {
            statusText.innerHTML = "ğŸ”´ Ù…Ø´ÙƒÙ„Ø© ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ù€ API";
        }
    };
</script>
