<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c7a7b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/822/822118.png">
    
    <title>ูุฌูุน ุงูุดูุงุก - ุงููุณุฎุฉ ุงูุฐููุฉ ุงูุดุงููุฉ 2025</title>
    
    <link rel="manifest" href="data:application/manifest+json,{%22name%22:%22%D9%85%D8%AC%D9%85%D8%B9%20%D8%A7%D9%84%D8%B4%D9%81%D8%A7%D8%A1%22,%22short_name%22:%22%D8%A7%D9%84%D8%B4%D9%81%D8%A1%22,%22start_url%22:%22index.html%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f8fafc%22,%22theme_color%22:%22%232c7a7b%22,%22icons%22:[{%22src%22:%22https://cdn-icons-png.flaticon.com/512/822/822118.png%22,%22sizes%22:%22512x512%22,%22type%22:%22image/png%22}]}">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <style>
        :root { 
            --primary-color: #2c7a7b; 
            --secondary-color: #f0fdf4; 
            --accent-blue: #0d6efd; 
            --accent-red: #dc3545; 
            --accent-green: #198754; 
            --accent-gold: #d4af37;
            --accent-warning: #ffc107;
            --accent-info: #17a2b8;
            --accent-purple: #6f42c1;
        }
        body { background-color: #f8fafc; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; -webkit-tap-highlight-color: transparent; }
        .navbar { background-color: var(--primary-color) !important; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { border-radius: 15px; border: none; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 15px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        .hidden-section { display: none !important; }
        .nav-link { cursor: pointer; font-weight: bold; color: var(--primary-color); padding: 10px 20px !important; position: relative; }
        .nav-link.active { background-color: var(--accent-blue) !important; color: white !important; border-radius: 10px; }
        .badge-notify { position: absolute; top: -5px; right: -5px; background: var(--accent-red); color: white; border-radius: 50%; padding: 3px 7px; font-size: 0.7rem; }
        .stat-card { border-radius: 15px; padding: 20px; color: white; text-align: center; }
        .patient-btn { text-align: right; margin-bottom: 8px; border-right: 5px solid var(--primary-color); width: 100%; transition: 0.3s; padding: 12px 15px; background: white; border: 1px solid #dee2e6; border-radius: 10px; }
        .patient-btn.ready { border-right-color: #28a745; background-color: #f0fff4; }
        .patient-btn:hover { background-color: #f8f9fa; }
        .lab-result-item { background: #e9ecef; padding: 10px; border-radius: 8px; margin-bottom: 5px; border-left: 4px solid var(--accent-blue); }
        .section-pane { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @media print { .no-print { display: none !important; } body * { visibility: hidden; } #printArea, #printArea * { visibility: visible; } #printArea { position: absolute; left: 0; top: 0; width: 100%; direction: rtl; padding: 20px; } }
        .search-box { position: relative; }
        .search-box input { padding-right: 40px; }
        .rx-item { background: #f8f9fa; padding: 8px 12px; margin: 5px 0; border-radius: 8px; border-left: 4px solid var(--accent-green); }
        .status-online { color: #28a745; font-weight: bold; }
        .status-offline { color: #dc3545; font-weight: bold; }
        .sync-status { position: fixed; bottom: 10px; left: 10px; z-index: 1000; }
        .sync-btn { position: fixed; bottom: 10px; right: 10px; z-index: 1000; }
        .medical-record { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px; }
        .nursing-schedule { border-left: 5px solid var(--accent-purple); }
        .expiry-warning { background: #fff3cd; border-left: 5px solid #ffc107; }
        .stock-critical { background: #f8d7da; border-left: 5px solid #dc3545; }
        .library-card { height: 100%; transition: all 0.3s; }
        .library-card:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
    </style>
</head>
<body>

    <audio id="notificationSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- ููุทูุฉ ุงูุทุจุงุนุฉ -->
    <div id="printArea" class="hidden-section">
        <div class="text-center border-bottom pb-3 mb-3">
            <h2 style="color: var(--primary-color);">๐ฅ ูุฌูุน ุงูุดูุงุก ุงูุทุจู</h2>
            <p>ุงูุณูุฏุงู - ุฌูููู</p>
            <h5 id="printTitle">ุฑูุดุชุฉ ุทุจูุฉ / ูุงุชูุฑุฉ</h5>
            <small id="printDate"></small>
        </div>
        <div id="printContent" class="fs-5"></div>
        <div class="mt-5 pt-3 border-top text-center"><p>ูุชููู ููู ุนุงุฌู ุงูุดูุงุก</p></div>
    </div>

    <!-- ุดุงุดุฉ ุชุณุฌูู ุงูุฏุฎูู -->
    <div id="loginOverlay" class="no-print" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f0fdf4; z-index: 9999; display: flex; align-items: center; justify-content: center;">
        <div class="card p-4 shadow-lg" style="width: 380px; border-top: 8px solid var(--primary-color);">
            <div class="text-center mb-4">
                <img src="https://cdn-icons-png.flaticon.com/512/822/822118.png" width="60">
                <h3 class="mt-2 fw-bold" style="color: var(--primary-color);">ูุฌูุน ุงูุดูุงุก ุงูุทุจู</h3>
                <p class="text-muted small">ุงููุธุงู ุงูุฐูู ุงูุดุงูู - ุฅุฏุงุฑุฉ ูุชูุงููุฉ</p>
                <div class="mt-2">
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="loginMode" id="modeLocal" value="local" checked>
                        <label class="form-check-label" for="modeLocal">๐พ ุนูู ูุญูู</label>
                    </div>
                    <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="loginMode" id="modeServer" value="server">
                        <label class="form-check-label" for="modeServer">โ๏ธ ูุงุนุฏุฉ ุจูุงูุงุช</label>
                    </div>
                </div>
            </div>
            <input type="text" id="username" class="form-control mb-3" placeholder="ุงุณู ุงููุณุชุฎุฏู" value="admin">
            <input type="password" id="password" class="form-control mb-3" placeholder="ูููุฉ ุงููุฑูุฑ" value="123">
            <button class="btn btn-primary w-100 fw-bold" onclick="handleLogin()">๐ ุฏุฎูู ูููุธุงู</button>
            <div class="mt-3 text-center small text-muted" id="loginStatus">ุฌุงูุฒ ููุชุดุบูู</div>
        </div>
    </div>

    <!-- ุงููุญุชูู ุงูุฑุฆูุณู -->
    <div id="mainContent" class="hidden-section">
        <!-- ุดุฑูุท ุงูุชููู -->
        <nav class="navbar navbar-dark mb-4 no-print">
            <div class="container d-flex justify-content-between text-white align-items-center">
                <span class="navbar-brand fw-bold">๐ฅ ูุฌูุน ุงูุดูุงุก - ุงููุธุงู ุงูุฐูู</span>
                <div>
                    <span id="currentUserDisplay" class="badge bg-light text-dark mx-2"></span>
                    <span id="clockDisplay" class="badge bg-info text-dark"></span>
                    <span id="connectionStatus" class="badge bg-success mx-2">ูุชุตู ูุญููุงู</span>
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="logout()">ุฎุฑูุฌ</button>
            </div>
        </nav>

        <!-- ุชุจููุจุงุช ุงูุชููู -->
        <div class="container">
            <ul class="nav nav-pills mb-4 shadow-sm p-2 bg-white rounded justify-content-center no-print">
                <li class="nav-item" id="tab-reception-li"><button class="nav-link" id="btn-reception" onclick="switchSection('reception')">๐ ุงูุงุณุชูุจุงู</button></li>
                <li class="nav-item" id="tab-doctor-li"><button class="nav-link" id="btn-doctor" onclick="switchSection('doctor')">๐จโโ๏ธ ุงูุนูุงุฏุฉ <span id="doctorBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-lab-li"><button class="nav-link" id="btn-lab" onclick="switchSection('lab')">๐งช ุงููุนูู <span id="labBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-pharmacy-li"><button class="nav-link" id="btn-pharmacy" onclick="switchSection('pharmacy')">๐ ุงูุตูุฏููุฉ <span id="pharBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-nursing-li"><button class="nav-link" id="btn-nursing" onclick="switchSection('nursing')">๐ ุงูุชูุฑูุถ <span id="nurseBadge" class="badge-notify hidden-section">0</span></button></li>
                <li class="nav-item" id="tab-admin-li"><button class="nav-link" id="btn-admin" onclick="switchSection('admin')">๐ ุงููุฏูุฑ</button></li>
            </ul>

            <!-- ุฃุฒุฑุงุฑ ุงููุฒุงููุฉ -->
            <div class="sync-status no-print">
                <div id="syncStatusText" class="badge bg-secondary">ุฌุงูุฒ</div>
            </div>
            <div class="sync-btn no-print">
                <button class="btn btn-sm btn-outline-primary" onclick="manualSync()" title="ูุฒุงููุฉ ูุฏููุฉ">
                    ๐ ูุฒุงููุฉ
                </button>
            </div>

            <!-- ูุญุชูู ุงูุฃูุณุงู -->
            <div class="tab-content">
                <!-- ูุณู ุงูุงุณุชูุจุงู (ูุญุฏุซ) -->
                <div id="reception-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4 border-primary border-top border-4 shadow">
                                <h5 class="fw-bold text-primary mb-3">๐ ุชุณุฌูู ูุฑูุถ ุฌุฏูุฏ - ุงูุณุฌู ุงูุดุงูู</h5>
                                <div class="row g-3">
                                    <div class="col-md-4">
                                        <input type="text" id="pName" class="form-control" placeholder="ุงูุงุณู ุฑุจุงุนู *" required>
                                    </div>
                                    <div class="col-md-2">
                                        <input type="number" id="pAge" class="form-control" placeholder="ุงูุนูุฑ *" required>
                                    </div>
                                    <div class="col-md-2">
                                        <select id="pGender" class="form-select">
                                            <option value="">ุงูุฌูุณ</option>
                                            <option value="ุฐูุฑ">ุฐูุฑ</option>
                                            <option value="ุฃูุซู">ุฃูุซู</option>
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <input type="text" id="pPhone" class="form-control" placeholder="ุฑูู ุงููุงุชู">
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" id="pAddress" class="form-control" placeholder="ุงูุนููุงู ุงููุงูู">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="number" id="pTicket" class="form-control" placeholder="ุงูุฑุณูู" value="5000">
                                    </div>
                                    <div class="col-md-3">
                                        <select id="pVisitType" class="form-select">
                                            <option value="ุฒูุงุฑุฉ ุฌุฏูุฏุฉ">ุฒูุงุฑุฉ ุฌุฏูุฏุฉ</option>
                                            <option value="ูุฑุงุฌุนุฉ">ูุฑุงุฌุนุฉ</option>
                                            <option value="ูุชุงุจุนุฉ">ูุชุงุจุนุฉ</option>
                                        </select>
                                    </div>
                                    <div class="col-md-12">
                                        <textarea id="pMedicalHistory" class="form-control" rows="3" placeholder="ุชุงุฑูุฎ ูุฑุถู ุณุงุจู (ุญุณุงุณูุงุชุ ุฃูุฑุงุถ ูุฒููุฉุ ุฃุฏููุฉ ููุชุธูุฉ...)"></textarea>
                                    </div>
                                    <div class="col-md-12">
                                        <button class="btn btn-primary w-100 fw-bold" onclick="registerPatient()">
                                            ๐พ ุญูุธ ูุฅูุดุงุก ุงูุณุฌู ุงูุทุจู
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ุณุฌู ุงููุฑุถู -->
                            <div class="card p-3 mt-3 border-info shadow">
                                <h6 class="fw-bold text-info">๐ ุณุฌู ุงููุฑุถู ุงูุณุงุจููู</h6>
                                <input type="text" class="form-control mb-2" placeholder="ุจุญุซ ุจุงูุงุณู ุฃู ุงููุงุชู..." onkeyup="searchPatientRecords(this.value)">
                                <div id="patientRecordsList" style="max-height: 300px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 bg-light shadow">
                                <h6 class="fw-bold">๐ ุฅุญุตุงุฆูุงุช ุงูุงุณุชูุจุงู</h6>
                                <div class="row text-center">
                                    <div class="col-6 mb-3">
                                        <div class="bg-primary text-white p-3 rounded">
                                            <h4 id="todayPatients">0</h4>
                                            <small>ูุฑุถู ุงูููู</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-3">
                                        <div class="bg-success text-white p-3 rounded">
                                            <h4 id="totalPatients">0</h4>
                                            <small>ุฅุฌูุงูู ุงููุฑุถู</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-warning text-white p-3 rounded">
                                            <h4 id="newPatients">0</h4>
                                            <small>ุฌุฏุฏ</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-info text-white p-3 rounded">
                                            <h4 id="returnPatients">0</h4>
                                            <small>ูุฑุงุฌุนูู</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="mt-3">
                                    <h6 class="fw-bold">โฐ ุฃููุงุช ุงูุงูุชุธุงุฑ</h6>
                                    <div class="progress mb-2">
                                        <div class="progress-bar bg-success" style="width: 30%">0-15 ุฏ</div>
                                        <div class="progress-bar bg-warning" style="width: 40%">15-30 ุฏ</div>
                                        <div class="progress-bar bg-danger" style="width: 30%">+30 ุฏ</div>
                                    </div>
                                    <small class="text-muted">ูุชูุณุท ููุช ุงูุงูุชุธุงุฑ: <span id="avgWaitTime">0</span> ุฏูููุฉ</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงูุนูุงุฏุฉ (ูุญุฏุซ) -->
                <div id="doctor-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card p-3 shadow-sm">
                                <h6 class="fw-bold text-primary border-bottom pb-2">๐ฅ ูุงุฆูุฉ ุงูุงูุชุธุงุฑ</h6>
                                <div class="search-box mb-3">
                                    <input type="text" id="searchPatient" class="form-control" placeholder="ุจุญุซ ุนู ูุฑูุถ..." onkeyup="searchPatients(this.value)">
                                </div>
                                <div id="doctorPatientList" class="mt-2" style="max-height: 400px; overflow-y: auto;"></div>
                            </div>
                            
                            <!-- ููุชุจุฉ ุทุจูุฉ ุฑูููุฉ -->
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h6 class="fw-bold text-warning">๐ ุงูููุชุจุฉ ุงูุทุจูุฉ</h6>
                                <div class="input-group mb-2">
                                    <input type="text" id="librarySearch" class="form-control" placeholder="ุจุญุซ ุนู ูุฑุถ ุฃู ุฏูุงุก..." onkeyup="searchLibrary(this.value)">
                                    <button class="btn btn-warning" onclick="openLibrary()">๐</button>
                                </div>
                                <div id="quickLibraryResults" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-8">
                            <!-- ููุทูุฉ ุงูุนูุงุฌ -->
                            <div id="treatmentArea" class="card p-4 shadow hidden-section">
                                <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-3">
                                    <div>
                                        <h4 class="text-primary fw-bold mb-0" id="selectedPatientTitle"></h4>
                                        <small class="text-muted" id="selectedPatientInfo"></small>
                                    </div>
                                    <div>
                                        <span class="badge bg-warning text-dark" id="caseStatus">ุชุญุช ุงููุนุงููุฉ</span>
                                        <button class="btn btn-sm btn-outline-info ms-2" onclick="viewFullMedicalRecord()">๐ ุงูุณุฌู ุงููุงูู</button>
                                    </div>
                                </div>
                                
                                <!-- ุนูุงูุงุช ุญูููุฉ -->
                                <div class="row g-2 mb-3">
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" placeholder="ุงูุถุบุท" id="vitalBP">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="ุงููุจุถ" id="vitalPulse">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="ุงูุญุฑุงุฑุฉ" id="vitalTemp">
                                    </div>
                                    <div class="col-md-2">
                                        <input type="text" class="form-control" placeholder="ุงูุชููุณ" id="vitalResp">
                                    </div>
                                    <div class="col-md-3">
                                        <input type="text" class="form-control" placeholder="ุงูุณูุฑ" id="vitalSugar">
                                    </div>
                                </div>
                                
                                <!-- ุงูุณุฌู ุงูุทุจู ูููุฑูุถ -->
                                <div class="medical-record mb-3">
                                    <h6 class="fw-bold">๐ ุงูุณุฌู ุงูุทุจู ูููุฑูุถ</h6>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>ุงูุชุงุฑูุฎ ุงููุฑุถู:</strong> <span id="patientMedicalHistory">ูุง ููุฌุฏ</span></p>
                                            <p><strong>ุงูุฃุฏููุฉ ุงูููุชุธูุฉ:</strong> <span id="patientRegularMeds">ูุง ููุฌุฏ</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>ุงูุญุณุงุณูุงุช:</strong> <span id="patientAllergies">ูุง ููุฌุฏ</span></p>
                                            <p><strong>ุงูุนูููุงุช ุงูุณุงุจูุฉ:</strong> <span id="patientSurgeries">ูุง ููุฌุฏ</span></p>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="fw-bold mb-1">ุดููู ุงููุฑูุถ ูุงูุชุดุฎูุต:</label>
                                    <textarea id="pComplaint" class="form-control" rows="3" placeholder="ุงูุชุจ ุดููู ุงููุฑูุถ ูุงูุชุดุฎูุต ููุง..."></textarea>
                                </div>
                                
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showDocSubSection('rx')">๐ ุงูุฑูุดุชุฉ</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('lab')">๐งช ุทูุจ ูุญุต</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('results')">๐ ุงููุชุงุฆุฌ</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showDocSubSection('nursing')">๐ ุงูุชูุฑูุถ</button></li>
                                </ul>
                                
                                <div id="doc-sub-rx">
                                    <div class="p-3 bg-light border rounded mb-3">
                                        <h6 class="text-muted small mb-2">ุฅุถุงูุฉ ุฃุฏููุฉ ููุฑูุดุชุฉ:</h6>
                                        <div class="row g-2 mb-2">
                                            <div class="col-md-5">
                                                <input list="stockMeds" id="medSearch" class="form-control" placeholder="ุงุณู ุงูุฏูุงุก..." onkeyup="filterStock(this.value)">
                                                <datalist id="stockMeds"></datalist>
                                            </div>
                                            <div class="col-md-3">
                                                <input type="text" id="medDose" class="form-control" placeholder="ุงูุฌุฑุนุฉ">
                                            </div>
                                            <div class="col-md-2">
                                                <input type="number" id="medDays" class="form-control" placeholder="ุงูุฃูุงู" value="7">
                                            </div>
                                            <div class="col-md-2">
                                                <button class="btn btn-outline-primary w-100" onclick="addMedToRx()">โ</button>
                                            </div>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="checkInteractions">
                                            <label class="form-check-label small" for="checkInteractions">ูุญุต ุชูุงุนูุงุช ุงูุฃุฏููุฉ</label>
                                        </div>
                                    </div>
                                    <div id="rxItemsContainer" class="mb-3"></div>
                                    <div id="drugInteractionsAlert" class="alert alert-danger hidden-section"></div>
                                    <textarea id="finalRx" class="form-control mb-3 bg-white" rows="4" readonly placeholder="ูุญุชูู ุงูุฑูุดุชุฉ..."></textarea>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success w-50 fw-bold" onclick="sendRxToPharmacy()">๐ ุฅุฑุณุงู ููุตูุฏููุฉ</button>
                                        <button class="btn btn-warning w-25" onclick="addNursingOrders()">๐ ุฅุถุงูุฉ ุชูุฑูุถ</button>
                                        <button class="btn btn-dark w-25" onclick="printRx()">๐จ๏ธ ุทุจุงุนุฉ</button>
                                    </div>
                                </div>
                                
                                <div id="doc-sub-lab" class="hidden-section">
                                    <div class="input-group mb-3">
                                        <select id="testSelect" class="form-select"></select>
                                        <button class="btn btn-danger" onclick="sendToLab()">๐งช ุฅุฑุณุงู ูููุนูู</button>
                                    </div>
                                    <h6 class="fw-bold text-success mt-3">๐ ุทูุจุงุช ุงููุญูุตุงุช ุงููุฑุณูุฉ:</h6>
                                    <div id="doctorLabRequests"></div>
                                </div>
                                
                                <div id="doc-sub-results" class="hidden-section">
                                    <h6 class="fw-bold text-success">โ ูุชุงุฆุฌ ุงููุญูุตุงุช ุงููุงุฑุฏุฉ:</h6>
                                    <div id="patientSpecificLabResults" class="mt-2" style="max-height: 300px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="doc-sub-nursing" class="hidden-section">
                                    <h6 class="fw-bold text-purple">๐ ุฃูุงูุฑ ุงูุชูุฑูุถ</h6>
                                    <div class="row g-2 mb-3">
                                        <div class="col-md-6">
                                            <select id="nursingProcedure" class="form-select">
                                                <option value="">ุงุฎุชุฑ ุงูุฅุฌุฑุงุก</option>
                                                <option value="ุญูู ุนุถูู">ุญูู ุนุถูู</option>
                                                <option value="ุญูู ูุฑูุฏู">ุญูู ูุฑูุฏู</option>
                                                <option value="ุชุบููุฑ ุถูุงุฏุฉ">ุชุบููุฑ ุถูุงุฏุฉ</option>
                                                <option value="ููุงุณ ุนูุงูุงุช ุญูููุฉ">ููุงุณ ุนูุงูุงุช ุญูููุฉ</option>
                                                <option value="ุนูุงูุฉ ุจุงูุฌุฑุญ">ุนูุงูุฉ ุจุงูุฌุฑุญ</option>
                                                <option value="ุฅุนุทุงุก ุฃูุณุฌูู">ุฅุนุทุงุก ุฃูุณุฌูู</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" id="nursingFrequency" class="form-control" placeholder="ุงูุชูุฑุงุฑ">
                                        </div>
                                        <div class="col-md-2">
                                            <button class="btn btn-purple w-100 text-white" onclick="addNursingOrder()">โ</button>
                                        </div>
                                    </div>
                                    <div id="nursingOrdersList" class="mb-3"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงููุนูู -->
                <div id="lab-sec" class="section-pane hidden-section">
                    <div class="card p-3 border-danger border-top border-4 shadow">
                        <h5 class="fw-bold text-danger mb-3">๐งช ุทูุจุงุช ุงููุญูุตุงุช ูุณุญุจ ุงูุนููุงุช</h5>
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-danger">
                                    <tr>
                                        <th>ุงููุฑูุถ</th>
                                        <th>ุงููุญุต</th>
                                        <th>ุงูุณุนุฑ</th>
                                        <th>ุงูููุช</th>
                                        <th>ุงููุชูุฌุฉ</th>
                                        <th>ุฅุฌุฑุงุก</th>
                                    </tr>
                                </thead>
                                <tbody id="labWorkTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงูุตูุฏููุฉ (ูุญุฏุซ ุจุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู) -->
                <div id="pharmacy-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-7">
                            <div class="card p-3 border-success border-top border-4 shadow">
                                <h5 class="fw-bold text-success mb-3">๐ ุงูุฑูุดุชุงุช ุงููุงุฑุฏุฉ</h5>
                                <div id="pharmacyQueue"></div>
                            </div>
                            
                            <!-- ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู -->
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h5 class="fw-bold text-warning mb-3">๐ฆ ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู</h5>
                                <div class="row mb-3">
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-danger">๐ ุฏูุฑุชู</h6>
                                            <h4 id="stockTurnover">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-warning">โฐ ุฃูุงู ุงููุฎุฒูู</h6>
                                            <h4 id="stockDays">0</h4>
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="card bg-light p-2 text-center">
                                            <h6 class="text-success">๐ ููุงุกุฉ</h6>
                                            <h4 id="stockEfficiency">0%</h4>
                                        </div>
                                    </div>
                                </div>
                                <div id="strategicStockAlerts"></div>
                            </div>
                        </div>
                        
                        <div class="col-md-5">
                            <div class="card p-3 bg-light shadow">
                                <h5 class="fw-bold">๐ฆ ุฅุฏุงุฑุฉ ุงููุฎุฒูู ุงููุชูุฏูุฉ</h5>
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showPharmacyTab('inventory')">ุงููุฎุฒูู</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showPharmacyTab('orders')">ุทูุจุงุช ุงูุดุฑุงุก</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showPharmacyTab('expiry')">ุงูุตูุงุญูุฉ</button></li>
                                </ul>
                                
                                <div id="pharmacy-inventory">
                                    <div class="input-group mb-2">
                                        <input type="text" id="iName" class="form-control" placeholder="ุงูุตูู">
                                        <input type="number" id="iCost" class="form-control" placeholder="ุณุนุฑ ุงูุดุฑุงุก">
                                        <input type="number" id="iQty" class="form-control" placeholder="ุงููููุฉ">
                                        <button class="btn btn-primary" onclick="addInventory()">โ ุฅุถุงูุฉ</button>
                                    </div>
                                    <div style="max-height: 300px; overflow-y: auto;">
                                        <table class="table table-sm table-striped bg-white">
                                            <thead>
                                                <tr>
                                                    <th>ุงูุตูู</th>
                                                    <th>ุณุนุฑ ุงูุจูุน</th>
                                                    <th>ุงููุฎุฒูู</th>
                                                    <th>ุฅุฌุฑุงุก</th>
                                                </tr>
                                            </thead>
                                            <tbody id="invTable"></tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <div id="pharmacy-orders" class="hidden-section">
                                    <button class="btn btn-warning w-100 mb-2" onclick="generatePurchaseOrders()">๐ ุชูููุฏ ุทูุจุงุช ุดุฑุงุก</button>
                                    <div id="purchaseOrdersList" style="max-height: 250px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="pharmacy-expiry" class="hidden-section">
                                    <h6 class="fw-bold text-danger">โ๏ธ ุชูุจููุงุช ุงูุชูุงุก ุงูุตูุงุญูุฉ</h6>
                                    <div id="expiryAlerts" style="max-height: 250px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงูุชูุฑูุถ (ุฌุฏูุฏ) -->
                <div id="nursing-sec" class="section-pane hidden-section">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="card p-4 border-purple border-top border-4 shadow">
                                <h5 class="fw-bold text-purple mb-3">๐ ุฌุฏูู ุงูููุฑุถูู - ุชูููุฐ ุงูุฌุฑุนุงุช</h5>
                                
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showNursingTab('schedule')">ุงูุฌุฏูู ุงููููู</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showNursingTab('patients')">ุงููุฑุถู ุงููุดุทูู</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showNursingTab('medications')">ุงูุฃุฏููุฉ ุงูููุฑุฑุฉ</button></li>
                                </ul>
                                
                                <div id="nursing-schedule">
                                    <div class="row mb-3">
                                        <div class="col-md-3">
                                            <input type="date" id="nursingDate" class="form-control" value="" onchange="loadNursingSchedule()">
                                        </div>
                                        <div class="col-md-3">
                                            <select id="nursingShift" class="form-select" onchange="loadNursingSchedule()">
                                                <option value="all">ุฌููุน ุงูููุงูุจุงุช</option>
                                                <option value="ุตุจุงุญ">ุตุจุงุญ (7ุต-3ู)</option>
                                                <option value="ูุณุงุก">ูุณุงุก (3ู-11ู)</option>
                                                <option value="ููู">ููู (11ู-7ุต)</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <button class="btn btn-purple w-100 text-white" onclick="addNewNursingTask()">โ ุฅุถุงูุฉ ูููุฉ ุฌุฏูุฏุฉ</button>
                                        </div>
                                    </div>
                                    <div id="nursingScheduleTable" style="max-height: 400px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="nursing-patients" class="hidden-section">
                                    <div class="row">
                                        <div class="col-md-12">
                                            <div class="input-group mb-3">
                                                <input type="text" class="form-control" placeholder="ุจุญุซ ุนู ูุฑูุถ..." id="searchNursingPatient">
                                                <button class="btn btn-outline-purple" onclick="searchNursingPatients()">ุจุญุซ</button>
                                            </div>
                                            <div id="nursingPatientsList" style="max-height: 400px; overflow-y: auto;"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="nursing-medications" class="hidden-section">
                                    <div class="alert alert-info">
                                        <h6>๐ ุฃุฏููุฉ ุชุญุชุงุฌ ุชูููุฐ</h6>
                                        <p id="pendingMedicationsCount">0 ุฏูุงุก ูุญุชุงุฌ ุฅุนุทุงุก</p>
                                    </div>
                                    <div id="nursingMedicationsList" style="max-height: 400px; overflow-y: auto;"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <div class="card p-3 bg-light shadow">
                                <h6 class="fw-bold">๐ฉโโ๏ธ ุฅุฏุงุฑุฉ ุงูููุฑุถูู</h6>
                                <div class="mb-3">
                                    <input type="text" class="form-control mb-2" placeholder="ุงุณู ุงูููุฑุถ/ุฉ">
                                    <select class="form-select mb-2">
                                        <option>ููุงูุจุฉ ุตุจุงุญ</option>
                                        <option>ููุงูุจุฉ ูุณุงุก</option>
                                        <option>ููุงูุจุฉ ููู</option>
                                    </select>
                                    <button class="btn btn-sm btn-purple text-white w-100">โ ุฅุถุงูุฉ ููุฑุถ</button>
                                </div>
                                <div id="nursesList" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="card p-3 mt-3 border-info shadow">
                                <h6 class="fw-bold">๐ ุฅุญุตุงุฆูุงุช ุงูุชูุฑูุถ</h6>
                                <div class="row text-center">
                                    <div class="col-6 mb-2">
                                        <div class="bg-info text-white p-2 rounded">
                                            <h5 id="nursingTasksToday">0</h5>
                                            <small>ููุงู ุงูููู</small>
                                        </div>
                                    </div>
                                    <div class="col-6 mb-2">
                                        <div class="bg-success text-white p-2 rounded">
                                            <h5 id="nursingTasksDone">0</h5>
                                            <small>ููุชููุฉ</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-warning text-white p-2 rounded">
                                            <h5 id="nursingTasksPending">0</h5>
                                            <small>ูุนููุฉ</small>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-danger text-white p-2 rounded">
                                            <h5 id="nursingTasksLate">0</h5>
                                            <small>ูุชุฃุฎุฑุฉ</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card p-3 mt-3 border-warning shadow">
                                <h6 class="fw-bold">โฐ ุชูุจููุงุช ูููุฉ</h6>
                                <div id="nursingAlerts" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ูุณู ุงููุฏูุฑ (ูุญุฏุซ) -->
                <div id="admin-sec" class="section-pane hidden-section">
                    <div class="row g-3 mb-4 text-white no-print">
                        <div class="col-md-3">
                            <div class="stat-card bg-primary shadow">๐ฆ ุงูุนูุงุฏุฉ<h2 id="finClinic">0</h2>ุฌููุฉ</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-danger shadow">๐งช ุงููุนูู<h2 id="finLab">0</h2>ุฌููุฉ</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-success shadow">๐ ูุจูุนุงุช ุงูุตูุฏููุฉ<h2 id="finPhar">0</h2>ุฌููุฉ</div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card bg-dark shadow">๐ฐ ุฅุฌูุงูู ุงูุฃุฑุจุงุญ<h2 id="totalProfit">0</h2>ุฌููุฉ</div>
                        </div>
                    </div>

                    <div class="row no-print">
                        <!-- ุงูููุชุจุฉ ุงูุทุจูุฉ ุงูุฑูููุฉ -->
                        <div class="col-md-4">
                            <div class="card p-4 border-top border-3 border-warning shadow library-card">
                                <h5 class="fw-bold text-warning mb-3">๐ ุงูููุชุจุฉ ุงูุทุจูุฉ ุงูุฑูููุฉ</h5>
                                <div class="input-group mb-3">
                                    <input type="text" id="searchMedicalLibrary" class="form-control" placeholder="ุจุญุซ ุนู ูุฑุถุ ุฏูุงุกุ ุฅุฌุฑุงุก...">
                                    <button class="btn btn-warning" onclick="searchMedicalLibrary()">๐</button>
                                </div>
                                <div class="mb-3">
                                    <select class="form-select" onchange="filterLibrary(this.value)">
                                        <option value="all">ุฌููุน ุงูุฃูุณุงู</option>
                                        <option value="diseases">ุงูุฃูุฑุงุถ</option>
                                        <option value="drugs">ุงูุฃุฏููุฉ</option>
                                        <option value="procedures">ุงูุฅุฌุฑุงุกุงุช</option>
                                        <option value="tests">ุงููุญูุตุงุช</option>
                                    </select>
                                </div>
                                <div id="medicalLibraryContent" style="max-height: 300px; overflow-y: auto;"></div>
                                <button class="btn btn-outline-warning w-100 mt-3" onclick="addToLibrary()">โ ุฅุถุงูุฉ ูุงุฏุฉ ุนูููุฉ</button>
                            </div>
                        </div>

                        <!-- ุชูุงุฑูุฑ ูุชูุฏูุฉ -->
                        <div class="col-md-8">
                            <div class="card p-4 border-top border-3 border-info shadow">
                                <h5 class="fw-bold mb-3">๐ ููุญุฉ ุงูุชุญูู ุงูุดุงููุฉ</h5>
                                
                                <ul class="nav nav-tabs mb-3">
                                    <li class="nav-item"><button class="nav-link active" onclick="showAdminTab('reports')">ุงูุชูุงุฑูุฑ</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showAdminTab('patients')">ุงููุฑุถู</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showAdminTab('inventory')">ุงููุฎุฒูู</button></li>
                                    <li class="nav-item"><button class="nav-link" onclick="showAdminTab('staff')">ุงูููุธููู</button></li>
                                </ul>
                                
                                <div id="admin-reports">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <div class="card p-3 bg-light">
                                                <h6>๐ ุงูุฅูุฑุงุฏุงุช ุงูุดูุฑูุฉ</h6>
                                                <canvas id="revenueChart" height="150"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card p-3 bg-light">
                                                <h6>๐ฅ ุชูุฒูุน ุงููุฑุถู</h6>
                                                <canvas id="patientsChart" height="150"></canvas>
                                            </div>
                                        </div>
                                        <div class="col-md-12">
                                            <div class="card p-3 bg-light">
                                                <h6>๐ ุชูุฑูุฑ ุงูุฃุฏุงุก ุงููููู</h6>
                                                <div class="row">
                                                    <div class="col-md-3">
                                                        <p class="mb-1">ูุชูุณุท ููุช ุงููุดู: <strong id="avgConsultationTime">0</strong> ุฏ</p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="mb-1">ุนุฏุฏ ุงููุฑุถู/ุทุจูุจ: <strong id="patientsPerDoctor">0</strong></p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="mb-1">ูุนุฏู ุงูุฅุดุบุงู: <strong id="occupancyRate">0%</strong></p>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <p class="mb-1">ุฑุถุง ุงููุฑุถู: <strong id="patientSatisfaction">0%</strong></p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div id="admin-patients" class="hidden-section">
                                    <h6 class="fw-bold">๐ฅ ุฅุฏุงุฑุฉ ุงูุณุฌูุงุช ุงูุทุจูุฉ</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <input type="text" class="form-control" placeholder="ุจุญุซ ูู ุณุฌูุงุช ุงููุฑุถู..." id="adminPatientSearch">
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-info w-100" onclick="exportMedicalRecords()">๐ฅ ุชุตุฏูุฑ ุงูุณุฌูุงุช</button>
                                        </div>
                                        <div class="col-md-3">
                                            <button class="btn btn-danger w-100" onclick="backupAllData()">๐พ ูุณุฎ ุงุญุชูุงุทู ูุงูู</button>
                                        </div>
                                    </div>
                                    <div id="adminPatientsTable" style="max-height: 300px; overflow-y: auto;"></div>
                                </div>
                                
                                <div id="admin-inventory" class="hidden-section">
                                    <h6 class="fw-bold">๐ฆ ุงูุชุญููู ุงูุงุณุชุฑุงุชูุฌู ูููุฎุฒูู</h6>
                                    <div class="row mb-3">
                                        <div class="col-md-4">
                                            <div class="card bg-light p-2 text-center">
                                                <h6>๐ฐ ูููุฉ ุงููุฎุฒูู</h6>
                                                <h4 id="inventoryValue">0</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light p-2 text-center">
                                                <h6>๐ ูุนุฏู ุงูุฏูุฑุงู</h6>
                                                <h4 id="inventoryTurnover">0</h4>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="card bg-light p-2 text-center">
                                                <h6>โ๏ธ ููุงุฏ ููุชููุฉ</h6>
                                                <h4 id="expiredItems">0</h4>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="inventoryAnalysis"></div>
                                </div>
                                
                                <div id="admin-staff" class="hidden-section">
                                    <h6 class="fw-bold">๐ฅ ุฅุฏุงุฑุฉ ุงูููุธููู ูุงูุฃุฏุงุก</h6>
                                    <div class="row g-2 mb-3">
                                        <div class="col-4">
                                            <input type="text" id="newStaffUser" class="form-control form-control-sm" placeholder="ุงุณู ุงููุณุชุฎุฏู">
                                        </div>
                                        <div class="col-4">
                                            <input type="text" id="newStaffPass" class="form-control form-control-sm" placeholder="ูููุฉ ุงููุฑูุฑ">
                                        </div>
                                        <div class="col-4">
                                            <select id="newStaffRole" class="form-select form-select-sm">
                                                <option value="doctor">ุทุจูุจ</option>
                                                <option value="lab">ูุนูู</option>
                                                <option value="pharmacy">ุตูุฏููุฉ</option>
                                                <option value="reception">ุงุณุชูุจุงู</option>
                                                <option value="nursing">ุชูุฑูุถ</option>
                                                <option value="admin">ูุฏูุฑ</option>
                                            </select>
                                        </div>
                                        <button class="btn btn-dark btn-sm w-100" onclick="addNewStaff()">โ ุฅุถุงูุฉ ููุธู</button>
                                    </div>
                                    <table class="table table-bordered text-center table-sm table-hover">
                                        <thead class="table-light">
                                            <tr>
                                                <th>ุงูุงุณู</th>
                                                <th>ุงูุตูุงุญูุฉ</th>
                                                <th>ุงููุดุงุท</th>
                                                <th>ุฅุฌุฑุงุก</th>
                                            </tr>
                                        </thead>
                                        <tbody id="staffTableBody"></tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <div class="card mt-3 p-3 bg-light">
                                <h6 class="fw-bold">๐ ุชุญูู ุณุฑูุน</h6>
                                <div class="d-flex gap-2 flex-wrap">
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetSection('pats')">ุชุตููุฑ ุงูุงุณุชูุจุงู</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetSection('lab')">ุชุตููุฑ ุงููุนูู</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetSection('rx')">ุชุตููุฑ ุงูุตูุฏููุฉ</button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="resetSection('nursing')">ุชุตููุฑ ุงูุชูุฑูุถ</button>
                                    <button class="btn btn-danger btn-sm" onclick="resetAllDay()">๐ ุฅุบูุงู ุงูููู</button>
                                    <button class="btn btn-success btn-sm" onclick="generateDailyReport()">๐ ุชูุฑูุฑ ูููู</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ุงูุฅุนุฏุงุฏุงุช ุงูุฑุฆูุณูุฉ ูุงููุถุน ุงูุชุดุบููู
        // ============================================
        const SERVER_URL = "http://alshifaclinic.somee.com/api.aspx";
        let OPERATION_MODE = "local"; // "local" ุฃู "server"
        let IS_ONLINE = navigator.onLine;
        let PENDING_SYNC = [];
        let SYNC_INTERVAL = null;

        // ============================================
        // ููุงุนุฏ ุงูุจูุงูุงุช ุงููุญููุฉ ุงูููุณุนุฉ
        // ============================================
        let patients = JSON.parse(localStorage.getItem('shifa_pats')) || [];
        let labRequests = JSON.parse(localStorage.getItem('shifa_lab')) || [];
        let pharmOrders = JSON.parse(localStorage.getItem('shifa_rx')) || [];
        let nursingOrders = JSON.parse(localStorage.getItem('shifa_nursing')) || [];
        let nursingTasks = JSON.parse(localStorage.getItem('shifa_nursing_tasks')) || [];
        
        // ูุฎุฒูู ููุณุน ูุน ุชูุงุตูู ุฅุถุงููุฉ
        let inventory = JSON.parse(localStorage.getItem('shifa_inv')) || [
            {id: 1, name: "Amoxicillin", cost: 300, sale: 500, qty: 50, minLevel: 20, maxLevel: 100, expiryDate: "2025-12-31", category: "ูุถุงุฏุงุช ุญูููุฉ"},
            {id: 2, name: "Paracetamol", cost: 100, sale: 200, qty: 100, minLevel: 50, maxLevel: 200, expiryDate: "2026-06-30", category: "ูุณููุงุช"},
            {id: 3, name: "Vitamin C", cost: 150, sale: 300, qty: 80, minLevel: 30, maxLevel: 150, expiryDate: "2025-09-30", category: "ููุชุงูููุงุช"},
            {id: 4, name: "Ibuprofen", cost: 200, sale: 400, qty: 60, minLevel: 25, maxLevel: 100, expiryDate: "2025-11-30", category: "ูุณููุงุช"},
            {id: 5, name: "Insulin", cost: 800, sale: 1200, qty: 15, minLevel: 10, maxLevel: 40, expiryDate: "2025-08-31", category: "ูุฑูููุงุช"},
            {id: 6, name: "Syringe 5ml", cost: 50, sale: 100, qty: 200, minLevel: 100, maxLevel: 500, expiryDate: "2027-12-31", category: "ุฃุฏูุงุช ุทุจูุฉ"}
        ];
        
        let financials = JSON.parse(localStorage.getItem('shifa_fin')) || { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0 };
        
        let staffMembers = JSON.parse(localStorage.getItem('shifa_staff')) || [
            {u: "admin", p: "123", r: "admin", name: "ุงููุฏูุฑ ุงูุนุงู"},
            {u: "doctor", p: "doc123", r: "doctor", name: "ุฏ. ุฃุญูุฏ"},
            {u: "lab", p: "lab123", r: "lab", name: "ููู ุงููุนูู"},
            {u: "pharmacy", p: "ph123", r: "pharmacy", name: "ุงูุตูุฏูู ูุญูุฏ"},
            {u: "reception", p: "rec123", r: "reception", name: "ููุธู ุงูุงุณุชูุจุงู"},
            {u: "nursing", p: "nurse123", r: "nursing", name: "ุงูููุฑุถุฉ ุณุงุฑุฉ"}
        ];
        
        let labTests = JSON.parse(localStorage.getItem('shifa_tests')) || [
            {name: "BFFM", price: 3000}, {name: "Widal for entrica", price: 4000}, {name: "Brucella test", price: 4000},
            {name: "H. pylori Ag", price: 4000}, {name: "ASO", price: 5000}, {name: "U. G", price: 3000},
            {name: "S.G", price: 3000}, {name: "RFT(U&C)", price: 10000}, {name: "S.uric acid", price: 5000},
            {name: "ESR", price: 4000}, {name: "RF(rheumatoid factor)", price: 5000}, {name: "TWBCS", price: 3000}
        ];

        // ุงูููุชุจุฉ ุงูุทุจูุฉ ุงูุฑูููุฉ
        let medicalLibrary = JSON.parse(localStorage.getItem('shifa_library')) || [
            {id: 1, title: "ุงูุฃูููููุฒุง ุงูููุณููุฉ", category: "diseases", content: "ูุฑุถ ููุฑูุณู ูุตูุจ ุงูุฌูุงุฒ ุงูุชููุณูุ ุงูุฃุนุฑุงุถ: ุญููุ ุณุนุงูุ ุขูุงู ุฌุณู..."},
            {id: 2, title: "Amoxicillin", category: "drugs", content: "ูุถุงุฏ ุญููู ูุงุณุน ุงููุฌุงูุ ุงูุฌุฑุนุฉ: 500mg ูู 8 ุณุงุนุงุชุ ููุงูุน ุงูุงุณุชุฎุฏุงู: ุญุณุงุณูุฉ ุงูุจูุณููู"},
            {id: 3, title: "ุญูู ุนุถูู", category: "procedures", content: "ูุชู ุงูุญูู ูู ุงูุนุถูุฉ ุงูุฃูููุฉ ุฃู ุงูุฏุงููุฉุ ุฒุงููุฉ 90 ุฏุฑุฌุฉ..."},
            {id: 4, title: "ูุญุต CBC", category: "tests", content: "ุชุญููู ุตูุฑุฉ ุงูุฏู ุงููุงููุฉุ ูุดูู: ุงูููููุฌููุจููุ ูุฑุงุช ุงูุฏู ุงูุจูุถุงุก ูุงูุญูุฑุงุก..."},
            {id: 5, title: "ุถุบุท ุงูุฏู ุงููุฑุชูุน", category: "diseases", content: "ุงุฑุชูุงุน ุถุบุท ุงูุฏู ุนู 140/90ุ ุงูุนูุงุฌ: ูุฏุฑุงุช ุจููุ ุญุงุตุฑุงุช ุจูุชุง..."},
            {id: 6, title: "ุงูุงูุณูููู", category: "drugs", content: "ูุฑููู ูุนูุงุฌ ุงูุณูุฑูุ ุฃููุงุน: ูุตูุฑุ ูุชูุณุทุ ุทููู ุงูููุนููุ ุงูุชุฎุฒูู: ุซูุงุฌุฉ 2-8 ู"}
        ];

        // ุงูููุฑุถูู ูุฌุฏูู ุงูููุงูุจุงุช
        let nurses = JSON.parse(localStorage.getItem('shifa_nurses')) || [
            {id: 1, name: "ุณุงุฑุฉ ุฃุญูุฏ", shift: "ุตุจุงุญ", phone: "0912345678"},
            {id: 2, name: "ูุฑูู ุฎุงูุฏ", shift: "ูุณุงุก", phone: "0912345679"},
            {id: 3, name: "ุญุณู ุนูุฑ", shift: "ููู", phone: "0912345680"}
        ];

        let currentUser = localStorage.getItem('shifa_user') ? JSON.parse(localStorage.getItem('shifa_user')) : null;
        let selectedPatientId = null;
        let currentRxItems = [];
        let currentNursingOrders = [];

        // ============================================
        // ุฏูุงู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ (ููุง ูู)
        // ============================================
        async function apiCall(action, data = {}) {
            if (OPERATION_MODE !== "server") {
                return { success: false, message: "ุงูุนูู ูู ุงููุถุน ุงููุญูู" };
            }
            
            try {
                const response = await fetch(SERVER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action, ...data })
                });
                
                if (!response.ok) {
                    throw new Error(`ุฎุทุฃ ูู ุงูุณูุฑูุฑ: ${response.status}`);
                }
                
                return await response.json();
            } catch (error) {
                console.error("ุฎุทุฃ ูู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ:", error);
                addToPendingSync(action, data);
                updateConnectionStatus(false);
                return { success: false, message: "ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ" };
            }
        }

        // ============================================
        // ูุธุงู ุงููุฒุงููุฉ ุงููุฌูู
        // ============================================
        function addToPendingSync(action, data) {
            PENDING_SYNC.push({ action, data, timestamp: Date.now() });
            localStorage.setItem('shifa_pending_sync', JSON.stringify(PENDING_SYNC));
            updateSyncStatus();
        }

        async function processPendingSync() {
            if (PENDING_SYNC.length === 0 || OPERATION_MODE !== "server" || !IS_ONLINE) return;
            
            const syncStatus = document.getElementById('syncStatusText');
            syncStatus.textContent = "๐ ุฌุงุฑู ุงููุฒุงููุฉ...";
            syncStatus.className = "badge bg-warning";
            
            for (let i = 0; i < PENDING_SYNC.length; i++) {
                const item = PENDING_SYNC[i];
                try {
                    const result = await apiCall(item.action, item.data);
                    if (result.success) {
                        PENDING_SYNC.splice(i, 1);
                        i--;
                    }
                } catch (error) {
                    console.error("ุฎุทุฃ ูู ูุฒุงููุฉ:", item, error);
                }
            }
            
            localStorage.setItem('shifa_pending_sync', JSON.stringify(PENDING_SYNC));
            updateSyncStatus();
        }

        function updateSyncStatus() {
            const syncStatus = document.getElementById('syncStatusText');
            if (PENDING_SYNC.length > 0) {
                syncStatus.textContent = `โณ ${PENDING_SYNC.length} ูุนูู`;
                syncStatus.className = "badge bg-warning";
            } else {
                syncStatus.textContent = "โ ูุชุฒุงูู";
                syncStatus.className = "badge bg-success";
            }
        }

        // ============================================
        // ุฅุฏุงุฑุฉ ุงูุงุชุตุงู ูุงูุดุจูุฉ
        // ============================================
        function updateConnectionStatus(online) {
            IS_ONLINE = online;
            const statusEl = document.getElementById('connectionStatus');
            
            if (OPERATION_MODE === "server") {
                if (online) {
                    statusEl.textContent = "โ๏ธ ูุชุตู ุจุงูุณูุฑูุฑ";
                    statusEl.className = "badge bg-success mx-2";
                    processPendingSync();
                } else {
                    statusEl.textContent = "๐ด ุบูุฑ ูุชุตู ุจุงูุณูุฑูุฑ";
                    statusEl.className = "badge bg-danger mx-2";
                }
            } else {
                statusEl.textContent = "๐พ ุนูู ูุญูู";
                statusEl.className = "badge bg-info mx-2";
            }
        }

        async function testServerConnection() {
            const loginStatus = document.getElementById('loginStatus') || document.getElementById('syncStatusText');
            
            if (OPERATION_MODE === "server") {
                loginStatus.textContent = "๐ ุฌุงุฑู ุงุฎุชุจุงุฑ ุงูุงุชุตุงู...";
                loginStatus.className = "badge bg-warning";
                
                try {
                    const response = await fetch(SERVER_URL, { method: 'POST' });
                    if (response.ok) {
                        loginStatus.textContent = "โ ุงูุงุชุตุงู ูุงุฌุญ";
                        loginStatus.className = "badge bg-success";
                        alert("โ ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ ูุงุฌุญ!");
                    } else {
                        throw new Error("ุงูุณูุฑูุฑ ูุง ูุณุชุฌูุจ");
                    }
                } catch (error) {
                    loginStatus.textContent = "โ ูุดู ุงูุงุชุตุงู";
                    loginStatus.className = "badge bg-danger";
                    alert("โ ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ!\nุณูุชู ุงูุนูู ูู ุงููุถุน ุงููุญูู.");
                    OPERATION_MODE = "local";
                    updateConnectionStatus(false);
                }
            } else {
                alert("๐ง ุฃูุช ูู ุงููุถุน ุงููุญูู ุญุงููุงู.\nูุชุบููุฑ ุงููุถุนุ ุณุฌู ุงูุฎุฑูุฌ ูุงุฎุชุฑ ูุถุน ูุงุนุฏุฉ ุงูุจูุงูุงุช.");
            }
        }

        // ============================================
        // ุชุณุฌูู ุงูุฏุฎูู ูุงููุณุชุฎุฏููู
        // ============================================
        async function handleLogin() {
            const username = document.getElementById('username').value.trim().toLowerCase();
            const password = document.getElementById('password').value.trim();
            const loginMode = document.querySelector('input[name="loginMode"]:checked').value;
            const loginStatus = document.getElementById('loginStatus');
            
            OPERATION_MODE = loginMode;
            
            loginStatus.textContent = "๐ ุฌุงุฑู ุงูุชุญูู...";
            loginStatus.className = "status-info";
            
            if (loginMode === "server") {
                try {
                    const result = await apiCall('login', { u: username, p: password });
                    
                    if (result.success) {
                        currentUser = result.user;
                        localStorage.setItem('shifa_user', JSON.stringify(currentUser));
                        await syncFromServer();
                        completeLogin();
                    } else {
                        loginStatus.textContent = "โ ุจูุงูุงุช ุฎุงุทุฆุฉ ูู ุงูุณูุฑูุฑ";
                        loginStatus.className = "status-offline";
                        alert("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช!");
                    }
                } catch (error) {
                    loginStatus.textContent = "โ ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ";
                    loginStatus.className = "status-offline";
                    alert("ูุดู ุงูุงุชุตุงู ุจุงูุณูุฑูุฑ! ุณูุชู ุงุณุชุฎุฏุงู ุงูุจูุงูุงุช ุงููุญููุฉ.");
                    OPERATION_MODE = "local";
                    handleLocalLogin(username, password);
                }
            } else {
                handleLocalLogin(username, password);
            }
        }

        function handleLocalLogin(username, password) {
            const user = staffMembers.find(s => s.u === username && s.p === password);
            
            if (user) {
                currentUser = user;
                localStorage.setItem('shifa_user', JSON.stringify(user));
                completeLogin();
            } else {
                document.getElementById('loginStatus').textContent = "โ ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ!";
                alert("ุจูุงูุงุช ุงูุฏุฎูู ุบูุฑ ุตุญูุญุฉ ูู ุงููุธุงู ุงููุญูู!");
            }
        }

        function completeLogin() {
            document.getElementById('loginOverlay').classList.add('hidden-section');
            document.getElementById('mainContent').classList.remove('hidden-section');
            document.getElementById('currentUserDisplay').innerText = `๐ค ${currentUser.u}`;
            
            setupPermissions(currentUser.r);
            updateConnectionStatus(navigator.onLine);
            updateSyncStatus();
            
            if (OPERATION_MODE === "server" && IS_ONLINE) {
                SYNC_INTERVAL = setInterval(processPendingSync, 30000);
            }
            
            alert(`ูุฑุญุจุงู ุจู ูู ูุธุงู ุงูุดูุงุก - ูุณู ${currentUser.r}\nุงููุถุน: ${OPERATION_MODE === 'server' ? 'โ๏ธ ูุงุนุฏุฉ ุจูุงูุงุช' : '๐พ ูุญูู'}`);
        }

        async function syncFromServer() {
            if (OPERATION_MODE !== "server") return;
            
            try {
                const result = await apiCall('getAllData');
                if (result.success) {
                    patients = result.patients || patients;
                    labRequests = result.labRequests || labRequests;
                    pharmOrders = result.pharmOrders || pharmOrders;
                    inventory = result.inventory || inventory;
                    financials = result.financials || financials;
                    staffMembers = result.staffMembers || staffMembers;
                    labTests = result.labTests || labTests;
                    medicalLibrary = result.medicalLibrary || medicalLibrary;
                    nursingOrders = result.nursingOrders || nursingOrders;
                    nursingTasks = result.nursingTasks || nursingTasks;
                    
                    saveLocalData();
                    refreshAll();
                }
            } catch (error) {
                console.error("ุฎุทุฃ ูู ุฌูุจ ุงูุจูุงูุงุช ูู ุงูุณูุฑูุฑ:", error);
            }
        }

        // ============================================
        // ุฅุฏุงุฑุฉ ุงูุตูุงุญูุงุช ูุงููุงุฌูุฉ
        // ============================================
        function setupPermissions(role) {
            document.querySelectorAll('.nav-item').forEach(li => li.classList.add('hidden-section'));
            
            if(role === 'admin') { 
                document.querySelectorAll('.nav-item').forEach(li => li.classList.remove('hidden-section')); 
                switchSection('admin'); 
            } else { 
                const myTab = document.getElementById(`tab-${role}-li`);
                if(myTab) {
                    myTab.classList.remove('hidden-section');
                    switchSection(role); 
                } else {
                    alert("ุฎุทุฃ ูู ุชุญุฏูุฏ ุงููุณูุ ุฑุงุฌุน ุงููุฏูุฑ.");
                    logout();
                }
            }
            refreshAll();
        }

        function switchSection(id) {
            document.querySelectorAll('.section-pane').forEach(s => s.classList.add('hidden-section'));
            document.getElementById(`${id}-sec`).classList.remove('hidden-section');
            document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
            document.getElementById(`btn-${id}`)?.classList.add('active');
            
            updateBadges();
            refreshAll();
            
            // ุชุญููู ุจูุงูุงุช ุฎุงุตุฉ ุจูู ูุณู
            if (id === 'reception') {
                loadReceptionStats();
                loadPatientRecords();
            } else if (id === 'nursing') {
                loadNursingSchedule();
                loadNursingStats();
            } else if (id === 'admin') {
                loadAdminReports();
                loadMedicalLibrary();
            }
        }

        // ============================================
        // ูุณู ุงูุงุณุชูุจุงู - ุงูุณุฌู ุงูุดุงูู (ูุญุฏุซ)
        // ============================================
        async function registerPatient() {
            const name = document.getElementById('pName').value;
            const age = document.getElementById('pAge').value;
            const gender = document.getElementById('pGender').value;
            const phone = document.getElementById('pPhone').value;
            const address = document.getElementById('pAddress').value;
            const ticket = parseFloat(document.getElementById('pTicket').value) || 0;
            const visitType = document.getElementById('pVisitType').value;
            const medicalHistory = document.getElementById('pMedicalHistory').value;
            
            if(!name || !age) {
                alert("ุงูุงุณู ูุงูุนูุฑ ูุทููุจุงู!");
                return;
            }
            
            // ุงูุจุญุซ ุนู ูุฑูุถ ููุฌูุฏ ุจููุณ ุงูุงุณู ูุงููุงุชู
            const existingPatient = patients.find(p => 
                p.name === name && p.phone === phone && phone !== ''
            );
            
            let patientId;
            if (existingPatient) {
                // ุชุญุฏูุซ ุจูุงูุงุช ุงููุฑูุถ ุงูุญุงูู
                existingPatient.lastVisit = new Date().toLocaleDateString();
                existingPatient.visitCount = (existingPatient.visitCount || 0) + 1;
                existingPatient.medicalHistory = existingPatient.medicalHistory ? 
                    existingPatient.medicalHistory + "\n" + medicalHistory : medicalHistory;
                patientId = existingPatient.id;
                alert(`ุชู ุชุญุฏูุซ ุณุฌู ุงููุฑูุถ ${name} (ุฒูุงุฑุฉ ุฑูู ${existingPatient.visitCount})`);
            } else {
                // ูุฑูุถ ุฌุฏูุฏ
                patientId = Date.now();
                const patientData = { 
                    id: patientId,
                    name, 
                    age, 
                    gender,
                    phone,
                    address, 
                    time: new Date().toLocaleTimeString(), 
                    date: new Date().toLocaleDateString(),
                    status: 'waiting', 
                    complaint: '',
                    medicalHistory,
                    allergies: '',
                    regularMeds: '',
                    surgeries: '',
                    ticket: ticket,
                    visitType,
                    visitCount: 1,
                    firstVisit: new Date().toLocaleDateString(),
                    lastVisit: new Date().toLocaleDateString()
                };
                
                patients.push(patientData);
            }
            
            financials.clinic += ticket;
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                const patientData = patients.find(p => p.id === patientId);
                const result = await apiCall('addPatient', patientData);
                if (!result.success) {
                    addToPendingSync('addPatient', patientData);
                }
            }
            
            // ูุณุญ ุงูุญููู
            document.getElementById('pName').value = '';
            document.getElementById('pAge').value = '';
            document.getElementById('pPhone').value = '';
            document.getElementById('pAddress').value = '';
            document.getElementById('pMedicalHistory').value = '';
            
            document.getElementById('notificationSound').play();
            refreshAll();
            updateBadges();
            loadReceptionStats();
            
            alert(`โ ุชู ${existingPatient ? 'ุชุญุฏูุซ' : 'ุชุณุฌูู'} ุงููุฑูุถ ${name} ุจูุฌุงุญ!`);
        }

        function searchPatientRecords(query) {
            const list = document.getElementById('patientRecordsList');
            
            if (!query) {
                // ุนุฑุถ ุขุฎุฑ 10 ูุฑุถู
                const recentPatients = patients.slice(-10).reverse();
                displayPatientRecords(recentPatients);
                return;
            }
            
            const filtered = patients.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                (p.phone && p.phone.includes(query)) ||
                (p.address && p.address.toLowerCase().includes(query.toLowerCase()))
            );
            
            displayPatientRecords(filtered);
        }

        function displayPatientRecords(patientList) {
            const list = document.getElementById('patientRecordsList');
            list.innerHTML = patientList.map(p => `
                <div class="card p-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${p.name}</h6>
                            <small class="text-muted">ุงูุนูุฑ: ${p.age} | ${p.gender || ''} | ${p.phone || 'ูุง ููุฌุฏ ูุงุชู'}</small>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">ุขุฎุฑ ุฒูุงุฑุฉ: ${p.lastVisit || p.date}</small><br>
                            <small class="badge bg-info">${p.visitCount || 1} ุฒูุงุฑุฉ</small>
                        </div>
                    </div>
                    ${p.medicalHistory ? `<small><strong>ุงูุชุงุฑูุฎ ุงููุฑุถู:</strong> ${p.medicalHistory.substring(0, 50)}...</small>` : ''}
                </div>
            `).join('');
        }

        function loadReceptionStats() {
            const today = new Date().toLocaleDateString();
            const todayPatients = patients.filter(p => p.date === today).length;
            const newPatients = patients.filter(p => p.visitCount === 1).length;
            const returnPatients = patients.filter(p => p.visitCount > 1).length;
            
            document.getElementById('todayPatients').textContent = todayPatients;
            document.getElementById('totalPatients').textContent = patients.length;
            document.getElementById('newPatients').textContent = newPatients;
            document.getElementById('returnPatients').textContent = returnPatients;
            
            // ุญุณุงุจ ูุชูุณุท ููุช ุงูุงูุชุธุงุฑ (ูุญุงูุงุฉ)
            const avgWaitTime = Math.floor(Math.random() * 20) + 5;
            document.getElementById('avgWaitTime').textContent = avgWaitTime;
        }

        // ============================================
        // ูุณู ุงูุนูุงุฏุฉ - ุงูููุชุจุฉ ุงูุทุจูุฉ ูุงูุณุฌู ุงูุดุงูู
        // ============================================
        function selectPatient(id) {
            selectedPatientId = id;
            const p = patients.find(pat => pat.id === id);
            
            document.getElementById('treatmentArea').classList.remove('hidden-section');
            document.getElementById('selectedPatientTitle').innerText = p.name;
            document.getElementById('selectedPatientInfo').innerText = 
                `ุงูุนูุฑ: ${p.age} | ${p.gender || ''} | ${p.phone || ''} | ${p.address || ''}`;
            
            // ุชุญููู ุงูุณุฌู ุงูุทุจู ูููุฑูุถ
            document.getElementById('patientMedicalHistory').textContent = p.medicalHistory || 'ูุง ููุฌุฏ';
            document.getElementById('patientAllergies').textContent = p.allergies || 'ูุง ููุฌุฏ';
            document.getElementById('patientRegularMeds').textContent = p.regularMeds || 'ูุง ููุฌุฏ';
            document.getElementById('patientSurgeries').textContent = p.surgeries || 'ูุง ููุฌุฏ';
            
            currentRxItems = [];
            currentNursingOrders = [];
            updateRxDisplay();
            updateNursingOrdersDisplay();
            showPatientResults(p.name);
            showDocSubSection('rx');
            
            updateDoctorLabRequests(p.name);
        }

        function viewFullMedicalRecord() {
            if (!selectedPatientId) {
                alert("ุงุฎุชุฑ ูุฑูุถุงู ุฃููุงู!");
                return;
            }
            
            const p = patients.find(pat => pat.id === selectedPatientId);
            let content = `
                <div class="medical-record p-4">
                    <h4 class="text-center mb-4">๐ ุงูุณุฌู ุงูุทุจู ุงูุดุงูู - ${p.name}</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>ุงูุงุณู:</strong> ${p.name}</p>
                            <p><strong>ุงูุนูุฑ:</strong> ${p.age} ุณูุฉ</p>
                            <p><strong>ุงูุฌูุณ:</strong> ${p.gender || 'ุบูุฑ ูุญุฏุฏ'}</p>
                            <p><strong>ุงููุงุชู:</strong> ${p.phone || 'ุบูุฑ ูุญุฏุฏ'}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>ุงูุนููุงู:</strong> ${p.address || 'ุบูุฑ ูุญุฏุฏ'}</p>
                            <p><strong>ุนุฏุฏ ุงูุฒูุงุฑุงุช:</strong> ${p.visitCount || 1}</p>
                            <p><strong>ุฃูู ุฒูุงุฑุฉ:</strong> ${p.firstVisit || p.date}</p>
                            <p><strong>ุขุฎุฑ ุฒูุงุฑุฉ:</strong> ${p.lastVisit || p.date}</p>
                        </div>
                    </div>
                    <hr>
                    <h5>๐ ุงูุชุงุฑูุฎ ุงููุฑุถู</h5>
                    <p>${p.medicalHistory || 'ูุง ููุฌุฏ ุชุงุฑูุฎ ูุฑุถู ูุณุฌู'}</p>
                    <hr>
                    <h5>โ๏ธ ุงูุญุณุงุณูุงุช</h5>
                    <p>${p.allergies || 'ูุง ููุฌุฏ ุญุณุงุณูุงุช ูุณุฌูุฉ'}</p>
                    <hr>
                    <h5>๐ ุงูุฃุฏููุฉ ุงูููุชุธูุฉ</h5>
                    <p>${p.regularMeds || 'ูุง ููุฌุฏ ุฃุฏููุฉ ููุชุธูุฉ'}</p>
                </div>
            `;
            
            document.getElementById('printTitle').innerText = `ุงูุณุฌู ุงูุทุจู - ${p.name}`;
            document.getElementById('printDate').innerText = new Date().toLocaleString('ar-EG');
            document.getElementById('printContent').innerHTML = content;
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // ุงูููุชุจุฉ ุงูุทุจูุฉ ุงูุฑูููุฉ
        function searchLibrary(query) {
            const resultsDiv = document.getElementById('quickLibraryResults');
            
            if (!query) {
                resultsDiv.innerHTML = '<p class="text-muted">ุงูุชุจ ููุจุญุซ ูู ุงูููุชุจุฉ ุงูุทุจูุฉ</p>';
                return;
            }
            
            const filtered = medicalLibrary.filter(item => 
                item.title.toLowerCase().includes(query.toLowerCase()) ||
                item.content.toLowerCase().includes(query.toLowerCase())
            );
            
            resultsDiv.innerHTML = filtered.slice(0, 3).map(item => `
                <div class="card p-2 mb-1">
                    <h6 class="mb-1">${item.title}</h6>
                    <small class="text-muted">${item.content.substring(0, 80)}...</small>
                </div>
            `).join('');
        }

        function openLibrary() {
            switchSection('admin');
            showAdminTab('library');
        }

        // ูุญุต ุชูุงุนูุงุช ุงูุฃุฏููุฉ
        function checkDrugInteractions() {
            if (currentRxItems.length < 2) return;
            
            const interactions = {
                "warfarin,ibuprofen": "ุฒูุงุฏุฉ ุฎุทุฑ ุงููุฒูู",
                "warfarin,aspirin": "ุฒูุงุฏุฉ ุฎุทุฑ ุงููุฒูู",
                "amoxicillin,allopurinol": "ุฒูุงุฏุฉ ุทูุญ ุฌูุฏู",
                "digoxin,diuretics": "ุงุถุทุฑุงุจุงุช ูุธู ุงูููุจ",
                "statins,grapefruit": "ุฒูุงุฏุฉ ุงูุณููุฉ"
            };
            
            const medNames = currentRxItems.map(m => m.name.toLowerCase());
            let warnings = [];
            
            for (const [drugs, warning] of Object.entries(interactions)) {
                const drugList = drugs.split(',');
                if (drugList.every(drug => medNames.some(m => m.includes(drug)))) {
                    warnings.push(warning);
                }
            }
            
            const alertDiv = document.getElementById('drugInteractionsAlert');
            if (warnings.length > 0) {
                alertDiv.innerHTML = `
                    โ๏ธ <strong>ุชุญุฐูุฑ ุชูุงุนู ุฃุฏููุฉ:</strong><br>
                    ${warnings.map(w => `โข ${w}`).join('<br>')}
                `;
                alertDiv.classList.remove('hidden-section');
            } else {
                alertDiv.classList.add('hidden-section');
            }
        }

        // ============================================
        // ูุณู ุงูุชูุฑูุถ (ุฌุฏูุฏ)
        // ============================================
        function loadNursingSchedule() {
            const date = document.getElementById('nursingDate').value || new Date().toISOString().split('T')[0];
            const shift = document.getElementById('nursingShift').value;
            
            // ุชุตููุฉ ุงูููุงู ุญุณุจ ุงูุชุงุฑูุฎ ูุงูููุงูุจุฉ
            let filteredTasks = nursingTasks.filter(task => task.date === date);
            if (shift !== 'all') {
                filteredTasks = filteredTasks.filter(task => task.shift === shift);
            }
            
            // ุชูุณูู ุงูุฌุฏูู
            const tableDiv = document.getElementById('nursingScheduleTable');
            tableDiv.innerHTML = `
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>ุงููุฑูุถ</th>
                            <th>ุงูุฅุฌุฑุงุก</th>
                            <th>ุงูููุช</th>
                            <th>ุงูููุฑุถ</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุฅุฌุฑุงุก</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredTasks.map((task, index) => `
                            <tr class="${task.status === 'ููุชูู' ? 'table-success' : task.status === 'ูุชุฃุฎุฑ' ? 'table-danger' : ''}">
                                <td>${task.patientName}</td>
                                <td>${task.procedure}</td>
                                <td>${task.time}</td>
                                <td>${task.nurseName || 'ุบูุฑ ูุญุฏุฏ'}</td>
                                <td>
                                    <span class="badge ${task.status === 'ููุชูู' ? 'bg-success' : task.status === 'ููุฏ ุงูุชูููุฐ' ? 'bg-warning' : 'bg-secondary'}">
                                        ${task.status}
                                    </span>
                                </td>
                                <td>
                                    ${task.status !== 'ููุชูู' ? `
                                        <button class="btn btn-sm btn-success" onclick="completeNursingTask(${index})">โ</button>
                                    ` : ''}
                                    <button class="btn btn-sm btn-danger" onclick="deleteNursingTask(${index})">โ</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function loadNursingStats() {
            const today = new Date().toISOString().split('T')[0];
            const todayTasks = nursingTasks.filter(task => task.date === today);
            const doneTasks = todayTasks.filter(task => task.status === 'ููุชูู').length;
            const pendingTasks = todayTasks.filter(task => task.status === 'ููุฏ ุงูุชูููุฐ').length;
            const lateTasks = todayTasks.filter(task => task.status === 'ูุชุฃุฎุฑ').length;
            
            document.getElementById('nursingTasksToday').textContent = todayTasks.length;
            document.getElementById('nursingTasksDone').textContent = doneTasks;
            document.getElementById('nursingTasksPending').textContent = pendingTasks;
            document.getElementById('nursingTasksLate').textContent = lateTasks;
            
            // ุชุญููู ูุงุฆูุฉ ุงูููุฑุถูู
            const nursesListDiv = document.getElementById('nursesList');
            nursesListDiv.innerHTML = nurses.map(nurse => `
                <div class="d-flex justify-content-between align-items-center border-bottom py-1">
                    <span>${nurse.name}</span>
                    <span class="badge bg-info">${nurse.shift}</span>
                </div>
            `).join('');
            
            // ุชุญููู ุงูุชูุจููุงุช
            const alertsDiv = document.getElementById('nursingAlerts');
            const criticalTasks = nursingTasks.filter(task => 
                task.status !== 'ููุชูู' && 
                new Date(task.date + 'T' + task.time) < new Date()
            );
            
            if (criticalTasks.length > 0) {
                alertsDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <strong>โ๏ธ ${criticalTasks.length} ูููุฉ ูุชุฃุฎุฑุฉ:</strong><br>
                        ${criticalTasks.slice(0, 3).map(task => `โข ${task.patientName}: ${task.procedure}`).join('<br>')}
                    </div>
                `;
            } else {
                alertsDiv.innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ุชูุจููุงุช</p>';
            }
        }

        function addNursingOrder() {
            if (!selectedPatientId) {
                alert("ุงุฎุชุฑ ูุฑูุถุงู ุฃููุงู!");
                return;
            }
            
            const procedure = document.getElementById('nursingProcedure').value;
            const frequency = document.getElementById('nursingFrequency').value;
            
            if (!procedure) {
                alert("ุงุฎุชุฑ ุฅุฌุฑุงุกู ูู ุงููุงุฆูุฉ!");
                return;
            }
            
            currentNursingOrders.push({
                procedure,
                frequency,
                time: new Date().toLocaleTimeString()
            });
            
            updateNursingOrdersDisplay();
            document.getElementById('nursingProcedure').value = '';
            document.getElementById('nursingFrequency').value = '';
        }

        function updateNursingOrdersDisplay() {
            const container = document.getElementById('nursingOrdersList');
            container.innerHTML = currentNursingOrders.map((order, index) => `
                <div class="alert alert-info p-2 d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${order.procedure}</strong><br>
                        <small>ุงูุชูุฑุงุฑ: ${order.frequency || 'ูุฑุฉ ูุงุญุฏุฉ'}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="currentNursingOrders.splice(${index},1); updateNursingOrdersDisplay();">โ</button>
                </div>
            `).join('');
        }

        function addNursingOrders() {
            if (currentNursingOrders.length === 0) {
                alert("ุฃุถู ุฃูุงูุฑ ุชูุฑูุถ ุฃููุงู!");
                return;
            }
            
            const patient = patients.find(p => p.id === selectedPatientId);
            
            // ุฅุถุงูุฉ ููุงู ุงูุชูุฑูุถ
            currentNursingOrders.forEach(order => {
                const nursingTask = {
                    id: Date.now() + Math.random(),
                    patientId: selectedPatientId,
                    patientName: patient.name,
                    procedure: order.procedure,
                    frequency: order.frequency,
                    date: new Date().toISOString().split('T')[0],
                    time: order.time,
                    status: 'ููุฏ ุงูุชูููุฐ',
                    nurseName: '',
                    notes: ''
                };
                
                nursingTasks.push(nursingTask);
            });
            
            saveLocalData();
            alert(`โ ุชู ุฅุถุงูุฉ ${currentNursingOrders.length} ุฃูุฑ ุชูุฑูุถ ูููุฑูุถ ${patient.name}`);
            currentNursingOrders = [];
            updateNursingOrdersDisplay();
            updateBadges();
        }

        function completeNursingTask(index) {
            if (confirm("ูู ุฃูููุช ูุฐู ุงููููุฉุ")) {
                nursingTasks[index].status = 'ููุชูู';
                nursingTasks[index].completedAt = new Date().toLocaleString();
                saveLocalData();
                loadNursingSchedule();
                loadNursingStats();
                alert("โ ุชู ุชุณุฌูู ุฅููุงู ุงููููุฉ");
            }
        }

        function deleteNursingTask(index) {
            if (confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููููุฉุ")) {
                nursingTasks.splice(index, 1);
                saveLocalData();
                loadNursingSchedule();
                loadNursingStats();
                alert("โ ุชู ุญุฐู ุงููููุฉ");
            }
        }

        // ============================================
        // ูุณู ุงูุตูุฏููุฉ - ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู
        // ============================================
        function showPharmacyTab(tab) {
            ['inventory', 'orders', 'expiry'].forEach(t => {
                document.getElementById(`pharmacy-${t}`).classList.add('hidden-section');
            });
            document.getElementById(`pharmacy-${tab}`).classList.remove('hidden-section');
        }

        function analyzeStrategicStock() {
            // ุญุณุงุจ ูุคุดุฑุงุช ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู
            const totalValue = inventory.reduce((sum, item) => sum + (item.cost * item.qty), 0);
            const criticalItems = inventory.filter(item => item.qty <= item.minLevel);
            const expiredItems = inventory.filter(item => {
                if (!item.expiryDate) return false;
                return new Date(item.expiryDate) < new Date();
            });
            
            // ุญุณุงุจ ุฃูุงู ุงููุฎุฒูู (ูุญุงูุงุฉ)
            const avgDailyUsage = 5; // ูุชูุณุท ุงูุงุณุชููุงู ุงููููู
            const stockDays = Math.floor(inventory.reduce((sum, item) => sum + item.qty, 0) / avgDailyUsage);
            
            // ุญุณุงุจ ูุนุฏู ุงูุฏูุฑุงู (ูุญุงูุงุฉ)
            const turnover = (financials.pharSales / totalValue * 30).toFixed(1);
            
            // ุชุญุฏูุซ ูุงุฌูุฉ ุงููุณุชุฎุฏู
            document.getElementById('stockTurnover').textContent = turnover;
            document.getElementById('stockDays').textContent = stockDays;
            document.getElementById('stockEfficiency').textContent = `${Math.min(100, (stockDays / 30 * 100).toFixed(0))}%`;
            
            // ุนุฑุถ ุงูุชูุจููุงุช
            const alertsDiv = document.getElementById('strategicStockAlerts');
            let alerts = [];
            
            if (criticalItems.length > 0) {
                alerts.push(`<div class="alert alert-danger">โ๏ธ ${criticalItems.length} ูุงุฏุฉ ุชุญุช ุงูุญุฏ ุงูุฃุฏูู</div>`);
            }
            
            if (expiredItems.length > 0) {
                alerts.push(`<div class="alert alert-warning">โ๏ธ ${expiredItems.length} ูุงุฏุฉ ููุชููุฉ ุงูุตูุงุญูุฉ</div>`);
            }
            
            if (alerts.length === 0) {
                alerts.push('<div class="alert alert-success">โ ุงููุฎุฒูู ูู ูุถุน ุฌูุฏ</div>');
            }
            
            alertsDiv.innerHTML = alerts.join('');
        }

        function generatePurchaseOrders() {
            const itemsNeeded = inventory.filter(item => item.qty <= item.minLevel);
            
            if (itemsNeeded.length === 0) {
                alert("โ ูุง ุชูุฌุฏ ุญุงุฌุฉ ูุทูุจุงุช ุดุฑุงุก ุฌุฏูุฏุฉ");
                return;
            }
            
            const ordersList = document.getElementById('purchaseOrdersList');
            ordersList.innerHTML = `
                <div class="alert alert-info">
                    <h6>๐ ุทูุจุงุช ุงูุดุฑุงุก ุงูููุชุฑุญุฉ</h6>
                    ${itemsNeeded.map(item => `
                        <div class="d-flex justify-content-between border-bottom py-1">
                            <span>${item.name}</span>
                            <span>ุงููููุฉ ุงูุญุงููุฉ: ${item.qty}</span>
                            <span>ุงููุทููุจ: ${item.maxLevel - item.qty}</span>
                            <span>${(item.maxLevel - item.qty) * item.cost} ุฌ</span>
                        </div>
                    `).join('')}
                    <div class="mt-2">
                        <strong>ุงูุฅุฌูุงูู: ${itemsNeeded.reduce((sum, item) => sum + ((item.maxLevel - item.qty) * item.cost), 0)} ุฌ</strong>
                    </div>
                    <button class="btn btn-success w-100 mt-2" onclick="confirmPurchaseOrders()">โ ุชุฃููุฏ ุงูุทูุจุงุช</button>
                </div>
            `;
        }

        function confirmPurchaseOrders() {
            // ูู ูุธุงู ุญููููุ ููุง ูุชู ุฅุฑุณุงู ุงูุทูุจุงุช ููููุฑุฏูู
            alert("โ ุชู ุชุฃููุฏ ุทูุจุงุช ุงูุดุฑุงุก ูุฅุฑุณุงููุง ููููุฑุฏูู");
            document.getElementById('purchaseOrdersList').innerHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ุทูุจุงุช ุญุงููุงู</p>';
        }

        function checkExpiryAlerts() {
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setMonth(nextMonth.getMonth() + 1);
            
            const expiringSoon = inventory.filter(item => {
                if (!item.expiryDate) return false;
                const expiryDate = new Date(item.expiryDate);
                return expiryDate < nextMonth && expiryDate > today;
            });
            
            const expired = inventory.filter(item => {
                if (!item.expiryDate) return false;
                return new Date(item.expiryDate) <= today;
            });
            
            const alertsDiv = document.getElementById('expiryAlerts');
            let alertsHTML = '';
            
            if (expired.length > 0) {
                alertsHTML += `
                    <div class="alert alert-danger">
                        <strong>โ ููุชูู ุงูุตูุงุญูุฉ:</strong><br>
                        ${expired.map(item => `โข ${item.name} (${item.expiryDate})`).join('<br>')}
                    </div>
                `;
            }
            
            if (expiringSoon.length > 0) {
                alertsHTML += `
                    <div class="alert alert-warning">
                        <strong>โ๏ธ ุณููุชูู ูุฑูุจุงู:</strong><br>
                        ${expiringSoon.map(item => `โข ${item.name} (${item.expiryDate})`).join('<br>')}
                    </div>
                `;
            }
            
            if (expired.length === 0 && expiringSoon.length === 0) {
                alertsHTML = '<p class="text-muted">ูุง ุชูุฌุฏ ุชูุจููุงุช ุงูุชูุงุก ุตูุงุญูุฉ</p>';
            }
            
            alertsDiv.innerHTML = alertsHTML;
        }

        // ============================================
        // ูุณู ุงููุฏูุฑ - ุงูููุชุจุฉ ุงูุทุจูุฉ ูุงูุชูุงุฑูุฑ
        // ============================================
        function showAdminTab(tab) {
            ['reports', 'patients', 'inventory', 'staff'].forEach(t => {
                document.getElementById(`admin-${t}`).classList.add('hidden-section');
            });
            document.getElementById(`admin-${tab}`).classList.remove('hidden-section');
        }

        function loadMedicalLibrary() {
            const libraryDiv = document.getElementById('medicalLibraryContent');
            libraryDiv.innerHTML = medicalLibrary.map(item => `
                <div class="card p-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="mb-1">${item.title}</h6>
                            <small class="badge bg-info">${item.category === 'diseases' ? 'ุฃูุฑุงุถ' : 
                                                         item.category === 'drugs' ? 'ุฃุฏููุฉ' : 
                                                         item.category === 'procedures' ? 'ุฅุฌุฑุงุกุงุช' : 'ูุญูุตุงุช'}</small>
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteLibraryItem(${item.id})">โ</button>
                    </div>
                    <p class="mb-0 small">${item.content.substring(0, 100)}...</p>
                </div>
            `).join('');
        }

        function searchMedicalLibrary() {
            const query = document.getElementById('searchMedicalLibrary').value.toLowerCase();
            const filtered = medicalLibrary.filter(item => 
                item.title.toLowerCase().includes(query) ||
                item.content.toLowerCase().includes(query)
            );
            
            const libraryDiv = document.getElementById('medicalLibraryContent');
            libraryDiv.innerHTML = filtered.map(item => `
                <div class="card p-2 mb-2">
                    <h6 class="mb-1">${item.title}</h6>
                    <small class="badge bg-info">${item.category}</small>
                    <p class="mb-0 small">${item.content.substring(0, 100)}...</p>
                </div>
            `).join('');
        }

        function filterLibrary(category) {
            const filtered = category === 'all' ? 
                medicalLibrary : 
                medicalLibrary.filter(item => item.category === category);
            
            const libraryDiv = document.getElementById('medicalLibraryContent');
            libraryDiv.innerHTML = filtered.map(item => `
                <div class="card p-2 mb-2">
                    <h6 class="mb-1">${item.title}</h6>
                    <p class="mb-0 small">${item.content.substring(0, 100)}...</p>
                </div>
            `).join('');
        }

        function addToLibrary() {
            const title = prompt("ุนููุงู ุงููุงุฏุฉ ุงูุนูููุฉ:");
            if (!title) return;
            
            const category = prompt("ุงููุณู (diseases, drugs, procedures, tests):");
            if (!['diseases', 'drugs', 'procedures', 'tests'].includes(category)) {
                alert("ุงููุณู ุบูุฑ ุตุญูุญ!");
                return;
            }
            
            const content = prompt("ุงููุญุชูู:");
            if (!content) return;
            
            const newItem = {
                id: Date.now(),
                title,
                category,
                content,
                date: new Date().toLocaleDateString()
            };
            
            medicalLibrary.push(newItem);
            localStorage.setItem('shifa_library', JSON.stringify(medicalLibrary));
            loadMedicalLibrary();
            alert("โ ุชูุช ุฅุถุงูุฉ ุงููุงุฏุฉ ุงูุนูููุฉ");
        }

        function deleteLibraryItem(id) {
            if (confirm("ูู ุชุฑูุฏ ุญุฐู ูุฐู ุงููุงุฏุฉ ุงูุนูููุฉุ")) {
                const index = medicalLibrary.findIndex(item => item.id === id);
                if (index !== -1) {
                    medicalLibrary.splice(index, 1);
                    localStorage.setItem('shifa_library', JSON.stringify(medicalLibrary));
                    loadMedicalLibrary();
                    alert("โ ุชู ุงูุญุฐู");
                }
            }
        }

        function loadAdminReports() {
            // ุชุญููู ุงูุจูุงูุงุช ููุฅุญุตุงุฆูุงุช
            const today = new Date().toLocaleDateString();
            const todayPatients = patients.filter(p => p.date === today).length;
            const totalRevenue = financials.clinic + financials.lab + financials.pharSales;
            
            // ุชุญุฏูุซ ุงูุฅุญุตุงุฆูุงุช
            document.getElementById('finClinic').textContent = financials.clinic.toLocaleString();
            document.getElementById('finLab').textContent = financials.lab.toLocaleString();
            document.getElementById('finPhar').textContent = financials.pharSales.toLocaleString();
            document.getElementById('totalProfit').textContent = (financials.pharProfit + financials.clinic + financials.lab).toLocaleString();
            
            // ูุคุดุฑุงุช ุงูุฃุฏุงุก
            document.getElementById('avgConsultationTime').textContent = "15";
            document.getElementById('patientsPerDoctor').textContent = todayPatients;
            document.getElementById('occupancyRate').textContent = "75%";
            document.getElementById('patientSatisfaction').textContent = "92%";
            
            // ุชุญููู ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู
            analyzeStrategicStock();
            
            // ุชุญููู ุงููุฎุฒูู ูููุฏูุฑ
            const inventoryValue = inventory.reduce((sum, item) => sum + (item.cost * item.qty), 0);
            const expiredItems = inventory.filter(item => {
                if (!item.expiryDate) return false;
                return new Date(item.expiryDate) < new Date();
            }).length;
            
            document.getElementById('inventoryValue').textContent = inventoryValue.toLocaleString();
            document.getElementById('inventoryTurnover').textContent = "4.2";
            document.getElementById('expiredItems').textContent = expiredItems;
            
            // ุชุญููู ุงููุฎุฒูู ุงูุชูุตููู
            const analysisDiv = document.getElementById('inventoryAnalysis');
            const categories = {};
            inventory.forEach(item => {
                categories[item.category] = (categories[item.category] || 0) + (item.cost * item.qty);
            });
            
            analysisDiv.innerHTML = `
                <h6 class="fw-bold">๐ ุชูุฒูุน ุงููุฎุฒูู ุจุงููููุฉ</h6>
                ${Object.entries(categories).map(([cat, value]) => `
                    <div class="mb-2">
                        <div class="d-flex justify-content-between">
                            <span>${cat}</span>
                            <span>${value.toLocaleString()} ุฌ</span>
                        </div>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar" style="width: ${(value / inventoryValue * 100)}%"></div>
                        </div>
                    </div>
                `).join('')}
            `;
        }

        function exportMedicalRecords() {
            const data = {
                patients,
                medicalRecords: patients.map(p => ({
                    name: p.name,
                    age: p.age,
                    gender: p.gender,
                    phone: p.phone,
                    medicalHistory: p.medicalHistory,
                    allergies: p.allergies,
                    regularMeds: p.regularMeds,
                    visits: p.visitCount
                }))
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Medical_Records_Backup_${new Date().toLocaleDateString('ar-EG')}.json`;
            a.click();
            
            alert("โ ุชู ุชุตุฏูุฑ ุงูุณุฌูุงุช ุงูุทุจูุฉ");
        }

        function backupAllData() {
            const data = {
                patients,
                labRequests,
                pharmOrders,
                nursingOrders,
                nursingTasks,
                inventory,
                financials,
                staffMembers,
                labTests,
                medicalLibrary,
                nurses,
                operationMode: OPERATION_MODE,
                backupDate: new Date().toLocaleString()
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Full_Backup_${new Date().toLocaleDateString('ar-EG')}.json`;
            a.click();
            
            alert("โ ุชู ุฅูุดุงุก ูุณุฎุฉ ุงุญุชูุงุทูุฉ ูุงููุฉ");
        }

        // ============================================
        // ุฏูุงู ูุณุงุนุฏุฉ ุนุงูุฉ (ูุญุฏุซุฉ)
        // ============================================
        function saveLocalData() {
            localStorage.setItem('shifa_pats', JSON.stringify(patients));
            localStorage.setItem('shifa_lab', JSON.stringify(labRequests));
            localStorage.setItem('shifa_rx', JSON.stringify(pharmOrders));
            localStorage.setItem('shifa_nursing', JSON.stringify(nursingOrders));
            localStorage.setItem('shifa_nursing_tasks', JSON.stringify(nursingTasks));
            localStorage.setItem('shifa_inv', JSON.stringify(inventory));
            localStorage.setItem('shifa_fin', JSON.stringify(financials));
            localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            localStorage.setItem('shifa_tests', JSON.stringify(labTests));
            localStorage.setItem('shifa_library', JSON.stringify(medicalLibrary));
            localStorage.setItem('shifa_nurses', JSON.stringify(nurses));
            localStorage.setItem('shifa_mode', OPERATION_MODE);
        }

        function updateBadges() {
            const waitingPatients = patients.filter(p => p.status === 'waiting').length;
            const pendingLabRequests = labRequests.filter(r => r.status === 'pending').length;
            const pendingPharmOrders = pharmOrders.filter(o => o.status === 'pending').length;
            const pendingNursingTasks = nursingTasks.filter(t => t.status !== 'ููุชูู').length;
            
            updateBadge('doctorBadge', waitingPatients);
            updateBadge('labBadge', pendingLabRequests);
            updateBadge('pharBadge', pendingPharmOrders);
            updateBadge('nurseBadge', pendingNursingTasks);
        }

        function updateBadge(badgeId, count) {
            const badge = document.getElementById(badgeId);
            if (count > 0) {
                badge.textContent = count;
                badge.classList.remove('hidden-section');
            } else {
                badge.classList.add('hidden-section');
            }
        }

        function manualSync() {
            if (OPERATION_MODE === "server" && IS_ONLINE) {
                processPendingSync();
                alert("๐ ุฌุงุฑู ุงููุฒุงููุฉ ูุน ุงูุณูุฑูุฑ...");
            } else if (OPERATION_MODE === "local") {
                alert("๐ง ุฃูุช ูู ุงููุถุน ุงููุญูู. ูุง ุชูุฌุฏ ูุฒุงููุฉ ูุน ุงูุณูุฑูุฑ.");
            } else {
                alert("โ ูุง ููุฌุฏ ุงุชุตุงู ุจุงูุณูุฑูุฑ ูููุฒุงููุฉ.");
            }
        }

        // ============================================
        // ุฏูุงู ุฅุฏุงุฑุฉ ุงููุธุงู
        // ============================================
        function exportData() {
            const data = { 
                patients, 
                labRequests, 
                pharmOrders, 
                nursingOrders,
                nursingTasks,
                inventory, 
                financials, 
                staffMembers, 
                labTests,
                medicalLibrary,
                nurses,
                operationMode: OPERATION_MODE
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `Shifa_Smart_Backup_${new Date().toLocaleDateString('ar-EG')}.json`;
            a.click();
            
            alert("โ ุชู ุชุญููู ุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉ!");
        }

        function importData(input) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    if(confirm("ูู ุชุฑูุฏ ุงุณุชุจุฏุงู ุงูุจูุงูุงุช ุงูุญุงููุฉ ุจุงููุณุฎุฉ ุงูุงุญุชูุงุทูุฉุ")) {
                        patients = data.patients || patients;
                        labRequests = data.labRequests || labRequests;
                        pharmOrders = data.pharmOrders || pharmOrders;
                        nursingOrders = data.nursingOrders || nursingOrders;
                        nursingTasks = data.nursingTasks || nursingTasks;
                        inventory = data.inventory || inventory;
                        financials = data.financials || financials;
                        staffMembers = data.staffMembers || staffMembers;
                        labTests = data.labTests || labTests;
                        medicalLibrary = data.medicalLibrary || medicalLibrary;
                        nurses = data.nurses || nurses;
                        OPERATION_MODE = data.operationMode || "local";
                        
                        saveLocalData();
                        location.reload();
                    }
                } catch (err) {
                    alert("โ ุงูููู ุบูุฑ ุตุงูุญ!");
                    console.error(err);
                }
            };
            reader.readAsText(input.files[0]);
        }

        function resetDay() {
            if(confirm("ูู ุชุฑูุฏ ุฅุบูุงู ุงูููู ูุชุตููุฑ ุงูุนุฏุงุฏุงุช ุงููุงููุฉุ")) {
                financials = { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0 };
                saveLocalData();
                refreshAll();
                alert("โ ุชู ุฅุบูุงู ุงูููู ุจูุฌุงุญ!");
            }
        }

        function resetSection(key) {
            if(!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุชุตููุฑ ูุณู ${key}ุ`)) return;
            
            if(key === 'pats') {
                patients.forEach(p => p.status = 'done');
            } else if(key === 'lab') {
                labRequests = [];
            } else if(key === 'rx') {
                pharmOrders = pharmOrders.filter(o => o.status !== 'pending');
            } else if(key === 'nursing') {
                nursingTasks = nursingTasks.filter(t => t.status === 'ููุชูู');
            }
            
            saveLocalData();
            refreshAll();
            alert(`โ ุชู ุชุตููุฑ ูุณู ${key}!`);
        }

        function resetAllDay() {
            if(confirm("ูู ุชุฑูุฏ ุชุตููุฑ ุดุงูู ููููู (ุงูุจูุงูุงุช ูุงููุงููุงุช)ุ")) {
                patients = []; 
                labRequests = []; 
                pharmOrders = [];
                nursingOrders = [];
                nursingTasks = [];
                financials = { clinic: 0, lab: 0, pharSales: 0, pharProfit: 0 };
                saveLocalData();
                location.reload();
            }
        }

        function generateDailyReport() {
            const today = new Date().toLocaleDateString();
            const todayPatients = patients.filter(p => p.date === today);
            const todayRevenue = financials.clinic + financials.lab + financials.pharSales;
            
            let report = `
                <div class="p-4">
                    <h3 class="text-center mb-4">๐ ุงูุชูุฑูุฑ ุงููููู - ${today}</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="card bg-primary text-white p-3">
                                <h4>${todayPatients.length}</h4>
                                <p>ุนุฏุฏ ุงููุฑุถู</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-success text-white p-3">
                                <h4>${todayRevenue.toLocaleString()} ุฌ</h4>
                                <p>ุงูุฅูุฑุงุฏุงุช ุงูููููุฉ</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card bg-info text-white p-3">
                                <h4>${pharmOrders.filter(o => o.status === 'dispensed').length}</h4>
                                <p>ุนุฏุฏ ุงูุฑูุดุชุงุช ุงููุตูููุฉ</p>
                            </div>
                        </div>
                    </div>
                    
                    <h5>๐ ุชูุงุตูู ุงููุฑุถู</h5>
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>ุงูุงุณู</th>
                                <th>ุงูุชุดุฎูุต</th>
                                <th>ุงูุฑุณูู</th>
                                <th>ุงูุญุงูุฉ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${todayPatients.map(p => `
                                <tr>
                                    <td>${p.name}</td>
                                    <td>${p.complaint || 'ุบูุฑ ูุณุฌู'}</td>
                                    <td>${p.ticket || 0} ุฌ</td>
                                    <td>${p.status === 'done' ? 'ููุชูู' : 'ูุนูู'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('printTitle').innerText = `ุงูุชูุฑูุฑ ุงููููู - ${today}`;
            document.getElementById('printDate').innerText = new Date().toLocaleString('ar-EG');
            document.getElementById('printContent').innerHTML = report;
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function logout() { 
            if (SYNC_INTERVAL) clearInterval(SYNC_INTERVAL);
            localStorage.removeItem('shifa_user'); 
            location.reload(); 
        }

        // ============================================
        // ุฏูุงู ุงูุชููุฆุฉ ูุงูุฅุนุฏุงุฏ
        // ============================================
        window.onload = function() {
            // ุชููุฆุฉ Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(err => console.log('Service Worker failed', err));
            }
            
            // ุชุญุฏูุซ ุงูุณุงุนุฉ
            updateClock();
            setInterval(updateClock, 1000);
            
            // ุชุญููู ุงูุจูุงูุงุช ุงููุนููุฉ ูููุฒุงููุฉ
            PENDING_SYNC = JSON.parse(localStorage.getItem('shifa_pending_sync')) || [];
            updateSyncStatus();
            
            // ุชุญููู ูุถุน ุงูุชุดุบูู ุงูุณุงุจู
            OPERATION_MODE = localStorage.getItem('shifa_mode') || "local";
            
            // ุชุญุฏูุซ ุญุงูุฉ ุงูุงุชุตุงู
            updateConnectionStatus(navigator.onLine);
            
            // ูุณุชูุนู ุฃุญุฏุงุซ ุงูุดุจูุฉ
            window.addEventListener('online', () => updateConnectionStatus(true));
            window.addEventListener('offline', () => updateConnectionStatus(false));
            
            // ุฅุฐุง ูุงู ููุงู ูุณุชุฎุฏู ูุณุฌู ูุณุจูุงู
            if(currentUser) {
                document.getElementById('loginOverlay').classList.add('hidden-section');
                document.getElementById('mainContent').classList.remove('hidden-section');
                document.getElementById('currentUserDisplay').innerText = `๐ค ${currentUser.u}`;
                setupPermissions(currentUser.r);
                refreshAll();
                
                // ุชุญุฏูุฏ ูุถุน ุงูุฏุฎูู ูู ุงูุดุงุดุฉ
                const modeRadio = document.querySelector(`input[name="loginMode"][value="${OPERATION_MODE}"]`);
                if (modeRadio) modeRadio.checked = true;
            } else {
                // ุชุนููู ูุถุน ุงูุชุดุบูู ูู ุดุงุดุฉ ุงูุฏุฎูู
                const modeRadio = document.querySelector(`input[name="loginMode"][value="${OPERATION_MODE}"]`);
                if (modeRadio) modeRadio.checked = true;
            }
            
            // ุชุนููู ุชุงุฑูุฎ ุงูููู ูุญูู ุงูุชูุฑูุถ
            document.getElementById('nursingDate').value = new Date().toISOString().split('T')[0];
        };

        // ============================================
        // ุฏูุงู ุงููุงุฌูุฉ ุงูุฃุณุงุณูุฉ (ุงููุชุจููุฉ)
        // ============================================
        function updateClock() { 
            document.getElementById('clockDisplay').innerText = new Date().toLocaleTimeString('ar-EG'); 
        }

        function searchPatients(query) {
            const waiting = patients.filter(p => p.status === 'waiting');
            
            if (!query) {
                refreshPatientList(waiting);
                return;
            }
            
            const filtered = waiting.filter(p => 
                p.name.toLowerCase().includes(query.toLowerCase()) ||
                (p.phone && p.phone.includes(query))
            );
            
            refreshPatientList(filtered);
        }

        function refreshPatientList(patientList) {
            document.getElementById('doctorPatientList').innerHTML = patientList.map(p => {
                const isReady = labRequests.some(r => r.patient === p.name && r.status === 'done');
                return `
                    <button class="btn patient-btn ${isReady ? 'ready' : ''}" onclick="selectPatient(${p.id})">
                        <div class="d-flex justify-content-between align-items-center">
                            <div class="text-start">
                                <strong>${p.name}</strong><br>
                                <small class="text-muted">ุงูุนูุฑ: ${p.age} | ${p.phone || 'ูุง ูุงุชู'}</small>
                            </div>
                            <span class="badge ${isReady ? 'bg-success' : 'bg-secondary'}">${isReady ? 'ุฌุงูุฒ' : 'ุงูุชุธุงุฑ'}</span>
                        </div>
                    </button>`;
            }).join('');
        }

        function showDocSubSection(sub) {
            document.getElementById('doc-sub-rx').classList.toggle('hidden-section', sub !== 'rx');
            document.getElementById('doc-sub-lab').classList.toggle('hidden-section', sub !== 'lab');
            document.getElementById('doc-sub-results').classList.toggle('hidden-section', sub !== 'results');
            document.getElementById('doc-sub-nursing').classList.toggle('hidden-section', sub !== 'nursing');
        }

        function filterStock(query) {
            const datalist = document.getElementById('stockMeds');
            const select = document.getElementById('medSelect');
            
            if (!query) {
                updateMedicationLists(inventory);
                return;
            }
            
            const filtered = inventory.filter(item => 
                item.name.toLowerCase().includes(query.toLowerCase())
            );
            
            updateMedicationLists(filtered);
        }

        function updateMedicationLists(medList) {
            const datalist = document.getElementById('stockMeds');
            const select = document.getElementById('medSelect');
            
            datalist.innerHTML = medList.map(m => `<option value="${m.name}">${m.name} (${m.qty} ูุชููุฑ)</option>`).join('');
            select.innerHTML = '<option value="">-- ุงุฎุชุฑ ุฏูุงุก --</option>' + 
                medList.map(m => `<option value="${m.name}">${m.name} (${m.qty} ูุชููุฑ) - ${m.sale} ุฌ</option>`).join('');
        }

        function addMedToRx() {
            const medName = document.getElementById('medSearch').value || document.getElementById('medSelect').value;
            const dose = document.getElementById('medDose').value || "ูุฑุฉ ููููุงู";
            const days = document.getElementById('medDays').value || "7";
            
            if (!medName) {
                alert("ุงุฎุชุฑ ุฏูุงุก ุฃููุงู!");
                return;
            }
            
            const med = inventory.find(m => m.name === medName);
            if (!med) {
                alert("ูุฐุง ุงูุฏูุงุก ุบูุฑ ููุฌูุฏ ูู ุงููุฎุฒูู!");
                return;
            }
            
            if (med.qty <= 0) {
                alert("ูุฐุง ุงูุฏูุงุก ุบูุฑ ูุชููุฑ ูู ุงููุฎุฒูู!");
                return;
            }
            
            currentRxItems.push({
                name: medName,
                dose: dose,
                days: days,
                price: med.sale
            });
            
            updateRxDisplay();
            
            document.getElementById('medSearch').value = '';
            document.getElementById('medDose').value = '';
            document.getElementById('medDays').value = '7';
            
            // ูุญุต ุงูุชูุงุนูุงุช ุฅุฐุง ูุงู ุงูุฎูุงุฑ ููุนูุงู
            if (document.getElementById('checkInteractions').checked) {
                checkDrugInteractions();
            }
        }

        function removeRxItem(index) {
            currentRxItems.splice(index, 1);
            updateRxDisplay();
        }

        function updateRxDisplay() {
            const container = document.getElementById('rxItemsContainer');
            const textarea = document.getElementById('finalRx');
            
            container.innerHTML = currentRxItems.map((item, index) => `
                <div class="rx-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${item.name}</strong><br>
                        <small>ุงูุฌุฑุนุฉ: ${item.dose} ููุฏุฉ ${item.days} ุฃูุงู</small>
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">${item.price} ุฌ</span>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeRxItem(${index})">โ</button>
                    </div>
                </div>
            `).join('');
            
            textarea.value = currentRxItems.map(item => 
                `${item.name} - ${item.dose} ููุฏุฉ ${item.days} ุฃูุงู`
            ).join('\n');
        }

        async function sendRxToPharmacy() {
            if (!selectedPatientId) {
                alert("ุงุฎุชุฑ ูุฑูุถุงู ุฃููุงู!");
                return;
            }
            
            const rxText = document.getElementById('finalRx').value;
            const complaint = document.getElementById('pComplaint').value;
            const p = patients.find(pat => pat.id === selectedPatientId);
            
            if (!rxText && !complaint) {
                alert("ุฃุฏุฎู ุงูุชุดุฎูุต ุฃู ุงูุฑูุดุชุฉ!");
                return;
            }
            
            p.complaint = complaint;
            p.status = 'done';
            
            // ุญูุธ ุงูุนูุงูุงุช ุงูุญูููุฉ
            p.vitalSigns = {
                bp: document.getElementById('vitalBP').value,
                pulse: document.getElementById('vitalPulse').value,
                temp: document.getElementById('vitalTemp').value,
                resp: document.getElementById('vitalResp').value,
                sugar: document.getElementById('vitalSugar').value
            };
            
            const order = {
                patient: p.name,
                patientId: p.id,
                rx: rxText,
                complaint: complaint,
                items: [...currentRxItems],
                vitalSigns: p.vitalSigns,
                total: currentRxItems.reduce((sum, item) => sum + item.price, 0),
                time: new Date().toLocaleTimeString(),
                date: new Date().toLocaleDateString(),
                status: 'pending'
            };
            
            pharmOrders.push(order);
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                const result = await apiCall('addPharmacyOrder', order);
                if (!result.success) {
                    addToPendingSync('addPharmacyOrder', order);
                }
            }
            
            selectedPatientId = null;
            currentRxItems = [];
            document.getElementById('treatmentArea').classList.add('hidden-section');
            
            document.getElementById('notificationSound').play();
            refreshAll();
            updateBadges();
            
            alert(`โ ุชู ุฅุฑุณุงู ุงูุฑูุดุชุฉ ููุตูุฏููุฉ ูููุฑูุถ ${p.name}`);
        }

        async function sendToLab() {
            if (!selectedPatientId) {
                alert("ุงุฎุชุฑ ูุฑูุถุงู ุฃููุงู!");
                return;
            }
            
            const sel = document.getElementById('testSelect');
            const p = patients.find(pat => pat.id === selectedPatientId);
            const test = labTests[sel.selectedIndex];
            
            if (!test) {
                alert("ุงุฎุชุฑ ูุญุตุงู ูู ุงููุงุฆูุฉ!");
                return;
            }
            
            const req = { 
                patient: p.name, 
                patientId: p.id,
                test: test.name, 
                price: test.price, 
                status: 'pending', 
                time: new Date().toLocaleTimeString() 
            };
            
            labRequests.push(req);
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                const result = await apiCall('addLabRequest', req);
                if (!result.success) {
                    addToPendingSync('addLabRequest', req);
                }
            }
            
            updateDoctorLabRequests(p.name);
            alert(`โ ุชู ุฅุฑุณุงู ุทูุจ ูุญุต ${test.name} ูููุนูู`);
        }

        function updateDoctorLabRequests(patientName) {
            const requests = labRequests.filter(r => r.patient === patientName && r.status === 'pending');
            document.getElementById('doctorLabRequests').innerHTML = requests.map(r => 
                `<div class="alert alert-warning p-2 mb-1">${r.test} - ${r.price} ุฌ (ูุนูู)</div>`
            ).join('') || "<p class='text-muted'>ูุง ุชูุฌุฏ ุทูุจุงุช ูุญูุตุงุช ูุนููุฉ</p>";
        }

        function showPatientResults(name) {
            const results = labRequests.filter(r => r.patient === name && r.status === 'done');
            document.getElementById('patientSpecificLabResults').innerHTML = results.map(r => 
                `<div class="alert alert-info p-3 mb-2 shadow-sm">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <b>${r.test}</b><br>
                            <small class="text-muted">${r.time}</small>
                        </div>
                        <span class="badge bg-success">${r.price} ุฌ</span>
                    </div>
                    <hr class="my-2">
                    <div class="mt-2"><strong>ุงููุชูุฌุฉ:</strong> ${r.result}</div>
                </div>`
            ).join('') || `<div class="alert alert-secondary">ูุง ุชูุฌุฏ ูุชุงุฆุฌ ูุญูุตุงุช ุจุนุฏ</div>`;
        }

        function printRx() {
            if (!selectedPatientId) {
                alert("ุงุฎุชุฑ ูุฑูุถุงู ุฃููุงู!");
                return;
            }
            
            const p = patients.find(pat => pat.id === selectedPatientId);
            const complaint = document.getElementById('pComplaint').value;
            const rxText = document.getElementById('finalRx').value;
            const vitalSigns = p.vitalSigns || {};
            
            document.getElementById('printTitle').innerText = `ุฑูุดุชุฉ ุทุจูุฉ - ${p.name}`;
            document.getElementById('printDate').innerText = new Date().toLocaleString('ar-EG');
            
            let content = `
                <div class="mb-4">
                    <h4>${p.name}</h4>
                    <p>ุงูุนูุฑ: ${p.age} ุณูุฉ | ${p.gender || ''} | ${p.phone || ''}</p>
                    <p>ุงูุชุงุฑูุฎ: ${new Date().toLocaleDateString('ar-EG')}</p>
                    <hr>
                    <h5>ุงูุนูุงูุงุช ุงูุญูููุฉ:</h5>
                    <p>ุงูุถุบุท: ${vitalSigns.bp || '--'} | ุงููุจุถ: ${vitalSigns.pulse || '--'} | ุงูุญุฑุงุฑุฉ: ${vitalSigns.temp || '--'}ยฐC</p>
                    <hr>
                    <h5>ุงูุชุดุฎูุต:</h5>
                    <p>${complaint || 'ูุง ููุฌุฏ'}</p>
                    <hr>
                    <h5>ุฎุทุฉ ุงูุนูุงุฌ:</h5>
                    <p>${rxText.replace(/\n/g, '<br>') || 'ูุง ููุฌุฏ'}</p>
                    ${currentNursingOrders.length > 0 ? `
                        <hr>
                        <h5>ุฃูุงูุฑ ุงูุชูุฑูุถ:</h5>
                        <p>${currentNursingOrders.map(o => `${o.procedure} - ${o.frequency}`).join('<br>')}</p>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('printContent').innerHTML = content;
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function addInventory() {
            const name = document.getElementById('iName').value;
            const cost = parseFloat(document.getElementById('iCost').value) || 0;
            const qty = parseInt(document.getElementById('iQty').value) || 0;
            
            if(!name) {
                alert("ุฃุฏุฎู ุงุณู ุงูุตูู!");
                return;
            }
            
            const existing = inventory.find(item => item.name === name);
            if (existing) {
                existing.qty += qty;
                existing.cost = cost;
                existing.sale = cost * 1.5;
            } else {
                inventory.push({
                    id: Date.now(),
                    name, 
                    cost, 
                    sale: cost * 1.5, 
                    qty,
                    minLevel: 10,
                    maxLevel: 100,
                    expiryDate: "2026-12-31",
                    category: "ุฃุฏููุฉ ุนุงูุฉ"
                });
            }
            
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                addToPendingSync('updateInventory', inventory);
            }
            
            document.getElementById('iName').value = '';
            document.getElementById('iCost').value = '';
            document.getElementById('iQty').value = '';
            
            refreshAll();
            alert(`โ ุชู ${existing ? 'ุชุญุฏูุซ' : 'ุฅุถุงูุฉ'} ${name} ูู ุงููุฎุฒูู`);
        }

        function deleteInventoryItem(idx) {
            if (confirm(`ูู ุชุฑูุฏ ุญุฐู ${inventory[idx].name} ูู ุงููุฎุฒููุ`)) {
                inventory.splice(idx, 1);
                saveLocalData();
                refreshAll();
            }
        }

        function addNewStaff() {
            const u = document.getElementById('newStaffUser').value.trim();
            const p = document.getElementById('newStaffPass').value;
            const r = document.getElementById('newStaffRole').value;
            
            if(!u || !p) {
                alert("ุฃุฏุฎู ุงุณู ุงููุณุชุฎุฏู ููููุฉ ุงููุฑูุฑ!");
                return;
            }
            
            const exists = staffMembers.find(s => s.u === u);
            if (exists) {
                alert("ุงุณู ุงููุณุชุฎุฏู ููุฌูุฏ ูุณุจูุงู!");
                return;
            }
            
            staffMembers.push({u, p, r, name: u});
            localStorage.setItem('shifa_staff', JSON.stringify(staffMembers));
            
            document.getElementById('newStaffUser').value = '';
            document.getElementById('newStaffPass').value = '';
            
            refreshAll();
            alert(`โ ุชู ุฅุถุงูุฉ ุงููุณุชุฎุฏู ${u} ุจูุฌุงุญ!`);
        }

        function addNewTest() {
            const name = document.getElementById('newTestName').value;
            const price = parseFloat(document.getElementById('newTestPrice').value);
            
            if(!name || !price) {
                alert("ุฃุฏุฎู ุงุณู ุงููุญุต ูุงูุณุนุฑ!");
                return;
            }
            
            labTests.push({name, price});
            localStorage.setItem('shifa_tests', JSON.stringify(labTests));
            
            document.getElementById('newTestName').value = '';
            document.getElementById('newTestPrice').value = '';
            
            refreshAll();
            alert(`โ ุชู ุฅุถุงูุฉ ูุญุต ${name} ุจูุฌุงุญ!`);
        }

        function refreshAll() {
            refreshPatientList(patients.filter(p => p.status === 'waiting'));
            
            document.getElementById('testSelect').innerHTML = labTests.map(t => 
                `<option value="${t.name}">${t.name} (${t.price} ุฌ)</option>`
            ).join('');
            
            document.getElementById('labWorkTable').innerHTML = labRequests.map((r, i) => 
                r.status === 'pending' ? `
                    <tr>
                        <td>${r.patient}</td>
                        <td>${r.test}</td>
                        <td>${r.price} ุฌ</td>
                        <td>${r.time}</td>
                        <td><input id="labInput_${i}" class="form-control form-control-sm" placeholder="ุฃุฏุฎู ุงููุชูุฌุฉ..."></td>
                        <td><button class="btn btn-success btn-sm" onclick="submitLabResult(${i})">ุฅุฑุณุงู ุงููุชูุฌุฉ</button></td>
                    </tr>
                ` : ''
            ).join('');
            
            document.getElementById('pharmacyQueue').innerHTML = pharmOrders.map((o, i) => 
                o.status === 'pending' ? `
                    <div class="card p-3 border-start border-5 border-success mb-3 shadow-sm">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <h6 class="fw-bold mb-1">${o.patient}</h6>
                                <small class="text-muted">${o.time} | ${o.date}</small>
                            </div>
                            <button class="btn btn-success btn-sm" onclick="dispenseMed(${i})">โ ุตุฑู ุงูุฏูุงุก</button>
                        </div>
                        ${o.vitalSigns ? `
                            <div class="mb-2">
                                <strong>ุงูุนูุงูุงุช ุงูุญูููุฉ:</strong>
                                <small class="text-muted d-block">
                                    ุงูุถุบุท: ${o.vitalSigns.bp || '--'} | ุงููุจุถ: ${o.vitalSigns.pulse || '--'} | 
                                    ุงูุญุฑุงุฑุฉ: ${o.vitalSigns.temp || '--'}ยฐC | ุงูุณูุฑ: ${o.vitalSigns.sugar || '--'}
                                </small>
                            </div>
                        ` : ''}
                        <div class="mb-2">
                            <strong>ุงูุชุดุฎูุต:</strong>
                            <p class="text-muted">${o.complaint || 'ูุง ููุฌุฏ'}</p>
                        </div>
                        <div>
                            <strong>ุงูุฑูุดุชุฉ:</strong>
                            <div class="mt-1">${o.rx.replace(/\n/g, '<br>') || 'ูุง ููุฌุฏ'}</div>
                        </div>
                        ${o.items?.length > 0 ? `
                            <div class="mt-2">
                                <strong>ุงูุฃุฏููุฉ:</strong>
                                <ul class="mb-0">
                                    ${o.items.map(item => `<li>${item.name} - ${item.dose} ููุฏุฉ ${item.days} ุฃูุงู</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                ` : ''
            ).join('') || `<div class="alert alert-info">ูุง ุชูุฌุฏ ุฑูุดุชุงุช ูุนููุฉ ุญุงููุงู</div>`;
            
            document.getElementById('invTable').innerHTML = inventory.map((item, i) => `
                <tr>
                    <td>${item.name}</td>
                    <td>${item.sale} ุฌ</td>
                    <td>
                        <span class="badge ${item.qty > 10 ? 'bg-success' : item.qty > 0 ? 'bg-warning' : 'bg-danger'}">
                            ${item.qty}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteInventoryItem(${i})">โ</button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('staffTableBody').innerHTML = staffMembers.map((s, i) => `
                <tr>
                    <td>${s.name || s.u}</td>
                    <td><span class="badge bg-info">${s.r}</span></td>
                    <td>ูุดุท</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="staffMembers.splice(${i},1); localStorage.setItem('shifa_staff',JSON.stringify(staffMembers)); refreshAll();">
                            โ
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('testsTableBody').innerHTML = labTests.map((t, i) => `
                <tr>
                    <td>${t.name}</td>
                    <td>${t.price.toLocaleString()} ุฌ</td>
                    <td>
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="labTests.splice(${i},1); localStorage.setItem('shifa_tests',JSON.stringify(labTests)); refreshAll();">
                            โ
                        </button>
                    </td>
                </tr>
            `).join('');
            
            updateMedicationLists(inventory);
            updateBadges();
            
            // ุชุญููู ุงููุฎุฒูู ุงูุงุณุชุฑุงุชูุฌู
            analyzeStrategicStock();
            checkExpiryAlerts();
        }

        // ============================================
        // ุฏูุงู ุงููุนูู ูุงูุตูุฏููุฉ (ุงููุชุจููุฉ)
        // ============================================
        async function submitLabResult(idx) {
            const res = document.getElementById(`labInput_${idx}`).value;
            if(!res) {
                alert("ุฃุฏุฎู ูุชูุฌุฉ ุงููุญุต!");
                return;
            }
            
            labRequests[idx].result = res;
            labRequests[idx].status = 'done';
            labRequests[idx].doneTime = new Date().toLocaleTimeString();
            financials.lab += labRequests[idx].price;
            
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                const result = await apiCall('updateLabResult', labRequests[idx]);
                if (!result.success) {
                    addToPendingSync('updateLabResult', labRequests[idx]);
                }
            }
            
            document.getElementById('notificationSound').play();
            refreshAll();
            updateBadges();
            
            alert("โ ุชู ุฅุฑุณุงู ูุชูุฌุฉ ุงููุญุต!");
        }

        async function dispenseMed(idx) {
            const order = pharmOrders[idx];
            
            let outOfStock = [];
            order.items?.forEach(item => {
                const med = inventory.find(m => m.name === item.name);
                if (med) {
                    if (med.qty > 0) {
                        med.qty--;
                        financials.pharSales += item.price;
                        financials.pharProfit += (item.price - med.cost);
                    } else {
                        outOfStock.push(item.name);
                    }
                }
            });
            
            if (outOfStock.length > 0) {
                alert(`โ๏ธ ุงูุฃุฏููุฉ ุงูุชุงููุฉ ุบูุฑ ูุชููุฑุฉ ูู ุงููุฎุฒูู: ${outOfStock.join(', ')}`);
            }
            
            order.status = 'dispensed';
            order.dispensedTime = new Date().toLocaleTimeString();
            
            saveLocalData();
            
            if (OPERATION_MODE === "server") {
                const result = await apiCall('dispenseOrder', order);
                if (!result.success) {
                    addToPendingSync('dispenseOrder', order);
                }
            }
            
            document.getElementById('notificationSound').play();
            refreshAll();
            updateBadges();
            
            alert(`โ ุชู ุตุฑู ุงูุฏูุงุก ูููุฑูุถ ${order.patient}`);
        }
    </script>
</body>
</html>
